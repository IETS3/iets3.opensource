package org.iets3.variability.base.ide.plugin;

/*Generated by MPS */

import jetbrains.mps.plugins.tool.GeneratedTool;
import jetbrains.mps.logging.Logger;
import javax.swing.Icon;
import com.intellij.ui.jcef.JBCefBrowser;
import javax.swing.JPanel;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.project.MPSProject;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.wm.ToolWindowAnchor;
import com.intellij.ui.jcef.JBCefApp;
import jetbrains.mps.RuntimeFlags;
import com.intellij.openapi.application.ApplicationManager;
import java.awt.BorderLayout;
import javax.swing.BoxLayout;
import javax.swing.JButton;
import com.intellij.icons.AllIcons;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;
import jetbrains.mps.ide.project.ProjectHelper;
import javax.swing.JToggleButton;
import java.io.File;
import org.iets3.variability.artifacts.base.behavior.SkeletonTree;
import org.iets3.variability.artifacts.base.plugin.IArtifactAlgorithms;
import java.io.BufferedWriter;
import java.io.FileWriter;
import java.io.IOException;
import javax.swing.JComponent;

public class SkeletonTreeViewer_Tool extends GeneratedTool {
  private static final Logger LOG = Logger.getLogger(SkeletonTreeViewer_Tool.class);
  private static final Icon ICON = IconContainer.ICON_a0_0;
  private JBCefBrowser browser;
  private JPanel rootPanel;
  private SNode ivaa;
  private MPSProject mpsProject;
  private boolean scaleToFit;
  public SkeletonTreeViewer_Tool(Project project) {
    super(project, "Skeleton Tree", null, ICON, ToolWindowAnchor.BOTTOM, false);
  }
  public void init(Project project) {
    super.init(project);
    if (!(JBCefApp.isSupported()) || RuntimeFlags.isTestMode()) {
      String errorMessage = "JCEF technology is not supported, browser-based tools cannot be used";
      if (ApplicationManager.getApplication().isHeadlessEnvironment()) {
        if (LOG.isInfoLevel()) {
          LOG.info(errorMessage);
        }
      } else {
        if (LOG.isErrorLevel()) {
          LOG.error(errorMessage);
        }
      }
      return;
    }

    SkeletonTreeViewer_Tool.this.rootPanel = new JPanel(new BorderLayout());
    final SkeletonTreeViewer_Tool tt = SkeletonTreeViewer_Tool.this;
    JPanel buttonPanel = new JPanel();
    buttonPanel.setLayout(new BoxLayout(buttonPanel, BoxLayout.PAGE_AXIS));
    JButton refreshButton = ButtonBuilder.createButton(AllIcons.Actions.Refresh, "Refresh");
    refreshButton.addActionListener(new ActionListener() {
      @Override
      public void actionPerformed(ActionEvent p1) {
        if ((tt.ivaa != null)) {
          ProjectHelper.fromIdeaProject(project).getRepository().getModelAccess().runReadAction(() -> tt.update(true));
        }
      }
    });
    buttonPanel.add(refreshButton);

    JToggleButton scaleToFit = ButtonBuilder.createToggleButton(AllIcons.Graph.ZoomOut, "Scale to fit");
    scaleToFit.addActionListener(new ActionListener() {
      @Override
      public void actionPerformed(ActionEvent p1) {
        JToggleButton b = (JToggleButton) p1.getSource();
        tt.scaleToFit = b.isSelected();
        if (b.isSelected()) {
          b.setIcon(AllIcons.Graph.ZoomIn);
        } else {
          b.setIcon(AllIcons.Graph.ZoomOut);
        }
        SkeletonTreeViewer_Tool.this.mpsProject.getRepository().getModelAccess().runReadAction(() -> tt.update(false));
      }
    });
    buttonPanel.add(scaleToFit);

    SkeletonTreeViewer_Tool.this.browser = new JBCefBrowser("https://www.itemis.com");
    SkeletonTreeViewer_Tool.this.rootPanel.add(buttonPanel, BorderLayout.WEST);
    SkeletonTreeViewer_Tool.this.rootPanel.add(SkeletonTreeViewer_Tool.this.browser.getComponent(), BorderLayout.CENTER);
  }
  public void show(SNode ivaa, MPSProject project) {
    SkeletonTreeViewer_Tool.this.ivaa = ivaa;
    SkeletonTreeViewer_Tool.this.mpsProject = project;
    SkeletonTreeViewer_Tool.this.update(true);
  }
  public void update(boolean withRebuild) {
    // use of 'svg' ('png' will not support links)
    String outtype = "svg";

    String path = SkeletonTreeViewer_Tool.this.mpsProject.getProjectFile().getParent() + "/.temp_gen/dotfiles/";
    new File(path).mkdirs();
    File dotfile = new File(path, "out.dot");
    if (withRebuild) {
      SkeletonTree skeltree = IArtifactAlgorithms.instance().skeletonTreeBuilder().buildTree(SkeletonTreeViewer_Tool.this.ivaa);
      String graph = skeltree.buildGraph(true);
      try {
        BufferedWriter writer = new BufferedWriter(new FileWriter(dotfile));
        writer.append(graph);
        writer.close();

        String cmd = "dot -T" + outtype + " -O " + dotfile.getAbsolutePath();
        Process exec = Runtime.getRuntime().exec(cmd);
        exec.waitFor();
      } catch (IOException e) {
        if (LOG.isErrorLevel()) {
          LOG.error("Cannot create intermediate file: " + e.getMessage());
        }
      } catch (InterruptedException e) {
        if (LOG.isWarningLevel()) {
          LOG.warning("Graph rendering process has been interrupted: " + e.getMessage());
        }
      }
    }

    SkelTreeHTMLBuilder builder = new SkelTreeHTMLBuilder();
    String imgpath = dotfile.getAbsolutePath() + "." + outtype;
    String html = builder.genHTML(SkeletonTreeViewer_Tool.this.ivaa, imgpath, SkeletonTreeViewer_Tool.this.scaleToFit);
    SkeletonTreeViewer_Tool.this.browser.loadHTML(html);
  }
  public JComponent getComponent() {
    return SkeletonTreeViewer_Tool.this.rootPanel;
  }
}
