package org.iets3.core.expr.plugin.plugin;

/*Generated by MPS */

import com.mbeddr.mpsutil.traceExplorer.plugin.IASTHighlighter;
import com.mbeddr.mpsutil.interpreter.rt.ComputationTrace;
import org.jetbrains.mps.openapi.module.SRepository;
import com.intellij.openapi.fileEditor.FileEditorManager;
import org.jetbrains.annotations.NotNull;
import java.util.Set;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;

/**
 * Attaches trace information from a trace record to MPS nodes as user objects.
 */
public class InterpreterValueHighlighter implements IASTHighlighter<ComputationTrace> {

  public static final String COLORIZE_VALUE = "colorize-value";

  private final SRepository repository;
  private final FileEditorManager fileEditorManager;

  public InterpreterValueHighlighter(final SRepository repository, final FileEditorManager fileEditorManager) {
    this.repository = repository;
    this.fileEditorManager = fileEditorManager;
  }


  @Override
  public void highlight(@NotNull ComputationTrace record, Set<SNode> rootCollector) {
    List<SNode> valueNodes = new ArrayList<SNode>();
    collectValueNodes(record.getTracedValue(), valueNodes);
    for (SNode n : ListSequence.fromList(valueNodes)) {
      SetSequence.fromSet(rootCollector).addElement(SNodeOperations.getContainingRoot(n));
      n.putUserObject(COLORIZE_VALUE, COLORIZE_VALUE);
    }
  }

  @Override
  public void unhighlight(@NotNull ComputationTrace record, Set<SNode> rootCollector) {
    List<SNode> valueNodes = new ArrayList<SNode>();
    collectValueNodes(record.getTracedValue(), valueNodes);
    for (SNode n : ListSequence.fromList(valueNodes)) {
      SetSequence.fromSet(rootCollector).addElement(SNodeOperations.getContainingRoot(n));
      n.putUserObject(COLORIZE_VALUE, null);
    }
  }

  public void collectValueNodes(Object value, List<SNode> collector) {
    if (value == null) {
      return;
    }
    if (value instanceof SNode) {
      ListSequence.fromList(collector).addElement((SNode) value);
    }
    if (value instanceof Iterable) {
      for (Object o : (Iterable) value) {
        collectValueNodes(o, collector);
      }
    }
  }


  @Override
  public void updateEditors(Set<SNode> collectedRoots) {
    for (SNode r : SetSequence.fromSet(collectedRoots)) {
      EditorUpdater.updateEditors(r.getReference(), repository, fileEditorManager);
    }
  }

}
