package org.iets3.core.junit.interpreter.run.configuration.plugin;

/*Generated by MPS */

import jetbrains.mps.execution.api.configurations.BaseMpsRunConfiguration;
import jetbrains.mps.execution.api.settings.IPersistentConfiguration;
import jetbrains.mps.project.structure.modules.Copyable;
import jetbrains.mps.execution.api.settings.PersistentConfigurationContext;
import com.intellij.execution.configurations.RuntimeConfigurationException;
import org.jdom.Element;
import com.intellij.openapi.util.WriteExternalException;
import com.intellij.openapi.util.InvalidDataException;
import java.util.List;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.baseLanguage.unitTest.execution.tool.UnitTestViewComponent;
import jetbrains.mps.baseLanguage.unitTest.execution.client.TestRunState;
import com.intellij.execution.process.ProcessHandler;
import com.intellij.execution.Executor;
import com.intellij.execution.configurations.RunConfiguration;
import com.intellij.execution.ui.ConsoleView;
import jetbrains.mps.execution.api.configurations.ConsoleCreator;
import jetbrains.mps.ide.actions.StandaloneMPSStackTraceFilter;
import jetbrains.mps.execution.configurations.implementation.plugin.plugin.TestInProcessRunState;
import jetbrains.mps.execution.configurations.implementation.plugin.plugin.RunStateEnum;
import com.intellij.execution.configurations.RuntimeConfigurationError;
import com.intellij.openapi.project.Project;
import com.intellij.execution.configurations.ConfigurationFactory;
import org.jetbrains.annotations.Nullable;
import com.intellij.execution.configurations.RunProfileState;
import org.jetbrains.annotations.NotNull;
import com.intellij.execution.runners.ExecutionEnvironment;
import com.intellij.execution.ExecutionException;
import com.intellij.openapi.options.SettingsEditor;
import com.intellij.execution.configurations.ConfigurationPerRunnerSettings;
import com.intellij.execution.runners.ProgramRunner;
import com.intellij.execution.configurations.ConfigurationInfoProvider;
import jetbrains.mps.execution.api.settings.SettingsEditorEx;
import com.intellij.openapi.util.Key;
import com.intellij.execution.BeforeRunTask;

public final class JUnitInterpreterTest_Configuration extends BaseMpsRunConfiguration implements IPersistentConfiguration, Copyable<JUnitInterpreterTest_Configuration> {
  private JUnitInterpreterSettings_Configuration myJUnitInterpreterSettings = new JUnitInterpreterSettings_Configuration(this.getProject());

  @Override
  public void checkConfiguration(final PersistentConfigurationContext context) throws RuntimeConfigurationException {
    this.getJUnitInterpreterSettings().checkConfiguration(context);
    checkInProcessRunIsSingle();
  }
  @Override
  public void writeExternal(Element element) throws WriteExternalException {
    {
      Element fieldElement = new Element("myJUnitInterpreterSettings");
      myJUnitInterpreterSettings.writeExternal(fieldElement);
      element.addContent(fieldElement);
    }
  }

  @Override
  public void readExternal(Element element) throws InvalidDataException {
    if (element == null) {
      throw new InvalidDataException("Cant read " + this + ": element is null.");
    }
    if (element.getChild("myJUnitInterpreterSettings") != null) {
      myJUnitInterpreterSettings.readExternal(element.getChild("myJUnitInterpreterSettings"));
    }
  }

  public List<SNodeReference> getTestsToMake() {
    return this.getJUnitInterpreterSettings().getTestsToMake(ProjectHelper.fromIdeaProject(this.getProject()));
  }
  private void setRequiredJUnitSettings() {
    this.getJUnitInterpreterSettings().setInProcessFlag(true);
  }
  public UnitTestViewComponent createTestViewComponent(TestRunState runState, final ProcessHandler process, Executor executor, RunConfiguration rc) {
    ConsoleView console = ConsoleCreator.createConsoleView(this.getProject(), false);
    console.addMessageFilter(new StandaloneMPSStackTraceFilter(this.getProject()));
    return new UnitTestViewComponent(this.getProject(), rc, executor, console, runState, () -> {
      if (process != null) {
        process.destroyProcess();
      }
    });
  }
  private void checkInProcessRunIsSingle() throws RuntimeConfigurationException {
    if (TestInProcessRunState.getInstance(this.getProject()).get() != RunStateEnum.IDLE) {
      throw new RuntimeConfigurationError("There is already another instance running tests in-process. Only one instance is allowed to run in-process.");
    }
  }
  @Override
  @Deprecated
  public JUnitInterpreterTest_Configuration clone() {
    return copy();
  }

  @Override
  public JUnitInterpreterTest_Configuration copy() {
    JUnitInterpreterTest_Configuration cloneTemplate = createCloneTemplate();
    // beware, PersistenceConfiguration.this of newly created MyState instance would be the same as
    // the value of myState, and != clone as regular Java passer-by would expect.
    cloneTemplate.myJUnitInterpreterSettings = ((Copyable<JUnitInterpreterSettings_Configuration>) myJUnitInterpreterSettings).copy();
    return cloneTemplate;
  }

  public JUnitInterpreterSettings_Configuration getJUnitInterpreterSettings() {
    return myJUnitInterpreterSettings;
  }

  public void setJUnitInterpreterSettings(JUnitInterpreterSettings_Configuration value) {
    myJUnitInterpreterSettings = value;
  }

  public JUnitInterpreterTest_Configuration(Project project, ConfigurationFactory factory, String name) {
    super(project, factory, name);
  }
  @Nullable
  public RunProfileState getState(@NotNull Executor executor, @NotNull ExecutionEnvironment environment) throws ExecutionException {
    return new JUnitInterpreterTest_Configuration_RunProfileState(this, executor, environment);
  }
  @Nullable
  public SettingsEditor<ConfigurationPerRunnerSettings> getRunnerSettingsEditor(ProgramRunner runner) {
    return null;
  }
  public ConfigurationPerRunnerSettings createRunnerSettings(ConfigurationInfoProvider provider) {
    return null;
  }
  public SettingsEditorEx<JUnitInterpreterTest_Configuration> getConfigurationEditor() {
    return (SettingsEditorEx<JUnitInterpreterTest_Configuration>) getEditor();
  }
  public JUnitInterpreterTest_Configuration createCloneTemplate() {
    return (JUnitInterpreterTest_Configuration) super.clone();
  }
  public SettingsEditorEx<? extends IPersistentConfiguration> getEditor() {
    return new JUnitInterpreterTest_Configuration_Editor(myJUnitInterpreterSettings.getEditor());
  }
  @Override
  public void checkConfiguration() throws RuntimeConfigurationException {
    final jetbrains.mps.project.Project mpsProject = ProjectHelper.fromIdeaProject(getProject());
    checkConfiguration(() -> mpsProject);
  }
  @Override
  public boolean canExecute(String executorId) {
    return JUnitInterpreterTest_Configuration_RunProfileState.canExecute(executorId);
  }
  public static void configureBeforeTaskDefaults(Key<? extends BeforeRunTask> providerID, BeforeRunTask task) {
    if (providerID == JUnitInterpreterCheckInterpreterModelsBuildState_BeforeTask.KEY) {
      task.setEnabled(true);
    }
  }
  public Object[] createJUnitInterpreterCheckInterpreterModelsBuildStateTask() {
    return new Object[]{};
  }
}
