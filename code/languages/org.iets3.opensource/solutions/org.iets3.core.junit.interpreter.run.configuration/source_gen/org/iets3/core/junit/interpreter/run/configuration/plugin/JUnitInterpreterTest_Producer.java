package org.iets3.core.junit.interpreter.run.configuration.plugin;

/*Generated by MPS */

import java.util.List;
import com.intellij.execution.junit.RuntimeConfigurationProducer;
import com.intellij.execution.configurations.ConfigurationType;
import com.intellij.execution.configurations.ConfigurationFactory;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.execution.api.configurations.BaseMpsProducer;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.plugins.runconfigs.MPSPsiElement;
import org.jetbrains.annotations.NotNull;
import com.intellij.execution.configurations.RunConfiguration;
import com.intellij.execution.actions.ConfigurationContext;
import org.jetbrains.mps.openapi.module.SModule;
import org.jetbrains.mps.openapi.module.SModuleReference;
import java.util.Objects;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.mps.openapi.model.SModelName;
import jetbrains.mps.persistence.PersistenceRegistry;
import org.jetbrains.mps.openapi.model.SModelReference;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.iets3.core.expr.plugin.plugin.ExecutionModePreference;
import jetbrains.mps.baseLanguage.unitTest.execution.client.TestNodeWrapperFactory;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.baseLanguage.unitTest.execution.client.ITestNodeWrapper;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.execution.lib.PointerUtils;
import jetbrains.mps.smodel.ModelAccessHelper;
import jetbrains.mps.baseLanguage.unitTest.behavior.ITestCase__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.baseLanguage.unitTest.behavior.ITestMethod__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SProperty;

public final class JUnitInterpreterTest_Producer {

  public static List<RuntimeConfigurationProducer> getProducers(ConfigurationType configurationType) {
    ConfigurationFactory configurationFactory = null;
    // assume the one with id matching configuration kind is the primary one.
    // In fact, though technically we support more that one factory per type (aka 'foreign' factories), all factories
    // bear same id (due to overlook of template author, I believe), and we effectively take the fist registerd one, which I don't
    // mind as 'foreign' factories do not work anyway.
    for (ConfigurationFactory f : configurationType.getConfigurationFactories()) {
      if (f.getId().equals(configurationType.getId())) {
        configurationFactory = f;
        break;
      }
    }
    if (configurationFactory == null) {
      configurationFactory = configurationType.getConfigurationFactories()[0];
    }
    List<RuntimeConfigurationProducer> creators = ListSequence.fromList(new ArrayList<RuntimeConfigurationProducer>());
    ListSequence.fromList(creators).addElement(new ProducerPart_MPSProject_q439o4_a(configurationFactory));
    ListSequence.fromList(creators).addElement(new ProducerPart_SModule_q439o4_b(configurationFactory));
    ListSequence.fromList(creators).addElement(new ProducerPart_SModel_q439o4_c(configurationFactory));
    ListSequence.fromList(creators).addElement(new ProducerPart_Node_q439o4_d(configurationFactory));
    ListSequence.fromList(creators).addElement(new ProducerPart_Node_q439o4_e(configurationFactory));
    ListSequence.fromList(creators).addElement(new ProducerPart_NlistITestCase_q439o4_f(configurationFactory));
    ListSequence.fromList(creators).addElement(new ProducerPart_NlistITestMethod_q439o4_g(configurationFactory));
    return creators;
  }

  public static final class ProducerPart_MPSProject_q439o4_a extends BaseMpsProducer<MPSProject> {
    public ProducerPart_MPSProject_q439o4_a(ConfigurationFactory configurationFactory) {
      super(configurationFactory);
    }

    @Override
    protected boolean isApplicable(Object source) {
      return source instanceof MPSProject;
    }

    @Override
    protected JUnitInterpreterTest_Configuration doCreateConfiguration(final MPSProject source) {
      setSourceElement(new MPSPsiElement(getMpsProject()));
      JUnitInterpreterTest_Configuration configuration = ((JUnitInterpreterTest_Configuration) getConfigurationFactory().createConfiguration("" + "Interpreter on Tests in Project", getContext().getRunManager().getConfigurationTemplate(getConfigurationFactory()).getConfiguration()));
      configuration.getJUnitInterpreterSettings().setJUnitRunType(JUnitInterpreterRunTypes.PROJECT);
      return configuration;
    }

    @Override
    protected boolean isConfigurationFromContext(@NotNull RunConfiguration configuration0, @NotNull ConfigurationContext context) {
      if (!(configuration0 instanceof JUnitInterpreterTest_Configuration)) {
        return false;
      }
      JUnitInterpreterTest_Configuration configuration = (JUnitInterpreterTest_Configuration) configuration0;
      JUnitInterpreterSettings_Configuration settings = configuration.getJUnitInterpreterSettings();
      return settings.getJUnitRunType() == JUnitInterpreterRunTypes.PROJECT;
    }

    @Override
    public ProducerPart_MPSProject_q439o4_a clone() {
      return (ProducerPart_MPSProject_q439o4_a) super.clone();
    }
  }
  public static final class ProducerPart_SModule_q439o4_b extends BaseMpsProducer<SModule> {
    public ProducerPart_SModule_q439o4_b(ConfigurationFactory configurationFactory) {
      super(configurationFactory);
    }

    @Override
    protected boolean isApplicable(Object source) {
      return source instanceof SModule;
    }

    @Override
    protected JUnitInterpreterTest_Configuration doCreateConfiguration(final SModule source) {
      setSourceElement(MPSPsiElement.createFor(source, getMpsProject()));
      String name = source.getModuleName();
      JUnitInterpreterTest_Configuration configuration = ((JUnitInterpreterTest_Configuration) getConfigurationFactory().createConfiguration("" + "Interpreter on Tests in '" + name + "'", getContext().getRunManager().getConfigurationTemplate(getConfigurationFactory()).getConfiguration()));
      configuration.getJUnitInterpreterSettings().setJUnitRunType(JUnitInterpreterRunTypes.MODULE);
      configuration.getJUnitInterpreterSettings().setModuleRef(source.getModuleReference().toString());
      return configuration;
    }

    @Override
    protected boolean isConfigurationFromContext(@NotNull RunConfiguration configuration0, @NotNull ConfigurationContext context) {
      if (!(configuration0 instanceof JUnitInterpreterTest_Configuration)) {
        return false;
      }
      JUnitInterpreterTest_Configuration configuration = (JUnitInterpreterTest_Configuration) configuration0;
      JUnitInterpreterSettings_Configuration settings = configuration.getJUnitInterpreterSettings();
      if (context.getPsiLocation() instanceof MPSPsiElement) {
        MPSPsiElement element = (MPSPsiElement) context.getPsiLocation();
        SModuleReference mRef = element.getUnresolvedItem(SModuleReference.class);
        if (mRef == null) {
          return false;
        }
        return settings.getJUnitRunType() == JUnitInterpreterRunTypes.MODULE && Objects.equals(settings.getModuleReference(), mRef);
      }
      return false;
    }

    @Override
    public ProducerPart_SModule_q439o4_b clone() {
      return (ProducerPart_SModule_q439o4_b) super.clone();
    }
  }
  public static final class ProducerPart_SModel_q439o4_c extends BaseMpsProducer<SModel> {
    public ProducerPart_SModel_q439o4_c(ConfigurationFactory configurationFactory) {
      super(configurationFactory);
    }

    @Override
    protected boolean isApplicable(Object source) {
      return source instanceof SModel;
    }

    @Override
    protected JUnitInterpreterTest_Configuration doCreateConfiguration(final SModel source) {
      setSourceElement(MPSPsiElement.createFor(source, getMpsProject()));
      SModelName name = source.getName();
      JUnitInterpreterTest_Configuration configuration = ((JUnitInterpreterTest_Configuration) getConfigurationFactory().createConfiguration("" + "Interpreter on Tests in '" + name.getValue() + "'", getContext().getRunManager().getConfigurationTemplate(getConfigurationFactory()).getConfiguration()));
      configuration.getJUnitInterpreterSettings().setJUnitRunType(JUnitInterpreterRunTypes.MODEL);
      configuration.getJUnitInterpreterSettings().setModelRef(PersistenceRegistry.getInstance().asString(source.getReference()));
      configuration.getJUnitInterpreterSettings().setModuleRef(source.getModule().getModuleReference().toString());
      return configuration;
    }

    @Override
    protected boolean isConfigurationFromContext(@NotNull RunConfiguration configuration0, @NotNull ConfigurationContext context) {
      if (!(configuration0 instanceof JUnitInterpreterTest_Configuration)) {
        return false;
      }
      JUnitInterpreterTest_Configuration configuration = (JUnitInterpreterTest_Configuration) configuration0;
      JUnitInterpreterSettings_Configuration settings = configuration.getJUnitInterpreterSettings();
      if (settings.getJUnitRunType() != JUnitInterpreterRunTypes.MODEL) {
        return false;
      }
      if (context.getPsiLocation() instanceof MPSPsiElement) {
        MPSPsiElement element = ((MPSPsiElement) context.getPsiLocation());
        SModelReference mRef = element.getUnresolvedItem(SModelReference.class);
        return mRef != null && Objects.equals(settings.getModelReference(), mRef);
      }
      return false;
    }

    @Override
    public ProducerPart_SModel_q439o4_c clone() {
      return (ProducerPart_SModel_q439o4_c) super.clone();
    }
  }
  public static final class ProducerPart_Node_q439o4_d extends BaseMpsProducer<SNode> {
    public ProducerPart_Node_q439o4_d(ConfigurationFactory configurationFactory) {
      super(configurationFactory);
    }

    @Override
    protected boolean isApplicable(Object source) {
      return source instanceof SNode && SNodeOperations.isInstanceOf(((SNode) source), CONCEPTS.BaseConcept$gP);
    }

    @Override
    protected JUnitInterpreterTest_Configuration doCreateConfiguration(final SNode source) {
      setSourceElement(MPSPsiElement.createFor(source, getMpsProject()));
      JUnitInterpreterTest_Configuration configuration = null;
      try (AutoResetTestExecutionWorkspaceSetting setting = new AutoResetTestExecutionWorkspaceSetting(ExecutionModePreference.INTERPRETER)) {
        // this is a producer for root; below you can find the producer for a test method
        TestNodeWrapperFactory tnf = new TestNodeWrapperFactory(ProjectHelper.fromIdeaProjectOrFail(getContext().getProject()).getPlatform());

        SNode testableMethod = tnf.findWrappableAncestor(source, false);
        if (testableMethod != null) {
          ITestNodeWrapper testWrapper = tnf.tryToWrap(testableMethod);
          if (testWrapper != null && !(testWrapper.isTestCase())) {
            // no need to run the whole test case if we are inside a test method
            return null;
          }
        }
        SNode testRoot = tnf.findWrappableAncestor(source, true);
        if (testRoot == null) {
          return null;
        }
        ITestNodeWrapper wrapper = tnf.tryToWrap(testRoot);
        if (wrapper == null || Sequence.fromIterable(wrapper.getTestMethods()).isEmpty()) {
          return null;
        }

        String name = wrapper.getName();
        if (name == null) {
          return null;
        }


        configuration = ((JUnitInterpreterTest_Configuration) getConfigurationFactory().createConfiguration("" + "Interpreter on '" + name + "'", getContext().getRunManager().getConfigurationTemplate(getConfigurationFactory()).getConfiguration()));
        configuration.getJUnitInterpreterSettings().setJUnitRunType(JUnitInterpreterRunTypes.NODE);
        configuration.getJUnitInterpreterSettings().setTestCases(PointerUtils.nodeToCloneableList(testRoot));
        if (!(wrapper.canRunInProcess())) {
          configuration.getJUnitInterpreterSettings().setInProcessFlag(false);
        }
      } catch (Exception e) {
      }
      return configuration;
    }

    @Override
    protected boolean isConfigurationFromContext(@NotNull RunConfiguration configuration0, @NotNull ConfigurationContext context) {
      if (!(configuration0 instanceof JUnitInterpreterTest_Configuration)) {
        return false;
      }
      JUnitInterpreterTest_Configuration configuration = (JUnitInterpreterTest_Configuration) configuration0;
      JUnitInterpreterSettings_Configuration settings = configuration.getJUnitInterpreterSettings();
      if (settings.getJUnitRunType() != JUnitInterpreterRunTypes.NODE) {
        return false;
      }

      if (context.getPsiLocation() instanceof MPSPsiElement) {
        final MPSPsiElement element = (MPSPsiElement) context.getPsiLocation();
        MPSProject mpsProject = element.getMPSProject();
        ModelAccessHelper mah = new ModelAccessHelper(mpsProject.getRepository());
        final TestNodeWrapperFactory tnf = new TestNodeWrapperFactory(mpsProject.getPlatform());

        Object mpsItem = mah.runReadAction(() -> element.getMPSItem());
        if (!(mpsItem instanceof SNode)) {
          return false;
        }
        final SNode sourceNode = (SNode) mpsItem;
        // no test for testableMethod since the run type are different for these two producers
        SNode testableRoot = mah.runReadAction(() -> tnf.findWrappableAncestor(sourceNode, true));
        if (testableRoot == null) {
          return false;
        }

        return Objects.equals(settings.getTestCases(), PointerUtils.nodeToCloneableList(testableRoot));
      }
      return false;
    }

    @Override
    public ProducerPart_Node_q439o4_d clone() {
      return (ProducerPart_Node_q439o4_d) super.clone();
    }
  }
  public static final class ProducerPart_Node_q439o4_e extends BaseMpsProducer<SNode> {
    public ProducerPart_Node_q439o4_e(ConfigurationFactory configurationFactory) {
      super(configurationFactory);
    }

    @Override
    protected boolean isApplicable(Object source) {
      return source instanceof SNode && SNodeOperations.isInstanceOf(((SNode) source), CONCEPTS.BaseConcept$gP);
    }

    @Override
    protected JUnitInterpreterTest_Configuration doCreateConfiguration(final SNode source) {
      setSourceElement(MPSPsiElement.createFor(source, getMpsProject()));
      // this is a producer for test method
      final TestNodeWrapperFactory tnf = new TestNodeWrapperFactory(ProjectHelper.fromIdeaProjectOrFail(getContext().getProject()).getPlatform());
      SNode method = tnf.findWrappableAncestor(source, false);
      if (method == null) {
        return null;
      }
      ITestNodeWrapper wrapper = tnf.tryToWrap(method);
      if (wrapper == null || wrapper.isTestCase()) {
        return null;
      }

      JUnitInterpreterTest_Configuration configuration = ((JUnitInterpreterTest_Configuration) getConfigurationFactory().createConfiguration("" + "Interpreter on '" + wrapper.getName() + "'", getContext().getRunManager().getConfigurationTemplate(getConfigurationFactory()).getConfiguration()));
      configuration.getJUnitInterpreterSettings().setJUnitRunType(JUnitInterpreterRunTypes.METHOD);
      configuration.getJUnitInterpreterSettings().setTestMethods(PointerUtils.nodeToCloneableList(method));
      if (!(wrapper.canRunInProcess())) {
        configuration.getJUnitInterpreterSettings().setInProcessFlag(false);
      }
      return configuration;
    }

    @Override
    protected boolean isConfigurationFromContext(@NotNull RunConfiguration configuration0, @NotNull ConfigurationContext context) {
      if (!(configuration0 instanceof JUnitInterpreterTest_Configuration)) {
        return false;
      }
      JUnitInterpreterTest_Configuration configuration = (JUnitInterpreterTest_Configuration) configuration0;
      JUnitInterpreterSettings_Configuration settings = configuration.getJUnitInterpreterSettings();
      if (settings.getJUnitRunType() != JUnitInterpreterRunTypes.METHOD) {
        return false;
      }
      if (context.getPsiLocation() instanceof MPSPsiElement) {
        final MPSPsiElement element = (MPSPsiElement) context.getPsiLocation();
        MPSProject mpsProject = element.getMPSProject();
        ModelAccessHelper mah = new ModelAccessHelper(mpsProject.getRepository());
        final TestNodeWrapperFactory tnf = new TestNodeWrapperFactory(mpsProject.getPlatform());
        Object mpsItem = mah.runReadAction(() -> element.getMPSItem());
        if (!(mpsItem instanceof SNode)) {
          return false;
        }
        final SNode sourceNode = (SNode) mpsItem;
        SNode testableMethod = mah.runReadAction(() -> tnf.findWrappableAncestor(sourceNode, false));
        if (testableMethod == null) {
          return false;
        }

        return Objects.equals(settings.getTestMethods(), PointerUtils.nodeToCloneableList(testableMethod));
      }
      return false;
    }

    @Override
    public ProducerPart_Node_q439o4_e clone() {
      return (ProducerPart_Node_q439o4_e) super.clone();
    }
  }
  public static final class ProducerPart_NlistITestCase_q439o4_f extends BaseMpsProducer<List<SNode>> {
    public ProducerPart_NlistITestCase_q439o4_f(ConfigurationFactory configurationFactory) {
      super(configurationFactory);
    }

    @Override
    protected boolean isApplicable(Object source) {
      if (!(source instanceof List)) {
        return false;
      }
      for (Object obj : (List) source) {
        if (!(obj instanceof SNode && SNodeOperations.isInstanceOf(((SNode) obj), CONCEPTS.ITestCase$Fp))) {
          return false;
        }
      }
      return true;
    }

    @Override
    protected JUnitInterpreterTest_Configuration doCreateConfiguration(final List<SNode> source) {
      setSourceElement(MPSPsiElement.createFor(source, getMpsProject()));
      boolean containsTest = false;
      boolean canRunInProcess = true;
      for (SNode testCase : source) {
        if (ListSequence.fromList(ITestCase__BehaviorDescriptor.getUncommentedTestMethods_id6I8tQNTvi0f.invoke(testCase)).isNotEmpty()) {
          containsTest = true;
        }
        if (!((boolean) ITestCase__BehaviorDescriptor.canRunInProcess_id5_jSk8paieB.invoke(testCase))) {
          canRunInProcess = false;
        }
      }
      if (!(containsTest)) {
        return null;
      }

      JUnitInterpreterTest_Configuration configuration = ((JUnitInterpreterTest_Configuration) getConfigurationFactory().createConfiguration("" + "Interpreter on TestCases " + SPropertyOperations.getString(SNodeOperations.cast(ListSequence.fromList(source).first(), CONCEPTS.ITestCase$Fp), PROPS.name$MnvL) + ",...", getContext().getRunManager().getConfigurationTemplate(getConfigurationFactory()).getConfiguration()));
      configuration.getJUnitInterpreterSettings().setJUnitRunType(JUnitInterpreterRunTypes.NODE);
      configuration.getJUnitInterpreterSettings().setTestCases(PointerUtils.nodesToCloneableList(source));
      if (!(canRunInProcess)) {
        configuration.getJUnitInterpreterSettings().setInProcessFlag(false);
      }
      return configuration;
    }


    @Override
    public ProducerPart_NlistITestCase_q439o4_f clone() {
      return (ProducerPart_NlistITestCase_q439o4_f) super.clone();
    }
  }
  public static final class ProducerPart_NlistITestMethod_q439o4_g extends BaseMpsProducer<List<SNode>> {
    public ProducerPart_NlistITestMethod_q439o4_g(ConfigurationFactory configurationFactory) {
      super(configurationFactory);
    }

    @Override
    protected boolean isApplicable(Object source) {
      if (!(source instanceof List)) {
        return false;
      }
      for (Object obj : (List) source) {
        if (!(obj instanceof SNode && SNodeOperations.isInstanceOf(((SNode) obj), CONCEPTS.ITestMethod$em))) {
          return false;
        }
      }
      return true;
    }

    @Override
    protected JUnitInterpreterTest_Configuration doCreateConfiguration(final List<SNode> source) {
      setSourceElement(MPSPsiElement.createFor(source, getMpsProject()));
      JUnitInterpreterTest_Configuration configuration = ((JUnitInterpreterTest_Configuration) getConfigurationFactory().createConfiguration("" + "Interpreter on TestCases " + ITestMethod__BehaviorDescriptor.getTestName_idhGBohAB.invoke(ListSequence.fromList(source).first()) + ",...", getContext().getRunManager().getConfigurationTemplate(getConfigurationFactory()).getConfiguration()));
      configuration.getJUnitInterpreterSettings().setJUnitRunType(JUnitInterpreterRunTypes.METHOD);
      boolean canRunInProcess = true;
      for (SNode testMethod : source) {
        SNode testCase = ITestMethod__BehaviorDescriptor.getTestCase_idhGBgWVd.invoke(testMethod);
        if (testCase == null || !((boolean) ITestCase__BehaviorDescriptor.canRunInProcess_id5_jSk8paieB.invoke(testCase))) {
          canRunInProcess = false;
        }
      }
      configuration.getJUnitInterpreterSettings().setTestMethods(PointerUtils.nodesToCloneableList(source));
      if (!(canRunInProcess)) {
        configuration.getJUnitInterpreterSettings().setInProcessFlag(false);
      }
      return configuration;
    }


    @Override
    public ProducerPart_NlistITestMethod_q439o4_g clone() {
      return (ProducerPart_NlistITestMethod_q439o4_g) super.clone();
    }
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept BaseConcept$gP = MetaAdapterFactory.getConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x10802efe25aL, "jetbrains.mps.lang.core.structure.BaseConcept");
    /*package*/ static final SInterfaceConcept ITestCase$Fp = MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b2709bd56L, "jetbrains.mps.baseLanguage.unitTest.structure.ITestCase");
    /*package*/ static final SInterfaceConcept ITestMethod$em = MetaAdapterFactory.getInterfaceConcept(0xf61473f9130f42f6L, 0xb98d6c438812c2f6L, 0x11b27438a3dL, "jetbrains.mps.baseLanguage.unitTest.structure.ITestMethod");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }
}
