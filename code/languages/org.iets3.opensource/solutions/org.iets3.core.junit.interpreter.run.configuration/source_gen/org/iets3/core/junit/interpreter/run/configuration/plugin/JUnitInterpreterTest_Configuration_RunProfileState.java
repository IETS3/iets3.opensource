package org.iets3.core.junit.interpreter.run.configuration.plugin;

/*Generated by MPS */

import jetbrains.mps.debug.api.run.DebuggerRunProfileState;
import com.intellij.execution.configurations.RunProfileState;
import org.jetbrains.annotations.NotNull;
import com.intellij.execution.runners.ExecutionEnvironment;
import com.intellij.execution.Executor;
import com.intellij.execution.configurations.ConfigurationPerRunnerSettings;
import com.intellij.execution.configurations.RunnerSettings;
import org.jetbrains.annotations.Nullable;
import com.intellij.execution.ExecutionResult;
import com.intellij.execution.runners.ProgramRunner;
import com.intellij.execution.ExecutionException;
import com.intellij.openapi.project.Project;
import com.intellij.execution.executors.DefaultDebugExecutor;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.ide.project.ProjectHelper;
import org.iets3.core.expr.plugin.plugin.ExecutionModePreference;
import java.util.List;
import jetbrains.mps.baseLanguage.unitTest.execution.client.ITestNodeWrapper;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.execution.configurations.implementation.plugin.plugin.JUnitProcessStarter;
import com.intellij.execution.process.ProcessHandler;
import jetbrains.mps.baseLanguage.unitTest.execution.client.TestRunState;
import jetbrains.mps.baseLanguage.unitTest.execution.tool.UnitTestViewComponent;
import com.intellij.execution.process.ProcessListener;
import jetbrains.mps.baseLanguage.unitTest.execution.client.UnitTestProcessListener;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.execution.api.configurations.DefaultExecutionResult;
import jetbrains.mps.execution.api.configurations.DefaultExecutionConsole;
import jetbrains.mps.debug.api.run.IDebuggerConfiguration;
import jetbrains.mps.debug.api.IDebuggerSettings;
import jetbrains.mps.debugger.java.api.settings.LocalConnectionSettings;
import jetbrains.mps.debug.api.IDebugger;
import jetbrains.mps.debug.api.Debuggers;
import com.intellij.execution.executors.DefaultRunExecutor;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class JUnitInterpreterTest_Configuration_RunProfileState extends DebuggerRunProfileState implements RunProfileState {
  @NotNull
  private final JUnitInterpreterTest_Configuration myRunConfiguration;
  @NotNull
  private final ExecutionEnvironment myEnvironment;

  public JUnitInterpreterTest_Configuration_RunProfileState(@NotNull JUnitInterpreterTest_Configuration configuration, @NotNull Executor executor, @NotNull ExecutionEnvironment environment) {
    myRunConfiguration = configuration;
    myEnvironment = environment;
  }

  public ConfigurationPerRunnerSettings getConfigurationSettings() {
    return null;
  }

  public RunnerSettings getRunnerSettings() {
    return null;
  }

  @Nullable
  public ExecutionResult execute(Executor executor, @NotNull ProgramRunner runner) throws ExecutionException {
    Project project = myEnvironment.getProject();
    JUnitInterpreterSettings_Configuration junitParams = myRunConfiguration.getJUnitInterpreterSettings();
    boolean debugExecutor = executor.getId().equals(DefaultDebugExecutor.EXECUTOR_ID);
    junitParams.setDebug(debugExecutor);
    MPSProject mpsProject = ProjectHelper.fromIdeaProject(project);
    AutoResetTestExecutionWorkspaceSetting setting = new AutoResetTestExecutionWorkspaceSetting(ExecutionModePreference.INTERPRETER);
    List<ITestNodeWrapper> testNodes = junitParams.getTests(mpsProject);
    setting.done();
    if (testNodes == null || ListSequence.fromList(testNodes).isEmpty()) {
      throw new ExecutionException("Could not find tests to run. Please check the run configuration for errors.");
    }
    if (mpsProject == null) {
      throw new ExecutionException("Could not get MPSProject to run.");
    }
    // exclude node of concepts not evaluable by interpreter
    WrapperFilter.filterByConcecpt(mpsProject.getRepository(), testNodes, CONCEPTS.ITestItemContainer$ow);

    JUnitProcessStarter processExecutor;
    processExecutor = new JUnitInterpreterProcessRunStarter(mpsProject, myRunConfiguration, testNodes);
    ProcessHandler processHandler = processExecutor.execute();

    TestRunState runState = new TestRunState(testNodes);
    final UnitTestViewComponent testViewComponent = myRunConfiguration.createTestViewComponent(runState, processHandler, executor, myRunConfiguration);
    ProcessListener listener = new UnitTestProcessListener(runState);

    _FunctionTypes._void_P0_E0 disposeHandler = () -> testViewComponent.dispose();
    {
      ProcessHandler _processHandler = processHandler;
      _processHandler.addProcessListener(listener);
      return new DefaultExecutionResult(_processHandler, new DefaultExecutionConsole(testViewComponent, disposeHandler));
    }
  }

  @NotNull
  public IDebuggerConfiguration getDebuggerConfiguration() {
    return new IDebuggerConfiguration() {
      @Nullable
      public IDebuggerSettings createDebuggerSettings() {
        return new LocalConnectionSettings(true);
      }
      public IDebugger getDebugger() {
        return Debuggers.getInstance().getDebuggerByName("Java");
      }
    };
  }

  public static boolean canExecute(String executorId) {
    if (DefaultRunExecutor.EXECUTOR_ID.equals(executorId)) {
      return true;
    }
    if (DefaultDebugExecutor.EXECUTOR_ID.equals(executorId)) {
      return true;
    }
    return false;
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept ITestItemContainer$ow = MetaAdapterFactory.getInterfaceConcept(0xd441fba0f46b43cdL, 0xb723dad7b65da615L, 0x527c70c5bae4dd04L, "org.iets3.core.expr.tests.structure.ITestItemContainer");
  }
}
