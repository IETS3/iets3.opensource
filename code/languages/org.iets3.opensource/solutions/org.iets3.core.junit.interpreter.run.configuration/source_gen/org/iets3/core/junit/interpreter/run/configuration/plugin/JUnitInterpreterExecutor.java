package org.iets3.core.junit.interpreter.run.configuration.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.smodel.ModelAccessHelper;
import java.util.List;
import jetbrains.mps.baseLanguage.unitTest.execution.client.ITestNodeWrapper;
import jetbrains.mps.baselanguage.unitTest.execution.launcher.CommandOutputStream;
import java.util.Set;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import xml4JUnit.ICustomRunnerConfig;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.baseLanguage.logging.rt.LogContext;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.junit.runner.Description;
import org.iets3.core.expr.tests.behavior.EvalResult;
import org.iets3.core.expr.tests.behavior.AbstractTestItem__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;

public class JUnitInterpreterExecutor {

  private final SRepository repo;
  private ModelAccessHelper helper;
  private List<ITestNodeWrapper> wrappers;
  private Throwable myException;
  private int myFailureCount = 0;
  private CommandOutputStream myOutStream;
  private CommandOutputStream myErrStream;
  private Set<SAbstractConcept> setOfConcepts;
  private ICustomRunnerConfig config;

  public JUnitInterpreterExecutor(SRepository repo, List<ITestNodeWrapper> wrappers, ICustomRunnerConfig config) {
    this.repo = repo;
    helper = new ModelAccessHelper(repo);
    this.wrappers = wrappers;
    setOfConcepts = SetSequence.fromSet(new HashSet<SAbstractConcept>());
    this.config = config;
  }

  public void init() {
    myOutStream = new CommandOutputStream(System.out);
    myErrStream = new CommandOutputStream(System.err);
    config.getListener().Init(myOutStream);
  }

  public void execute() {
    SetSequence.fromSet(setOfConcepts).clear();
    myFailureCount = 0;
    if (wrappers == null || ListSequence.fromList(wrappers).isEmpty()) {
      return;
    }
    for (ITestNodeWrapper wrapper : wrappers) {
      if (config.isTerminationRequested()) {
        break;
      }
      doExecute(wrapper);
    }
    SetSequence.fromSet(setOfConcepts).visitAll((it) -> LogContext.with(JUnitInterpreterExecutor.class, null, null, null).warning("concept not supported: " + it));
    config.getListener().testRunFinished(null);
    config.getReporter().runFinished();
  }


  private void doExecute(ITestNodeWrapper wrapper) {
    if (wrapper == null || wrapper.getNodePointer() == null) {
      return;
    }
    if (config.isTerminationRequested()) {
      return;
    }
    SNode node = getNode(wrapper.getNodePointer());
    try {
      if (SNodeOperations.isInstanceOf(node, CONCEPTS.ITestItemContainer$ow)) {
        handleNonEmptyItems(wrapper, node);
      } else {
        if (SNodeOperations.isInstanceOf(node, CONCEPTS.AbstractTestItem$9u)) {
          handleTestItem(wrapper, SNodeOperations.as(node, CONCEPTS.AbstractTestItem$9u));
        } else {
          SetSequence.fromSet(setOfConcepts).addElement(SNodeOperations.getConcept(node));
        }
      }
    } catch (Exception e) {
      myException = e;
    }

    if (wrapper.isTestCase()) {
      doExecute(wrapper.getTestCase());
    }
  }

  public int getFailureCount() {
    return myFailureCount;
  }

  public Throwable getExecutionError() {
    return myException;
  }

  private SNode getNode(final SNodeReference nodeReference) {
    final Wrappers._T<SNode> resultNode = new Wrappers._T<SNode>();
    helper.runReadAction(() -> resultNode.value = nodeReference.resolve(repo));
    return resultNode.value;
  }

  private void handleNonEmptyItems(ITestNodeWrapper wrapper, SNode node) {
    config.getReporter().testSuiteStarted(wrapper.getFqName(), node);
    Iterable<ITestNodeWrapper> testMethods = wrapper.getTestMethods();
    for (ITestNodeWrapper rm : Sequence.fromIterable(testMethods)) {
      doExecute(rm);
    }
    config.getReporter().testSuiteFinished(wrapper.getFqName(), node);
  }

  private void handleTestItem(final ITestNodeWrapper wrapper, final SNode item) {
    repo.getModelAccess().runWriteAction(() -> {
      int index = wrapper.getFqName().lastIndexOf(".");
      String caseName = wrapper.getFqName().substring(0, index);
      String methodName = wrapper.getFqName().substring(index + 1);
      Description testDescription = Description.createTestDescription(caseName, methodName);
      config.getListener().testStarted(testDescription);
      config.getReporter().testCaseStarted(wrapper.getFqName(), item);
      EvalResult testResult = AbstractTestItem__BehaviorDescriptor.executeTest_id4KZjPKUdEYm.invoke(item);
      Thread.currentThread().yield();
      if (!(testResult.isOk())) {
        if (testResult.getException() != null) {
          config.getReporter().testCaseFailed(wrapper.getFqName(), item, testResult.getException().getMessage().toString(), "");
        }
        config.getReporter().testCaseFailed(wrapper.getFqName(), item, testResult.getErrorMessage().toString(), "");
        config.getListener().testFailureForEvalResult(testDescription, testResult);
        myFailureCount++;
      }
      config.getReporter().testCaseFinished(wrapper.getFqName(), item);
      config.getListener().testFinished(testDescription);
    });
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept ITestItemContainer$ow = MetaAdapterFactory.getInterfaceConcept(0xd441fba0f46b43cdL, 0xb723dad7b65da615L, 0x527c70c5bae4dd04L, "org.iets3.core.expr.tests.structure.ITestItemContainer");
    /*package*/ static final SConcept AbstractTestItem$9u = MetaAdapterFactory.getConcept(0xd441fba0f46b43cdL, 0xb723dad7b65da615L, 0x7211e50064e6dba0L, "org.iets3.core.expr.tests.structure.AbstractTestItem");
  }
}
