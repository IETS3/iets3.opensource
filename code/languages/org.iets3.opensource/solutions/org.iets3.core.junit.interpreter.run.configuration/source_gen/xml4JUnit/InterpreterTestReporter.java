package xml4JUnit;

/*Generated by MPS */

import java.text.SimpleDateFormat;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.Date;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.apache.commons.io.FilenameUtils;
import java.io.File;
import javax.xml.bind.JAXBContext;
import javax.xml.bind.Marshaller;
import javax.xml.bind.JAXBException;
import java.util.regex.Matcher;
import java.util.TimeZone;
import java.net.InetAddress;
import java.net.UnknownHostException;
import java.util.regex.Pattern;

/**
 * The attributes which are required and or implied can be found here
 * https://ant.apache.org/manual/api/org/apache/tools/ant/taskdefs/optional/junit/XMLConstants.html
 */
public class InterpreterTestReporter implements IInterpreterTestReporter {
  private static final String ISO8601_DATETIME_PATTERN = "YYYY-MM-DD'T'hh:mm:ss";
  private SimpleDateFormat simpleDateFormat;


  private Testsuites root;
  private MySuite currentSuite;
  private MyCase currentCase;

  public InterpreterTestReporter() {
    root = new Testsuites();
  }
  @Override
  public void runFinished() {
  }
  @Override
  public void testSuiteStarted(String testSuiteFQName, SNode node) {
    currentSuite = new MySuite();
    currentSuite.setName(testSuiteFQName);
    currentSuite.setPackage(SModelOperations.getModelName(SNodeOperations.getModel(node)));
    currentSuite.setSkipped("0");
    currentSuite.setHostname(hostname());
    currentSuite.setId("0");
    currentSuite.setTimestamp(timeStamp(new Date(System.currentTimeMillis())));
    currentSuite.setSystemErr("");
    currentSuite.setSystemOut("");
    root.getTestsuite().add(currentSuite);
  }
  @Override
  public void testSuiteFinished(String testSuiteFQName, SNode node) {
    currentSuite.stop();
    currentSuite.setTests(String.valueOf(currentSuite.getTestcase().size()));
    currentSuite.setErrors(String.valueOf(currentSuite.errorCounter));
    currentSuite.setFailures(String.valueOf(currentSuite.failureCounter));
  }
  @Override
  public void testCaseStarted(String testCaseFQname, SNode node) {
    currentCase = new MyCase(currentSuite);
    currentCase.setName(shortName(testCaseFQname));
    currentCase.setClassname(prefix(testCaseFQname));
    currentCase.setTime("0");
    currentSuite.getTestcase().add(currentCase);
  }
  @Override
  public void testCaseFinished(String testCaseFQname, SNode node) {
    currentCase.stop();
  }
  @Override
  public void testCaseFailed(String testCaseFQname, SNode node, String msg, String longMsg) {
    Failure failure = new Failure();
    failure.setMessage(msg);
    currentCase.getFailure().add(failure);
    currentCase.incFailure();
  }
  @Override
  public void testOutputLine(String testCaseFQname, SNode node, String msg) {
  }
  @Override
  public void testErrorLine(String testCaseFQname, SNode node, String msg) {
  }
  @Override
  public void outputLine(String msg) {
  }
  @Override
  public void errorLine(String msg) {
  }
  @Override
  public void writeToFiles(String path, String filenamePrefix) {
    for (Testsuite suite : ListSequence.fromList(root.getTestsuite())) {
      try {
        String baseName = FilenameUtils.getBaseName(filenamePrefix);
        String filename = path + File.separator + suite.getPackage() + File.separator + baseName + "_" + suite.getName().replaceAll("\\W+", "") + ".xml";
        System.out.println("Writing XML-Test report for '" + suite.getName() + "' to '" + filename + "'");
        File file = new File(filename);
        file.getParentFile().mkdirs();
        JAXBContext context = JAXBContext.newInstance(Testsuites.class);
        Marshaller marshaller = context.createMarshaller();
        marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, true);
        marshaller.marshal(suite, file);
        System.out.println("\tdone.");
      } catch (JAXBException e) {
        System.err.println(e.getMessage());
      }
    }
  }
  private String shortName(String testFQname) {
    Matcher matcher = REGEXP.matcher(testFQname);
    return (matcher.matches() ? matcher.group(1) : testFQname);
  }
  private String prefix(String testFQname) {
    Matcher matcher = REGEXP1.matcher(testFQname);
    return (matcher.matches() ? matcher.group(1) : testFQname);
  }

  private String timeStamp(Date date) {
    if (simpleDateFormat == null) {
      simpleDateFormat = new SimpleDateFormat(InterpreterTestReporter.ISO8601_DATETIME_PATTERN);
      simpleDateFormat.setTimeZone(TimeZone.getTimeZone("GMT"));
      simpleDateFormat.setLenient(true);
    }
    return simpleDateFormat.format(date);
  }

  private String hostname() {
    String result = "irrelevant";
    try {
      result = InetAddress.getLocalHost().getHostName();
    } catch (UnknownHostException ignore) {
    }
    return result;
  }

  public class MySuite extends Testsuite {
    /*package*/ long errorCounter;
    /*package*/ long failureCounter;
    /*package*/ long starttime;
    /*package*/ long endtime;
    public MySuite() {
      errorCounter = 0;
      failureCounter = 0;
      starttime = System.currentTimeMillis();
    }
    public void incFailure() {
      failureCounter++;
    }
    public void stop() {
      endtime = System.currentTimeMillis();
      setTime(String.valueOf((endtime - starttime) / 1000));
    }
  }

  public class MyCase extends Testcase {
    /*package*/ MySuite parent;
    /*package*/ long elapsedTime;
    /*package*/ long starttime;
    /*package*/ long endtime;

    public MyCase(MySuite parent) {
      this.parent = parent;
      starttime = System.currentTimeMillis();
    }
    public void incFailure() {
      parent.incFailure();
    }
    public void stop() {
      endtime = System.currentTimeMillis();
      setTime(String.valueOf((endtime - starttime) / 1000));
    }
  }

  private static final Pattern REGEXP = Pattern.compile(".+\\.([^\\.]+)$", 0);
  private static final Pattern REGEXP1 = Pattern.compile("(.*)\\.[^\\.]+$", 0);
}
