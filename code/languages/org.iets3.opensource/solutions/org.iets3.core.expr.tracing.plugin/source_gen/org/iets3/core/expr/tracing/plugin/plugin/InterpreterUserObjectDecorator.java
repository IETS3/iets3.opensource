package org.iets3.core.expr.tracing.plugin.plugin;

/*Generated by MPS */

import com.mbeddr.mpsutil.traceExplorer.plugin.ITraceDecorator;
import com.mbeddr.mpsutil.interpreter.rt.ComputationTrace;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.module.SRepository;
import com.intellij.openapi.fileEditor.FileEditorManager;
import com.mbeddr.mpsutil.traceExplorer.plugin.INodeMapper;
import org.jetbrains.mps.openapi.model.SNode;
import org.iets3.core.expr.plugin.plugin.EditorUpdater;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.iets3.core.expr.tracing.util.TracingValue;
import com.mbeddr.mpsutil.interpreter.behavior.ITrivialNode__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

/**
 * Attaches trace information from a trace record to MPS nodes as user objects.
 */
public class InterpreterUserObjectDecorator implements ITraceDecorator<ComputationTrace> {

  @NotNull
  private final SRepository repository;
  @NotNull
  private final FileEditorManager fileEditorManager;
  private INodeMapper mapper = null;

  public InterpreterUserObjectDecorator(@NotNull final SRepository repository, @NotNull final FileEditorManager fileEditorManager) {
    this.repository = repository;
    this.fileEditorManager = fileEditorManager;
  }

  public void setNodeMapper(INodeMapper nodeMapper) {
    this.mapper = nodeMapper;
  }

  public INodeMapper getNodeMapper() {
    return this.mapper;
  }

  private SNode getMappedNode(SNode node) {
    if (mapper != null) {
      return mapper.getMappedNodeOrGivenNode(node);
    } else {
      return node;
    }
  }

  @Override
  public void decorate(@NotNull final ComputationTrace record) {
    this.repository.getModelAccess().executeCommand(() -> {
      decorateValues(record);
      SNode mappedNode = getMappedNode(record.getTargetNode());
      EditorUpdater.updateEditors(mappedNode.getReference(), repository, fileEditorManager);
    });
  }

  private void decorateValues(final ComputationTrace record) {
    SNode recordNode = record.getTargetNode();
    for (SNode n : ListSequence.fromList(SNodeOperations.getNodeDescendants(recordNode, null, true, new SAbstractConcept[]{}))) {
      ComputationTrace r = record.descendantForNode(n);
      if (r != null) {
        TracingValue v = null;
        if (r.hasConstraintFailure()) {
          v = new TracingValue("FAIL: " + r.getConstrainFailureMessage(), null);
        } else {
          if (SNodeOperations.isInstanceOf(n, CONCEPTS.ITrivialNode$6J) && (boolean) ITrivialNode__BehaviorDescriptor.isTrivial_id3T40JVg3mh$.invoke(SNodeOperations.cast(n, CONCEPTS.ITrivialNode$6J))) {
            continue;
          }
          Object tv = r.getTracedValue();
          if (tv != null) {
            v = new TracingValue(tv.toString(), tv);
          }
        }
        if (v != null) {
          SNode mappedNode = getMappedNode(n);
          TracingValue.set(mappedNode, v);
        }
      }
    }
  }

  @Override
  public void undecorate(@NotNull final ComputationTrace record) {
    repository.getModelAccess().runReadAction(() -> {
      undecorateValues(record);
      SNode mappedNode = getMappedNode(record.getTargetNode());
      EditorUpdater.updateEditors(mappedNode.getReference(), repository, fileEditorManager);
    });
  }

  private void undecorateValues(final ComputationTrace record) {
    SNode recordNode = record.getTargetNode();
    // TODO fill in the blanks
    for (SNode n : ListSequence.fromList(SNodeOperations.getNodeDescendants(recordNode, null, true, new SAbstractConcept[]{}))) {
      SNode mappedNode = getMappedNode(n);
      TracingValue.unset(mappedNode);
    }
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept ITrivialNode$6J = MetaAdapterFactory.getInterfaceConcept(0x47f075a6558e4640L, 0xa6067ce0236c8023L, 0x3e4402fed00d643fL, "com.mbeddr.mpsutil.interpreter.structure.ITrivialNode");
  }
}
