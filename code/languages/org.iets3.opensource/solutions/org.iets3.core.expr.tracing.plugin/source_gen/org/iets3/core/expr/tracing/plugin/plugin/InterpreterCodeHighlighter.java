package org.iets3.core.expr.tracing.plugin.plugin;

/*Generated by MPS */

import com.mbeddr.mpsutil.traceExplorer.plugin.IASTHighlighter;
import com.mbeddr.mpsutil.interpreter.rt.ComputationTrace;
import org.jetbrains.mps.openapi.module.SRepository;
import com.intellij.openapi.fileEditor.FileEditorManager;
import org.jetbrains.annotations.NotNull;
import java.util.Set;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.iets3.core.expr.plugin.plugin.EditorUpdater;

/**
 * Attaches trace information from a trace record to MPS nodes as user objects.
 */
public class InterpreterCodeHighlighter implements IASTHighlighter<ComputationTrace> {

  public static final String COLORIZE_CODE = "colorize-code";

  private final SRepository repository;
  private final FileEditorManager fileEditorManager;

  public InterpreterCodeHighlighter(final SRepository repository, final FileEditorManager fileEditorManager) {
    this.repository = repository;
    this.fileEditorManager = fileEditorManager;
  }


  @Override
  public void highlight(@NotNull ComputationTrace record, Set<SNode> rootCollector) {
    if (record.isInAnEditor()) {
      SNode n = record.getTargetNode();
      SetSequence.fromSet(rootCollector).addElement(SNodeOperations.getContainingRoot(n));
      n.putUserObject(COLORIZE_CODE, COLORIZE_CODE);
    }
  }

  @Override
  public void unhighlight(@NotNull ComputationTrace record, Set<SNode> rootCollector) {
    if (record.isInAnEditor()) {
      SNode n = record.getTargetNode();
      SetSequence.fromSet(rootCollector).addElement(SNodeOperations.getContainingRoot(n));
      n.putUserObject(COLORIZE_CODE, null);
    }
  }


  @Override
  public void updateEditors(Set<SNode> collectedRoots) {
    for (SNode r : SetSequence.fromSet(collectedRoots)) {
      EditorUpdater.updateEditors(r.getReference(), repository, fileEditorManager);
    }
  }

}
