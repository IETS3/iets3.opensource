package org.iets3.core.expr.tracing.plugin.plugin;

/*Generated by MPS */

import com.mbeddr.mpsutil.traceExplorer.plugin.ITraceRecordRenderer;
import com.mbeddr.mpsutil.interpreter.rt.ComputationTrace;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.module.SRepository;
import com.intellij.ui.SimpleTextAttributes;
import java.awt.Color;
import org.jetbrains.annotations.NotNull;
import com.intellij.ui.ColoredTextContainer;
import com.intellij.ui.JBColor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.intellij.util.ui.UIUtil;
import org.iets3.core.expr.base.plugin.EffectHelper;
import com.mbeddr.mpsutil.interpreter.behavior.ITracerFrame__BehaviorDescriptor;
import org.iets3.core.expr.tracing.util.TracingConstants;
import javax.swing.Icon;
import jetbrains.mps.ide.icons.GlobalIconManager;
import com.intellij.icons.AllIcons;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class InterpreterRecordRenderer implements ITraceRecordRenderer<ComputationTrace> {
  private static final int MAX_SYNTAX_LEN = 25;
  private static final int MAX_VAL_LEN = 50;

  private SNode traceIconNode = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x63c1aad1e2db439cL, 0xa30a02b5e0bc80f3L, 0x59ce29f88158d153L, "org.iets3.core.expr.tracing.structure.TracerIconConcept"));
  private SNode ghostIconNode = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x63c1aad1e2db439cL, 0xa30a02b5e0bc80f3L, 0x5344eca2dfe9b5f6L, "org.iets3.core.expr.tracing.structure.GhostIconConcept"));

  private final SRepository repository;

  public InterpreterRecordRenderer(SRepository repository) {
    this.repository = repository;
  }

  private SimpleTextAttributes ta(Color bg, Color tc, int style) {
    return new SimpleTextAttributes(bg, tc, bg, style);
  }

  @Override
  public void render(@NotNull final ComputationTrace record, @NotNull final ColoredTextContainer output) {
    final SNode targetNode = record.getTargetNode();
    repository.getModelAccess().runReadAction(() -> {
      Color bgColor = JBColor.background();
      if (SNodeOperations.isInstanceOf(targetNode, CONCEPTS.ITracerFrame$iZ)) {
        bgColor = JBColor.LIGHT_GRAY;
      }

      SimpleTextAttributes effectStyle = ta(bgColor, new JBColor(new Color(196, 107, 0), new Color(196, 107, 0)), SimpleTextAttributes.STYLE_BOLD);
      SimpleTextAttributes revealStyle = ta(bgColor, JBColor.RED, SimpleTextAttributes.STYLE_BOLD);
      SimpleTextAttributes regularBoldStyle = ta(bgColor, JBColor.foreground(), SimpleTextAttributes.STYLE_BOLD);
      SimpleTextAttributes regularStyle = ta(bgColor, JBColor.foreground(), SimpleTextAttributes.STYLE_PLAIN);
      SimpleTextAttributes errorStyle = ta(bgColor, JBColor.RED, SimpleTextAttributes.STYLE_BOLD);
      SimpleTextAttributes cachedStyle = ta(bgColor, new JBColor(Color.decode("#228A00"), new Color(45, 179, 0)), SimpleTextAttributes.STYLE_BOLD);
      SimpleTextAttributes inactiveStyle = ta(bgColor, UIUtil.getInactiveTextColor(), SimpleTextAttributes.STYLE_PLAIN | SimpleTextAttributes.STYLE_SMALLER);


      if (record.mustBeRevealed()) {
        output.append("[R] ", revealStyle);
      }
      if (record.isCachedValue()) {
        output.append("[C] ", cachedStyle);
      }
      if (SNodeOperations.isInstanceOf(targetNode, CONCEPTS.Expression$D_) && new EffectHelper(targetNode).readsOrModifiesMutableState()) {
        output.append("[E] ", effectStyle);
      }
      if (record.hasCustomLabel()) {
        if (record.isInfoNode()) {
          output.append(record.getCustomLabel() + ": ", regularStyle);
        } else {
          output.append(record.getCustomLabel() + ": ", regularBoldStyle);
        }
      } else {
        if (record.getKind() != null) {
          String kind = record.getKind();
          if (kind.matches("[a-z ]+") && SNodeOperations.isInstanceOf(targetNode, CONCEPTS.INamedConcept$Kd)) {
            output.append(kind + " ", regularBoldStyle);
          }
        }
      }

      SimpleTextAttributes syntaxStyle;
      SimpleTextAttributes valueStyleBold;
      SimpleTextAttributes valueStyleRegular;
      if (record.isInAnEditor()) {
        if (record.isInfoNode()) {
          syntaxStyle = ta(bgColor, JBColor.foreground(), SimpleTextAttributes.STYLE_PLAIN);
        } else if (SNodeOperations.isInstanceOf(targetNode, CONCEPTS.ITracerFrame$iZ) && (boolean) ITracerFrame__BehaviorDescriptor.isMajor_id5U8d23PSzWx.invoke(SNodeOperations.cast(targetNode, CONCEPTS.ITracerFrame$iZ))) {
          syntaxStyle = ta(bgColor, JBColor.foreground(), SimpleTextAttributes.STYLE_PLAIN | SimpleTextAttributes.STYLE_UNDERLINE);
        } else {
          syntaxStyle = ta(bgColor, JBColor.foreground(), SimpleTextAttributes.STYLE_PLAIN);
        }
        valueStyleBold = ta(bgColor, TracingConstants.DEBUGGER_COLOR, SimpleTextAttributes.STYLE_BOLD);
        valueStyleRegular = ta(bgColor, TracingConstants.DEBUGGER_COLOR, SimpleTextAttributes.STYLE_PLAIN);
      } else {
        if (SNodeOperations.isInstanceOf(targetNode, CONCEPTS.ITracerFrame$iZ) && (boolean) ITracerFrame__BehaviorDescriptor.isMajor_id5U8d23PSzWx.invoke(SNodeOperations.cast(targetNode, CONCEPTS.ITracerFrame$iZ))) {
          syntaxStyle = ta(bgColor, JBColor.GRAY, SimpleTextAttributes.STYLE_PLAIN | SimpleTextAttributes.STYLE_UNDERLINE);
        } else {
          syntaxStyle = ta(bgColor, JBColor.GRAY, SimpleTextAttributes.STYLE_PLAIN);
        }
        valueStyleBold = ta(bgColor, TracingConstants.DEBUGGER_COLOR_LIGHT, SimpleTextAttributes.STYLE_PLAIN);
        valueStyleRegular = ta(bgColor, TracingConstants.DEBUGGER_COLOR_LIGHT, SimpleTextAttributes.STYLE_PLAIN);
      }
      String syntax = (record.isInfoNode() ? "" : record.getSyntax());
      if (syntax.length() > MAX_SYNTAX_LEN) {
        syntax = syntax.substring(0, MAX_SYNTAX_LEN) + "...";
      }
      output.append(syntax, syntaxStyle);

      Object value = record.getTracedValue();
      if (record.hasConstraintFailure()) {
        output.append("  \u21EA  ", errorStyle);
        output.append(record.getConstrainFailureMessage(), errorStyle);
      } else {
        if (value != null) {
          output.append("  \u21D2  ", valueStyleBold);
          String valString = value.toString();
          if (valString.length() > MAX_VAL_LEN) {
            valString = valString.substring(0, MAX_VAL_LEN) + " ...";
          }
          output.append(valString, valueStyleBold);
          String nn = value.getClass().getCanonicalName();
          if (nn != null && nn.contains(".")) {
            nn = nn.substring(nn.lastIndexOf('.') + 1);
          }
          output.append(" : " + nn, valueStyleRegular);
          String ts = record.getTimeAsString();
          if (ts != null) {
            output.append("   (" + ts + " ms)", inactiveStyle);
          }
        }
      }

      Icon icon = null;
      GlobalIconManager iconMng = GlobalIconManager.getInstance();
      if (record.isInfoNode()) {
        icon = AllIcons.General.Information;
      } else if (record.getIconNode() != null) {
        icon = iconMng.getIconFor(record.getIconNode());
      } else {
        SNode acd = SNodeOperations.asNode(SNodeOperations.getConcept(targetNode));
        if (SNodeOperations.isInstanceOf(acd, CONCEPTS.ConceptDeclaration$gH)) {
          if (!(record.isInAnEditor())) {
            icon = iconMng.getIconFor(ghostIconNode);
          } else {
            SNode conIcon = SLinkOperations.getTarget(SNodeOperations.cast(acd, CONCEPTS.ConceptDeclaration$gH), LINKS.icon$HKhR);
            if (conIcon != null) {
              icon = iconMng.getIconFor(targetNode);
            } else {
              icon = iconMng.getIconFor(traceIconNode);
            }
          }
        }
      }
      output.setIcon(icon);
      output.setToolTipText(record.getConceptName());
      output.append(" [" + record.getConceptName() + "]", inactiveStyle);
    });
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept ITracerFrame$iZ = MetaAdapterFactory.getInterfaceConcept(0x47f075a6558e4640L, 0xa6067ce0236c8023L, 0x760b48e4e8391c1fL, "com.mbeddr.mpsutil.interpreter.structure.ITracerFrame");
    /*package*/ static final SConcept Expression$D_ = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a047L, "org.iets3.core.expr.base.structure.Expression");
    /*package*/ static final SInterfaceConcept INamedConcept$Kd = MetaAdapterFactory.getInterfaceConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, "jetbrains.mps.lang.core.structure.INamedConcept");
    /*package*/ static final SConcept ConceptDeclaration$gH = MetaAdapterFactory.getConcept(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0xf979ba0450L, "jetbrains.mps.lang.structure.structure.ConceptDeclaration");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink icon$HKhR = MetaAdapterFactory.getContainmentLink(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0xf979ba0450L, 0x57cf4eb14c4f9ef5L, "icon");
  }
}
