package org.iets3.core.expr.tracing.plugin.plugin;

/*Generated by MPS */

import org.iets3.core.expr.plugin.plugin.AbstractTraceExplorerAction;
import org.iets3.core.expr.plugin.plugin.ITraceExplorerAction;
import org.jetbrains.mps.openapi.model.SNode;
import com.intellij.openapi.actionSystem.AnActionEvent;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.iets3.core.expr.base.behavior.ITraceRoot__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.iets3.core.expr.base.behavior.IMultiTraceRoot__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import com.mbeddr.mpsutil.traceExplorer.plugin.ITraceRecord;
import com.mbeddr.mpsutil.interpreter.rt.ComputationTrace;
import com.mbeddr.mpsutil.interpreter.behavior.ITracerFrame__BehaviorDescriptor;
import org.iets3.core.plugin.plugin.CommandWithMessage;
import jetbrains.mps.lang.core.behavior.BaseConcept__BehaviorDescriptor;
import jetbrains.mps.ide.icons.GlobalIconManager;
import java.util.List;
import com.intellij.openapi.ui.popup.util.BaseListPopupStep;
import com.intellij.openapi.ui.popup.PopupStep;
import com.intellij.openapi.ui.popup.ListPopup;
import com.intellij.openapi.ui.popup.JBPopupFactory;
import javax.swing.Icon;
import com.intellij.openapi.application.ApplicationManager;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import com.intellij.openapi.ui.Messages;
import javax.swing.JComponent;
import jetbrains.mps.plugins.projectplugins.ProjectPluginManager;
import com.mbeddr.mpsutil.traceExplorer.plugin.TraceExplorer_Tool;
import jetbrains.mps.ide.tools.BaseTabbedProjectTool;
import org.iets3.core.expr.plugin.plugin.Disposables;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class DefaultTraceExplorerActionHandler extends AbstractTraceExplorerAction implements ITraceExplorerAction {

  protected SNode node;
  protected ITraceTabOptionFactory traceTabOptionFactory = new DefaultTraceTabOptionsFactory();


  @Override
  public int getPriority() {
    return 0;
  }

  @Override
  public void setNode(SNode node) {
    this.node = node;
  }

  @Override
  public boolean isApplicable(AnActionEvent event) {
    if (SNodeOperations.isInstanceOf(node, CONCEPTS.ITraceRoot$Kp) && (boolean) ITraceRoot__BehaviorDescriptor.canActAsTraceRoot_id7obiejCh8RB.invoke(SNodeOperations.cast(node, CONCEPTS.ITraceRoot$Kp))) {
      return true;
    }
    if (SNodeOperations.isInstanceOf(node, CONCEPTS.IMultiTraceRoot$nd) && ListSequence.fromList(IMultiTraceRoot__BehaviorDescriptor.getTraceCategories_idXblfskIwx1.invoke(SNodeOperations.cast(node, CONCEPTS.IMultiTraceRoot$nd))).isNotEmpty()) {
      return true;
    }

    return ListSequence.fromList(SNodeOperations.getNodeAncestors(node, null, false)).any((it) -> SNodeOperations.isInstanceOf(it, CONCEPTS.ITraceRoot$Kp) && (boolean) ITraceRoot__BehaviorDescriptor.canActAsTraceRoot_id7obiejCh8RB.invoke(SNodeOperations.cast(it, CONCEPTS.ITraceRoot$Kp)) || SNodeOperations.isInstanceOf(it, CONCEPTS.IMultiTraceRoot$nd) && ListSequence.fromList(IMultiTraceRoot__BehaviorDescriptor.getTraceCategories_idXblfskIwx1.invoke(SNodeOperations.cast(it, CONCEPTS.IMultiTraceRoot$nd))).isNotEmpty());
  }


  @Override
  public void execute(AnActionEvent event) {
    if (SNodeOperations.isInstanceOf(node, CONCEPTS.ITraceRoot$Kp)) {
      buildTraceAndRun(SNodeOperations.cast(node, CONCEPTS.ITraceRoot$Kp));
    } else if (Sequence.fromIterable(SNodeOperations.ofConcept(SNodeOperations.getNodeAncestors(node, null, false), CONCEPTS.ITraceRoot$Kp)).isNotEmpty()) {
      buildTraceAndRun(Sequence.fromIterable(SNodeOperations.ofConcept(SNodeOperations.getNodeAncestors(node, null, false), CONCEPTS.ITraceRoot$Kp)).first());
    } else if (SNodeOperations.isInstanceOf(node, CONCEPTS.IMultiTraceRoot$nd)) {
      handleMulti(SNodeOperations.cast(node, CONCEPTS.IMultiTraceRoot$nd));
    } else if (Sequence.fromIterable(SNodeOperations.ofConcept(SNodeOperations.getNodeAncestors(node, null, false), CONCEPTS.IMultiTraceRoot$nd)).isNotEmpty()) {
      handleMulti(Sequence.fromIterable(SNodeOperations.ofConcept(SNodeOperations.getNodeAncestors(node, null, false), CONCEPTS.IMultiTraceRoot$nd)).first());
    }
  }

  /*package*/ ITraceRecord getRoot(ITraceRecord rec) {
    if (rec instanceof ComputationTrace) {
      ComputationTrace ct = ((ComputationTrace) rec);
      ct = ct.rootTrace();
      if (SNodeOperations.isInstanceOf(ct.getTargetNode(), CONCEPTS.ITracerFrame$iZ)) {
        return ITracerFrame__BehaviorDescriptor.constructCustomFrame_id2kg0xI3thT2.invoke(SNodeOperations.cast(ct.getTargetNode(), CONCEPTS.ITracerFrame$iZ), null, ct);
      } else {
        return ct;
      }
    }
    return rec;
  }

  /*package*/ void buildTraceAndRun(final SNode trn) {
    CommandWithMessage.execute("Preparing Trace of " + BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(trn), mpsProject.getRepository(), new Runnable() {
      public void run() {
        ITraceRecord rootTrace = ITraceRoot__BehaviorDescriptor.getRootTrace_id7obiejCh8Tv.invoke(trn);
        runTracer(ITraceRoot__BehaviorDescriptor.getTabTitle_id2CFPPn7rG02.invoke(trn), GlobalIconManager.getInstance().getIconFor(trn), getRoot(rootTrace));
      }
    });
  }


  /*package*/ void handleMulti(final SNode mtrn) {
    final List<String> cats = IMultiTraceRoot__BehaviorDescriptor.getTraceCategories_idXblfskIwx1.invoke(mtrn);
    if (ListSequence.fromList(cats).isEmpty()) {
      return;
    }
    if (ListSequence.fromList(cats).count() == 1) {
      mpsProject.getRepository().getModelAccess().runReadAction(() -> runTracer(IMultiTraceRoot__BehaviorDescriptor.getTabTitle_idXblfskIwxh.invoke(mtrn, ListSequence.fromList(cats).first()), GlobalIconManager.getInstance().getIconFor(mtrn), getRoot(IMultiTraceRoot__BehaviorDescriptor.getRootTrace_idXblfskIwxp.invoke(mtrn, ListSequence.fromList(cats).first()))));
    } else {
      BaseListPopupStep step = new BaseListPopupStep("Choose Trace", cats) {
        @Override
        public PopupStep onChosen(Object selectedValue, boolean finalChoice) {
          final String cat = (String) selectedValue;
          mpsProject.getRepository().getModelAccess().runReadAction(() -> runTracer(IMultiTraceRoot__BehaviorDescriptor.getTabTitle_idXblfskIwxh.invoke(mtrn, cat), GlobalIconManager.getInstance().getIconFor(mtrn), getRoot(IMultiTraceRoot__BehaviorDescriptor.getRootTrace_idXblfskIwxp.invoke(mtrn, cat))));
          return super.onChosen(selectedValue, finalChoice);
        }
      };
      ListPopup pp = JBPopupFactory.getInstance().createListPopup(step);
      pp.showInFocusCenter();
    }
  }


  /*package*/ void runTracer(String title, Icon icon, ITraceRecord root) {
    if (root == null) {
      ApplicationManager.getApplication().invokeLater(() -> {
        final Wrappers._T<String> presentation = new Wrappers._T<String>();
        mpsProject.getRepository().getModelAccess().runReadAction(() -> presentation.value = BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(node));
        Messages.showErrorDialog("The trace was null for node \n" + presentation.value, "Tracing");
      });
      return;
    }

    final JComponent tab = ProjectPluginManager.getInstance(ideaProject).getTool(TraceExplorer_Tool.class).openTrace(traceTabOptionFactory.createTraceTabOption(ideaProject, mpsProject, title, icon, root));
    // The cast below is actually valid in the generated code so the error is suppressed.
    final BaseTabbedProjectTool tool = (BaseTabbedProjectTool) (ProjectPluginManager.getInstance(ideaProject).getTool(TraceExplorer_Tool.class));

    // Close the tab in case the plugin gets reloaded while it's open.
    Disposables.add(tab, () -> tool.closeTab(tab));
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept ITraceRoot$Kp = MetaAdapterFactory.getInterfaceConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x760b48e4e8448dc2L, "org.iets3.core.expr.base.structure.ITraceRoot");
    /*package*/ static final SInterfaceConcept IMultiTraceRoot$nd = MetaAdapterFactory.getInterfaceConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0xf4b54f714ba06c9L, "org.iets3.core.expr.base.structure.IMultiTraceRoot");
    /*package*/ static final SInterfaceConcept ITracerFrame$iZ = MetaAdapterFactory.getInterfaceConcept(0x47f075a6558e4640L, 0xa6067ce0236c8023L, 0x760b48e4e8391c1fL, "com.mbeddr.mpsutil.interpreter.structure.ITracerFrame");
  }
}
