package org.iets3.core.expr.tracing.plugin.plugin;

/*Generated by MPS */

import com.mbeddr.mpsutil.traceExplorer.plugin.CustomValueRenderer;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.nodeEditor.UIEditorComponent;
import javax.swing.JComponent;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import java.util.Collection;
import org.iets3.core.expr.toplevel.plugin.RecordValue;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.smodel.tempmodel.TemporaryModels;
import com.intellij.ui.SimpleColoredComponent;
import jetbrains.mps.ide.icons.GlobalIconManager;
import com.intellij.ui.SimpleTextAttributes;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import jetbrains.mps.openapi.navigation.EditorNavigator;
import jetbrains.mps.smodel.tempmodel.TempModuleOptions;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.annotations.Nullable;
import org.jetbrains.annotations.NonNls;
import com.intellij.ui.treeStructure.Tree;
import com.intellij.ui.JBColor;
import javax.swing.tree.TreeCellRenderer;
import java.awt.Component;
import javax.swing.JTree;
import javax.swing.tree.DefaultMutableTreeNode;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import javax.swing.JPanel;
import java.awt.GridLayout;
import java.awt.BorderLayout;
import javax.swing.JLabel;
import com.mbeddr.mpsutil.traceExplorer.plugin.CVR;
import java.awt.LayoutManager;
import com.intellij.util.ui.UIUtil;
import javax.swing.BoxLayout;
import javax.swing.JSeparator;
import javax.swing.SwingConstants;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;

public class ExpressionsValueRenderer extends CustomValueRenderer {

  private SModel temporaryModel = null;
  private UIEditorComponent temporaryEditorComp = null;

  @Override
  public JComponent render(final Object value, final MPSProject project) {
    final Wrappers._T<String> vs = new Wrappers._T<String>(null);
    if (value == null) {
      return null;
    }
    project.getRepository().getModelAccess().runReadAction(() -> vs.value = value.toString());
    if (value instanceof Collection) {
      return renderCollection(value, project);
    }
    if (value instanceof Iterable) {
      return renderIterable(value, project);
    }
    if (value instanceof RecordValue) {
      return renderRecord(value, project);
    }
    if (value instanceof SNode) {
      final Wrappers._T<JComponent> res = new Wrappers._T<JComponent>(null);
      project.getRepository().getModelAccess().runReadAction(() -> {
        SModel mm = ((SNode) value).getModel();
        if (mm == null || TemporaryModels.isTemporary(mm)) {
          res.value = renderNodeEmbed(value, project);
        } else {
          res.value = renderNodeNew(value, vs.value, project);
        }
      });
      return res.value;
    }
    return null;
  }

  private JComponent renderNodeNew(final Object value, final String vs, final MPSProject project) {
    final SimpleColoredComponent cc = new SimpleColoredComponent();
    project.getRepository().getModelAccess().runReadAction(() -> {
      jetbrains.mps.smodel.SNode node = (jetbrains.mps.smodel.SNode) value;
      cc.setIcon(GlobalIconManager.getInstance().getIconFor(node));
      cc.append(vs, SimpleTextAttributes.REGULAR_ATTRIBUTES);
      cc.append(" [" + node.getConcept().getName() + "]", SimpleTextAttributes.GRAYED_ATTRIBUTES);
      cc.addMouseListener(new MouseAdapter() {
        @Override
        public void mouseClicked(MouseEvent event) {
          if (event.getClickCount() == 2) {
            new EditorNavigator(project).shallFocus(true).shallSelect(true).open(node.getReference());
          }
        }
      });
    });
    return cc;
  }

  private JComponent renderNodeEmbed(final Object value, final MPSProject project) {
    final Wrappers._T<SNode> copiedValue = new Wrappers._T<SNode>(null);
    if (temporaryEditorComp != null) {
      temporaryEditorComp.dispose();
    }
    try {
      project.getRepository().getModelAccess().runWriteAction(() -> {
        if (temporaryModel == null) {
          temporaryModel = TemporaryModels.getInstance().create(true, false, null, TempModuleOptions.forDefaultModule());
        }
        copiedValue.value = SNodeOperations.copyNode(((SNode) value));
        for (SNode n : Sequence.fromIterable(temporaryModel.getRootNodes())) {
          temporaryModel.removeRootNode(n);
        }
        temporaryModel.addRootNode(copiedValue.value);
      });
      project.getRepository().getModelAccess().runReadAction(() -> {
        temporaryEditorComp = new UIEditorComponent(project.getRepository(), null) {
          @Nullable
          @Override
          public Object getData(@NonNls String key) {
            return super.getData(key);
          }
        };
        temporaryEditorComp.editNode(copiedValue.value);
        temporaryEditorComp.invalidate();
        temporaryEditorComp.updateUI();
        temporaryEditorComp.update();
      });
    } catch (Throwable t) {
      t.printStackTrace();
    }
    return temporaryEditorComp;
  }

  private JComponent renderRecord(final Object value, final MPSProject project) {
    final Wrappers._T<Tree> tree = new Wrappers._T<Tree>();
    project.getRepository().getModelAccess().runReadAction(() -> {
      RecordValue rv = (RecordValue) value;

      tree.value = new Tree(createTreeNode(rv));
      tree.value.setBackground(JBColor.background());
      tree.value.setOpaque(false);
      tree.value.setCellRenderer(new TreeCellRenderer() {
        public Component getTreeCellRendererComponent(JTree p0, Object treeNode, boolean selected, boolean p3, boolean p4, int p5, boolean focused) {
          DefaultMutableTreeNode dmtn = (DefaultMutableTreeNode) treeNode;
          final Object val = dmtn.getUserObject();
          if (val instanceof RecordValue) {
            final Wrappers._T<String> recordTypeName = new Wrappers._T<String>();
            project.getRepository().getModelAccess().runReadAction(() -> recordTypeName.value = ((RecordValue) val).recordTypeName());
            return label(recordTypeName.value, selected, focused);
          }
          Tuples._2<String, Object> pair = (Tuples._2<String, Object>) val;
          JPanel p = panel(new GridLayout(0, 2));
          JPanel lp = panel(new BorderLayout());
          JLabel labelLabel = label(pair._0() + " = ", selected, focused);
          lp.add(labelLabel, BorderLayout.NORTH);
          p.add(lp);
          p.add(CVR.render(pair._1(), project));
          p.doLayout();
          lp.doLayout();
          return p;
        }
      });
      tree.value.setRowHeight(0);
      tree.value.setRowHeight(1);
      tree.value.setRowHeight(0);
    });
    return tree.value;
  }

  private JPanel panel(LayoutManager l) {
    JPanel pp = new JPanel();
    pp.setLayout(l);
    pp.setBackground(JBColor.PanelBackground);
    pp.setOpaque(false);
    return pp;
  }

  private JLabel label(String s, boolean selected, boolean focused) {
    JLabel ll = new JLabel(s);
    ll.setForeground(UIUtil.getTreeForeground(selected, focused));
    ll.setBackground(UIUtil.getTreeBackground(selected, focused));
    ll.setOpaque(false);
    return ll;
  }

  private JComponent renderCollection(final Object value, final MPSProject project) {
    final JPanel collPanel = new JPanel();
    collPanel.setBackground(JBColor.white);
    project.getRepository().getModelAccess().runReadAction(() -> {
      Collection coll = (Collection) value;
      collPanel.setLayout(new BoxLayout(collPanel, BoxLayout.Y_AXIS));
      for (Object o : coll) {
        collPanel.add(CVR.render(o, project));
        collPanel.add(new JSeparator(SwingConstants.HORIZONTAL));
      }
    });
    return collPanel;
  }

  private JComponent renderIterable(final Object value, final MPSProject project) {
    final List<Object> l = ListSequence.fromList(new ArrayList<Object>());
    project.getRepository().getModelAccess().runReadAction(() -> {
      Iterable i = ((Iterable) value);
      for (Object e : i) {
        ListSequence.fromList(l).addElement(e);
      }
    });
    return renderCollection(l, project);
  }


  private DefaultMutableTreeNode createTreeNode(Object data) {
    DefaultMutableTreeNode treeNode = new DefaultMutableTreeNode(data);
    if (data instanceof RecordValue) {
      RecordValue rv = ((RecordValue) data);
      for (String name : rv.memberNames()) {
        treeNode.add(createTreeNode(MultiTuple.<String,Object>from(name, rv.getValueByName(name))));
      }
    }
    return treeNode;
  }



}
