package org.iets3.core.expr.dataflow.interpreter.plugin;

/*Generated by MPS */

import com.mbeddr.mpsutil.interpreter.rt.IContext;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import java.util.List;
import java.util.ArrayList;
import org.iets3.core.expr.dataflow.behavior.Connector__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SConcept;

public class CompositeBlockEvaluator {

  public CompositeBlockEvaluator(IContext ctx, SNode blk) {
    this.block = blk;
    this.ctx = ctx;
  }

  public void eval() {
    for (SNode op : ListSequence.fromList(SLinkOperations.getChildren(block, LINKS.outports$xLwx))) {
      Object value = evalOutport(op);
      ctx.getEnvironment().put(op, value);
    }
  }

  public Object getOutput(SNode op) {
    return this.ctx.getEnvironment().get(op);
  }

  public List<Object> getAllOutputs() {
    List<Object> res = ListSequence.fromList(new ArrayList<Object>());
    for (SNode op : ListSequence.fromList(SLinkOperations.getChildren(block, LINKS.outports$xLwx))) {
      ListSequence.fromList(res).addElement(ctx.getEnvironment().get(op));
    }
    return res;
  }

  public Object evalOutport(final SNode out) {
    SNode conn = ListSequence.fromList(SLinkOperations.getChildren(block, LINKS.connectors$M0o8)).where((it) -> (boolean) Connector__BehaviorDescriptor.connectsToOutsidePort_id5Q9FzcI4YUK.invoke(it, out)).first();
    return evalEndpoint(SLinkOperations.getTarget(conn, LINKS.left$rT$n));
  }

  public Object evalInPort(SNode in) {
    return ctx.getEnvironment().get(in);
  }

  public Object evalInstance(final SNode instance, SNode out) {
    SNode b = SLinkOperations.getTarget(instance, LINKS.block$aVz7);
    try {
      ctx.pushEnvironment(instance, MapSequence.fromMap(new HashMap<SNode, Object>()));
      for (final SNode in : ListSequence.fromList(SLinkOperations.getChildren(b, LINKS.inports$dl2o))) {
        SNode conn = ListSequence.fromList(SLinkOperations.getChildren(this.block, LINKS.connectors$M0o8)).findFirst((it) -> (boolean) Connector__BehaviorDescriptor.connectsToInsideInPort_id5Q9FzcI6bZ6.invoke(it, instance, in));
        Object evaledInput = evalEndpoint(SLinkOperations.getTarget(conn, LINKS.left$rT$n));
        ctx.getEnvironment().put(in, evaledInput);
      }
      for (final SNode p : ListSequence.fromList(SLinkOperations.getChildren(b, LINKS.params$7rRh))) {
        SNode pv = ListSequence.fromList(SLinkOperations.getChildren(instance, LINKS.paramValues$mkq$)).findFirst((it) -> SLinkOperations.getTarget(it, LINKS.param$UNjl) == p);
        Object v = ctx.getRootInterpreter().evaluate(SLinkOperations.getTarget(pv, LINKS.expr$CW3E), ctx);
        ctx.getEnvironment().put(p, v);
      }
      if (SNodeOperations.isInstanceOf(b, CONCEPTS.ExprBlock$YR)) {
        return ctx.getRootInterpreter().evaluate(SLinkOperations.getTarget(out, LINKS.value$cAQw), ctx);
      } else {
        CompositeBlockEvaluator evaluatotr = new CompositeBlockEvaluator(ctx, SNodeOperations.cast(b, CONCEPTS.CompositeBlock$TJ));
        evaluatotr.eval();
        return evaluatotr.getOutput(out);
      }
    } finally {
      ctx.popEnvironment(instance);
    }
  }

  public Object evalEndpoint(SNode e) {
    if (SNodeOperations.isInstanceOf(e, CONCEPTS.OutsideEndpoint$pO)) {
      return evalInPort(SNodeOperations.cast(SLinkOperations.getTarget(SNodeOperations.cast(e, CONCEPTS.OutsideEndpoint$pO), LINKS.port$zHo1), CONCEPTS.InPort$Ah));
    } else {
      return evalInstance(SLinkOperations.getTarget(SNodeOperations.cast(e, CONCEPTS.InsideEndpoint$Ek), LINKS.instance$qJ6s), SNodeOperations.cast(SLinkOperations.getTarget(e, LINKS.port$zHo1), CONCEPTS.OutPort$FI));
    }
  }

  private SNode block;
  private IContext ctx;

  private static final class LINKS {
    /*package*/ static final SContainmentLink outports$xLwx = MetaAdapterFactory.getContainmentLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716a5aL, 0x4f91a4533f716c71L, "outports");
    /*package*/ static final SContainmentLink connectors$M0o8 = MetaAdapterFactory.getContainmentLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716a5dL, 0x395649586dd3ac0dL, "connectors");
    /*package*/ static final SContainmentLink left$rT$n = MetaAdapterFactory.getContainmentLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x395649586dce5477L, 0x395649586dced341L, "left");
    /*package*/ static final SReferenceLink block$aVz7 = MetaAdapterFactory.getReferenceLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716a61L, 0x395649586dbb837cL, "block");
    /*package*/ static final SContainmentLink inports$dl2o = MetaAdapterFactory.getContainmentLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716a5aL, 0x4f91a4533f716a58L, "inports");
    /*package*/ static final SContainmentLink paramValues$mkq$ = MetaAdapterFactory.getContainmentLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716a61L, 0x27d47effb8db0ac1L, "paramValues");
    /*package*/ static final SReferenceLink param$UNjl = MetaAdapterFactory.getReferenceLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x27d47effb8daa7e4L, 0x27d47effb8daa80bL, "param");
    /*package*/ static final SContainmentLink expr$CW3E = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x3b256bb6ae8048d8L, 0x3b256bb6ae8048d9L, "expr");
    /*package*/ static final SContainmentLink params$7rRh = MetaAdapterFactory.getContainmentLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716a5aL, 0x5d89ae332e211052L, "params");
    /*package*/ static final SContainmentLink value$cAQw = MetaAdapterFactory.getContainmentLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716b2fL, 0x27d47effb90810e1L, "value");
    /*package*/ static final SReferenceLink port$zHo1 = MetaAdapterFactory.getReferenceLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x395649586dce555cL, 0x395649586dce5726L, "port");
    /*package*/ static final SReferenceLink instance$qJ6s = MetaAdapterFactory.getReferenceLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x395649586dce5728L, 0x216b83c328c0ebb1L, "instance");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept ExprBlock$YR = MetaAdapterFactory.getConcept(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716984L, "org.iets3.core.expr.dataflow.structure.ExprBlock");
    /*package*/ static final SConcept CompositeBlock$TJ = MetaAdapterFactory.getConcept(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716a5dL, "org.iets3.core.expr.dataflow.structure.CompositeBlock");
    /*package*/ static final SConcept OutsideEndpoint$pO = MetaAdapterFactory.getConcept(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x395649586dce5641L, "org.iets3.core.expr.dataflow.structure.OutsideEndpoint");
    /*package*/ static final SConcept InPort$Ah = MetaAdapterFactory.getConcept(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f7169a0L, "org.iets3.core.expr.dataflow.structure.InPort");
    /*package*/ static final SConcept InsideEndpoint$Ek = MetaAdapterFactory.getConcept(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x395649586dce5728L, "org.iets3.core.expr.dataflow.structure.InsideEndpoint");
    /*package*/ static final SConcept OutPort$FI = MetaAdapterFactory.getConcept(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716b2fL, "org.iets3.core.expr.dataflow.structure.OutPort");
  }
}
