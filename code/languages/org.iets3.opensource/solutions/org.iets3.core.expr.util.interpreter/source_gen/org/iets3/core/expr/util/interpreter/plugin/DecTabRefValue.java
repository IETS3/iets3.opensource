package org.iets3.core.expr.util.interpreter.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.util.List;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import com.mbeddr.mpsutil.interpreter.rt.IContext;
import com.mbeddr.mpsutil.interpreter.rt.ICoverageAnalyzer;
import com.mbeddr.mpsutil.interpreter.rt.ComputationTrace;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;

public class DecTabRefValue {
  private SNode tab;
  private List<Tuples._2<SNode, Object>> boundValues = ListSequence.fromList(new ArrayList<Tuples._2<SNode, Object>>());
  public DecTabRefValue(SNode tab) {
    this.tab = tab;
  }
  public Object executeEvaluated(List<Tuples._2<SNode, Object>> evaluatedArgs, IContext context, ICoverageAnalyzer coverage, ComputationTrace contextTrace, boolean stopOnStop) {
    context.pushEnvironment(tab, null);
    Iterable<Tuples._2<SNode, Object>> seq = ListSequence.fromList(evaluatedArgs).concat(ListSequence.fromList(boundValues)).sort((it) -> SNodeOperations.getIndexInParent(it._0()), true);
    for (Tuples._2<SNode, Object> item : Sequence.fromIterable(seq)) {
      context.getEnvironment().put(item._0(), item._1());
    }
    ComputationTrace tt = new ComputationTrace(tab, true);
    contextTrace.addChild(tt);
    Object res = context.getRootInterpreter().evaluate(tab, context, coverage, tt, stopOnStop);
    tt.setValue(res);
    context.popEnvironment(tab);

    return res;
  }

  public DecTabRefValue bindValue(SNode col, Object value, IContext ctx, ICoverageAnalyzer coverage) {
    DecTabRefValue copy = this.copy(ctx, coverage);
    ListSequence.fromList(copy.boundValues).addElement(MultiTuple.<SNode,Object>from(col, value));
    return copy;
  }
  public DecTabRefValue copy(IContext ctx, ICoverageAnalyzer coverage) {
    DecTabRefValue copy = new DecTabRefValue(tab);
    ListSequence.fromList(copy.boundValues).addSequence(ListSequence.fromList(this.boundValues));
    return copy;
  }
}
