package org.iets3.core.expr.util.interpreter.plugin;

/*Generated by MPS */

import org.iets3.core.expr.base.behavior.IETS3ExprContext;
import org.jetbrains.mps.openapi.model.SNode;
import com.mbeddr.mpsutil.interpreter.rt.ICoverageAnalyzer;
import com.mbeddr.mpsutil.interpreter.rt.ComputationTrace;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.iets3.core.expr.util.behavior.MultiDecTab__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.iets3.core.expr.util.behavior.DataRow__BehaviorDescriptor;
import org.iets3.core.expr.util.behavior.SameExpression__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.iets3.core.expr.util.behavior.RangeSpecifier__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import org.iets3.core.expr.util.behavior.IMultiDecTab__BehaviorDescriptor;
import org.iets3.core.expr.util.behavior.AssigningResultColDef__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SProperty;

public class MultiDecTabHelper {

  private IETS3ExprContext ctx;
  private SNode node;
  private ICoverageAnalyzer cov;
  private ComputationTrace trace;

  /**
   * Value set for the node representing a row in the computation trace by this helper. 
   * Knowing the value that is used to indicate that the row was matched is useful for analyses 
   * scenarios like coverage reporting.
   */
  public static final String ROW_MATCHED_VALUE = "row matched";


  public MultiDecTabHelper(SNode node, IETS3ExprContext ctx, ICoverageAnalyzer coverage, ComputationTrace trace) {
    this.ctx = ctx;
    this.node = node;
    this.cov = coverage;
    this.trace = trace;
  }

  public Object exec(SNode expr) {
    return ctx.getRootInterpreter().evaluate(expr, ctx, cov, trace, false);
  }

  public Object exec(SNode expr, ComputationTrace tr) {
    return ctx.getRootInterpreter().evaluate(expr, ctx, cov, tr, false);
  }

  public Object runDectab() {
    List<Object> queryResults = ListSequence.fromList(new ArrayList<Object>());
    ComputationTrace headers = trace.newChild(node, true, "headers");
    for (SNode ch : Sequence.fromIterable(MultiDecTab__BehaviorDescriptor.queryColDefs_id8XWEteuHOl.invoke(node))) {
      ListSequence.fromList(queryResults).addElement(exec(SLinkOperations.getTarget(ch, LINKS.expr$CW3E), headers));
    }
    headers.setValue(queryResults);
    for (SNode r : ListSequence.fromList(SLinkOperations.getChildren(node, LINKS.rows$sdUx))) {
      final ComputationTrace rowTrace = trace.newChild(r, true, "row " + SNodeOperations.getIndexInParent(r));
      // used because if we attach skipped/matched to the row, the table layout will break

      boolean rowMatches = true;
      for (final SNode c : Sequence.fromIterable(DataRow__BehaviorDescriptor.queryContents_id8XWEteuTUz.invoke(r))) {
        List<SNode> exprs = SLinkOperations.getChildren(c, LINKS.exprs$KQyr);
        if ((ListSequence.fromList(exprs).first() != null) && SNodeOperations.isInstanceOf(ListSequence.fromList(exprs).first(), CONCEPTS.SameExpression$oD)) {
          exprs = Sequence.fromIterable(SameExpression__BehaviorDescriptor.effectiveContents_idNuz63e$fnb.invoke(SNodeOperations.cast(ListSequence.fromList(exprs).first(), CONCEPTS.SameExpression$oD))).toList();
        }
        if (ListSequence.fromList(exprs).isEmpty()) {
          continue;
        }
        final Object expected = ListSequence.fromList(queryResults).getElement(SNodeOperations.getIndexInParent(SLinkOperations.getTarget(c, LINKS.col$28hQ)));
        boolean thisOneMatches = ListSequence.fromList(exprs).any((it) -> {
          if (SNodeOperations.isInstanceOf(it, CONCEPTS.RangeValueExpr$Vq)) {
            // need to add coverage explicitly, as only its copy is evaluated
            ListSequence.fromList(SNodeOperations.getNodeDescendants(it, null, true, new SAbstractConcept[]{})).visitAll((n) -> cov.coverValue(n, null));
            SNode eee = RangeSpecifier__BehaviorDescriptor.createExpression_id1tPb0nsnb6P.invoke(SLinkOperations.getTarget(SNodeOperations.cast(it, CONCEPTS.RangeValueExpr$Vq), LINKS.range$iA1U), SLinkOperations.getTarget(SNodeOperations.cast(SLinkOperations.getTarget(c, LINKS.col$28hQ), CONCEPTS.QueryColDef$Es), LINKS.expr$CW3E));
            return (Boolean) exec(eee, rowTrace);
          } else {
            return exec(it, rowTrace).equals(expected);
          }
        });
        if (SPropertyOperations.getBoolean(c, PROPS.negate$5eQg) && thisOneMatches) {
          rowMatches = false;
        } else if (!(SPropertyOperations.getBoolean(c, PROPS.negate$5eQg)) && !(thisOneMatches)) {
          rowMatches = false;
        }
      }
      if (rowMatches) {
        rowTrace.setValue(ROW_MATCHED_VALUE);
        final ComputationTrace resultTrace = trace.newChild(node, true, "results");

        if (Sequence.fromIterable(IMultiDecTab__BehaviorDescriptor.resultColDefs_id7FuUjk_57S0.invoke(node)).all((it) -> SNodeOperations.isInstanceOf(it, CONCEPTS.AssigningResultColDef$_w))) {
          for (SNode rc : Sequence.fromIterable(DataRow__BehaviorDescriptor.resultContents_id8XWEtejPkO.invoke(r))) {
            Object val = exec(ListSequence.fromList(SLinkOperations.getChildren(rc, LINKS.exprs$KQyr)).first(), resultTrace);
            AssigningResultColDef__BehaviorDescriptor.assign_id6OunYCeYf_J.invoke(SNodeOperations.cast(SLinkOperations.getTarget(rc, LINKS.col$28hQ), CONCEPTS.AssigningResultColDef$_w), val, ctx.getEnvironment());
          }
        }

        if (Sequence.fromIterable(IMultiDecTab__BehaviorDescriptor.resultColDefs_id7FuUjk_57S0.invoke(node)).count() == 1) {
          Object singleRes = exec(ListSequence.fromList(SLinkOperations.getChildren(Sequence.fromIterable(DataRow__BehaviorDescriptor.resultContents_id8XWEtejPkO.invoke(r)).first(), LINKS.exprs$KQyr)).first(), resultTrace);
          resultTrace.setValue(singleRes);
          return singleRes;
        } else {
          List<Object> listRes = Sequence.fromIterable(DataRow__BehaviorDescriptor.resultContents_id8XWEtejPkO.invoke(r)).select((it) -> exec(ListSequence.fromList(SLinkOperations.getChildren(it, LINKS.exprs$KQyr)).first(), resultTrace)).toList();
          resultTrace.setValue(listRes);
          return listRes;
        }

      } else {
        rowTrace.setValue("row skipped");
      }
    }
    return null;
  }


  private static final class LINKS {
    /*package*/ static final SContainmentLink expr$CW3E = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x3b256bb6ae8048d8L, 0x3b256bb6ae8048d9L, "expr");
    /*package*/ static final SContainmentLink exprs$KQyr = MetaAdapterFactory.getContainmentLink(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x23df2a74df94468L, 0x23df2a74df944d8L, "exprs");
    /*package*/ static final SReferenceLink col$28hQ = MetaAdapterFactory.getReferenceLink(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x23df2a74df94468L, 0x23df2a74df945baL, "col");
    /*package*/ static final SContainmentLink range$iA1U = MetaAdapterFactory.getContainmentLink(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x6d1e5fea0f4a460bL, 0x6d1e5fea0f4a460cL, "range");
    /*package*/ static final SContainmentLink rows$sdUx = MetaAdapterFactory.getContainmentLink(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x7adee935251479e0L, 0x7adee93525147c24L, "rows");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept SameExpression$oD = MetaAdapterFactory.getConcept(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0xcde8c60ce90a22dL, "org.iets3.core.expr.util.structure.SameExpression");
    /*package*/ static final SConcept RangeValueExpr$Vq = MetaAdapterFactory.getConcept(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x6d1e5fea0f4a460bL, "org.iets3.core.expr.util.structure.RangeValueExpr");
    /*package*/ static final SConcept QueryColDef$Es = MetaAdapterFactory.getConcept(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x23df2a74df65f60L, "org.iets3.core.expr.util.structure.QueryColDef");
    /*package*/ static final SConcept AssigningResultColDef$_w = MetaAdapterFactory.getConcept(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x6d1e5fea0ef8f94aL, "org.iets3.core.expr.util.structure.AssigningResultColDef");
  }

  private static final class PROPS {
    /*package*/ static final SProperty negate$5eQg = MetaAdapterFactory.getProperty(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x23df2a74df94468L, 0x2acea3560b33ac64L, "negate");
  }
}
