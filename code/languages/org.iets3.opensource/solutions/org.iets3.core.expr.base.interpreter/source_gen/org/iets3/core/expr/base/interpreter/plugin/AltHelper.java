package org.iets3.core.expr.base.interpreter.plugin;

/*Generated by MPS */

import org.iets3.core.expr.base.behavior.IETS3ExprContext;
import org.jetbrains.mps.openapi.model.SNode;
import com.mbeddr.mpsutil.interpreter.rt.ICoverageAnalyzer;
import com.mbeddr.mpsutil.interpreter.rt.ComputationTrace;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.iets3.core.expr.base.runtime.runtime.PTF;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class AltHelper {

  private IETS3ExprContext ctx;
  private SNode node;
  private ICoverageAnalyzer cov;
  private ComputationTrace trace;

  public AltHelper(SNode node, IETS3ExprContext ctx, ICoverageAnalyzer coverage, ComputationTrace trace) {
    this.ctx = ctx;
    this.node = node;
    this.cov = coverage;
    this.trace = trace;
  }

  public Object exec(SNode expr) {
    return ctx.getRootInterpreter().evaluate(expr, ctx, cov, trace, false);
  }

  public Object runDectab() {
    cov.registerBranches(SNodeOperations.getConcept(node), new String[]{"aCase", "otherwise"});
    for (SNode caze : ListSequence.fromList(SLinkOperations.getChildren(node, LINKS.alternatives$_UE0)).where((it) -> !(PTF.isOtherwiseLiteral(SLinkOperations.getTarget(it, LINKS.when$ywD6))))) {
      Object condVal = exec(SLinkOperations.getTarget(caze, LINKS.when$ywD6));
      if (condVal instanceof Boolean && ((boolean) condVal)) {
        cov.visitedConceptBranch(SNodeOperations.getConcept(node), "aCase");
        return exec(SLinkOperations.getTarget(caze, LINKS.then$yx78));
      }
    }
    SNode otherwise = ListSequence.fromList(SLinkOperations.getChildren(node, LINKS.alternatives$_UE0)).where((it) -> PTF.isOtherwiseLiteral(SLinkOperations.getTarget(it, LINKS.when$ywD6))).first();
    if (otherwise != null) {
      cov.visitedConceptBranch(SNodeOperations.getConcept(node), "otherwise");
      Object neededForTracingAndCoverage = exec(SLinkOperations.getTarget(otherwise, LINKS.when$ywD6));
      return exec(SLinkOperations.getTarget(otherwise, LINKS.then$yx78));
    }
    return null;
  }


  private static final class LINKS {
    /*package*/ static final SContainmentLink when$ywD6 = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x6ea1ae96e110d65bL, 0x6ea1ae96e110d66eL, "when");
    /*package*/ static final SContainmentLink then$yx78 = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x6ea1ae96e110d65bL, 0x6ea1ae96e110d670L, "then");
    /*package*/ static final SContainmentLink alternatives$_UE0 = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x6ea1ae96e110d644L, 0x6ea1ae96e110d6caL, "alternatives");
  }
}
