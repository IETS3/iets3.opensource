package org.iets3.core.expr.metafunction.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import org.iets3.core.expr.base.behavior.IETS3ExprContext;
import com.mbeddr.mpsutil.interpreter.rt.IInterpreter;
import com.mbeddr.mpsutil.interpreter.rt.InterpreterEvaluationHelper;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import com.mbeddr.mpsutil.interpreter.rt.ComputationTrace;
import com.mbeddr.mpsutil.interpreter.rt.IEnvironment;
import com.mbeddr.mpsutil.interpreter.rt.NullCoverageAnalyzer;
import jetbrains.mps.lang.core.behavior.BaseConcept__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SProperty;

public class MFI {

  private SNode function;
  private IETS3ExprContext ctx;
  private IInterpreter interpreter;


  public MFI(SNode fun) {
    function = fun;
    ctx = new IETS3ExprContext();
    interpreter = InterpreterEvaluationHelper.getInterpreter("arithmetic");
    ctx.setRootInterpreter(interpreter);
  }

  public MFI(IETS3ExprContext interpreterContext, SNode fun) {
    function = fun;
    ctx = interpreterContext;
    interpreter = ctx.getRootInterpreter();
  }


  public MFI setEvaluatedArgValue(final String name, Object value) throws MFIException {
    SNode arg = ListSequence.fromList(SLinkOperations.getChildren(function, LINKS.args$M3Dr)).findFirst((it) -> SPropertyOperations.getString(it, PROPS.name$MnvL).equals(name));
    if (arg == null) {
      throw new MFIException("Argument named '" + name + "' does not exist");
    }
    ctx.getEnvironment().put(arg, value);
    return this;
  }

  public MFI setRawArgValue(final String name, SNode value) throws MFIException {
    SNode arg = ListSequence.fromList(SLinkOperations.getChildren(function, LINKS.args$M3Dr)).findFirst((it) -> SPropertyOperations.getString(it, PROPS.name$MnvL).equals(name));
    if (arg == null) {
      throw new MFIException("Argument named '" + name + "' does not exist");
    }
    ctx.getEnvironment().put(arg, interpreter.evaluate(value, ctx));
    return this;
  }


  public Object run(ComputationTrace trace) throws MFIException {
    IEnvironment env = ctx.getEnvironment();
    for (SNode arg : ListSequence.fromList(SLinkOperations.getChildren(function, LINKS.args$M3Dr))) {
      if (env.get(arg) == null) {
        throw new MFIException("no value found in environment for argument '" + SPropertyOperations.getString(arg, PROPS.name$MnvL) + "'");
      }
    }
    ComputationTrace tt = new ComputationTrace(this.function);
    Object val = interpreter.evaluate(function, ctx, new NullCoverageAnalyzer(), tt, false);
    trace.addChild(tt, true, BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(this.function));
    tt.setValue(val);
    return val;
  }

  public Object run(Object valueOfSingleArg, ComputationTrace trace) throws MFIException {
    int argCount = ListSequence.fromList(SLinkOperations.getChildren(this.function, LINKS.args$M3Dr)).count();
    if (argCount != 1) {
      throw new MFIException("This method is only allowed for functions with one argument; this one has " + argCount);
    }
    setEvaluatedArgValue(SPropertyOperations.getString(ListSequence.fromList(SLinkOperations.getChildren(this.function, LINKS.args$M3Dr)).first(), PROPS.name$MnvL), valueOfSingleArg);
    return run(trace);
  }

  public String getPresentation() {
    return (String) BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(this.function);
  }



  private static final class LINKS {
    /*package*/ static final SContainmentLink args$M3Dr = MetaAdapterFactory.getContainmentLink(0x711a16d799e84e1dL, 0xb20c99c0b7309cd8L, 0x53300f6d0c251610L, 0x53300f6d0c251cd3L, "args");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }
}
