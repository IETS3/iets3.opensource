package org.iets3.core.expr.util.plugin;

/*Generated by MPS */

import de.slisson.mps.tables.runtime.plugin.CopyPasteSupport;
import org.jetbrains.mps.openapi.model.SNode;
import de.slisson.mps.tables.runtime.selection.UndirectedTableRange;
import jetbrains.mps.openapi.editor.EditorContext;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import de.slisson.mps.tables.runtime.selection.TableRangeSelection;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import de.slisson.mps.tables.runtime.plugin.TableData;
import java.util.Objects;
import java.util.List;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class MultiDecTabCopyPasteImpl implements CopyPasteSupport {

  public static final int leftHeaderAndNavigationColumns = 2;
  public static final int headerRows = 1;

  private SNode table;

  private UndirectedTableRange withoutNavigationAndHeaderColumns(UndirectedTableRange tableSelection) {
    return tableSelection.withOffset(-headerRows, -leftHeaderAndNavigationColumns);
  }

  @Override
  public int priority() {
    return 0;
  }

  @Override
  public boolean isApplicable(SNode node, EditorContext editorContext) {
    return SNodeOperations.isInstanceOf(node, CONCEPTS.MultiDecTab$Cw);
  }

  @Override
  public void setTableNode(SNode table) {
    this.table = SNodeOperations.as(table, CONCEPTS.MultiDecTab$Cw);
  }

  @Override
  public void delete(TableRangeSelection selection, EditorContext editorContext) {
    withoutNavigationAndHeaderColumns(selection.toUndirectedRange()).iterate((Integer rowIndex, Integer colIndex) -> {
      SNode selectedRow = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.rows$sdUx)).getElement(rowIndex);
      SNode selectedCol = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.colDefs$80en)).getElement(colIndex);
      SNode cell = ListSequence.fromList(SLinkOperations.getChildren(selectedRow, LINKS.contents$qmm1)).findFirst((currentCell) -> SLinkOperations.getTarget(currentCell, LINKS.col$28hQ) == selectedCol);
      SNodeOperations.deleteNode(cell);
    });
  }

  @Override
  public TableData<SNode> copy(TableRangeSelection selection, EditorContext editorContext) {
    TableData<SNode> data = new TableData<SNode>();
    UndirectedTableRange box = withoutNavigationAndHeaderColumns(selection.toUndirectedRange());
    return data.collect(box, (Integer rowIndex, Integer colIndex) -> {
      SNode row = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.rows$sdUx)).getElement(rowIndex);
      SNode col = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.colDefs$80en)).getElement(colIndex);
      SNode content = ListSequence.fromList(SLinkOperations.getChildren(row, LINKS.contents$qmm1)).findFirst((cell) -> Objects.equals(SLinkOperations.getTarget(cell, LINKS.col$28hQ), col));
      return check_omj9c9_a3a1a0c0q(check_omj9c9_a0d0b0a2a61(SLinkOperations.getChildren(content, LINKS.exprs$KQyr)));
    });
  }

  @Override
  public void paste(TableRangeSelection selection, TableData<SNode> data, EditorContext editorContext) {
    UndirectedTableRange range = withoutNavigationAndHeaderColumns(selection.toUndirectedRange());

    data.forEach(range.getStartRow(), range.getStartColumn(), (SNode value, Integer row, Integer col) -> {
      if (col >= ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.colDefs$80en)).count()) {
        // ignore data columns outside of the table
        return;
      }

      while (row >= ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.rows$sdUx)).count()) {
        SLinkOperations.addNewChild(table, LINKS.rows$sdUx, null);
      }

      SNode selectedRow = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.rows$sdUx)).getElement(row);
      SNode selectedCol = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.colDefs$80en)).getElement(col);

      SNode content = ListSequence.fromList(SLinkOperations.getChildren(selectedRow, LINKS.contents$qmm1)).findFirst((cell) -> SLinkOperations.getTarget(cell, LINKS.col$28hQ) == selectedCol);
      if (content == null) {
        content = createContent_omj9c9_a0a0i0c0a2a81(selectedCol);
        ListSequence.fromList(SLinkOperations.getChildren(selectedRow, LINKS.contents$qmm1)).addElement(content);
      }

      ListSequence.fromList(SLinkOperations.getChildren(content, LINKS.exprs$KQyr)).clear();
      ListSequence.fromList(SLinkOperations.getChildren(content, LINKS.exprs$KQyr)).addElement(SNodeOperations.as(SNodeOperations.copyNode(value), CONCEPTS.Expression$D_));
    });
  }
  private static SNode check_omj9c9_a3a1a0c0q(SNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return SNodeOperations.copyNode(checkedDotOperand);
    }
    return null;
  }
  private static SNode check_omj9c9_a0d0b0a2a61(List<SNode> checkedDotOperand) {
    if (null != checkedDotOperand) {
      return ListSequence.fromList(checkedDotOperand).first();
    }
    return null;
  }
  private static SNode createContent_omj9c9_a0a0i0c0a2a81(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.Content$au);
    n0.setReferenceTarget(LINKS.col$28hQ, p0);
    return n0.getResult();
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept MultiDecTab$Cw = MetaAdapterFactory.getConcept(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x23df2a74df65f5cL, "org.iets3.core.expr.util.structure.MultiDecTab");
    /*package*/ static final SConcept Expression$D_ = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a047L, "org.iets3.core.expr.base.structure.Expression");
    /*package*/ static final SConcept Content$au = MetaAdapterFactory.getConcept(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x23df2a74df94468L, "org.iets3.core.expr.util.structure.Content");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink rows$sdUx = MetaAdapterFactory.getContainmentLink(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x7adee935251479e0L, 0x7adee93525147c24L, "rows");
    /*package*/ static final SContainmentLink colDefs$80en = MetaAdapterFactory.getContainmentLink(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x7adee935251479e0L, 0x7adee93525147a20L, "colDefs");
    /*package*/ static final SContainmentLink contents$qmm1 = MetaAdapterFactory.getContainmentLink(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x23df2a74df8bcffL, 0x23df2a74df944daL, "contents");
    /*package*/ static final SReferenceLink col$28hQ = MetaAdapterFactory.getReferenceLink(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x23df2a74df94468L, 0x23df2a74df945baL, "col");
    /*package*/ static final SContainmentLink exprs$KQyr = MetaAdapterFactory.getContainmentLink(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x23df2a74df94468L, 0x23df2a74df944d8L, "exprs");
  }
}
