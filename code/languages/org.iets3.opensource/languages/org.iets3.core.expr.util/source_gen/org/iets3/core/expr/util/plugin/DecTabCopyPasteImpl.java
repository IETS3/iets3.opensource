package org.iets3.core.expr.util.plugin;

/*Generated by MPS */

import de.slisson.mps.tables.runtime.plugin.CopyPasteSupport;
import org.jetbrains.mps.openapi.model.SNode;
import de.slisson.mps.tables.runtime.selection.UndirectedTableRange;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.openapi.editor.EditorContext;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import de.slisson.mps.tables.runtime.selection.TableRangeSelection;
import org.iets3.core.expr.util.behavior.DecTab__BehaviorDescriptor;
import de.slisson.mps.tables.runtime.plugin.TableData;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SProperty;

public class DecTabCopyPasteImpl implements CopyPasteSupport {

  /**
   * The table has a navigation column on the left and right.
   */
  public static final int navigationColumnsLeft = 1;
  public static final int navigationColumnsRight = 1;
  public static final int headerColumn = 1;

  private SNode table;

  private UndirectedTableRange withoutNavigationColumns(UndirectedTableRange tableSelection) {
    if (tableSelection.getEndColumn() >= ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.colHeaders$3s_N)).count() + navigationColumnsLeft + headerColumn) {
      // remove right navigation column if selected
      tableSelection = tableSelection.withoutRightColumns(navigationColumnsRight);
    }
    return tableSelection.withOffset(0, -navigationColumnsLeft);
  }

  @Override
  public int priority() {
    return 0;
  }

  @Override
  public boolean isApplicable(SNode node, EditorContext editorContext) {
    return SNodeOperations.isInstanceOf(node, CONCEPTS.DecTab$hI);
  }

  @Override
  public void setTableNode(SNode table) {
    this.table = SNodeOperations.as(table, CONCEPTS.DecTab$hI);
  }

  @Override
  public void delete(TableRangeSelection selection, EditorContext editorContext) {
    withoutNavigationColumns(selection.toUndirectedRange()).iterate((Integer row, Integer col) -> {
      if (row == 0 || col == 0) {
        return;
      }
      SNode rowHeader = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.rowHeaders$3rSK)).getElement(row - 1);
      SNode colHeader = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.colHeaders$3s_N)).getElement(col - 1);
      SNode cell = DecTab__BehaviorDescriptor.findContent_id6kR0qIbwVrt.invoke(table, colHeader, rowHeader);
      SNodeOperations.deleteNode(cell);
    });
  }

  @Override
  public TableData<SNode> copy(TableRangeSelection selection, EditorContext editorContext) {
    TableData<SNode> data = new TableData<SNode>();

    data.collect(withoutNavigationColumns(selection.toUndirectedRange()), (Integer row, Integer col) -> {
      if (row == 0 && col == 0) {
        return createStringLiteral_ihkpgl_a0a0a1a0c0r();
      }
      if (row == 0) {
        SNode colHeader = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.colHeaders$3s_N)).getElement(col - 1);
        return SNodeOperations.copyNode(ListSequence.fromList(SLinkOperations.getChildren(colHeader, LINKS.expressions$2RXU)).first());
      }
      if (col == 0) {
        SNode rowHeader = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.rowHeaders$3rSK)).getElement(row - 1);
        return SNodeOperations.copyNode(ListSequence.fromList(SLinkOperations.getChildren(rowHeader, LINKS.expressions$2RXU)).first());
      }
      SNode rowHeader = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.rowHeaders$3rSK)).getElement(row - 1);
      SNode colHeader = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.colHeaders$3s_N)).getElement(col - 1);
      return SNodeOperations.copyNode(DecTab__BehaviorDescriptor.findContentExpression_id29Y5P9UYTXZ.invoke(table, colHeader, rowHeader));
    });

    return as_ihkpgl_a0e0r(data, TableData.class);
  }

  @Override
  public void paste(TableRangeSelection selection, TableData<SNode> data, EditorContext editorContext) {
    UndirectedTableRange range = withoutNavigationColumns(selection.toUndirectedRange());
    data.forEach(range.getStartRow(), range.getStartColumn(), (SNode element, Integer row, Integer col) -> {
      if (row <= ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.rowHeaders$3rSK)).count() && col <= ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.colHeaders$3s_N)).count()) {
        insertElement(row, col, SNodeOperations.as(element, CONCEPTS.Expression$D_));
      }
    });
  }

  private void insertElement(int row, int col, SNode value) {
    if (row == 0 && col == 0) {
      return;
    }
    SNode selectedRow = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.rowHeaders$3rSK)).getElement(row - 1);
    SNode selectedCol = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.colHeaders$3s_N)).getElement(col - 1);

    if (row == 0 || (col == 0)) {
      return;
    }

    SNode content = DecTab__BehaviorDescriptor.findContent_id6kR0qIbwVrt.invoke(table, selectedCol, selectedRow);
    if (content == null) {
      // create new content cell
      content = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x3a7ea77800c0430eL, "org.iets3.core.expr.util.structure.DecTabContent"));
      SLinkOperations.setTarget(content, LINKS.col$3qUK, selectedCol);
      SLinkOperations.setTarget(content, LINKS.row$3lio, selectedRow);
      ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.contents$3yGd)).addElement(content);
    }

    ListSequence.fromList(SLinkOperations.getChildren(content, LINKS.expressions$2RXU)).clear();
    ListSequence.fromList(SLinkOperations.getChildren(content, LINKS.expressions$2RXU)).addElement(SNodeOperations.copyNode(value));
  }
  private static SNode createStringLiteral_ihkpgl_a0a0a1a0c0r() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.StringLiteral$By);
    n0.setProperty(PROPS.value$zwlK, "");
    return n0.getResult();
  }
  private static <T> T as_ihkpgl_a0e0r(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink colHeaders$3s_N = MetaAdapterFactory.getContainmentLink(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x3a7ea77800c04308L, 0x3a7ea77800c04344L, "colHeaders");
    /*package*/ static final SContainmentLink rowHeaders$3rSK = MetaAdapterFactory.getContainmentLink(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x3a7ea77800c04308L, 0x3a7ea77800c04341L, "rowHeaders");
    /*package*/ static final SContainmentLink expressions$2RXU = MetaAdapterFactory.getContainmentLink(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x3a7ea77800c0430fL, 0x3a7ea77800c04310L, "expressions");
    /*package*/ static final SReferenceLink col$3qUK = MetaAdapterFactory.getReferenceLink(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x3a7ea77800c0430eL, 0x3a7ea77800c0433cL, "col");
    /*package*/ static final SReferenceLink row$3lio = MetaAdapterFactory.getReferenceLink(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x3a7ea77800c0430eL, 0x3a7ea77800c04339L, "row");
    /*package*/ static final SContainmentLink contents$3yGd = MetaAdapterFactory.getContainmentLink(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x3a7ea77800c04308L, 0x3a7ea77800c04349L, "contents");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept DecTab$hI = MetaAdapterFactory.getConcept(0x8bb1251eeae547abL, 0x984333adfae8edaaL, 0x3a7ea77800c04308L, "org.iets3.core.expr.util.structure.DecTab");
    /*package*/ static final SConcept Expression$D_ = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a047L, "org.iets3.core.expr.base.structure.Expression");
    /*package*/ static final SConcept StringLiteral$By = MetaAdapterFactory.getConcept(0x6b277d9ad52d416fL, 0xa2091919bd737f50L, 0x46ff3b3d86d3edc8L, "org.iets3.core.expr.simpleTypes.structure.StringLiteral");
  }

  private static final class PROPS {
    /*package*/ static final SProperty value$zwlK = MetaAdapterFactory.getProperty(0x6b277d9ad52d416fL, 0xa2091919bd737f50L, 0x46ff3b3d86d3edc8L, 0x46ff3b3d86d3edcbL, "value");
  }
}
