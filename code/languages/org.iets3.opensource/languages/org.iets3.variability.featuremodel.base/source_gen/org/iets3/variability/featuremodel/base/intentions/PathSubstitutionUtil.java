package org.iets3.variability.featuremodel.base.intentions;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import java.util.List;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.typechecking.TypecheckingFacade;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import org.iets3.variability.featuremodel.base.behavior.FeatureTreeNode__BehaviorDescriptor;
import org.iets3.variability.featuremodel.base.plugin.FeatureModelTraversal;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class PathSubstitutionUtil {
  private static final Logger LOG = Logger.getLogger(PathSubstitutionUtil.class);

  public static List<List<SNode>> fullPathAsNodes(SNode node) {
    SNode dotExpression = SNodeOperations.cast(SNodeOperations.getParent(node), CONCEPTS.DotExpression$jp);
    SNode currentAbstractFeature = SLinkOperations.getTarget(SNodeOperations.as(TypecheckingFacade.getFromContext().getTypeOf(SLinkOperations.getTarget(dotExpression, LINKS.expr$CW3E)), CONCEPTS.FeatureType$_L), LINKS.feature$SwK2);
    if ((currentAbstractFeature == null)) {
      return ListSequence.fromList(new ArrayList<List<SNode>>());
    }
    SNode currentFeature = FeatureTreeNode__BehaviorDescriptor.effectiveFeature_id6GZHy352t67.invoke(currentAbstractFeature);
    List<List<SNode>> paths = FeatureModelTraversal.findAllPathsToSubFeature(currentFeature, SLinkOperations.getTarget(node, LINKS.feature$hhv5), (String msg, SNode target) -> {
      if (LOG.isErrorLevel()) {
        LOG.error("ERROR: " + msg + "@" + target.getNodeId());
      }
    });
    return FeatureModelTraversal.prunePaths(paths, SLinkOperations.getTarget(node, LINKS.feature$hhv5));
  }


  public static SNode wrapInDotExpression(SNode node, List<SNode> parameter) {
    return PathSubstitutionUtil.wrapWithInExpression(ListSequence.fromList(parameter).subListSequence(1, ListSequence.fromList(parameter).count()), createDotExpression_hyvmgy_b0a0e(SLinkOperations.getTarget(SNodeOperations.cast(SNodeOperations.getParent(node), CONCEPTS.DotExpression$jp), LINKS.expr$CW3E), ListSequence.fromList(parameter).getElement(0)));
  }

  public static SNode wrapWithInExpression(List<SNode> remainingNodes, SNode startExpression) {
    return SNodeOperations.cast(ListSequence.fromList(remainingNodes).foldLeft(startExpression, (SNode st, SNode p) -> createDotExpression_hyvmgy_a0a0a0a0a6(st, createSubFeatureDotTarget_hyvmgy_a0b0a0a0a0a0a6(p))), CONCEPTS.DotExpression$jp);
  }
  private static SNode createDotExpression_hyvmgy_b0a0e(SNode p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.DotExpression$jp);
    n0.forChild(LINKS.expr$CW3E).initNode(p0, CONCEPTS.Expression$D_, true);
    {
      SNodeBuilder n1 = n0.forChild(LINKS.target$u23F).init(CONCEPTS.SubFeatureDotTarget$5P);
      n1.setReferenceTarget(LINKS.feature$hhv5, p1);
    }
    return n0.getResult();
  }
  private static SNode createDotExpression_hyvmgy_a0a0a0a0a6(SNode p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.DotExpression$jp);
    n0.forChild(LINKS.expr$CW3E).initNode(p0, CONCEPTS.Expression$D_, true);
    n0.forChild(LINKS.target$u23F).initNode(p1, CONCEPTS.IDotTarget$jS, true);
    return n0.getResult();
  }
  private static SNode createSubFeatureDotTarget_hyvmgy_a0b0a0a0a0a0a6(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.SubFeatureDotTarget$5P);
    n0.setReferenceTarget(LINKS.feature$hhv5, p0);
    return n0.getResult();
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept DotExpression$jp = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x7cef88020a0f4249L, "org.iets3.core.expr.base.structure.DotExpression");
    /*package*/ static final SConcept FeatureType$_L = MetaAdapterFactory.getConcept(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x7cde27c7fd8487c2L, "org.iets3.variability.featuremodel.base.structure.FeatureType");
    /*package*/ static final SConcept Expression$D_ = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a047L, "org.iets3.core.expr.base.structure.Expression");
    /*package*/ static final SConcept SubFeatureDotTarget$5P = MetaAdapterFactory.getConcept(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x7cde27c7fd85baccL, "org.iets3.variability.featuremodel.base.structure.SubFeatureDotTarget");
    /*package*/ static final SInterfaceConcept IDotTarget$jS = MetaAdapterFactory.getInterfaceConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x7cef88020a0f424aL, "org.iets3.core.expr.base.structure.IDotTarget");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink expr$CW3E = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x3b256bb6ae8048d8L, 0x3b256bb6ae8048d9L, "expr");
    /*package*/ static final SReferenceLink feature$SwK2 = MetaAdapterFactory.getReferenceLink(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x7cde27c7fd8487c2L, 0x7cde27c7fd8487ccL, "feature");
    /*package*/ static final SReferenceLink feature$hhv5 = MetaAdapterFactory.getReferenceLink(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x7cde27c7fd85baccL, 0x7cde27c7fd85bad9L, "feature");
    /*package*/ static final SContainmentLink target$u23F = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x7cef88020a0f4249L, 0x7cef88020a0f424bL, "target");
  }
}
