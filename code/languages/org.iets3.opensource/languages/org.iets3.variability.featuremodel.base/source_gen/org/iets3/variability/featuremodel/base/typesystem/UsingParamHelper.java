package org.iets3.variability.featuremodel.base.typesystem;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import java.util.Objects;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.iets3.variability.featuremodel.base.behavior.IUsingParamContext__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SProperty;

public class UsingParamHelper {

  /**
   * For a given required using-parameter for FeatureModelInclude fmi, we need to find a proper rhs value.
   * 
   * This method does this heuristically and returns a reference expression which can be used as rhs.
   * 
   * @param reqParam the using-parameter we have to satisfy
   * @param fmi the FeatureModelInclude node which needs an actual using-parameter for its feature model
   * @return a reference expression which satisfies the using-parameter
   */
  public static SNode findFeatureModelForParam(final SNode reqParam, SNode fmi) {
    SNode contextFM = SNodeOperations.getNodeAncestor(fmi, CONCEPTS.FeatureModel$X0, false, false);

    // look for local FMI and use it
    SNode matchingFMI = ListSequence.fromList(SNodeOperations.getNodeDescendants(contextFM, CONCEPTS.FeatureModelInclude$Iq, false, new SAbstractConcept[]{})).findFirst((it) -> Objects.equals(SLinkOperations.getTarget(it, LINKS.fm$EY24), SLinkOperations.getTarget(reqParam, LINKS.fm$Zpvv)));
    if ((matchingFMI != null)) {
      // we are using a locally defined FeatureModelInclude to satisfy the required parameter
      return createFMIncludeRefExpr_z0z2yz_a1a4a1(matchingFMI);
    }

    // possible addition: We could also look into local FMIs and check if there is a sub-FM matching our needs

    // nothing found yet, check out using-params of enclosing feature model
    SNode matchingParam = Sequence.fromIterable(IUsingParamContext__BehaviorDescriptor.usingParams_idMYWxk17YoO.invoke(contextFM)).findFirst((it) -> Objects.equals(SLinkOperations.getTarget(it, LINKS.fm$Zpvv), SLinkOperations.getTarget(reqParam, LINKS.fm$Zpvv)));
    if ((matchingParam != null)) {
      // we delegate the needed using-parameter to the first matching declared using-param of the context FM
      return createUsingParamRefExpr_z0z2yz_a1a01a1(matchingParam);
    }

    // did not find any proper instance for the required FM, create a new using-param and delegate it to outside
    SNode newParam = createFMParam_z0z2yz_a0n0b(SPropertyOperations.getString(reqParam, PROPS.name$MnvL) + "_NEW", SLinkOperations.getTarget(reqParam, LINKS.fm$Zpvv));
    if ((SLinkOperations.getTarget(contextFM, LINKS.using$qwrH) == null)) {
      SLinkOperations.setTarget(contextFM, LINKS.using$qwrH, createUsingSection_z0z2yz_a0a0o0b());
    }
    ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(contextFM, LINKS.using$qwrH), LINKS.params$eBc7)).addElement(newParam);
    return createUsingParamRefExpr_z0z2yz_a61a1(newParam);
  }
  private static SNode createFMIncludeRefExpr_z0z2yz_a1a4a1(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.FMIncludeRefExpr$TX);
    n0.setReferenceTarget(LINKS.fmInclude$ZAXs, p0);
    return n0.getResult();
  }
  private static SNode createUsingParamRefExpr_z0z2yz_a1a01a1(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.UsingParamRefExpr$Pc);
    n0.setReferenceTarget(LINKS.param$FQy9, p0);
    return n0.getResult();
  }
  private static SNode createFMParam_z0z2yz_a0n0b(String p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.FMParam$Gd);
    n0.setProperty(PROPS.name$MnvL, p0);
    n0.setReferenceTarget(LINKS.fm$Zpvv, p1);
    return n0.getResult();
  }
  private static SNode createUsingSection_z0z2yz_a0a0o0b() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.UsingSection$Nd);
    return n0.getResult();
  }
  private static SNode createUsingParamRefExpr_z0z2yz_a61a1(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.UsingParamRefExpr$Pc);
    n0.setReferenceTarget(LINKS.param$FQy9, p0);
    return n0.getResult();
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept FeatureModel$X0 = MetaAdapterFactory.getConcept(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x375cadc47516a211L, "org.iets3.variability.featuremodel.base.structure.FeatureModel");
    /*package*/ static final SConcept FeatureModelInclude$Iq = MetaAdapterFactory.getConcept(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x375cadc475172168L, "org.iets3.variability.featuremodel.base.structure.FeatureModelInclude");
    /*package*/ static final SConcept FMIncludeRefExpr$TX = MetaAdapterFactory.getConcept(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x7d6d839c28cfb861L, "org.iets3.variability.featuremodel.base.structure.FMIncludeRefExpr");
    /*package*/ static final SConcept UsingParamRefExpr$Pc = MetaAdapterFactory.getConcept(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x7d6d839c2837f1d4L, "org.iets3.variability.featuremodel.base.structure.UsingParamRefExpr");
    /*package*/ static final SConcept FMParam$Gd = MetaAdapterFactory.getConcept(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x6b367b20f4b08715L, "org.iets3.variability.featuremodel.base.structure.FMParam");
    /*package*/ static final SConcept UsingSection$Nd = MetaAdapterFactory.getConcept(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x7d6d839c28028b46L, "org.iets3.variability.featuremodel.base.structure.UsingSection");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink fm$EY24 = MetaAdapterFactory.getReferenceLink(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x375cadc475172168L, 0x375cadc475172169L, "fm");
    /*package*/ static final SReferenceLink fm$Zpvv = MetaAdapterFactory.getReferenceLink(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x6b367b20f4b08715L, 0x6b367b20f4b33988L, "fm");
    /*package*/ static final SContainmentLink using$qwrH = MetaAdapterFactory.getContainmentLink(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x375cadc47516a211L, 0x7d6d839c2802989aL, "using");
    /*package*/ static final SContainmentLink params$eBc7 = MetaAdapterFactory.getContainmentLink(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x7d6d839c28028b46L, 0x6b367b20f4b339d2L, "params");
    /*package*/ static final SReferenceLink fmInclude$ZAXs = MetaAdapterFactory.getReferenceLink(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x7d6d839c28cfb861L, 0x7d6d839c28cfbbd5L, "fmInclude");
    /*package*/ static final SReferenceLink param$FQy9 = MetaAdapterFactory.getReferenceLink(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x7d6d839c2837f1d4L, 0x7d6d839c2837fbe8L, "param");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }
}
