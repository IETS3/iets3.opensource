package org.iets3.variability.featuremodel.base.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import org.iets3.variability.featuremodel.base.behavior.FeatureTreeNode__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SEnumOperations;
import org.iets3.variability.featuremodel.base.behavior.AbstractFeature__BehaviorDescriptor;
import java.awt.Graphics2D;
import java.awt.Rectangle;
import java.awt.RenderingHints;
import java.awt.BasicStroke;
import com.intellij.ui.JBColor;
import java.awt.geom.Line2D;
import java.awt.geom.Ellipse2D;
import java.awt.geom.Arc2D;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

/**
 * TODO: Move this class to the editor aspect of this language.
 */
public class FeatureShape {

  public enum EdgeType {
    ROOT(),
    SEQUENCE(),
    OR(),
    XOR();


    public static EdgeType of(SNode node) {
      if ((boolean) FeatureTreeNode__BehaviorDescriptor.isRoot_id7Nu9WvXvoDo.invoke(node)) {
        return EdgeType.ROOT;
      }
      SNode parent = SNodeOperations.cast(SNodeOperations.getParent(node), CONCEPTS.FeatureTreeNode$HV);
      if (SEnumOperations.isMember(AbstractFeature__BehaviorDescriptor.subFeatureRelationShip_id6GZHy357BWt.invoke(FeatureTreeNode__BehaviorDescriptor.effectiveFeature_id6GZHy352t67.invoke(parent)), 0x375cadc475182d48L)) {
        return EdgeType.OR;
      }
      if (SEnumOperations.isMember(AbstractFeature__BehaviorDescriptor.subFeatureRelationShip_id6GZHy357BWt.invoke(FeatureTreeNode__BehaviorDescriptor.effectiveFeature_id6GZHy352t67.invoke(parent)), 0x375cadc475182d45L)) {
        return EdgeType.XOR;
      }
      return EdgeType.SEQUENCE;
    }
  }

  public enum NodeType {
    BLANK(),
    OPTIONAL(),
    MANDATORY();


    public static NodeType of(SNode node) {
      if (EdgeType.of(node) != EdgeType.SEQUENCE) {
        return NodeType.BLANK;
      }
      return ((boolean) FeatureTreeNode__BehaviorDescriptor.isMandatory_id7Nu9WvXv0Mk.invoke(node) ? NodeType.MANDATORY : NodeType.OPTIONAL);
    }
  }

  private final Graphics2D graphics;
  private final Rectangle selfBounds;
  private final Rectangle nodeBounds;
  private final float stroke;
  private final double lineX;
  private final double lineY;

  public FeatureShape(Graphics2D graphics, Rectangle selfBounds, Rectangle nodeBounds) {
    this.graphics = graphics;
    this.selfBounds = selfBounds;
    this.nodeBounds = nodeBounds;

    // compute stroke width so that it is 1.0 for default font size (13)
    stroke = Math.max(1.0f, nodeBounds.height / 13.0f);
    lineX = nodeBounds.x + nodeBounds.width * 0.5;
    lineY = nodeBounds.y + nodeBounds.height * 0.5;
  }

  private void initGraphics() {
    graphics.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
    graphics.setStroke(new BasicStroke(stroke));
    graphics.setColor(JBColor.BLACK);
  }

  public void paintNode(NodeType nodeType, boolean hasChildren, boolean expanded, boolean highlighted) {
    initGraphics();
    double r = (nodeType == NodeType.BLANK ? 0 : selfBounds.height * 0.35);

    // horizontal line
    graphics.draw(new Line2D.Double(selfBounds.x, lineY, lineX - r, lineY));

    // bullet
    if (nodeType != NodeType.BLANK) {
      Ellipse2D shape = new Ellipse2D.Double(lineX - r, lineY - r, r * 2, r * 2);
      graphics.draw(shape);
      if (nodeType == NodeType.MANDATORY) {
        graphics.fill(shape);
      }
    }

    // vertical line
    if (hasChildren && expanded) {
      double y = (nodeType == NodeType.BLANK ? lineY : lineY + r);
      graphics.draw(new Line2D.Double(lineX, y, lineX, selfBounds.getMaxY()));
    }

    // expand/collapse button
    if (hasChildren && highlighted) {
      Rectangle b = new Rectangle(selfBounds);
      b.width = b.height;
      b.grow(-1, -1);

      graphics.setColor(JBColor.WHITE);
      graphics.fillRect(b.x, b.y, b.width, b.height);
      graphics.setColor(JBColor.GRAY);
      graphics.drawRect(b.x, b.y, b.width, b.height);

      b.grow(-b.width / 4, -b.height / 4);
      graphics.drawLine(b.x, b.y + b.height / 2, b.x + b.width, b.y + b.height / 2);
      if (!(expanded)) {
        graphics.drawLine(b.x + b.width / 2, b.y, b.x + b.width / 2, b.y + b.height);
      }
    }
  }

  public void paintEdge(EdgeType edgeType) {
    initGraphics();

    // coords
    double left = selfBounds.x + nodeBounds.width * 0.5;

    // edge
    if (edgeType == EdgeType.OR || edgeType == EdgeType.XOR) {
      double r = selfBounds.height * 0.5;
      double x = left - r;
      double y = lineY - r;
      Arc2D shape = new Arc2D.Double(x, y, r * 2, r * 2, 0, 90, Arc2D.OPEN);
      graphics.draw(shape);
      if (edgeType == EdgeType.OR) {
        shape.setArcType(Arc2D.PIE);
        graphics.fill(shape);
      }
    }

    // horizontal line
    graphics.draw(new Line2D.Double(left, lineY, selfBounds.getMaxX(), lineY));
  }

  public void paintLine() {
    initGraphics();

    graphics.draw(new Line2D.Double(lineX, selfBounds.y, lineX, selfBounds.getMaxY() - nodeBounds.height * 0.5));
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept FeatureTreeNode$HV = MetaAdapterFactory.getConcept(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x375cadc475172167L, "org.iets3.variability.featuremodel.base.structure.FeatureTreeNode");
  }
}
