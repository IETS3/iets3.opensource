package org.iets3.core.expr.dataflow.behavior;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import java.util.Objects;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SProperty;

public class CompositeBlockTransformer {

  private SNode block;
  private SNode function;
  private Map<SNode, SNode> myCollector;

  public CompositeBlockTransformer(SNode blk, Map<SNode, SNode> collector) {
    this.function = Block__BehaviorDescriptor.makeFunctionSig_id2nByCcx$A7b.invoke(blk);
    this.block = blk;
    myCollector = collector;
  }

  public SNode make() {
    final SNode fun = this.function;
    if (ListSequence.fromList(SLinkOperations.getChildren(this.block, LINKS.outports$xLwx)).count() == 1) {
      SLinkOperations.setTarget(fun, LINKS.body$Y8TB, evalOutport(ListSequence.fromList(SLinkOperations.getChildren(this.block, LINKS.outports$xLwx)).first()));
    } else {
      SNode tv = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0xe2477421831765aL, "org.iets3.core.expr.base.structure.TupleValue"));
      for (SNode o : ListSequence.fromList(SLinkOperations.getChildren(this.block, LINKS.outports$xLwx))) {
        ListSequence.fromList(SLinkOperations.getChildren(tv, LINKS.values$FZYa)).addElement(evalOutport(o));
      }
      SLinkOperations.setTarget(fun, LINKS.body$Y8TB, tv);
    }

    ListSequence.fromList(SNodeOperations.getNodeDescendants(SLinkOperations.getTarget(fun, LINKS.body$Y8TB), CONCEPTS.InportRef$NA, true, new SAbstractConcept[]{})).visitAll((final SNode ipr) -> SNodeOperations.replaceWithAnother(ipr, createArgRef_fvmzc9_a0a0a0a0d0h(ListSequence.fromList(SLinkOperations.getChildren(fun, LINKS.args$XOIh)).findFirst((it) -> Objects.equals(SPropertyOperations.getString(it, PROPS.name$MnvL), SPropertyOperations.getString(SLinkOperations.getTarget(ipr, LINKS.port$_Q9r), PROPS.name$MnvL))))));
    ListSequence.fromList(SNodeOperations.getNodeDescendants(SLinkOperations.getTarget(fun, LINKS.body$Y8TB), CONCEPTS.ParamRef$bF, true, new SAbstractConcept[]{})).visitAll((final SNode pr) -> SNodeOperations.replaceWithAnother(pr, createArgRef_fvmzc9_a0a0a0a0e0h(ListSequence.fromList(SLinkOperations.getChildren(fun, LINKS.args$XOIh)).findFirst((it) -> Objects.equals(SPropertyOperations.getString(it, PROPS.name$MnvL), SPropertyOperations.getString(SLinkOperations.getTarget(pr, LINKS.param$AS0o), PROPS.name$MnvL))))));

    return fun;
  }


  public SNode evalOutport(final SNode out) {
    SNode conn = ListSequence.fromList(SLinkOperations.getChildren(block, LINKS.connectors$M0o8)).where((it) -> (boolean) Connector__BehaviorDescriptor.connectsToOutsidePort_id5Q9FzcI4YUK.invoke(it, out)).first();
    return evalEndpoint(SLinkOperations.getTarget(conn, LINKS.left$rT$n));
  }

  public SNode evalInPort(final SNode in) {
    return createArgRef_fvmzc9_a0a21(ListSequence.fromList(SLinkOperations.getChildren(this.function, LINKS.args$XOIh)).findFirst((it) -> Objects.equals(SPropertyOperations.getString(it, PROPS.name$MnvL), SPropertyOperations.getString(in, PROPS.name$MnvL))));
  }

  public SNode evalInstance(final SNode instance, SNode out) {
    SNode b = SLinkOperations.getTarget(instance, LINKS.block$aVz7);

    if (MapSequence.fromMap(myCollector).get(b) == null) {
      MapSequence.fromMap(myCollector).put(b, Block__BehaviorDescriptor.makeFunction_id2nByCcx_v36.invoke(b, myCollector));
    }
    SNode call = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x71934284d7d145eeL, 0xa0548c072591085fL, 0x427ce5230842b3ecL, "org.iets3.core.expr.toplevel.structure.FunctionCall"));
    SLinkOperations.setTarget(call, LINKS.function$xJRS, MapSequence.fromMap(myCollector).get(b));

    for (final SNode p : ListSequence.fromList(SLinkOperations.getChildren(b, LINKS.params$7rRh))) {
      ListSequence.fromList(SLinkOperations.getChildren(call, LINKS.args$xJpQ)).addElement(SNodeOperations.copyNode(SLinkOperations.getTarget(ListSequence.fromList(SLinkOperations.getChildren(instance, LINKS.paramValues$mkq$)).findFirst((it) -> SLinkOperations.getTarget(it, LINKS.param$UNjl) == p), LINKS.expr$CW3E)));
    }
    for (final SNode in : ListSequence.fromList(SLinkOperations.getChildren(b, LINKS.inports$dl2o))) {
      SNode conn = ListSequence.fromList(SLinkOperations.getChildren(this.block, LINKS.connectors$M0o8)).findFirst((it) -> (boolean) Connector__BehaviorDescriptor.connectsToInsideInPort_id5Q9FzcI6bZ6.invoke(it, instance, in));
      ListSequence.fromList(SLinkOperations.getChildren(call, LINKS.args$xJpQ)).addElement(evalEndpoint(SLinkOperations.getTarget(conn, LINKS.left$rT$n)));
    }
    return call;
  }

  public SNode evalEndpoint(SNode e) {
    if (SNodeOperations.isInstanceOf(e, CONCEPTS.OutsideEndpoint$pO)) {
      return evalInPort(SNodeOperations.cast(SLinkOperations.getTarget(SNodeOperations.cast(e, CONCEPTS.OutsideEndpoint$pO), LINKS.port$zHo1), CONCEPTS.InPort$Ah));
    } else {
      return evalInstance(SLinkOperations.getTarget(SNodeOperations.cast(e, CONCEPTS.InsideEndpoint$Ek), LINKS.instance$qJ6s), SNodeOperations.cast(SLinkOperations.getTarget(e, LINKS.port$zHo1), CONCEPTS.OutPort$FI));
    }
  }

  private static SNode createArgRef_fvmzc9_a0a0a0a0d0h(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ArgRef$HM);
    n0.setReferenceTarget(LINKS.arg$Nd6m, p0);
    return n0.getResult();
  }
  private static SNode createArgRef_fvmzc9_a0a0a0a0e0h(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ArgRef$HM);
    n0.setReferenceTarget(LINKS.arg$Nd6m, p0);
    return n0.getResult();
  }
  private static SNode createArgRef_fvmzc9_a0a21(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ArgRef$HM);
    n0.setReferenceTarget(LINKS.arg$Nd6m, p0);
    return n0.getResult();
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink body$Y8TB = MetaAdapterFactory.getContainmentLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x427ce523083b8a2fL, 0x427ce523083b8a56L, "body");
    /*package*/ static final SContainmentLink outports$xLwx = MetaAdapterFactory.getContainmentLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716a5aL, 0x4f91a4533f716c71L, "outports");
    /*package*/ static final SContainmentLink values$FZYa = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0xe2477421831765aL, 0xe2477421831765bL, "values");
    /*package*/ static final SContainmentLink args$XOIh = MetaAdapterFactory.getContainmentLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x427ce523083b8a2fL, 0x427ce523083b8a3fL, "args");
    /*package*/ static final SReferenceLink port$_Q9r = MetaAdapterFactory.getReferenceLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716cc3L, 0x4f91a4533f716cc4L, "port");
    /*package*/ static final SReferenceLink param$AS0o = MetaAdapterFactory.getReferenceLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x27d47effb8cbcbc7L, 0x27d47effb8cbcbe6L, "param");
    /*package*/ static final SContainmentLink connectors$M0o8 = MetaAdapterFactory.getContainmentLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716a5dL, 0x395649586dd3ac0dL, "connectors");
    /*package*/ static final SContainmentLink left$rT$n = MetaAdapterFactory.getContainmentLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x395649586dce5477L, 0x395649586dced341L, "left");
    /*package*/ static final SReferenceLink block$aVz7 = MetaAdapterFactory.getReferenceLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716a61L, 0x395649586dbb837cL, "block");
    /*package*/ static final SReferenceLink function$xJRS = MetaAdapterFactory.getReferenceLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x427ce5230841f89cL, 0x427ce5230841f8a8L, "function");
    /*package*/ static final SContainmentLink args$xJpQ = MetaAdapterFactory.getContainmentLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x427ce5230841f89cL, 0x427ce5230841f8a6L, "args");
    /*package*/ static final SContainmentLink paramValues$mkq$ = MetaAdapterFactory.getContainmentLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716a61L, 0x27d47effb8db0ac1L, "paramValues");
    /*package*/ static final SReferenceLink param$UNjl = MetaAdapterFactory.getReferenceLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x27d47effb8daa7e4L, 0x27d47effb8daa80bL, "param");
    /*package*/ static final SContainmentLink expr$CW3E = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x3b256bb6ae8048d8L, 0x3b256bb6ae8048d9L, "expr");
    /*package*/ static final SContainmentLink params$7rRh = MetaAdapterFactory.getContainmentLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716a5aL, 0x5d89ae332e211052L, "params");
    /*package*/ static final SContainmentLink inports$dl2o = MetaAdapterFactory.getContainmentLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716a5aL, 0x4f91a4533f716a58L, "inports");
    /*package*/ static final SReferenceLink port$zHo1 = MetaAdapterFactory.getReferenceLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x395649586dce555cL, 0x395649586dce5726L, "port");
    /*package*/ static final SReferenceLink instance$qJ6s = MetaAdapterFactory.getReferenceLink(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x395649586dce5728L, 0x216b83c328c0ebb1L, "instance");
    /*package*/ static final SReferenceLink arg$Nd6m = MetaAdapterFactory.getReferenceLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x427ce523084037adL, 0x427ce52308410686L, "arg");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept InportRef$NA = MetaAdapterFactory.getConcept(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716cc3L, "org.iets3.core.expr.dataflow.structure.InportRef");
    /*package*/ static final SConcept ParamRef$bF = MetaAdapterFactory.getConcept(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x27d47effb8cbcbc7L, "org.iets3.core.expr.dataflow.structure.ParamRef");
    /*package*/ static final SConcept OutsideEndpoint$pO = MetaAdapterFactory.getConcept(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x395649586dce5641L, "org.iets3.core.expr.dataflow.structure.OutsideEndpoint");
    /*package*/ static final SConcept InPort$Ah = MetaAdapterFactory.getConcept(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f7169a0L, "org.iets3.core.expr.dataflow.structure.InPort");
    /*package*/ static final SConcept InsideEndpoint$Ek = MetaAdapterFactory.getConcept(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x395649586dce5728L, "org.iets3.core.expr.dataflow.structure.InsideEndpoint");
    /*package*/ static final SConcept OutPort$FI = MetaAdapterFactory.getConcept(0xcee4aa62aca94f26L, 0x960275129cd457c9L, 0x4f91a4533f716b2fL, "org.iets3.core.expr.dataflow.structure.OutPort");
    /*package*/ static final SConcept ArgRef$HM = MetaAdapterFactory.getConcept(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x427ce523084037adL, "org.iets3.core.expr.lambda.structure.ArgRef");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }
}
