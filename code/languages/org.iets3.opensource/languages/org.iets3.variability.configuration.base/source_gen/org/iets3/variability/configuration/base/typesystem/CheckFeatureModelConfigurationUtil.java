package org.iets3.variability.configuration.base.typesystem;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import org.iets3.variability.configuration.base.plugin.FMCTraversal;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SEnumOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.iets3.variability.configuration.base.behavior.AbstractFeatureConfiguration__BehaviorDescriptor;
import org.iets3.variability.configuration.base.behavior.ConfigCursor;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.iets3.variability.configuration.base.plugin.FeatureAttributeAssignmentUtil;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class CheckFeatureModelConfigurationUtil {

  public static void handleAttributes(final SNode fmc, final _FunctionTypes._void_P2_E0<? super String, ? super SNode> warner) {
    FMCTraversal.Result traverseConfigsUnselection = FMCTraversal.traverseConfigs(fmc, (cc) -> SPropertyOperations.getEnum(cc.asNode(), PROPS.selectionState$zbc1) == SEnumOperations.getMember(MetaAdapterFactory.getEnumeration(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x5db06c237c250a73L, "org.iets3.variability.featuremodel.base.structure.FeatureSelectionState"), 0x5db06c237c250a74L, "untouched") && (boolean) AbstractFeatureConfiguration__BehaviorDescriptor.hasParentConfig_id2NjwOUXrBy.invoke(cc.asNode()));

    traverseConfigsUnselection.earlyStopped.ifPresent((es) -> {
      ConfigCursor cc = es.left;
      List<SNode> afcPath = es.right;
      final String msg = "Please make a selection";
      ListSequence.fromList(afcPath).visitAll((it) -> warner.invoke(msg, SLinkOperations.getTarget(it, LINKS.content$Wdfq)));
      warner.invoke(msg, cc.asNode());
      warner.invoke("Configuration selection is not complete - either complete selection or set configuration to abstract", fmc);
    });

    // Early abort when missing selection
    if (traverseConfigsUnselection.earlyStopped.isPresent()) {
      return;
    }

    FMCTraversal.Result traverseConfigsUnassignedAttribute = FMCTraversal.traverseConfigs(fmc, (cc) -> Sequence.fromIterable(AbstractFeatureConfiguration__BehaviorDescriptor.attributeAssignments_id30ECcbtQkN2.invoke(cc.asNode())).any((attribute) -> FeatureAttributeAssignmentUtil.isUnassignedAttribute(attribute)));

    traverseConfigsUnassignedAttribute.earlyStopped.ifPresent((es) -> {
      ConfigCursor cc = es.left;
      List<SNode> afcPath = es.right;
      SNode missingAttributeAssognment = Sequence.fromIterable(AbstractFeatureConfiguration__BehaviorDescriptor.attributeAssignments_id30ECcbtQkN2.invoke(cc.asNode())).findFirst((attribute) -> FeatureAttributeAssignmentUtil.isUnassignedAttribute(attribute));

      String msg = "Attribute Value is missing";
      warner.invoke(msg, missingAttributeAssognment);
      String msgDetailed = msg + " in Attribute " + SPropertyOperations.getString(SLinkOperations.getTarget(missingAttributeAssognment, LINKS.attribute$J5jI), PROPS.name$MnvL);
      warner.invoke(msgDetailed, fmc);
      final String msgForRefs = msgDetailed + ". Follow references to find!";
      ListSequence.fromList(afcPath).visitAll((node) -> warner.invoke(msgForRefs, SLinkOperations.getTarget(node, LINKS.content$Wdfq)));
    });
  }

  private static final class PROPS {
    /*package*/ static final SProperty selectionState$zbc1 = MetaAdapterFactory.getProperty(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x302aa0c2ddab8940L, 0x526bcda9b5a2fcdbL, "selectionState");
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink content$Wdfq = MetaAdapterFactory.getContainmentLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x302aa0c2ddab8940L, 0x5cf5c0d0479f4bc8L, "content");
    /*package*/ static final SReferenceLink attribute$J5jI = MetaAdapterFactory.getReferenceLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x302aa0c2ddc5ae16L, 0x302aa0c2ddca3d88L, "attribute");
  }
}
