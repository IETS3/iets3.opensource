package org.iets3.variability.configuration.base.behavior;

/*Generated by MPS */

import java.util.List;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.iets3.variability.featuremodel.base.behavior.AbstractFeature__BehaviorDescriptor;
import org.iets3.variability.featuremodel.base.behavior.FeatureTreeNode__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import java.util.Collections;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.Objects;
import org.iets3.variability.featuremodel.base.behavior.Cardinality__BehaviorDescriptor;
import com.google.common.collect.Lists;
import com.google.common.collect.Iterables;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;

/**
 * 
 */
public class ChildActions {

  public static List<Action> childActionsByFeature(SNode feature) {
    Iterable<Action> featureAttributeActions = Sequence.fromIterable(AbstractFeature__BehaviorDescriptor.attributes_id6GZHy357BWb.invoke(FeatureTreeNode__BehaviorDescriptor.effectiveFeature_id6GZHy352t67.invoke(feature))).select((it) -> new AddAttribute(it));
    return concat(childFeaturesToActions(feature), featureAttributeActions);
  }

  public static List<Action> childActionsByConfig(SNode config) {
    if (isCardinalityConfig(config)) {
      return childrenForConfigWithCardinality(SNodeOperations.cast(config, CONCEPTS.FeatureWithCardinalityConfiguration$iu));
    }
    return childrenForConfigWithoutCardinality(config);
  }

  private static Iterable<Action> childFeaturesToActions(SNode feature) {
    return Sequence.fromIterable(AbstractFeature__BehaviorDescriptor.subFeatures_id6GZHy357BW_.invoke(FeatureTreeNode__BehaviorDescriptor.effectiveFeature_id6GZHy352t67.invoke(feature))).select((it) -> makeAddConfigByFeature(it));
  }

  private static Action makeAddConfigByFeature(SNode feature) {
    return (isCardinalityFeature(feature) ? new AddConfigByCardinalityFeature(feature) : new AddConfigByFeature(feature));
  }

  private static List<Action> childrenForConfigWithoutCardinality(SNode config) {
    {
      final SNode content = SLinkOperations.getTarget(config, LINKS.content$Wdfq);
      if (SNodeOperations.isInstanceOf(content, CONCEPTS.InlineFeatureConfigurationContent$P5)) {
        return concat(ChildActions.subfeatureActions(content), ChildActions.moveNewFeatureSubConfigurationsToConfiguration(config, content), ChildActions.attributeActions(content, config));
      }
    }
    return Collections.emptyList();
  }

  private static List<Action> subfeatureActions(SNode content) {
    return ListSequence.fromList(SLinkOperations.getChildren(content, LINKS.subfeatureConfigurations$l9wi)).select((childConfig) -> createActionForConfig(childConfig)).toList();
  }

  private static List<Action> moveNewFeatureSubConfigurationsToConfiguration(SNode config, SNode content) {
    return Sequence.fromIterable(ChildActions.childFeaturesNotInConfigurationContent(AbstractFeature__BehaviorDescriptor.subFeatures_id6GZHy357BW_.invoke(FeatureTreeNode__BehaviorDescriptor.effectiveFeature_id6GZHy352t67.invoke(SLinkOperations.getTarget(config, LINKS.targetFeature$16lA))), content)).select((it) -> makeAddConfigByFeature(it)).toList();
  }

  private static Iterable<SNode> childFeaturesNotInConfigurationContent(Iterable<SNode> childFeatures, final SNode content) {
    return Sequence.fromIterable(childFeatures).where((final SNode it) -> !(ListSequence.fromList(SLinkOperations.getChildren(content, LINKS.subfeatureConfigurations$l9wi)).any((it2) -> Objects.equals(SLinkOperations.getTarget(it2, LINKS.targetFeature$16lA), it))));
  }

  private static List<Action> attributeActions(SNode content, SNode config) {
    return concat(ChildActions.shouldBeAddedFeatureAttributes(config, content), ChildActions.shouldBeRemovedFeatureAttributes(content));
  }

  private static Iterable<Action> shouldBeAddedFeatureAttributes(SNode config, SNode content) {
    return Sequence.fromIterable(ChildActions.featureAttributesNotInConfig(config, content)).select((it) -> new AddAttribute(it));
  }

  private static Iterable<Action> shouldBeRemovedFeatureAttributes(SNode content) {
    return ListSequence.fromList(SLinkOperations.getChildren(content, LINKS.attributeAssignments$seL5)).where((it) -> (SLinkOperations.getTarget(it, LINKS.attribute$J5jI) == null)).select((it) -> new RemoveAttribute(it));
  }

  private static Iterable<SNode> featureAttributesNotInConfig(SNode config, final SNode content) {
    return Sequence.fromIterable(AbstractFeature__BehaviorDescriptor.attributes_id6GZHy357BWb.invoke(FeatureTreeNode__BehaviorDescriptor.effectiveFeature_id6GZHy352t67.invoke(SLinkOperations.getTarget(config, LINKS.targetFeature$16lA)))).where((final SNode featAtt) -> !(ListSequence.fromList(SLinkOperations.getChildren(content, LINKS.attributeAssignments$seL5)).any((confAttAssign) -> Objects.equals(SLinkOperations.getTarget(confAttAssign, LINKS.attribute$J5jI), featAtt))));
  }

  private static List<Action> childrenForConfigWithCardinality(SNode config) {
    List<SNode> subfeatureConfigurations = SLinkOperations.getChildren((SNodeOperations.cast(SLinkOperations.getTarget(config, LINKS.content$Wdfq), CONCEPTS.InlineFeatureConfigurationContent$P5)), LINKS.subfeatureConfigurations$l9wi);
    int cardinalities = ListSequence.fromList(subfeatureConfigurations).count();
    int lowerbound = (int) FeatureTreeNode__BehaviorDescriptor.effectiveLower_id54HsVvOxxSB.invoke(SLinkOperations.getTarget(config, LINKS.targetFeature$16lA));
    int retainbleItems = ChildActions.retainableItems(config, cardinalities);
    int lowerBoundIncrease = Math.max(0, lowerbound - cardinalities);

    return concat(ChildActions.retainableItemsActions(subfeatureConfigurations, retainbleItems), ChildActions.superfluousItemsActions(subfeatureConfigurations, retainbleItems, cardinalities), ChildActions.lowerBoundIncreaseActions(config, lowerBoundIncrease));
  }

  private static List<Action> lowerBoundIncreaseActions(SNode config, int lowerBoundIncrease) {
    return (lowerBoundIncrease > 0 ? Collections.<Action>singletonList(new IncreaseLowerBoundOfCardinality(SLinkOperations.getTarget(config, LINKS.targetFeature$16lA), lowerBoundIncrease)) : Collections.<Action>emptyList());
  }

  private static Iterable<Action> superfluousItemsActions(List<SNode> subfeatureConfigurations, int retainableItems, int actualBound) {
    return ListSequence.fromList((ListSequence.fromList(subfeatureConfigurations).subListSequence(retainableItems, actualBound))).select((it) -> RemoveNode.removeByCardinalityReduction(it));
  }

  private static Iterable<Action> retainableItemsActions(List<SNode> subfeatureConfigurations, int mandatoryItems) {
    return ListSequence.fromList(subfeatureConfigurations).subListSequence(0, mandatoryItems).where((it) -> SNodeOperations.isInstanceOf(SLinkOperations.getTarget(it, LINKS.content$Wdfq), CONCEPTS.InlineFeatureConfigurationContent$P5)).select((it) -> new KeepInlineConfig(SNodeOperations.present(it) + "", SNodeOperations.cast(SLinkOperations.getTarget(it, LINKS.content$Wdfq), CONCEPTS.InlineFeatureConfigurationContent$P5), childActionsByConfig(it)));
  }

  private static int retainableItems(SNode config, int actualBound) {
    int upperbound = ((boolean) Cardinality__BehaviorDescriptor.hasInfiniteUpperBound_id7Wa2sv3F32k.invoke(SLinkOperations.getTarget(SLinkOperations.getTarget(config, LINKS.targetFeature$16lA), LINKS.cardinality$EsDt)) ? Integer.MAX_VALUE : (int) FeatureTreeNode__BehaviorDescriptor.effectiveUpper_id54HsVvOxyJa.invoke(SLinkOperations.getTarget(config, LINKS.targetFeature$16lA)));

    return Math.min(actualBound, upperbound);
  }

  private static Action createActionForConfig(SNode config) {
    if ((SLinkOperations.getTarget(config, LINKS.targetFeature$16lA) == null)) {
      return RemoveNode.removeByNoTargetFeature(config);
    }

    if (featureParentNotEqualConfigFeatureParent(config)) {
      return RemoveNode.removeByDifferingParent(config);
    }

    if (isCardinalityConfig(config) && configHasCardinalityFeature(config)) {
      return new KeepInlineConfig(SNodeOperations.present(config) + "", SNodeOperations.cast(SLinkOperations.getTarget(config, LINKS.content$Wdfq), CONCEPTS.InlineFeatureConfigurationContent$P5), ChildActions.childActionsByConfig(config));
    }
    if (isCardinalityConfig(config)) {
      return new RemoveCardinality(SNodeOperations.cast(config, CONCEPTS.FeatureWithCardinalityConfiguration$iu));
    }
    if (configHasCardinalityFeature(config)) {
      return new IntroduceCardinality(SNodeOperations.cast(config, CONCEPTS.FeatureConfiguration$x2));
    }
    if (isInlineConfig(config)) {
      return new KeepInlineConfig(SNodeOperations.present(config) + "", SNodeOperations.cast(SLinkOperations.getTarget(config, LINKS.content$Wdfq), CONCEPTS.InlineFeatureConfigurationContent$P5), childActionsByConfig(config));
    }
    return new Action();
  }

  private static boolean featureParentNotEqualConfigFeatureParent(SNode config) {
    {
      final SNode configParent = ChildActions.parentConfiguration(config);
      if (SNodeOperations.isInstanceOf(configParent, CONCEPTS.AbstractFeatureConfiguration$3P)) {
        {
          final SNode featureParent = SNodeOperations.getParent(SLinkOperations.getTarget(config, LINKS.targetFeature$16lA));
          if (SNodeOperations.isInstanceOf(featureParent, CONCEPTS.FeatureTreeNode$HV)) {
            return !(Objects.equals(FeatureTreeNode__BehaviorDescriptor.effectiveFeature_id6GZHy352t67.invoke(SLinkOperations.getTarget(configParent, LINKS.targetFeature$16lA)), featureParent));
          }
        }
      }
    }
    return false;
  }

  private static SNode parentConfiguration(SNode config) {
    // We have to take 2 steps as a 'Content' Concept is inbetween
    return SNodeOperations.getParent(SNodeOperations.getParent(config));
  }

  private static boolean isInlineConfig(SNode config) {
    return SNodeOperations.isInstanceOf(config, CONCEPTS.FeatureConfiguration$x2) && SNodeOperations.isInstanceOf(SLinkOperations.getTarget(config, LINKS.content$Wdfq), CONCEPTS.InlineFeatureConfigurationContent$P5);
  }

  private static boolean configHasCardinalityFeature(SNode config) {
    return isCardinalityFeature(SLinkOperations.getTarget(config, LINKS.targetFeature$16lA));
  }

  public static boolean isCardinalityFeature(SNode feature) {
    return (SLinkOperations.getTarget(feature, LINKS.cardinality$EsDt) != null);
  }


  private static boolean isCardinalityConfig(SNode config) {
    return SNodeOperations.isInstanceOf(config, CONCEPTS.FeatureWithCardinalityConfiguration$iu) && SNodeOperations.isInstanceOf(SLinkOperations.getTarget(config, LINKS.content$Wdfq), CONCEPTS.InlineFeatureConfigurationContent$P5);
  }

  private static <T> List<T> concat(Iterable<T>... itertables) {
    return Lists.newArrayList(Iterables.concat(itertables));
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept FeatureWithCardinalityConfiguration$iu = MetaAdapterFactory.getConcept(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x55c09a0155d9c97cL, "org.iets3.variability.configuration.base.structure.FeatureWithCardinalityConfiguration");
    /*package*/ static final SConcept InlineFeatureConfigurationContent$P5 = MetaAdapterFactory.getConcept(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479f4bfcL, "org.iets3.variability.configuration.base.structure.InlineFeatureConfigurationContent");
    /*package*/ static final SConcept FeatureConfiguration$x2 = MetaAdapterFactory.getConcept(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479ec91dL, "org.iets3.variability.configuration.base.structure.FeatureConfiguration");
    /*package*/ static final SConcept AbstractFeatureConfiguration$3P = MetaAdapterFactory.getConcept(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x302aa0c2ddab8940L, "org.iets3.variability.configuration.base.structure.AbstractFeatureConfiguration");
    /*package*/ static final SConcept FeatureTreeNode$HV = MetaAdapterFactory.getConcept(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x375cadc475172167L, "org.iets3.variability.featuremodel.base.structure.FeatureTreeNode");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink content$Wdfq = MetaAdapterFactory.getContainmentLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x302aa0c2ddab8940L, 0x5cf5c0d0479f4bc8L, "content");
    /*package*/ static final SContainmentLink subfeatureConfigurations$l9wi = MetaAdapterFactory.getContainmentLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479f4bfcL, 0x5cf5c0d0479ec91aL, "subfeatureConfigurations");
    /*package*/ static final SReferenceLink targetFeature$16lA = MetaAdapterFactory.getReferenceLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x302aa0c2ddab8940L, 0x5cf5c0d0479ec91eL, "targetFeature");
    /*package*/ static final SContainmentLink attributeAssignments$seL5 = MetaAdapterFactory.getContainmentLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479f4bfcL, 0x302aa0c2ddc5ae13L, "attributeAssignments");
    /*package*/ static final SReferenceLink attribute$J5jI = MetaAdapterFactory.getReferenceLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x302aa0c2ddc5ae16L, 0x302aa0c2ddca3d88L, "attribute");
    /*package*/ static final SContainmentLink cardinality$EsDt = MetaAdapterFactory.getContainmentLink(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x375cadc475172167L, 0x375cadc47519250cL, "cardinality");
  }
}
