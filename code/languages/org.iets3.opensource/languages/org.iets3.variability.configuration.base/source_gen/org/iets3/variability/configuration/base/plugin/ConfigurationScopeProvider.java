package org.iets3.variability.configuration.base.plugin;

/*Generated by MPS */

import jetbrains.mps.scope.Scope;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.scope.ModelPlusImportedScope;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.scope.FilteringScope;
import java.util.Objects;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class ConfigurationScopeProvider {

  /**
   * Get a scope with all configurations for a given root feature, in the current model and its dependencies
   * 
   * @param context a node which defines the current model
   * @param fmRootFeature the root feature to which the configurations should match
   * @return the scope of configurations
   */
  public static Scope configurationsScope(SNode context, final SNode fmRootFeature) {
    ModelPlusImportedScope all = new ModelPlusImportedScope(SNodeOperations.getModel(context), false, CONCEPTS.FeatureModelConfiguration$nE);
    return new FilteringScope(all) {
      @Override
      public boolean isExcluded(SNode node) {
        // exclude non-root-features and configurations in comments
        return !(isValidConfig(SNodeOperations.cast(node, CONCEPTS.FeatureModelConfiguration$nE), fmRootFeature));
      }
    };
  }

  public static boolean isValidConfig(SNode config, final SNode fmRootFeature) {
    // config must match feature model and must not be commented out
    return (Objects.equals(SLinkOperations.getTarget(config, LINKS.targetFeature$16lA), fmRootFeature)) && ((SNodeOperations.getNodeAncestor(config, CONCEPTS.BaseCommentAttribute$nv, false, false) == null));
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept FeatureModelConfiguration$nE = MetaAdapterFactory.getConcept(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479ec915L, "org.iets3.variability.configuration.base.structure.FeatureModelConfiguration");
    /*package*/ static final SConcept BaseCommentAttribute$nv = MetaAdapterFactory.getConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x3dcc194340c24debL, "jetbrains.mps.lang.core.structure.BaseCommentAttribute");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink targetFeature$16lA = MetaAdapterFactory.getReferenceLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x302aa0c2ddab8940L, 0x5cf5c0d0479ec91eL, "targetFeature");
  }
}
