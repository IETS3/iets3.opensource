package org.iets3.variability.configuration.base.behavior;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.util.List;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.Collections;
import com.google.common.collect.Lists;
import java.util.function.Function;
import java.util.stream.Stream;
import java.util.stream.Collectors;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SConcept;

/**
 * Removes a node.
 */
public class RemoveNode extends Action {
  private final SNode config;

  private RemoveNode(List<SNode> configExchangeCandidate, SNode config, List<Action> children) {
    super(configExchangeCandidate, children);
    this.config = config;
  }

  private static List<SNode> createConfigurationExchangeCandidates(SNode node) {
    // share children to market
    {
      final SNode content = SLinkOperations.getTarget(node, LINKS.content$Wdfq);
      if (SNodeOperations.isInstanceOf(content, CONCEPTS.InlineFeatureConfigurationContent$P5)) {
        return ListSequence.fromList(SLinkOperations.getChildren(content, LINKS.subfeatureConfigurations$l9wi)).where((it) -> (SLinkOperations.getTarget(it, LINKS.targetFeature$16lA) != null)).toList();
      }
    }

    return Collections.emptyList();
  }

  private static List<Action> subactions(SNode node) {
    Iterable<List<Action>> actions = ListSequence.fromList(createConfigurationExchangeCandidates(node)).select((it) -> ChildActions.childActionsByConfig(it));
    return Lists.newArrayList(actions).stream().flatMap(new Function<List<Action>, Stream<Action>>() {
      public Stream<Action> apply(List<Action> actions) {
        return Lists.newArrayList(actions).stream();
      }
    }).collect(Collectors.<Action>toList());
  }

  public static RemoveNode removeByNoTargetFeature(SNode config) {
    return new RemoveNode(createConfigurationExchangeCandidates(config), config, subactions(config));
  }

  public static RemoveNode removeByCardinalityReduction(SNode config) {
    return new RemoveNode(Collections.<SNode>emptyList(), config, Collections.<Action>emptyList());
  }

  public static RemoveNode removeByDifferingParent(SNode config) {
    return new RemoveNode(Collections.<SNode>singletonList(SNodeOperations.cast(config, CONCEPTS.FeatureConfiguration$x2)), config, ChildActions.childActionsByConfig(config));
  }


  @Override
  public Iterable<SNode> applyTo(SNode parent) {
    {
      final SNode ifcc = parent;
      if (SNodeOperations.isInstanceOf(ifcc, CONCEPTS.InlineFeatureConfigurationContent$P5)) {
        // this is _not_ equivalent to detach(): we may remove the node only if it's still in the original parent.
        ListSequence.fromList(SLinkOperations.getChildren(ifcc, LINKS.subfeatureConfigurations$l9wi)).removeWhere((it) -> it == config);
      }
    }
    return Collections.emptyList();
  }

  @Override
  public String toString() {
    return "remove " + SNodeOperations.present(config);
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink content$Wdfq = MetaAdapterFactory.getContainmentLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x302aa0c2ddab8940L, 0x5cf5c0d0479f4bc8L, "content");
    /*package*/ static final SContainmentLink subfeatureConfigurations$l9wi = MetaAdapterFactory.getContainmentLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479f4bfcL, 0x5cf5c0d0479ec91aL, "subfeatureConfigurations");
    /*package*/ static final SReferenceLink targetFeature$16lA = MetaAdapterFactory.getReferenceLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x302aa0c2ddab8940L, 0x5cf5c0d0479ec91eL, "targetFeature");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept InlineFeatureConfigurationContent$P5 = MetaAdapterFactory.getConcept(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479f4bfcL, "org.iets3.variability.configuration.base.structure.InlineFeatureConfigurationContent");
    /*package*/ static final SConcept FeatureConfiguration$x2 = MetaAdapterFactory.getConcept(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479ec91dL, "org.iets3.variability.configuration.base.structure.FeatureConfiguration");
  }
}
