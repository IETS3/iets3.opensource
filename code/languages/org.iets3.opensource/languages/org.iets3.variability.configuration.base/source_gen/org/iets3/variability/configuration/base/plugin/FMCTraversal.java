package org.iets3.variability.configuration.base.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import org.iets3.variability.configuration.base.behavior.ConfigCursor;
import com.google.common.collect.ImmutableMap;
import org.apache.commons.lang3.tuple.ImmutablePair;
import java.util.List;
import java.util.Collection;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import org.apache.commons.lang3.tuple.Pair;
import java.util.Optional;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.google.common.collect.Lists;
import java.util.Collections;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.IterableUtils;
import org.apache.commons.lang3.builder.HashCodeBuilder;
import org.apache.commons.lang3.builder.EqualsBuilder;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class FMCTraversal {

  public static Result traverseConfigs(SNode afc) {
    return traverseConfigs(afc, (_n) -> false);
  }

  public static Result traverseConfigs(SNode afc, _FunctionTypes._return_P1_E0<? extends Boolean, ? super ConfigCursor> earlyStop) {
    Akkumulator akkumulator = new Akkumulator();
    traverseHlp(ConfigCursor.create(afc), akkumulator, earlyStop);
    return new Result(akkumulator.pathConfigs, akkumulator.earlyStopped());
  }

  public static ImmutableMap<ImmutablePair<SNode, List<SNode>>, SNode> asMap(Collection<PathConfig> pathConfigs) {
    return ImmutableMap.copyOf(CollectionSequence.fromCollection(pathConfigs).select((it) -> Pair.of(it.key(), it.config)));
  }

  private static void traverseHlp(ConfigCursor cc, Akkumulator akkumulator, _FunctionTypes._return_P1_E0<? extends Boolean, ? super ConfigCursor> earlyStop) {
    if (earlyStop.invoke(cc)) {
      akkumulator.setEarlyStop(cc);
      return;
    }
    Optional<SNode> fmi = Optional.ofNullable(SNodeOperations.as(cc.feature(), CONCEPTS.FeatureModelInclude$Iq));

    if (fmi.isPresent()) {
      akkumulator.addPathElement(cc);
    }
    akkumulator.addConfig(cc.asNode());
    // Recurse
    for (ConfigCursor subCC : CollectionSequence.fromCollection(cc.subConfigs())) {
      traverseHlp(subCC, akkumulator, earlyStop);
    }
    if (fmi.isPresent()) {
      akkumulator.removePathElement();
    }
  }


  private static class Akkumulator {
    private List<SNode> afcs = Lists.newLinkedList();
    private final List<SNode> fmis = Lists.newLinkedList();

    private Collection<PathConfig> pathConfigs = Lists.newLinkedList();
    private ConfigCursor earlyStopped;
    private List<SNode> earylStopPath = Collections.emptyList();

    /*package*/ void addPathElement(ConfigCursor fmi) {
      ListSequence.fromList(this.afcs).addElement(fmi.asNode());
      ListSequence.fromList(this.fmis).addElement(SNodeOperations.cast(SLinkOperations.getTarget(fmi.asNode(), LINKS.targetFeature$16lA), CONCEPTS.FeatureModelInclude$Iq));
    }

    /*package*/ void removePathElement() {
      ListSequence.fromList(this.afcs).removeLastElement();
      ListSequence.fromList(this.fmis).removeLastElement();
    }

    private void addConfig(SNode config) {
      CollectionSequence.fromCollection(this.pathConfigs).addElement(new PathConfig(config, Lists.newLinkedList(this.afcs), Lists.newLinkedList(this.fmis)));
    }

    private void setEarlyStop(ConfigCursor cc) {
      this.earlyStopped = cc;
      this.earylStopPath = Lists.newLinkedList(this.afcs);
    }

    private Optional<ImmutablePair<ConfigCursor, List<SNode>>> earlyStopped() {
      return Optional.ofNullable(this.earlyStopped).map((p1) -> ImmutablePair.of(p1, Akkumulator.this.earylStopPath));
    }
  }

  public static class Result {
    public final Collection<PathConfig> pathConfigs;
    public final Optional<ImmutablePair<ConfigCursor, List<SNode>>> earlyStopped;

    public Result(Collection<PathConfig> pathConfig, Optional<ImmutablePair<ConfigCursor, List<SNode>>> earlyStopped) {
      this.pathConfigs = pathConfig;
      this.earlyStopped = earlyStopped;
    }
  }

  public static class PathConfig {
    private final List<SNode> path;
    private final List<SNode> fmis;
    private final SNode config;
    public final SNode feature;

    public PathConfig(SNode config, List<SNode> path, List<SNode> fmis) {
      this.config = config;
      this.path = path;
      this.feature = SLinkOperations.getTarget(config, LINKS.targetFeature$16lA);
      this.fmis = fmis;
    }

    public List<SNode> configurationPath() {
      return this.path;
    }

    public List<SNode> featureModelIncludesPath() {
      return this.fmis;
    }

    public SNode configuration() {
      return this.config;
    }

    public ImmutablePair<SNode, List<SNode>> key() {
      return ImmutablePair.of(this.feature, this.featureModelIncludesPath());
    }


    @Override
    public String toString() {
      return IterableUtils.join(ListSequence.fromList(path).select((it) -> SNodeOperations.present(it)), "->") + "/" + SNodeOperations.present(this.config);
    }


    @Override
    public int hashCode() {
      return new HashCodeBuilder().append(path).append(config).append(this.feature).build();
    }

    @Override
    public boolean equals(Object obj) {
      if (!(obj instanceof PathConfig)) {
        return false;
      }
      PathConfig other = ((PathConfig) obj);
      return new EqualsBuilder().append(this.path, other.path).append(this.config, other.config).append(this.feature, other.feature).build();
    }
  }


  private static final class CONCEPTS {
    /*package*/ static final SConcept FeatureModelInclude$Iq = MetaAdapterFactory.getConcept(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x375cadc475172168L, "org.iets3.variability.featuremodel.base.structure.FeatureModelInclude");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink targetFeature$16lA = MetaAdapterFactory.getReferenceLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x302aa0c2ddab8940L, 0x5cf5c0d0479ec91eL, "targetFeature");
  }
}
