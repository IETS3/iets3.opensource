package org.iets3.variability.configuration.base.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.runtime.AbstractNonTypesystemRule_Runtime;
import jetbrains.mps.lang.typesystem.runtime.NonTypesystemRule_Runtime;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import jetbrains.mps.lang.typesystem.runtime.IsApplicableStatus;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.iets3.variability.base.behavior.IVariabilityContainer__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import java.util.Objects;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.errors.messageTargets.MessageTarget;
import jetbrains.mps.errors.messageTargets.NodeMessageTarget;
import jetbrains.mps.errors.IErrorReporter;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.iets3.variability.configuration.base.behavior.FeatureModelConfiguration__BehaviorDescriptor;
import jetbrains.mps.errors.BaseQuickFixProvider;
import java.util.List;
import org.apache.commons.lang3.tuple.Pair;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class check_FeatureModelConfiguration_NonTypesystemRule extends AbstractNonTypesystemRule_Runtime implements NonTypesystemRule_Runtime {
  public check_FeatureModelConfiguration_NonTypesystemRule() {
  }
  public void applyRule(final SNode fmc, final TypeCheckingContext typeCheckingContext, IsApplicableStatus status) {
    // check if name is unique in current container
    SNode container = SNodeOperations.getNodeAncestor(fmc, CONCEPTS.IVariabilityContainer$Cw, false, false);
    if ((container != null)) {
      // We have many tests where the same configuration is used as input and expected.
      // In order to avoid many false positives of this checking rule in the tests, we filter these out. 
      Iterable<SNode> allConfigs = SNodeOperations.ofConcept(IVariabilityContainer__BehaviorDescriptor.getContents_id22kx7U4Ix5a.invoke(container), CONCEPTS.FeatureModelConfiguration$nE);
      Iterable<SNode> configsWithoutTestAnnotation = Sequence.fromIterable(allConfigs).where((it) -> (new IAttributeDescriptor.NodeAttribute(CONCEPTS.TestNodeAnnotation$27).get(it) == null));
      if (Sequence.fromIterable(configsWithoutTestAnnotation).any((it) -> !(Objects.equals(it, fmc)) && Objects.equals(SPropertyOperations.getString(it, PROPS.name$MnvL), SPropertyOperations.getString(fmc, PROPS.name$MnvL)))) {
        {
          final MessageTarget errorTarget = new NodeMessageTarget();
          IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(fmc, "Configuration with duplicate name exists in current container", "r:791971f5-b094-4342-a75c-0ce6c1b43e9d(org.iets3.variability.configuration.base.typesystem)", "9159423170666523437", null, errorTarget);
        }
      }
    }

    // report error if cycle check found a problem
    if (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(fmc, LINKS.content$Wdfq), CONCEPTS.FeatureConfigurationErrorContent$W0)) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(fmc, "Configuration created for model with a dependency cycle. Fix the cycle first and then adapt to feature model.", "r:791971f5-b094-4342-a75c-0ce6c1b43e9d(org.iets3.variability.configuration.base.typesystem)", "3543850148881343487", null, errorTarget);
      }
      return;
    }

    for (SNode used : ListSequence.fromList(SLinkOperations.getChildren(fmc, LINKS.usedConfigs$WedD))) {
      for (SNode used2 : ListSequence.fromList(SLinkOperations.getChildren(fmc, LINKS.usedConfigs$WedD))) {
        if (!(Objects.equals(used, used2)) && Objects.equals(SLinkOperations.getTarget(used, LINKS.param$pwLK), SLinkOperations.getTarget(used2, LINKS.param$pwLK))) {
          {
            final MessageTarget errorTarget = new NodeMessageTarget();
            IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(used, "Duplicate specification for using-parameter", "r:791971f5-b094-4342-a75c-0ce6c1b43e9d(org.iets3.variability.configuration.base.typesystem)", "9038024733924024089", null, errorTarget);
          }
        }
      }
    }

    // Check if config fits to feature model. This is only done if config is on top of a 'extends'-hierarchy.
    if ((boolean) FeatureModelConfiguration__BehaviorDescriptor.shouldAdaptToFM_id2XyYtG$KzQT.invoke(fmc)) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(fmc, "There were changes in the Feature Model. Please adapt this config to its Feature Model.", "r:791971f5-b094-4342-a75c-0ce6c1b43e9d(org.iets3.variability.configuration.base.typesystem)", "3543850148881346922", null, errorTarget);
        {
          BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("org.iets3.variability.configuration.base.typesystem.propagateFMchangesToConfig_QuickFix", "4999651317663867413", false);
          intentionProvider.putArgument("fmc", fmc);
          _reporter_2309309498.addIntentionProvider(intentionProvider);
        }
      }
      return;
    }

    // Make sure that the current config can be integrated into the extends-hierarchy
    if ((new IAttributeDescriptor.NodeAttribute(CONCEPTS.FMCInheritanceCheck$Kn).get(fmc) != null) && (SLinkOperations.getTarget(SLinkOperations.getTarget(fmc, LINKS.extendedFMC$tFbw), LINKS.config$ID3f) != null)) {
      List<Pair<SNode, SNode>> FMCconflictingConfigs = Sequence.fromIterable(FeatureModelConfiguration__BehaviorDescriptor.conflictingConfigs_id39DASUy8gYy.invoke(fmc)).toList();

      if (ListSequence.fromList(FMCconflictingConfigs).isEmpty()) {
        {
          final MessageTarget errorTarget = new NodeMessageTarget();
          IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(fmc, "dummy for quickfix", "r:791971f5-b094-4342-a75c-0ce6c1b43e9d(org.iets3.variability.configuration.base.typesystem)", "3543850148881346873", null, errorTarget);
          {
            BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("org.iets3.variability.configuration.base.typesystem.fix_applyInheritance_QuickFix", "3543850148881346876", true);
            _reporter_2309309498.addIntentionProvider(intentionProvider);
          }
        }
        // success the attached automatic quick-fix integrates into the hierarchy
        return;
      } else {
        {
          final MessageTarget errorTarget = new NodeMessageTarget();
          IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(fmc, "Inheritance can not be applied here. There are inconsistencies between this configuration and the extended configuration.", "r:791971f5-b094-4342-a75c-0ce6c1b43e9d(org.iets3.variability.configuration.base.typesystem)", "3543850148881346886", null, errorTarget);
          {
            BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("org.iets3.variability.configuration.base.typesystem.fix_AdaptToExtendedFMC_QuickFix", "3543850148881346889", false);
            _reporter_2309309498.addIntentionProvider(intentionProvider);
          }
          {
            BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("org.iets3.variability.configuration.base.typesystem.fix_RemoveConflictingInheritance_QuickFix", "3543850148881346890", false);
            _reporter_2309309498.addIntentionProvider(intentionProvider);
          }
        }
        for (Pair<SNode, SNode> FMCconflictingConfig : ListSequence.fromList(FMCconflictingConfigs)) {
          {
            final MessageTarget errorTarget = new NodeMessageTarget();
            IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(FMCconflictingConfig.getValue(), "Conflict with extended configuration " + SPropertyOperations.getString(FMCconflictingConfig.getKey(), PROPS.name$MnvL), "r:791971f5-b094-4342-a75c-0ce6c1b43e9d(org.iets3.variability.configuration.base.typesystem)", "3543850148881346895", null, errorTarget);
          }
        }
        // failure no integration possible. The provided lazy quick-fixes will solve the situation.
      }
      return;
    }

    // At this point we know that the current config has been integrated into the extends-hierarchy
    // Check if the directly extended config changed
    if ((boolean) FeatureModelConfiguration__BehaviorDescriptor.shouldAdaptToExtendedFMC_id1v5X_U3jjTR.invoke(fmc)) {
      List<Pair<SNode, SNode>> FMCconflictingConfigs = Sequence.fromIterable(FeatureModelConfiguration__BehaviorDescriptor.conflictingConfigs_id39DASUy8gYy.invoke(fmc)).toList();

      if (ListSequence.fromList(FMCconflictingConfigs).isEmpty()) {
        {
          final MessageTarget errorTarget = new NodeMessageTarget();
          IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(fmc, "There were changes in the extended configuration. Please adapt this config to the config it extends.", "r:791971f5-b094-4342-a75c-0ce6c1b43e9d(org.iets3.variability.configuration.base.typesystem)", "3543850148881346941", null, errorTarget);
          {
            BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("org.iets3.variability.configuration.base.typesystem.fix_AdaptToExtendedFMC_QuickFix", "3543850148881346944", false);
            _reporter_2309309498.addIntentionProvider(intentionProvider);
          }
        }
      } else {
        {
          final MessageTarget errorTarget = new NodeMessageTarget();
          IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(fmc, "ATTENTION! There are inconsistencies between this configuration and a extended configuration due to changes in the extended configuration. Either Adapt this config to the extended config or remove inheritance.", "r:791971f5-b094-4342-a75c-0ce6c1b43e9d(org.iets3.variability.configuration.base.typesystem)", "3543850148881346954", null, errorTarget);
          {
            BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("org.iets3.variability.configuration.base.typesystem.fix_AdaptToExtendedFMC_QuickFix", "3543850148881346957", false);
            _reporter_2309309498.addIntentionProvider(intentionProvider);
          }
          {
            BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("org.iets3.variability.configuration.base.typesystem.fix_RemoveConflictingInheritance_QuickFix", "3543850148881346958", false);
            _reporter_2309309498.addIntentionProvider(intentionProvider);
          }
        }
        for (Pair<SNode, SNode> FMCconflictingConfig : ListSequence.fromList(FMCconflictingConfigs)) {
          {
            final MessageTarget errorTarget = new NodeMessageTarget();
            IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(FMCconflictingConfig.getValue(), "Conflict with extended configuration " + SPropertyOperations.getString(FMCconflictingConfig.getKey(), PROPS.name$MnvL), "r:791971f5-b094-4342-a75c-0ce6c1b43e9d(org.iets3.variability.configuration.base.typesystem)", "8133409599038458974", null, errorTarget);
          }
        }
      }
    }
    // Look for extended config in the hierarchy (parents) which must be adapted
    for (SNode extendedFMC : Sequence.fromIterable(FeatureModelConfiguration__BehaviorDescriptor.shouldAdaptAllExtendedConfigs_id1v5X_U3jBfx.invoke(fmc)).where((it) -> !(Objects.equals(it, fmc)))) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(fmc, "There were changes in the Feature Model. Please adapt config " + SPropertyOperations.getString(extendedFMC, PROPS.name$MnvL) + " to the Feature Model.", "r:791971f5-b094-4342-a75c-0ce6c1b43e9d(org.iets3.variability.configuration.base.typesystem)", "3543850148881347023", null, errorTarget);
      }
    }

    if (!((boolean) FeatureModelConfiguration__BehaviorDescriptor.isAbstractConfig_id4onczE5Z3D9.invoke(fmc))) {
      // If a abstract config is referenced the config itself must be abstract
      SNode abstractFMI = ListSequence.fromList(SNodeOperations.getNodeDescendants(fmc, CONCEPTS.FeatureModelConfigurationRef$kq, false, new SAbstractConcept[]{})).findFirst((it) -> SPropertyOperations.getBoolean(SLinkOperations.getTarget(it, LINKS.config$VWuN), PROPS.abstract$Wu4W));
      if (abstractFMI != null) {
        {
          final MessageTarget errorTarget = new NodeMessageTarget();
          IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(fmc, "Needs to be abstract, at least one abstract Feature Model Configuration referenced. " + SPropertyOperations.getString(SLinkOperations.getTarget(abstractFMI, LINKS.config$VWuN), PROPS.name$MnvL), "r:791971f5-b094-4342-a75c-0ce6c1b43e9d(org.iets3.variability.configuration.base.typesystem)", "4999651317681596651", null, errorTarget);
          {
            BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("org.iets3.variability.configuration.base.typesystem.makeConfigAbstract_QuickFix", "4999651317689220572", false);
            intentionProvider.putArgument("fmc", fmc);
            _reporter_2309309498.addIntentionProvider(intentionProvider);
          }
        }
        return;
      }
      // Show warnings for missing attributes
      CheckFeatureModelConfigurationUtil.handleAttributes(fmc, (String msg, SNode n) -> {
        {
          final MessageTarget errorTarget = new NodeMessageTarget();
          IErrorReporter _reporter_2309309498 = typeCheckingContext.reportWarning(n, msg, "r:791971f5-b094-4342-a75c-0ce6c1b43e9d(org.iets3.variability.configuration.base.typesystem)", "3543850148881346851", null, errorTarget);
        }
      });

      // Show warnings for missing with-parameters
      for (SNode undefParam : Sequence.fromIterable(FeatureModelConfiguration__BehaviorDescriptor.getMissingUsedConfigs_id3j7vM_E9Zts.invoke(fmc))) {
        {
          final MessageTarget errorTarget = new NodeMessageTarget();
          IErrorReporter _reporter_2309309498 = typeCheckingContext.reportWarning(fmc, "Missing configuration for using parameter '" + SPropertyOperations.getString(undefParam, PROPS.name$MnvL) + "'", "r:791971f5-b094-4342-a75c-0ce6c1b43e9d(org.iets3.variability.configuration.base.typesystem)", "3803148226192559284", null, errorTarget);
        }
      }
    }

    // Show solver errors
    if (SPropertyOperations.getBoolean(fmc, PROPS.hasSolverError$yxrG)) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(fmc, SPropertyOperations.getString(fmc, PROPS.solverErrorMessage$DYqd), "r:791971f5-b094-4342-a75c-0ce6c1b43e9d(org.iets3.variability.configuration.base.typesystem)", "5154894928108157633", null, errorTarget);
      }
      return;
    }

  }
  public SAbstractConcept getApplicableConcept() {
    return CONCEPTS.FeatureModelConfiguration$nE;
  }
  public IsApplicableStatus isApplicableAndPattern(SNode argument) {
    return new IsApplicableStatus(argument.getConcept().isSubConceptOf(getApplicableConcept()), null);
  }
  public boolean overrides() {
    return false;
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept IVariabilityContainer$Cw = MetaAdapterFactory.getInterfaceConcept(0x9b66c5c938bf4315L, 0xa96f9f4e212c69cbL, 0x2094847e8426ce97L, "org.iets3.variability.base.structure.IVariabilityContainer");
    /*package*/ static final SConcept FeatureModelConfiguration$nE = MetaAdapterFactory.getConcept(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479ec915L, "org.iets3.variability.configuration.base.structure.FeatureModelConfiguration");
    /*package*/ static final SConcept TestNodeAnnotation$27 = MetaAdapterFactory.getConcept(0x8585453e6bfb4d80L, 0x98deb16074f1d86cL, 0x119e1c6609cL, "jetbrains.mps.lang.test.structure.TestNodeAnnotation");
    /*package*/ static final SConcept FeatureConfigurationErrorContent$W0 = MetaAdapterFactory.getConcept(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x34aae17cd64425dbL, "org.iets3.variability.configuration.base.structure.FeatureConfigurationErrorContent");
    /*package*/ static final SConcept FMCInheritanceCheck$Kn = MetaAdapterFactory.getConcept(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x32699b8ea1ed143bL, "org.iets3.variability.configuration.base.structure.FMCInheritanceCheck");
    /*package*/ static final SConcept FeatureModelConfigurationRef$kq = MetaAdapterFactory.getConcept(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479eed6aL, "org.iets3.variability.configuration.base.structure.FeatureModelConfigurationRef");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
    /*package*/ static final SProperty abstract$Wu4W = MetaAdapterFactory.getProperty(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479ec915L, 0x4617323a85e85324L, "abstract");
    /*package*/ static final SProperty hasSolverError$yxrG = MetaAdapterFactory.getProperty(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479ec915L, 0x4789dda0139da333L, "hasSolverError");
    /*package*/ static final SProperty solverErrorMessage$DYqd = MetaAdapterFactory.getProperty(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479ec915L, 0x5ea937a3d8527c5fL, "solverErrorMessage");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink content$Wdfq = MetaAdapterFactory.getContainmentLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x302aa0c2ddab8940L, 0x5cf5c0d0479f4bc8L, "content");
    /*package*/ static final SReferenceLink param$pwLK = MetaAdapterFactory.getReferenceLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x7d6d839c2865b139L, 0x7d6d839c2866af76L, "param");
    /*package*/ static final SContainmentLink usedConfigs$WedD = MetaAdapterFactory.getContainmentLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479ec915L, 0x7d6d839c2865b7a7L, "usedConfigs");
    /*package*/ static final SContainmentLink extendedFMC$tFbw = MetaAdapterFactory.getContainmentLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479ec915L, 0x4617323a864bd075L, "extendedFMC");
    /*package*/ static final SReferenceLink config$ID3f = MetaAdapterFactory.getReferenceLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x4617323a864bd036L, 0x4617323a864bd049L, "config");
    /*package*/ static final SReferenceLink config$VWuN = MetaAdapterFactory.getReferenceLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479eed6aL, 0x5cf5c0d0479eed6bL, "config");
  }
}
