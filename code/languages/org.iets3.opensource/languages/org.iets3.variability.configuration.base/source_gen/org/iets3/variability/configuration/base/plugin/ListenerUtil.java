package org.iets3.variability.configuration.base.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.iets3.variability.featuremodel.base.behavior.ICalculateHashForUpdateWarning__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.iets3.variability.featuremodel.base.plugin.FeatureModelTraversal;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.iets3.variability.configuration.base.behavior.FeatureModelConfiguration__BehaviorDescriptor;
import org.iets3.analysis.base.behavior.ISolvable__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SEnumOperations;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SProperty;

public class ListenerUtil {

  public static boolean blockListeners = false;

  public static void expressionActions(SNode instance) {
    // this is used to avoid asynchronous solver execution in tests
    if (blockListeners) {
      return;
    }

    SNode faa = SNodeOperations.getNodeAncestor(instance, CONCEPTS.FeatureAttributeAssignment$1f, false, false);
    if ((faa != null)) {
      ICalculateHashForUpdateWarning__BehaviorDescriptor.updateUpdateHash_id6MJy$PGs_q4.invoke(SNodeOperations.getNodeAncestor(faa, CONCEPTS.FeatureModelConfiguration$nE, false, false));
      ListenerUtil.featureAttributeAssignmentActions(faa, instance);
    }
  }

  public static void featureAttributeAssignmentActions(SNode faa, SNode expression) {
    // don't run solver on incomplete FeatureModelConfiguration
    SNode fmconfig = SNodeOperations.getNodeAncestor(faa, CONCEPTS.FeatureModelConfiguration$nE, false, false);
    if (SPropertyOperations.getBoolean(fmconfig, PROPS.complete$4SB6)) {
      SNode ifcc = SNodeOperations.cast(SNodeOperations.getParent(faa), CONCEPTS.InlineFeatureConfigurationContent$P5);
      final SNode targetFeature = SLinkOperations.getTarget(SNodeOperations.getNodeAncestor(ifcc, CONCEPTS.AbstractFeatureConfiguration$3P, false, false), LINKS.targetFeature$16lA);
      // Checks for ambiguous paths
      boolean ambiguousPathExists = ListSequence.fromList(SNodeOperations.getNodeDescendants(faa, CONCEPTS.FeatureRefExpr$Ys, false, new SAbstractConcept[]{})).translate((fre) -> FeatureModelTraversal.findAllPaths(targetFeature, SLinkOperations.getTarget(fre, LINKS.feature$3d5y))).any((path) -> ListSequence.fromList(path).count() > 1);
      if (ambiguousPathExists) {
        return;
      }
      // run solver depending on state of parent featureconfig and Attribute assignment
      if (SNodeOperations.isInstanceOf(SNodeOperations.getParent(ifcc), CONCEPTS.FeatureConfiguration$x2)) {
        SNode fc = SNodeOperations.cast(SNodeOperations.getParent(ifcc), CONCEPTS.FeatureConfiguration$x2);
        // Feature without cardinality
        if ((SLinkOperations.getTarget(SLinkOperations.getTarget(fc, LINKS.targetFeature$16lA), LINKS.cardinality$EsDt) == null)) {
          ListenerUtil.featureWithoutCardinality(expression, fmconfig);
        } else {
          // Feature with cardinality
          // only relevant for selected instances
          ListenerUtil.featureWithCardinality(expression, fmconfig, fc);
        }
      } else {
        // here for parent featureModelConfiguration
        SNode fmc = SNodeOperations.cast(SNodeOperations.getParent(ifcc), CONCEPTS.FeatureModelConfiguration$nE);
        ListenerUtil.expressionInFeatureModelConfiguration(expression, fmc, fmconfig);
      }
    }
  }


  public static void expressionInFeatureModelConfiguration(SNode expr, SNode fmc, SNode fmconfig) {
    if (SNodeOperations.isInstanceOf(expr, CONCEPTS.FeatureRefExpr$Ys)) {
      return;
    }
    {
      final SNode dotExpression = expr;
      if (SNodeOperations.isInstanceOf(dotExpression, CONCEPTS.DotExpression$jp)) {
        if (!(SNodeOperations.isInstanceOf(SLinkOperations.getTarget(dotExpression, LINKS.target$u23F), CONCEPTS.FeatureAttributeDotTarget$Ko)) || (SLinkOperations.getTarget(dotExpression, LINKS.target$u23F) == null)) {
          return;
        }
      }
    }

    // TODO: the following code should probably be unified with the method featureWithoutCardinality() below, they are quite similar
    if (ListSequence.fromList(SNodeOperations.getNodeDescendants(expr, CONCEPTS.Expression$D_, true, new SAbstractConcept[]{})).where((it) -> SNodeOperations.getConcept(it).equals(SNodeOperations.getConcept(SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a047L, "org.iets3.core.expr.base.structure.Expression"))))).isEmpty()) {
      FeatureModelConfiguration__BehaviorDescriptor.removeError_id5UDdUfokHMF.invoke(fmconfig);
      ISolvable__BehaviorDescriptor.runManuallyAsync_id7QODtLvTFnz.invoke(fmc);
    } else {
      FeatureModelConfiguration__BehaviorDescriptor.showError_id5UDdUfokAGW.invoke(fmc, "Expression in attribute assignment incomplete. Please solve error manually before going on.");
    }
  }

  private static void featureWithCardinality(SNode expr, SNode fmconfig, SNode fc) {
    if (SPropertyOperations.getEnum(fc, PROPS.selectionState$zbc1) == SEnumOperations.getMember(MetaAdapterFactory.getEnumeration(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x5db06c237c250a73L, "org.iets3.variability.featuremodel.base.structure.FeatureSelectionState"), 0x5db06c237c250a7cL, "userTrue") || SPropertyOperations.getEnum(fc, PROPS.selectionState$zbc1) == SEnumOperations.getMember(MetaAdapterFactory.getEnumeration(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x5db06c237c250a73L, "org.iets3.variability.featuremodel.base.structure.FeatureSelectionState"), 0x5db06c237c250a75L, "autoTrue")) {
      featureWithoutCardinality(expr, fmconfig);
    }
  }

  private static void featureWithoutCardinality(SNode expr, SNode fmconfig) {
    if (ListSequence.fromList(SNodeOperations.getNodeDescendants(expr, CONCEPTS.Expression$D_, true, new SAbstractConcept[]{})).where((it) -> SNodeOperations.getConcept(it).equals(SNodeOperations.getConcept(SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a047L, "org.iets3.core.expr.base.structure.Expression"))))).isEmpty()) {
      FeatureModelConfiguration__BehaviorDescriptor.removeError_id5UDdUfokHMF.invoke(fmconfig);
      ISolvable__BehaviorDescriptor.runManuallyAsync_id7QODtLvTFnz.invoke(fmconfig);
    } else {
      FeatureModelConfiguration__BehaviorDescriptor.showError_id5UDdUfokAGW.invoke(fmconfig, "Expression in attribute assignment incomplete. Please solve error manually before going on.");
      return;

    }
  }


  private static final class CONCEPTS {
    /*package*/ static final SConcept FeatureAttributeAssignment$1f = MetaAdapterFactory.getConcept(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x302aa0c2ddc5ae16L, "org.iets3.variability.configuration.base.structure.FeatureAttributeAssignment");
    /*package*/ static final SConcept FeatureModelConfiguration$nE = MetaAdapterFactory.getConcept(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479ec915L, "org.iets3.variability.configuration.base.structure.FeatureModelConfiguration");
    /*package*/ static final SConcept InlineFeatureConfigurationContent$P5 = MetaAdapterFactory.getConcept(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479f4bfcL, "org.iets3.variability.configuration.base.structure.InlineFeatureConfigurationContent");
    /*package*/ static final SConcept AbstractFeatureConfiguration$3P = MetaAdapterFactory.getConcept(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x302aa0c2ddab8940L, "org.iets3.variability.configuration.base.structure.AbstractFeatureConfiguration");
    /*package*/ static final SConcept FeatureRefExpr$Ys = MetaAdapterFactory.getConcept(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x7cde27c7fd81d2eeL, "org.iets3.variability.featuremodel.base.structure.FeatureRefExpr");
    /*package*/ static final SConcept FeatureConfiguration$x2 = MetaAdapterFactory.getConcept(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479ec91dL, "org.iets3.variability.configuration.base.structure.FeatureConfiguration");
    /*package*/ static final SConcept DotExpression$jp = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x7cef88020a0f4249L, "org.iets3.core.expr.base.structure.DotExpression");
    /*package*/ static final SConcept FeatureAttributeDotTarget$Ko = MetaAdapterFactory.getConcept(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x7cde27c7fd968aaaL, "org.iets3.variability.featuremodel.base.structure.FeatureAttributeDotTarget");
    /*package*/ static final SConcept Expression$D_ = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a047L, "org.iets3.core.expr.base.structure.Expression");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink targetFeature$16lA = MetaAdapterFactory.getReferenceLink(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x302aa0c2ddab8940L, 0x5cf5c0d0479ec91eL, "targetFeature");
    /*package*/ static final SReferenceLink feature$3d5y = MetaAdapterFactory.getReferenceLink(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x7cde27c7fd81d2eeL, 0x7cde27c7fd81d2f8L, "feature");
    /*package*/ static final SContainmentLink cardinality$EsDt = MetaAdapterFactory.getContainmentLink(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x375cadc475172167L, 0x375cadc47519250cL, "cardinality");
    /*package*/ static final SContainmentLink target$u23F = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x7cef88020a0f4249L, 0x7cef88020a0f424bL, "target");
  }

  private static final class PROPS {
    /*package*/ static final SProperty complete$4SB6 = MetaAdapterFactory.getProperty(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x5cf5c0d0479ec915L, 0x427f472315a4eeb9L, "complete");
    /*package*/ static final SProperty selectionState$zbc1 = MetaAdapterFactory.getProperty(0x71226ee2bbc445d2L, 0xa41d20b97237156cL, 0x302aa0c2ddab8940L, 0x526bcda9b5a2fcdbL, "selectionState");
  }
}
