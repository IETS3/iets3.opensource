package org.iets3.core.expr.data.plugin;

/*Generated by MPS */

import de.slisson.mps.tables.runtime.plugin.CopyPasteSupport;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import de.slisson.mps.tables.runtime.selection.UndirectedTableRange;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.openapi.editor.EditorContext;
import de.slisson.mps.tables.runtime.selection.TableRangeSelection;
import de.slisson.mps.tables.runtime.plugin.TableData;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import de.slisson.mps.tables.runtime.plugin.TableTransformationManager;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SProperty;

public class DataTableCopyPasteImpl implements CopyPasteSupport {

  /**
   * The table has a navigation column on the left and right.
   */
  public static final int navigationColumnsLeft = 1;
  public static final int navigationColumnsRight = 1;
  public static final int headerColumn = 1;

  private SNode table;

  @Override
  public void setTableNode(SNode tableNode) {
    this.table = SNodeOperations.as(tableNode, CONCEPTS.DataTable$qy);
  }

  private UndirectedTableRange withoutNavigationColumns(UndirectedTableRange tableSelection) {
    if (tableSelection.getEndColumn() >= ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.dataCols$8Lcc)).count() + navigationColumnsLeft + headerColumn) {
      // remove right navigation column if selected
      tableSelection = tableSelection.withoutRightColumns(navigationColumnsRight);
    }
    return tableSelection.withOffset(0, -navigationColumnsLeft);
  }

  @Override
  public int priority() {
    return 0;
  }
  @Override
  public boolean isApplicable(SNode node, EditorContext editorContext) {
    return SNodeOperations.isInstanceOf(node, CONCEPTS.DataTable$qy);
  }

  @Override
  public void delete(TableRangeSelection selection, EditorContext editorContext) {
    withoutNavigationColumns(selection.toUndirectedRange()).iterate((Integer rowIndex, Integer colIndex) -> {
      if (rowIndex > ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.rows$1pKa)).count() || colIndex > ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.dataCols$8Lcc)).count()) {
        return;
      }

      int dataColIndex = colIndex - 1;
      int dataRowIndex = rowIndex - 1;

      if (colIndex == 0 || rowIndex == 0) {
        return;
      }

      SNode selectedRow = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.rows$1pKa)).getElement(dataRowIndex);
      SNode selectedCol = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.dataCols$8Lcc)).getElement(dataColIndex);
      SNode selectedCell = ListSequence.fromList(SLinkOperations.getChildren(selectedRow, LINKS.cells$lhZ4)).findFirst((it) -> SLinkOperations.getTarget(it, LINKS.col$bcAI) == selectedCol);
      SNodeOperations.deleteNode(selectedCell);
    });
  }

  @Override
  public TableData<SNode> copy(TableRangeSelection selection, EditorContext editorContext) {
    TableData<SNode> data = new TableData<SNode>();

    UndirectedTableRange range = withoutNavigationColumns(selection.toUndirectedRange());

    return as_fq73yl_a0e0q(data.collect(range, (Integer rowIndex, Integer colIndex) -> {
      if (rowIndex > ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.rows$1pKa)).count() || colIndex > ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.dataCols$8Lcc)).count()) {
        return null;
      }

      int dataColIndex = colIndex - 1;
      int dataRowIndex = rowIndex - 1;

      if (colIndex == 0 && rowIndex == 0) {
        return null;
      }
      if (rowIndex == 0) {
        return createStringLiteral_fq73yl_a0a6a1a0a4a61(SPropertyOperations.getString(ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.dataCols$8Lcc)).getElement(dataColIndex), PROPS.name$MnvL));
      }
      SNode selectedRow = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.rows$1pKa)).getElement(dataRowIndex);
      if (colIndex == 0) {
        return createStringLiteral_fq73yl_a0a8a1a0a4a61(SPropertyOperations.getString(selectedRow, PROPS.name$MnvL));
      }

      final SNode selectedCol = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.dataCols$8Lcc)).getElement(dataColIndex);
      SNode content = ListSequence.fromList(SLinkOperations.getChildren(selectedRow, LINKS.cells$lhZ4)).findFirst((it) -> SLinkOperations.getTarget(it, LINKS.col$bcAI) == selectedCol);
      return SNodeOperations.copyNode(SLinkOperations.getTarget(content, LINKS.value$exyO));
    }), TableData.class);
  }

  @Override
  public void paste(final TableRangeSelection selection, TableData<SNode> data, final EditorContext editorContext) {
    int startRow = selection.getStartRow();
    // The user may have selected the first navigation column. If so, the start column index is fine.
    // If not, we need to shift the column by one in order to iterate over the correct indices.
    int startCol = (selection.getStartColumn() == 0 ? selection.getStartColumn() : selection.getStartColumn() - navigationColumnsLeft);

    data.forEach(startRow, startCol, (SNode value, Integer row, Integer col) -> {
      if (col > ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.dataCols$8Lcc)).count()) {
        // ignore data columns which are outside of the table
        return;
      }

      while (row > ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.rows$1pKa)).count()) {
        // append new rows
        SLinkOperations.addNewChild(table, LINKS.rows$1pKa, null);
      }

      if (row == 0 && col == 0) {
        return;
      }

      int dataRowIndex = row - 1;
      int dataColIndex = col - 1;

      if (row == 0) {
        SPropertyOperations.assign(ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.dataCols$8Lcc)).getElement(dataColIndex), PROPS.name$MnvL, TableTransformationManager.nodeToData(selection, value, editorContext));
        return;
      }
      SNode selectedRow = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.rows$1pKa)).getElement(dataRowIndex);
      if (col == 0) {
        SPropertyOperations.assign(selectedRow, PROPS.name$MnvL, TableTransformationManager.nodeToData(selection, value, editorContext));
        return;
      }

      final SNode selectedCol = ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.dataCols$8Lcc)).getElement(dataColIndex);
      SNode content = ListSequence.fromList(SLinkOperations.getChildren(selectedRow, LINKS.cells$lhZ4)).findFirst((it) -> SLinkOperations.getTarget(it, LINKS.col$bcAI) == selectedCol);
      if (content == null) {
        // new data cell
        content = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0xb25b8ad14d3d4e45L, 0x8c7872091b39fddaL, 0x335c4a1eb64ca38L, "org.iets3.core.expr.data.structure.DataCell"));
        SLinkOperations.setTarget(content, LINKS.col$bcAI, selectedCol);
        ListSequence.fromList(SLinkOperations.getChildren(selectedRow, LINKS.cells$lhZ4)).addElement(content);
      }
      SLinkOperations.setTarget(content, LINKS.value$exyO, SNodeOperations.as(SNodeOperations.copyNode(value), CONCEPTS.Expression$D_));
    });
  }
  private static SNode createStringLiteral_fq73yl_a0a6a1a0a4a61(String p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.StringLiteral$By);
    n0.setProperty(PROPS.value$zwlK, p0);
    return n0.getResult();
  }
  private static SNode createStringLiteral_fq73yl_a0a8a1a0a4a61(String p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.StringLiteral$By);
    n0.setProperty(PROPS.value$zwlK, p0);
    return n0.getResult();
  }
  private static <T> T as_fq73yl_a0e0q(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept DataTable$qy = MetaAdapterFactory.getConcept(0xb25b8ad14d3d4e45L, 0x8c7872091b39fddaL, 0x335c4a1eb648aeeL, "org.iets3.core.expr.data.structure.DataTable");
    /*package*/ static final SConcept Expression$D_ = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a047L, "org.iets3.core.expr.base.structure.Expression");
    /*package*/ static final SConcept StringLiteral$By = MetaAdapterFactory.getConcept(0x6b277d9ad52d416fL, 0xa2091919bd737f50L, 0x46ff3b3d86d3edc8L, "org.iets3.core.expr.simpleTypes.structure.StringLiteral");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink dataCols$8Lcc = MetaAdapterFactory.getContainmentLink(0xb25b8ad14d3d4e45L, 0x8c7872091b39fddaL, 0x335c4a1eb648aeeL, 0x335c4a1eb64c526L, "dataCols");
    /*package*/ static final SContainmentLink rows$1pKa = MetaAdapterFactory.getContainmentLink(0xb25b8ad14d3d4e45L, 0x8c7872091b39fddaL, 0x335c4a1eb648aeeL, 0x335c4a1eb677ef4L, "rows");
    /*package*/ static final SContainmentLink cells$lhZ4 = MetaAdapterFactory.getContainmentLink(0xb25b8ad14d3d4e45L, 0x8c7872091b39fddaL, 0x335c4a1eb652889L, 0x335c4a1eb64cdd6L, "cells");
    /*package*/ static final SReferenceLink col$bcAI = MetaAdapterFactory.getReferenceLink(0xb25b8ad14d3d4e45L, 0x8c7872091b39fddaL, 0x335c4a1eb64ca38L, 0x335c4a1eb64d73eL, "col");
    /*package*/ static final SContainmentLink value$exyO = MetaAdapterFactory.getContainmentLink(0xb25b8ad14d3d4e45L, 0x8c7872091b39fddaL, 0x335c4a1eb64ca38L, 0x335c4a1eb64e24fL, "value");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
    /*package*/ static final SProperty value$zwlK = MetaAdapterFactory.getProperty(0x6b277d9ad52d416fL, 0xa2091919bd737f50L, 0x46ff3b3d86d3edc8L, 0x46ff3b3d86d3edcbL, "value");
  }
}
