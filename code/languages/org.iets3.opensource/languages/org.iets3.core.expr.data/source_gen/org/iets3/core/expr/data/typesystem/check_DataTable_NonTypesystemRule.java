package org.iets3.core.expr.data.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.runtime.AbstractNonTypesystemRule_Runtime;
import jetbrains.mps.lang.typesystem.runtime.NonTypesystemRule_Runtime;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import jetbrains.mps.lang.typesystem.runtime.IsApplicableStatus;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.errors.messageTargets.MessageTarget;
import jetbrains.mps.errors.messageTargets.NodeMessageTarget;
import jetbrains.mps.errors.IErrorReporter;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.Objects;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SConcept;

public class check_DataTable_NonTypesystemRule extends AbstractNonTypesystemRule_Runtime implements NonTypesystemRule_Runtime {
  public check_DataTable_NonTypesystemRule() {
  }
  public void applyRule(final SNode dataTable, final TypeCheckingContext typeCheckingContext, IsApplicableStatus status) {
    if (SPropertyOperations.getBoolean(dataTable, PROPS.allowLookup$yBV8)) {
      Sequence.fromIterable(SLinkOperations.collectMany(SLinkOperations.getChildren(dataTable, LINKS.rows$1pKa), LINKS.cells$lhZ4)).visitAll((it) -> {
        if (!(SNodeOperations.isInstanceOf(SLinkOperations.getTarget(it, LINKS.value$exyO), CONCEPTS.ILiteral$FG))) {
          final MessageTarget errorTarget = new NodeMessageTarget();
          IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(SLinkOperations.getTarget(it, LINKS.value$exyO), "only literals are allowed in data tables that support lookups", "r:e29c70b2-feb7-465e-9534-7fdb395635c2(org.iets3.core.expr.data.typesystem)", "5582042358565729544", null, errorTarget);
        }
      });
    }
    if (!(SPropertyOperations.getBoolean(dataTable, PROPS.allowLookup$yBV8)) && (SLinkOperations.getTarget(dataTable, LINKS.defaultLookupColumn$TWBX) != null)) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(dataTable, "default lookup columns are only supported when using lookup", "r:e29c70b2-feb7-465e-9534-7fdb395635c2(org.iets3.core.expr.data.typesystem)", "8847603084240380493", null, errorTarget);
      }
    }

    if (SPropertyOperations.getBoolean(dataTable, PROPS.allowLookup$yBV8)) {
      Iterable<List<SNode>> columnDefaultValues = ListSequence.fromList(SLinkOperations.getChildren(dataTable, LINKS.dataCols$8Lcc)).select((final SNode col) -> Sequence.fromIterable(SLinkOperations.collectMany(SLinkOperations.getChildren(dataTable, LINKS.rows$1pKa), LINKS.cells$lhZ4)).where((row) -> SNodeOperations.isInstanceOf(SLinkOperations.getTarget(row, LINKS.value$exyO), CONCEPTS.IEmptyLiteral$r$) && Objects.equals(SLinkOperations.getTarget(row, LINKS.col$bcAI), col)).toList());
      Sequence.fromIterable(columnDefaultValues).visitAll((defaultValues) -> {
        if (ListSequence.fromList(defaultValues).count() > 1) {
          ListSequence.fromList(defaultValues).skip(1).visitAll((def) -> {
            {
              final MessageTarget errorTarget = new NodeMessageTarget();
              IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(def, "only one empty input value per column is allowed", "r:e29c70b2-feb7-465e-9534-7fdb395635c2(org.iets3.core.expr.data.typesystem)", "3186273868907759177", null, errorTarget);
            }
          });
        }
      });
    }
  }
  public SAbstractConcept getApplicableConcept() {
    return CONCEPTS.DataTable$qy;
  }
  public IsApplicableStatus isApplicableAndPattern(SNode argument) {
    return new IsApplicableStatus(argument.getConcept().isSubConceptOf(getApplicableConcept()), null);
  }
  public boolean overrides() {
    return false;
  }

  private static final class PROPS {
    /*package*/ static final SProperty allowLookup$yBV8 = MetaAdapterFactory.getProperty(0xb25b8ad14d3d4e45L, 0x8c7872091b39fddaL, 0x335c4a1eb648aeeL, 0x2e23b0ba32b9b634L, "allowLookup");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink rows$1pKa = MetaAdapterFactory.getContainmentLink(0xb25b8ad14d3d4e45L, 0x8c7872091b39fddaL, 0x335c4a1eb648aeeL, 0x335c4a1eb677ef4L, "rows");
    /*package*/ static final SContainmentLink cells$lhZ4 = MetaAdapterFactory.getContainmentLink(0xb25b8ad14d3d4e45L, 0x8c7872091b39fddaL, 0x335c4a1eb652889L, 0x335c4a1eb64cdd6L, "cells");
    /*package*/ static final SContainmentLink value$exyO = MetaAdapterFactory.getContainmentLink(0xb25b8ad14d3d4e45L, 0x8c7872091b39fddaL, 0x335c4a1eb64ca38L, 0x335c4a1eb64e24fL, "value");
    /*package*/ static final SContainmentLink defaultLookupColumn$TWBX = MetaAdapterFactory.getContainmentLink(0xb25b8ad14d3d4e45L, 0x8c7872091b39fddaL, 0x335c4a1eb648aeeL, 0x7ac90020e5d2a54dL, "defaultLookupColumn");
    /*package*/ static final SContainmentLink dataCols$8Lcc = MetaAdapterFactory.getContainmentLink(0xb25b8ad14d3d4e45L, 0x8c7872091b39fddaL, 0x335c4a1eb648aeeL, 0x335c4a1eb64c526L, "dataCols");
    /*package*/ static final SReferenceLink col$bcAI = MetaAdapterFactory.getReferenceLink(0xb25b8ad14d3d4e45L, 0x8c7872091b39fddaL, 0x335c4a1eb64ca38L, 0x335c4a1eb64d73eL, "col");
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept ILiteral$FG = MetaAdapterFactory.getInterfaceConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x6bff9a8a7cdaf784L, "org.iets3.core.expr.base.structure.ILiteral");
    /*package*/ static final SInterfaceConcept IEmptyLiteral$r$ = MetaAdapterFactory.getInterfaceConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0xcb3f5606a54bb58L, "org.iets3.core.expr.base.structure.IEmptyLiteral");
    /*package*/ static final SConcept DataTable$qy = MetaAdapterFactory.getConcept(0xb25b8ad14d3d4e45L, 0x8c7872091b39fddaL, 0x335c4a1eb648aeeL, "org.iets3.core.expr.data.structure.DataTable");
  }
}
