package org.iets3.core.expr.statemachines.plugin;

/*Generated by MPS */

import org.iets3.core.expr.mutable.plugin.InteractorValue;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.List;
import com.mbeddr.mpsutil.interpreter.rt.IContext;
import org.iets3.core.expr.statemachines.behavior.IStateContainer__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.iets3.core.expr.statemachines.behavior.StateMachine__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import com.mbeddr.mpsutil.interpreter.rt.ComputationTrace;
import org.iets3.core.expr.mutable.plugin.GlobalClockContainer;
import org.iets3.core.expr.statemachines.behavior.State__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.iets3.core.expr.mutable.plugin.InteractionDescriptor;
import org.iets3.core.expr.mutable.plugin.IDValue;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.typechecking.TypecheckingFacade;
import org.iets3.core.expr.mutable.plugin.IDCommand;
import org.iets3.core.expr.mutable.plugin.IDArg;
import org.iets3.core.expr.mutable.plugin.IDElement;
import org.iets3.core.expr.mutable.plugin.ContextValue;
import org.iets3.core.expr.mutable.plugin.InterceptorState;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import org.iets3.core.expr.mutable.behavior.IInterceptor__BehaviorDescriptor;
import org.iets3.core.expr.base.behavior.IETS3ExprContext;
import com.mbeddr.mpsutil.interpreter.rt.ICoverageAnalyzer;
import com.mbeddr.mpsutil.interpreter.rt.IEnvironment;
import org.iets3.core.expr.mutable.plugin.TranactionContext;
import java.math.BigInteger;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import jetbrains.mps.smodel.SNodePointer;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;

public class SmValue extends InteractorValue {

  private SNode myMachine;
  private SmInternalData data;
  private List<Object> params;

  public SmValue(IContext context, SNode machine, List<Object> args) {
    super(machine, context);
    myMachine = machine;
    params = args;
  }

  public void start() {
    final SNode is = IStateContainer__BehaviorDescriptor.initialState_id3H4W4dizefM.invoke(myMachine);
    data = new SmInternalData(is);
    for (SNode v : Sequence.fromIterable(StateMachine__BehaviorDescriptor.variables_idaPhVmWXB8g.invoke(this.machine()))) {
      setVar(v, eval(SLinkOperations.getTarget(v, LINKS.expr$CW3E), new ComputationTrace(v)));
    }
    data.currentStateEntryTime = GlobalClockContainer.clock().timeMillis();
    data.lastTriggeredTransitionTime = GlobalClockContainer.clock().timeMillis();
    Iterable<SNode> eads = State__BehaviorDescriptor.entryActions_id7$TgoCYlwiZ.invoke(is);
    Sequence.fromIterable(eads).visitAll((it) -> eval(it, new ComputationTrace(is)));
  }


  public SNode machine() {
    return this.myMachine;
  }

  public SNode getCurrentState() {
    return this.data.myCurrentState;
  }

  @Override
  public Object getValue() {
    return this.data;
  }
  @Override
  public void setValue(Object newValue) {
    this.data = ((SmInternalData) newValue);
  }

  public void setVar(SNode var, Object value) {
    SMVarValue varValue = MapSequence.fromMap(this.data.variables).get(var);
    if (varValue == null) {
      varValue = new SMVarValue();
      MapSequence.fromMap(this.data.variables).put(var, varValue);
    }
    varValue.setValue(value);
  }


  @Override
  public Object createSnapshot() {
    SmValue snap = new SmValue(interpreterCtx, this.machine(), params);
    snap.setValue(this.data.createSnapshot());
    return snap;
  }

  @Override
  public String toString() {
    return "SM:" + SPropertyOperations.getString(this.machine(), PROPS.name$MnvL) + this.data.toString();
  }

  public boolean isInState(SNode s) {
    return this.data.myCurrentState == s;
  }

  public Object getParamValue(int index) {
    return ListSequence.fromList(this.params).getElement(index);
  }

  public static InteractionDescriptor descriptor(SNode machine) {
    InteractionDescriptor d = new InteractionDescriptor();
    d.addElement(new IDValue("state", createSNodeType_vuhzt7_b0a0a0b0cb()).dontUseInCode());
    for (SNode v : Sequence.fromIterable(StateMachine__BehaviorDescriptor.variables_idaPhVmWXB8g.invoke(machine))) {
      d.addElement(new IDValue(SPropertyOperations.getString(v, PROPS.name$MnvL), SNodeOperations.cast(SNodeOperations.copyNode(TypecheckingFacade.getFromContext().getTypeOf(v)), CONCEPTS.Type$WK)).dontUseInCode().setAssociatedNode(v));
    }
    for (SNode q : Sequence.fromIterable(StateMachine__BehaviorDescriptor.queries_id4J6AqiIXbWG.invoke(machine))) {
      d.addElement(new IDValue(SPropertyOperations.getString(q, PROPS.name$MnvL), SNodeOperations.cast(SNodeOperations.copyNode(TypecheckingFacade.getFromContext().getTypeOf(q)), CONCEPTS.Type$WK)).dontUseInCode().setAssociatedNode(q));
    }
    for (SNode e : Sequence.fromIterable(StateMachine__BehaviorDescriptor.events_id7$TgoCYjSsJ.invoke(machine))) {
      d.addElement(new IDCommand(SPropertyOperations.getString(e, PROPS.name$MnvL), ListSequence.fromList(SLinkOperations.getChildren(e, LINKS.args$aKQV)).select((it) -> new IDArg(SPropertyOperations.getString(it, PROPS.name$MnvL), SNodeOperations.copyNode(SLinkOperations.getTarget(it, LINKS.type$8xXf)))).toGenericArray(IDArg.class)).dontUseInCode().setAssociatedNode(e));
    }
    return d;
  }

  public IDElement processInterceptors(IDElement element, List<Object> payload, List<ContextValue> contextArgs, IContext ctx, ComputationTrace trace) {
    List<SNode> containers = SNodeOperations.getNodeAncestors(this.data.myCurrentState, CONCEPTS.IInterceptorContainer$D2, true);
    for (SNode c : ListSequence.fromList(containers)) {
      List<SNode> is = SLinkOperations.getChildren(c, LINKS.interceptors$BQ9K);
      for (SNode i : ListSequence.fromList(is)) {
        InterceptorState state = this.data.interceptorState.getState(i, ctx, trace);
        Tuples._2<IDElement, InterceptorState> processResult = IInterceptor__BehaviorDescriptor.processOrThrow_id4IV0h47deV3.invoke(i, element, state, payload, contextArgs, ctx, trace);
        element = processResult._0();
        this.data.interceptorState.updateState(i, processResult._1());
      }
    }
    return element;
  }

  @Override
  public Object handleElement(IDElement element, List<Object> payload, List<ContextValue> contextArgs, IETS3ExprContext ctx, ICoverageAnalyzer coverage, ComputationTrace trace) {
    MapSequence.fromMap(env()).put(InteractorValue.THIS, this);
    element = processInterceptors(element, payload, contextArgs, ctx, trace);
    if (element instanceof IDCommand) {
      SNode evt = StateMachine__BehaviorDescriptor.eventByName_id7bd8pkkAFT3.invoke(this.machine(), element.name);
      handleTrigger(evt, payload, coverage, trace);
    } else if (element instanceof IDValue) {
      if (element.name.equals("state")) {
        return data.myCurrentState;
      } else {
        SNode v = StateMachine__BehaviorDescriptor.variableByName_id7bd8pkk$zhp.invoke(this.machine(), element.name);
        if (v != null) {
          return getVariableValue(v);
        }
        SNode q = StateMachine__BehaviorDescriptor.queryByName_id4J6AqiIYd94.invoke(this.machine(), element.name);
        if (q != null) {
          return handleQuery(q, coverage, trace);
        }
      }
    }
    return null;
  }


  public IEnvironment env() {
    return this.interpreterCtx.getEnvironment();
  }

  private void handleAutomaticTransitions(ComputationTrace trace) {
    SNode currentState = this.getCurrentState();
    for (SNode at : Sequence.fromIterable(State__BehaviorDescriptor.automaticTransitions_id7Z_fDCw7kpI.invoke(currentState))) {
      if (isGuardOK(at, trace)) {
        performTransition(at, currentState, trace);
      }
    }
  }

  public void handleTrigger(final SNode triggerEvent, List<Object> params, ICoverageAnalyzer coverage, ComputationTrace trace) {
    coverage.registerBranches(CONCEPTS.StateMachine$He, new String[]{"transitionGuardOK", "transitionGuardNotOK", "noTransitionApplies"});
    coverage.visitedConcept(CONCEPTS.StateMachine$He);
    handleAutomaticTransitions(trace);
    SNode machine = this.machine();
    TranactionContext.registerWithCurrentTx(env(), this);
    for (SNode eventArg : ListSequence.fromList(SLinkOperations.getChildren(triggerEvent, LINKS.args$aKQV))) {
      coverage.visitedConcept(CONCEPTS.EventArg$Ph);
      coverage.visitedConcept(CONCEPTS.Event$Q3);
      MapSequence.fromMap(env()).put(eventArg, ListSequence.fromList(params).getElement(SNodeOperations.getIndexInParent(eventArg)));
    }
    SNode currentState = this.getCurrentState();
    coverage.visitedConcept(CONCEPTS.State$OA);
    Iterable<SNode> applicableTx = Sequence.fromIterable(State__BehaviorDescriptor.allApplicableTriggeredTransitions_idk9boAuhUuG.invoke(currentState)).where((it) -> SNodeOperations.isInstanceOf(SLinkOperations.getTarget(it, LINKS.trigger$YOCW), CONCEPTS.EventTrigger$pZ) && SLinkOperations.getTarget(SNodeOperations.cast(SLinkOperations.getTarget(it, LINKS.trigger$YOCW), CONCEPTS.EventTrigger$pZ), LINKS.event$xWBT) == triggerEvent);
    boolean aTxHasHappened = false;
    for (SNode tx : Sequence.fromIterable(applicableTx)) {
      coverage.visitedConcept(CONCEPTS.TriggeredTransition$1F);
      if (isGuardOK(tx, trace)) {
        coverage.visitedConceptBranch(CONCEPTS.StateMachine$He, "transitionGuardOK");
        ComputationTrace txTrace = trace.newChild(tx, true, "tx taken", tx);
        performTransition(tx, currentState, txTrace);
        data.lastTriggeredTransitionTime = GlobalClockContainer.clock().timeMillis();
        aTxHasHappened = true;
        break;
      } else {
        coverage.visitedConceptBranch(CONCEPTS.StateMachine$He, "transitionGuardNotOK");
      }
    }
    if (!(aTxHasHappened) && SPropertyOperations.getBoolean(machine, PROPS.isStrict$_qyl)) {
      coverage.visitedConceptBranch(CONCEPTS.StateMachine$He, "noTransitionApplies");
      trace.newChild(machine, true, "no tx");
      throw new NoTransitionException(machine, triggerEvent, currentState, interpreterCtx, trace);
    } else {
      handleAutomaticTransitions(trace);
    }
  }

  public void handlePoke(ICoverageAnalyzer coverage, ComputationTrace trace) {
    MapSequence.fromMap(env()).put(THIS, this);
    handleAutomaticTransitions(trace);
  }

  public Object handleQuery(SNode query, ICoverageAnalyzer coverage, ComputationTrace trace) {
    return eval(SLinkOperations.getTarget(query, LINKS.expr$CW3E), trace);
  }

  private void performTransition(SNode tx, SNode currentState, final ComputationTrace txTrace) {
    if (SLinkOperations.getTarget(tx, LINKS.target$3GhT) != null && SNodeOperations.isInstanceOf(SLinkOperations.getTarget(tx, LINKS.target$3GhT), CONCEPTS.StateTarget$nV)) {
      SNode targetState = SLinkOperations.getTarget(SNodeOperations.cast(SLinkOperations.getTarget(tx, LINKS.target$3GhT), CONCEPTS.StateTarget$nV), LINKS.state$sUSc);
      SNode effectiveTargetState = State__BehaviorDescriptor.effectiveTargetState_idk9boAu8mY4.invoke(targetState);

      SNode lcs = State__BehaviorDescriptor.leastCommonContainerWith_idk9boAtVIcE.invoke(currentState, targetState);
      List<SNode> leaving = State__BehaviorDescriptor.statesUpToContainer_idk9boAu1Bd0.invoke(currentState, lcs);
      List<SNode> entering = State__BehaviorDescriptor.statesDownFrom_idk9boAu6HpS.invoke(effectiveTargetState, lcs);
      for (SNode l : ListSequence.fromList(leaving)) {
        Sequence.fromIterable(State__BehaviorDescriptor.exitActions_id7$TgoCYlwoK.invoke(l)).visitAll((it) -> eval(it, txTrace.newChild(it, true, "exit action", it)));
      }
      if (SLinkOperations.getTarget(tx, LINKS.action$aEUh) != null) {
        eval(SLinkOperations.getTarget(tx, LINKS.action$aEUh), txTrace.newChild(SLinkOperations.getTarget(tx, LINKS.action$aEUh), true, "tx action"));
      }
      this.data = this.data.copy();
      data.currentStateEntryTime = GlobalClockContainer.clock().timeMillis();
      data.myCurrentState = effectiveTargetState;
      for (SNode e : ListSequence.fromList(entering)) {
        Sequence.fromIterable(State__BehaviorDescriptor.entryActions_id7$TgoCYlwiZ.invoke(e)).visitAll((it) -> eval(it, txTrace.newChild(it, true, "entry action", it)));
      }
    } else {
      if (SLinkOperations.getTarget(tx, LINKS.action$aEUh) != null) {
        eval(SLinkOperations.getTarget(tx, LINKS.action$aEUh), txTrace.newChild(SLinkOperations.getTarget(tx, LINKS.action$aEUh), true, "tx action"));
      }
    }
  }


  private boolean isGuardOK(SNode tx, ComputationTrace trace) {
    if (SLinkOperations.getTarget(tx, LINKS.guard$axcj) == null) {
      return true;
    }
    Object guard = eval(SLinkOperations.getTarget(tx, LINKS.guard$axcj), trace);
    if (guard instanceof Boolean) {
      return ((boolean) guard);
    } else {
      return false;
    }
  }


  public Object getVariableValue(SNode variable) {
    return MapSequence.fromMap(data.variables).get(variable).getValue();
  }

  public SMVarValue getVariableBox(SNode variable) {
    return MapSequence.fromMap(data.variables).get(variable);
  }

  @Override
  public boolean currentlyAllowsThisElement(final IDElement element) {
    if (element instanceof IDCommand) {
      Iterable<SNode> eventsInCurrentState = Sequence.fromIterable(SLinkOperations.collect(SNodeOperations.ofConcept(SLinkOperations.collect(State__BehaviorDescriptor.allApplicableTriggeredTransitions_idk9boAuhUuG.invoke(this.data.myCurrentState), LINKS.trigger$YOCW), CONCEPTS.EventTrigger$pZ), LINKS.event$xWBT)).distinct();
      return Sequence.fromIterable(eventsInCurrentState).any((it) -> SPropertyOperations.getString(it, PROPS.name$MnvL).equals(element.name));
    }
    return true;
  }

  public BigInteger timeInCurrentState() {
    BigInteger entered = this.data.currentStateEntryTime;
    return GlobalClockContainer.clock().timeMillis().subtract(entered);
  }

  public BigInteger timeSinceLastTriggeredTransition() {
    BigInteger entered = this.data.currentStateEntryTime;
    return GlobalClockContainer.clock().timeMillis().subtract(entered);
  }


  @Override
  public Object getSubstate(SNode n, IContext ctx, ComputationTrace trace) {
    if (SNodeOperations.isInstanceOf(n, CONCEPTS.IInterceptor$Wz)) {
      return this.data.interceptorState.getState(SNodeOperations.cast(n, CONCEPTS.IInterceptor$Wz), ctx, trace);
    }
    return null;
  }
  private static SNode createSNodeType_vuhzt7_b0a0a0b0cb() {
    PersistenceFacade facade = PersistenceFacade.getInstance();
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.SNodeType$hR);
    n0.setReference(LINKS.concept$OMgE, new SNodePointer(facade.createModelReference("r:854255a4-0f76-4555-8c94-d91e2ad4eb02(org.iets3.core.expr.statemachines.structure)"), facade.createNodeId("8735085014265912535")));
    return n0.getResult();
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink expr$CW3E = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x3b256bb6ae8048d8L, 0x3b256bb6ae8048d9L, "expr");
    /*package*/ static final SContainmentLink args$aKQV = MetaAdapterFactory.getContainmentLink(0xcd87ddab6434448eL, 0xa0111e1c898de18eL, 0x7939418a3e285cdaL, 0x2b547b5bcdbceebL, "args");
    /*package*/ static final SContainmentLink type$8xXf = MetaAdapterFactory.getContainmentLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba520709L, 0x68d69d36ba52070cL, "type");
    /*package*/ static final SContainmentLink interceptors$BQ9K = MetaAdapterFactory.getContainmentLink(0xfbba51185fc649ffL, 0x9c3b0b4469830440L, 0x4bbb01110734ff1cL, 0x4bbb011107350e42L, "interceptors");
    /*package*/ static final SContainmentLink trigger$YOCW = MetaAdapterFactory.getContainmentLink(0xcd87ddab6434448eL, 0xa0111e1c898de18eL, 0x7939418a3e285cddL, 0x30d6adb796ad5d2fL, "trigger");
    /*package*/ static final SReferenceLink event$xWBT = MetaAdapterFactory.getReferenceLink(0xcd87ddab6434448eL, 0xa0111e1c898de18eL, 0x30d6adb796ad5d1fL, 0x30d6adb796ad5d2dL, "event");
    /*package*/ static final SContainmentLink target$3GhT = MetaAdapterFactory.getContainmentLink(0xcd87ddab6434448eL, 0xa0111e1c898de18eL, 0x7fe53e9a201bb0edL, 0x7fe53e9a203e05f1L, "target");
    /*package*/ static final SReferenceLink state$sUSc = MetaAdapterFactory.getReferenceLink(0xcd87ddab6434448eL, 0xa0111e1c898de18eL, 0x7fe53e9a203dfc21L, 0x7fe53e9a203dfc22L, "state");
    /*package*/ static final SContainmentLink action$aEUh = MetaAdapterFactory.getContainmentLink(0xcd87ddab6434448eL, 0xa0111e1c898de18eL, 0x7fe53e9a201bb0edL, 0x7939418a3e46e991L, "action");
    /*package*/ static final SContainmentLink guard$axcj = MetaAdapterFactory.getContainmentLink(0xcd87ddab6434448eL, 0xa0111e1c898de18eL, 0x7fe53e9a201bb0edL, 0x7939418a3e285ce0L, "guard");
    /*package*/ static final SReferenceLink concept$OMgE = MetaAdapterFactory.getReferenceLink(0x7866978ea0f04cc7L, 0x81bc4d213d9375e1L, 0x108f968b3caL, 0x1090e46ca51L, "concept");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
    /*package*/ static final SProperty isStrict$_qyl = MetaAdapterFactory.getProperty(0xcd87ddab6434448eL, 0xa0111e1c898de18eL, 0x7939418a3e285ca3L, 0xfb2bd50a7ef87f2L, "isStrict");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Type$WK = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a614L, "org.iets3.core.expr.base.structure.Type");
    /*package*/ static final SInterfaceConcept IInterceptorContainer$D2 = MetaAdapterFactory.getInterfaceConcept(0xfbba51185fc649ffL, 0x9c3b0b4469830440L, 0x4bbb01110734ff1cL, "org.iets3.core.expr.mutable.structure.IInterceptorContainer");
    /*package*/ static final SConcept StateMachine$He = MetaAdapterFactory.getConcept(0xcd87ddab6434448eL, 0xa0111e1c898de18eL, 0x7939418a3e285ca3L, "org.iets3.core.expr.statemachines.structure.StateMachine");
    /*package*/ static final SConcept EventArg$Ph = MetaAdapterFactory.getConcept(0xcd87ddab6434448eL, 0xa0111e1c898de18eL, 0x2b547b5bcdbceedL, "org.iets3.core.expr.statemachines.structure.EventArg");
    /*package*/ static final SConcept Event$Q3 = MetaAdapterFactory.getConcept(0xcd87ddab6434448eL, 0xa0111e1c898de18eL, 0x7939418a3e285cdaL, "org.iets3.core.expr.statemachines.structure.Event");
    /*package*/ static final SConcept State$OA = MetaAdapterFactory.getConcept(0xcd87ddab6434448eL, 0xa0111e1c898de18eL, 0x7939418a3e285cd7L, "org.iets3.core.expr.statemachines.structure.State");
    /*package*/ static final SConcept EventTrigger$pZ = MetaAdapterFactory.getConcept(0xcd87ddab6434448eL, 0xa0111e1c898de18eL, 0x30d6adb796ad5d1fL, "org.iets3.core.expr.statemachines.structure.EventTrigger");
    /*package*/ static final SConcept TriggeredTransition$1F = MetaAdapterFactory.getConcept(0xcd87ddab6434448eL, 0xa0111e1c898de18eL, 0x7939418a3e285cddL, "org.iets3.core.expr.statemachines.structure.TriggeredTransition");
    /*package*/ static final SConcept StateTarget$nV = MetaAdapterFactory.getConcept(0xcd87ddab6434448eL, 0xa0111e1c898de18eL, 0x7fe53e9a203dfc21L, "org.iets3.core.expr.statemachines.structure.StateTarget");
    /*package*/ static final SInterfaceConcept IInterceptor$Wz = MetaAdapterFactory.getInterfaceConcept(0xfbba51185fc649ffL, 0x9c3b0b4469830440L, 0x4bbb01110734eea6L, "org.iets3.core.expr.mutable.structure.IInterceptor");
    /*package*/ static final SConcept SNodeType$hR = MetaAdapterFactory.getConcept(0x7866978ea0f04cc7L, 0x81bc4d213d9375e1L, 0x108f968b3caL, "jetbrains.mps.lang.smodel.structure.SNodeType");
  }
}
