package org.iets3.core.expr.statemachines.plugin;

/*Generated by MPS */

import com.mbeddr.mpsutil.interpreter.rt.IRequiresSnapshot;
import org.jetbrains.mps.openapi.model.SNode;
import java.math.BigInteger;
import org.iets3.core.expr.mutable.plugin.InterceptorStateManager;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import org.iets3.core.expr.mutable.plugin.GlobalClockContainer;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.IMapping;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class SmInternalData implements IRequiresSnapshot {

  public SNode myCurrentState;
  public BigInteger currentStateEntryTime;
  public BigInteger lastTriggeredTransitionTime;
  public InterceptorStateManager interceptorState = new InterceptorStateManager();

  public Map<SNode, SMVarValue> variables = MapSequence.fromMap(new HashMap<SNode, SMVarValue>());

  public SmInternalData(SNode currentState) {
    myCurrentState = currentState;
    currentStateEntryTime = GlobalClockContainer.clock().timeMillis();
    lastTriggeredTransitionTime = GlobalClockContainer.clock().timeMillis();
  }

  public SmInternalData copy() {
    SmInternalData d = new SmInternalData(this.myCurrentState);
    MapSequence.fromMap(d.variables).putAll(this.variables);
    d.interceptorState = this.interceptorState.copy();
    return d;
  }

  @Override
  public String toString() {
    String s = "[" + SPropertyOperations.getString(this.myCurrentState, PROPS.name$MnvL) + "]";
    if (MapSequence.fromMap(this.variables).isNotEmpty()) {
      s += MapSequence.fromMap(this.variables).select((it) -> SPropertyOperations.getString(it.key(), PROPS.name$MnvL) + "=" + it.value().createSnapshot().toString());
    }
    return s;
  }

  @Override
  public Object createSnapshot() {
    SmInternalData d = new SmInternalData(this.myCurrentState);
    d.variables = MapSequence.fromMap(new HashMap<SNode, SMVarValue>());
    for (IMapping<SNode, SMVarValue> v : MapSequence.fromMap(this.variables)) {
      MapSequence.fromMap(d.variables).put(v.key(), ((SMVarValue) ((SMVarValue) v.value()).createSnapshot()));
    }
    return d;
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }
}
