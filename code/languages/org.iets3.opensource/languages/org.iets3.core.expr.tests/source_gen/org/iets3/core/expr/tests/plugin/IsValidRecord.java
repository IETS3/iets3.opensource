package org.iets3.core.expr.tests.plugin;

/*Generated by MPS */

import org.hamcrest.DiagnosingMatcher;
import com.mbeddr.mpsutil.interpreter.rt.IContext;
import com.mbeddr.mpsutil.interpreter.rt.ICoverageAnalyzer;
import org.hamcrest.Description;
import org.iets3.core.expr.toplevel.plugin.RecordValue;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.typechecking.TypecheckingFacade;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.core.behavior.BaseConcept__BehaviorDescriptor;
import org.iets3.core.expr.base.plugin.ValidValue;
import org.iets3.core.expr.base.plugin.TypeConstraintHelper;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class IsValidRecord extends DiagnosingMatcher<Object> {
  private final IContext ctx;
  private final ICoverageAnalyzer coverage;

  public IsValidRecord(IContext ctx, ICoverageAnalyzer coverage, boolean expectedValidity) {
    this.ctx = ctx;
    this.coverage = coverage;
  }

  @Override
  protected boolean matches(Object value, Description description) {
    if (value == null) {
      description.appendText("was null");
      return false;
    }

    if (!(value instanceof RecordValue)) {
      description.appendText("was not a record value but " + value);
      return false;
    }

    RecordValue recordValue = ((RecordValue) value);
    SNode recordDeclaration = recordValue.recordDeclaration();
    if (recordDeclaration == null) {
      description.appendText("was a record value with no associated record declaration");
      return false;
    }

    SNode type = TypecheckingFacade.getFromContext().getTypeOf(recordDeclaration);
    if (!(SNodeOperations.isInstanceOf(type, CONCEPTS.Type$WK))) {
      description.appendText("was a record value with an invalid type " + BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(type));
      return false;
    }

    ValidValue validValue = TypeConstraintHelper.isValidInteractive(SNodeOperations.cast(type, CONCEPTS.Type$WK), value, ctx, coverage, null);

    if (!(validValue.ok)) {
      description.appendText(validValue.msg.toString());
      return false;
    }

    return true;
  }

  @Override
  public void describeTo(Description description) {
    description.appendText("a valid record");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Type$WK = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a614L, "org.iets3.core.expr.base.structure.Type");
  }
}
