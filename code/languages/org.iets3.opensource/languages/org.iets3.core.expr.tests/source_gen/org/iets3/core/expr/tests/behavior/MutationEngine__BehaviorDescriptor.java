package org.iets3.core.expr.tests.behavior;

/*Generated by MPS */

import jetbrains.mps.core.aspects.behaviour.BaseBHDescriptor;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.core.aspects.behaviour.api.SMethod;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.core.aspects.behaviour.SMethodBuilder;
import jetbrains.mps.core.aspects.behaviour.SJavaCompoundTypeImpl;
import jetbrains.mps.core.aspects.behaviour.AccessPrivileges;
import org.jetbrains.mps.openapi.model.SModel;
import org.iets3.core.expr.base.plugin.Mutator;
import java.util.List;
import java.util.Random;
import java.util.Set;
import org.jetbrains.mps.openapi.model.EditableSModel;
import java.util.Arrays;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.model.ModelDeleteHelper;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import org.iets3.core.expr.tests.plugin.MutationRegistry;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import org.jetbrains.mps.openapi.persistence.ModelRoot;
import jetbrains.mps.persistence.DefaultModelRoot;
import jetbrains.mps.project.SModuleOperations;
import jetbrains.mps.smodel.ModelImports;
import jetbrains.mps.smodel.CopyUtil;
import jetbrains.mps.core.aspects.behaviour.api.SConstructor;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.core.aspects.behaviour.api.BHMethodNotFoundException;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public final class MutationEngine__BehaviorDescriptor extends BaseBHDescriptor {
  private static final SAbstractConcept CONCEPT = MetaAdapterFactory.getConcept(0xd441fba0f46b43cdL, 0xb723dad7b65da615L, 0x3961737bc46346c7L, "org.iets3.core.expr.tests.structure.MutationEngine");

  public static final SMethod<SNode> mutate_id3_xsRJ4oOrE = new SMethodBuilder<SNode>(new SJavaCompoundTypeImpl((Class<SNode>) ((Class) Object.class))).name("mutate").modifiers(0, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(4134712908315838186L).languageId(0xb723dad7b65da615L, 0xd441fba0f46b43cdL).build2(SMethodBuilder.createJavaParameter((Class<SNode>) ((Class) Object.class), ""));
  public static final SMethod<Void> optionallyDelete_id1qjbRymONRy = new SMethodBuilder<Void>(new SJavaCompoundTypeImpl(Void.class)).name("optionallyDelete").modifiers(0, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(1626696085383888354L).languageId(0xb723dad7b65da615L, 0xd441fba0f46b43cdL).build2(SMethodBuilder.createJavaParameter((Class<SModel>) ((Class) Object.class), ""), SMethodBuilder.createJavaParameter(Boolean.TYPE, ""));
  public static final SMethod<SNode> findAdapterByInternalID_id3_xsRJ4LDk5 = new SMethodBuilder<SNode>(new SJavaCompoundTypeImpl((Class<SNode>) ((Class) Object.class))).name("findAdapterByInternalID").modifiers(0, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(4134712908322346245L).languageId(0xb723dad7b65da615L, 0xd441fba0f46b43cdL).build2(SMethodBuilder.createJavaParameter((Class<SModel>) ((Class) Object.class), ""), SMethodBuilder.createJavaParameter(String.class, ""));
  public static final SMethod<Mutator> findRandomMutator_id7WSgHRL8UlQ = new SMethodBuilder<Mutator>(new SJavaCompoundTypeImpl(Mutator.class)).name("findRandomMutator").modifiers(0, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(9167150562513495414L).languageId(0xb723dad7b65da615L, 0xd441fba0f46b43cdL).build2(SMethodBuilder.createJavaParameter((Class<List<Mutator>>) ((Class) Object.class), ""), SMethodBuilder.createJavaParameter(Random.class, ""));
  public static final SMethod<SNode> findRandomNode_id7WSgHRL9pFP = new SMethodBuilder<SNode>(new SJavaCompoundTypeImpl((Class<SNode>) ((Class) Object.class))).name("findRandomNode").modifiers(0, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(9167150562513623797L).languageId(0xb723dad7b65da615L, 0xd441fba0f46b43cdL).build2(SMethodBuilder.createJavaParameter((Class<List<SNode>>) ((Class) Object.class), ""), SMethodBuilder.createJavaParameter(Random.class, ""));
  public static final SMethod<Void> makeChange_id3_xsRJ4wolt = new SMethodBuilder<Void>(new SJavaCompoundTypeImpl(Void.class)).name("makeChange").modifiers(0, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(4134712908317820253L).languageId(0xb723dad7b65da615L, 0xd441fba0f46b43cdL).build2(SMethodBuilder.createJavaParameter((Class<SNode>) ((Class) Object.class), ""), SMethodBuilder.createJavaParameter((Class<SNode>) ((Class) Object.class), ""), SMethodBuilder.createJavaParameter((Class<Set<String>>) ((Class) Object.class), ""), SMethodBuilder.createJavaParameter((Class<List<SNode>>) ((Class) Object.class), ""), SMethodBuilder.createJavaParameter(Random.class, ""));
  public static final SMethod<SNode> replaceWith_id1qjbRymQQWe = new SMethodBuilder<SNode>(new SJavaCompoundTypeImpl((Class<SNode>) ((Class) Object.class))).name("replaceWith").modifiers(0, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(1626696085384425230L).languageId(0xb723dad7b65da615L, 0xd441fba0f46b43cdL).build2(SMethodBuilder.createJavaParameter((Class<SNode>) ((Class) Object.class), ""), SMethodBuilder.createJavaParameter((Class<SNode>) ((Class) Object.class), ""), SMethodBuilder.createJavaParameter((Class<Set<String>>) ((Class) Object.class), ""));
  public static final SMethod<Void> deleteAllMutationModels_id1qjbRymWTp$ = new SMethodBuilder<Void>(new SJavaCompoundTypeImpl(Void.class)).name("deleteAllMutationModels").modifiers(0, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(1626696085386008164L).languageId(0xb723dad7b65da615L, 0xd441fba0f46b43cdL).build2();
  /*package*/ static final SMethod<EditableSModel> createClonedModel_id3_xsRJ4wgFT = new SMethodBuilder<EditableSModel>(new SJavaCompoundTypeImpl(EditableSModel.class)).name("createClonedModel").modifiers(0, AccessPrivileges.PRIVATE).concept(CONCEPT).baseMethodId(4134712908317788921L).languageId(0xb723dad7b65da615L, 0xd441fba0f46b43cdL).build2(SMethodBuilder.createJavaParameter((Class<SNode>) ((Class) Object.class), ""), SMethodBuilder.createJavaParameter(String.class, ""));
  public static final SMethod<String> nodeIdentifier_id1qjbRynmQXx = new SMethodBuilder<String>(new SJavaCompoundTypeImpl(String.class)).name("nodeIdentifier").modifiers(0, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(1626696085392813921L).languageId(0xb723dad7b65da615L, 0xd441fba0f46b43cdL).build2(SMethodBuilder.createJavaParameter((Class<SNode>) ((Class) Object.class), ""));

  private static final List<SMethod<?>> BH_METHODS = Arrays.<SMethod<?>>asList(mutate_id3_xsRJ4oOrE, optionallyDelete_id1qjbRymONRy, findAdapterByInternalID_id3_xsRJ4LDk5, findRandomMutator_id7WSgHRL8UlQ, findRandomNode_id7WSgHRL9pFP, makeChange_id3_xsRJ4wolt, replaceWith_id1qjbRymQQWe, deleteAllMutationModels_id1qjbRymWTp$, createClonedModel_id3_xsRJ4wgFT, nodeIdentifier_id1qjbRynmQXx);

  private static void ___init___(@NotNull SNode __thisNode__) {
    SPropertyOperations.assign(__thisNode__, PROPS.numberOfMutations$E8ru, 10);
  }

  /*package*/ static SNode mutate_id3_xsRJ4oOrE(@NotNull SNode __thisNode__, SNode adapter) {
    Random rand = new Random(System.currentTimeMillis());
    SModel originalModel = adapter.getModel();
    List<SNode> globalLog = new ArrayList<SNode>();
    Set<String> mutatedNodes = SetSequence.fromSet(new HashSet<String>());
    for (int i = 0; i < SPropertyOperations.getInteger(__thisNode__, PROPS.numberOfMutations$E8ru); i++) {
      SModel newModel = MutationEngine__BehaviorDescriptor.createClonedModel_id3_xsRJ4wgFT.invokeSpecial(__thisNode__, adapter, originalModel.getName() + ".mutatants." + TestSubjectAdapter__BehaviorDescriptor.getName_id7WSgHRKUTmg.invoke(adapter) + "." + i);
      SNode clonedAdapter = MutationEngine__BehaviorDescriptor.findAdapterByInternalID_id3_xsRJ4LDk5.invoke(__thisNode__, newModel, SPropertyOperations.getString(adapter, PROPS.internalUniqueID$u16H));
      SNode subject = TestSubjectAdapter__BehaviorDescriptor.getSubject_id3_xsRJ4sekF.invoke(clonedAdapter);
      List<SNode> localLog = new ArrayList<SNode>();
      MutationEngine__BehaviorDescriptor.makeChange_id3_xsRJ4wolt.invoke(__thisNode__, clonedAdapter, subject, mutatedNodes, localLog, rand);
      EvalResult r = AbstractTestItem__BehaviorDescriptor.executeTest_id4KZjPKUdEYm.invoke(SNodeOperations.cast(SNodeOperations.getParent(clonedAdapter), CONCEPTS.VectorTestItem$2F));
      if (ListSequence.fromList(localLog).isEmpty()) {
        MutationEngine__BehaviorDescriptor.optionallyDelete_id1qjbRymONRy.invoke(__thisNode__, newModel, ((boolean) true));
      } else {
        if (!(r.isOk())) {
          MutationEngine__BehaviorDescriptor.optionallyDelete_id1qjbRymONRy.invoke(__thisNode__, newModel, ((boolean) !(SPropertyOperations.getBoolean(__thisNode__, PROPS.keepAll$YRMv))));
        } else {
          ListSequence.fromList(globalLog).addSequence(ListSequence.fromList(localLog));
        }
      }
    }
    ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(adapter, LINKS.mutator$ahE8), LINKS.logs$2Mrz)).addSequence(ListSequence.fromList(globalLog));
    return null;
  }
  /*package*/ static void optionallyDelete_id1qjbRymONRy(@NotNull SNode __thisNode__, SModel m, boolean delete) {
    if (delete) {
      new ModelDeleteHelper(m).delete();
    }
  }
  /*package*/ static SNode findAdapterByInternalID_id3_xsRJ4LDk5(@NotNull SNode __thisNode__, SModel m, final String internalID) {
    return ListSequence.fromList(SModelOperations.nodes(m, CONCEPTS.TestSubjectAdapter$24)).where((it) -> SPropertyOperations.getString(it, PROPS.internalUniqueID$u16H).equals(internalID)).first();
  }
  /*package*/ static Mutator findRandomMutator_id7WSgHRL8UlQ(@NotNull SNode __thisNode__, List<Mutator> muts, Random rand) {
    return ListSequence.fromList(muts).getElement(rand.nextInt(ListSequence.fromList(muts).count()));
  }
  /*package*/ static SNode findRandomNode_id7WSgHRL9pFP(@NotNull SNode __thisNode__, List<SNode> nodes, Random rand) {
    return ListSequence.fromList(nodes).getElement(rand.nextInt(ListSequence.fromList(nodes).count()));
  }
  /*package*/ static void makeChange_id3_xsRJ4wolt(@NotNull SNode __thisNode__, SNode adapter, SNode node, Set<String> mutatedNodes, List<SNode> newChanges, Random rand) {
    List<Mutator> allMutators = MutationRegistry.getMutators();
    boolean mutationHasBeenDone = false;
    int attempts = 0;
    List<SNode> subtrees = TestSubjectAdapter__BehaviorDescriptor.getMutatableSubtrees_id3yVmeSjI$yN.invoke(adapter);
    List<SNode> allNodes = SNodeOperations.getNodeDescendants(MutationEngine__BehaviorDescriptor.findRandomNode_id7WSgHRL9pFP.invoke(__thisNode__, subtrees, rand), null, false, new SAbstractConcept[]{});
    while (!(mutationHasBeenDone) && attempts < 10) {
      attempts++;
      final Mutator mutator = MutationEngine__BehaviorDescriptor.findRandomMutator_id7WSgHRL8UlQ.invoke(__thisNode__, allMutators, rand);
      List<SNode> candidates = ListSequence.fromList(allNodes).where((it) -> mutator.appliesTo(it)).toList();
      if (ListSequence.fromList(candidates).isNotEmpty()) {
        SNode r = MutationEngine__BehaviorDescriptor.findRandomNode_id7WSgHRL9pFP.invoke(__thisNode__, candidates, rand);
        if (!(SetSequence.fromSet(mutatedNodes).contains(MutationEngine__BehaviorDescriptor.nodeIdentifier_id1qjbRynmQXx.invoke(__thisNode__, r)))) {
          ListSequence.fromList(newChanges).addElement(MutationEngine__BehaviorDescriptor.replaceWith_id1qjbRymQQWe.invoke(__thisNode__, r, mutator.mutate(r), mutatedNodes));
          return;
        }
      }
    }
  }
  /*package*/ static SNode replaceWith_id1qjbRymQQWe(@NotNull SNode __thisNode__, SNode oldNode, SNode newNode, Set<String> mutatedNodes) {
    SetSequence.fromSet(mutatedNodes).addElement(MutationEngine__BehaviorDescriptor.nodeIdentifier_id1qjbRynmQXx.invoke(__thisNode__, oldNode));
    SNodeOperations.replaceWithAnother(oldNode, newNode);
    SetSequence.fromSet(mutatedNodes).addElement(MutationEngine__BehaviorDescriptor.nodeIdentifier_id1qjbRynmQXx.invoke(__thisNode__, newNode));
    SNode setNew = new IAttributeDescriptor.NodeAttribute(CONCEPTS.OldNodeAnnotation$Mc).setNew(newNode);
    SLinkOperations.setTarget(setNew, LINKS.oldNode$8VwQ, SNodeOperations.copyNode(oldNode));
    return createMutationLog_4duin7_a5a6(newNode);
  }
  /*package*/ static void deleteAllMutationModels_id1qjbRymWTp$(@NotNull final SNode __thisNode__) {
    ListSequence.fromList(SLinkOperations.getChildren(__thisNode__, LINKS.logs$2Mrz)).visitAll((it) -> {
      MutationEngine__BehaviorDescriptor.optionallyDelete_id1qjbRymONRy.invoke(__thisNode__, SNodeOperations.getModel(SLinkOperations.getTarget(it, LINKS.newNode$mFyX)), ((boolean) true));
      SNodeOperations.deleteNode(it);
    });
  }
  /*package*/ static EditableSModel createClonedModel_id3_xsRJ4wgFT(@NotNull SNode __thisNode__, SNode adapter, String name) {
    SModel orgModel = adapter.getModel();
    ModelRoot mr = adapter.getModel().getModelRoot();
    EditableSModel result = null;
    if (mr instanceof DefaultModelRoot) {
      result = SModuleOperations.createModelWithAdjustments(name, mr);
    } else {
      result = SModuleOperations.createModelWithAdjustments(name, mr);
    }
    ModelImports imports = new ModelImports(result);
    imports.copyImportedModelsFrom(orgModel);
    imports.copyUsedLanguagesFrom(orgModel);
    imports.copyEmployedDevKitsFrom(orgModel);
    imports.copyLanguageEngagedOnGeneration(orgModel);
    CopyUtil.copyModelContent(orgModel, result);
    result.setChanged(true);
    result.save();
    return result;
  }
  /*package*/ static String nodeIdentifier_id1qjbRynmQXx(@NotNull SNode __thisNode__, SNode n) {
    StringBuffer bf = new StringBuffer();
    for (SNode a : ListSequence.fromList(SNodeOperations.getNodeAncestors(n, null, true)).reversedList()) {
      bf.append(":");
      bf.append(SNodeOperations.getConcept(a).getName());
      if (SNodeOperations.getParent(a) != null) {
        bf.append("@");
        bf.append(SNodeOperations.getContainingLink(a));
        bf.append(".");
        bf.append(SNodeOperations.getIndexInParent(a) + "");
      } else {
        int rootIdx = ListSequence.fromList(SModelOperations.roots(SNodeOperations.getModel(a), null)).indexOf(a);
        bf.append("@");
        bf.append("ROOT");
        bf.append(".");
        bf.append(rootIdx);
      }
    }
    return bf.toString();
  }

  /*package*/ MutationEngine__BehaviorDescriptor() {
  }

  @Override
  protected void initNode(@NotNull SNode node, @NotNull SConstructor constructor, @Nullable Object[] parameters) {
    ___init___(node);
  }

  @Override
  protected <T> T invokeSpecial0(@NotNull SNode node, @NotNull SMethod<T> method, @Nullable Object[] parameters) {
    int methodIndex = BH_METHODS.indexOf(method);
    if (methodIndex < 0) {
      throw new BHMethodNotFoundException(this, method);
    }
    switch (methodIndex) {
      case 0:
        return (T) ((SNode) mutate_id3_xsRJ4oOrE(node, (SNode) parameters[0]));
      case 1:
        optionallyDelete_id1qjbRymONRy(node, (SModel) parameters[0], ((boolean) (Boolean) parameters[1]));
        return null;
      case 2:
        return (T) ((SNode) findAdapterByInternalID_id3_xsRJ4LDk5(node, (SModel) parameters[0], (String) parameters[1]));
      case 3:
        return (T) ((Mutator) findRandomMutator_id7WSgHRL8UlQ(node, (List<Mutator>) parameters[0], (Random) parameters[1]));
      case 4:
        return (T) ((SNode) findRandomNode_id7WSgHRL9pFP(node, (List<SNode>) parameters[0], (Random) parameters[1]));
      case 5:
        makeChange_id3_xsRJ4wolt(node, (SNode) parameters[0], (SNode) parameters[1], (Set<String>) parameters[2], (List<SNode>) parameters[3], (Random) parameters[4]);
        return null;
      case 6:
        return (T) ((SNode) replaceWith_id1qjbRymQQWe(node, (SNode) parameters[0], (SNode) parameters[1], (Set<String>) parameters[2]));
      case 7:
        deleteAllMutationModels_id1qjbRymWTp$(node);
        return null;
      case 8:
        return (T) ((EditableSModel) createClonedModel_id3_xsRJ4wgFT(node, (SNode) parameters[0], (String) parameters[1]));
      case 9:
        return (T) ((String) nodeIdentifier_id1qjbRynmQXx(node, (SNode) parameters[0]));
      default:
        throw new BHMethodNotFoundException(this, method);
    }
  }

  @Override
  protected <T> T invokeSpecial0(@NotNull SAbstractConcept concept, @NotNull SMethod<T> method, @Nullable Object[] parameters) {
    int methodIndex = BH_METHODS.indexOf(method);
    if (methodIndex < 0) {
      throw new BHMethodNotFoundException(this, method);
    }
    switch (methodIndex) {
      default:
        throw new BHMethodNotFoundException(this, method);
    }
  }

  @NotNull
  @Override
  public List<SMethod<?>> getDeclaredMethods() {
    return BH_METHODS;
  }

  @NotNull
  @Override
  public SAbstractConcept getConcept() {
    return CONCEPT;
  }
  private static SNode createMutationLog_4duin7_a5a6(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.MutationLog$XF);
    n0.setReferenceTarget(LINKS.newNode$mFyX, p0);
    return n0.getResult();
  }

  private static final class PROPS {
    /*package*/ static final SProperty numberOfMutations$E8ru = MetaAdapterFactory.getProperty(0xd441fba0f46b43cdL, 0xb723dad7b65da615L, 0x3961737bc46346c7L, 0x3961737bc4f25e8aL, "numberOfMutations");
    /*package*/ static final SProperty internalUniqueID$u16H = MetaAdapterFactory.getProperty(0xd441fba0f46b43cdL, 0xb723dad7b65da615L, 0x12e0beaa8fda1a08L, 0x3961737bc470a1b7L, "internalUniqueID");
    /*package*/ static final SProperty keepAll$YRMv = MetaAdapterFactory.getProperty(0xd441fba0f46b43cdL, 0xb723dad7b65da615L, 0x3961737bc46346c7L, 0x7f3842ddf1224628L, "keepAll");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept VectorTestItem$2F = MetaAdapterFactory.getConcept(0xd441fba0f46b43cdL, 0xb723dad7b65da615L, 0x39ebb0e06abca11aL, "org.iets3.core.expr.tests.structure.VectorTestItem");
    /*package*/ static final SConcept TestSubjectAdapter$24 = MetaAdapterFactory.getConcept(0xd441fba0f46b43cdL, 0xb723dad7b65da615L, 0x12e0beaa8fda1a08L, "org.iets3.core.expr.tests.structure.TestSubjectAdapter");
    /*package*/ static final SConcept OldNodeAnnotation$Mc = MetaAdapterFactory.getConcept(0xd441fba0f46b43cdL, 0xb723dad7b65da615L, 0x16932f7896db681dL, "org.iets3.core.expr.tests.structure.OldNodeAnnotation");
    /*package*/ static final SConcept MutationLog$XF = MetaAdapterFactory.getConcept(0xd441fba0f46b43cdL, 0xb723dad7b65da615L, 0x16932f7896cc1415L, "org.iets3.core.expr.tests.structure.MutationLog");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink mutator$ahE8 = MetaAdapterFactory.getContainmentLink(0xd441fba0f46b43cdL, 0xb723dad7b65da615L, 0x12e0beaa8fda1a08L, 0x3961737bc4f292a4L, "mutator");
    /*package*/ static final SContainmentLink logs$2Mrz = MetaAdapterFactory.getContainmentLink(0xd441fba0f46b43cdL, 0xb723dad7b65da615L, 0x3961737bc46346c7L, 0x16932f7896e3d5fdL, "logs");
    /*package*/ static final SContainmentLink oldNode$8VwQ = MetaAdapterFactory.getContainmentLink(0xd441fba0f46b43cdL, 0xb723dad7b65da615L, 0x16932f7896db681dL, 0x16932f7896db682bL, "oldNode");
    /*package*/ static final SReferenceLink newNode$mFyX = MetaAdapterFactory.getReferenceLink(0xd441fba0f46b43cdL, 0xb723dad7b65da615L, 0x16932f7896cc1415L, 0x16932f7896e3d5bfL, "newNode");
  }
}
