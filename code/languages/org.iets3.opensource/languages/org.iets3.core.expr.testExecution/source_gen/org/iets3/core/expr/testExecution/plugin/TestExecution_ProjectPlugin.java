package org.iets3.core.expr.testExecution.plugin;

/*Generated by MPS */

import com.mbeddr.mpsutil.spreferences.runtime.SPreferencesProjectPlugin;
import java.util.List;
import jetbrains.mps.plugins.prefs.BaseProjectPrefsComponent;
import com.intellij.openapi.project.Project;
import java.util.ArrayList;
import com.mbeddr.mpsutil.spreferences.runtime.SPreferencesModelFactory;
import org.jetbrains.mps.openapi.model.SModel;
import com.mbeddr.mpsutil.spreferences.runtime.PreferenceModules;
import com.mbeddr.mpsutil.spreferences.runtime.SPreferencesUtil;
import jetbrains.mps.smodel.ModuleRepositoryFacade;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import jetbrains.mps.smodel.Language;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.project.Solution;
import org.jetbrains.mps.openapi.model.EditableSModel;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import com.mbeddr.mpsutil.spreferences.runtime.SPrefererencesComponent;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class TestExecution_ProjectPlugin extends SPreferencesProjectPlugin {

  @Override
  protected List<BaseProjectPrefsComponent> createPreferencesComponents(final Project project) {
    List<BaseProjectPrefsComponent> components = new ArrayList<BaseProjectPrefsComponent>();

    SPreferencesModelFactory factory = new SPreferencesModelFactory() {
      public SModel getModel(final jetbrains.mps.project.Project mpsProject) {
        String id = "TestExecutionPreferences";
        String title = "TestExecutionPreferences";
        String modelName = PreferenceModules.getModelName(mpsProject, false, id);
        String folder = PreferenceModules.getFolder(mpsProject, id, false, false);
        final SModel model = PreferenceModules.getModel(folder, modelName, mpsProject);

        mpsProject.getRepository().getModelAccess().executeCommand(new Runnable() {
          public void run() {
            SPreferencesUtil.useLanguage(model, ModuleRepositoryFacade.getInstance().getModule(PersistenceFacade.getInstance().createModuleReference("2022a471-10ba-4431-ba5d-622df898f3c6(org.iets3.core.expr.testExecution)"), Language.class), mpsProject);

            List<SNode> pageNodes = SModelOperations.roots(model, CONCEPTS.TestExecutionConfig$QC);
            boolean isInit = pageNodes.isEmpty();
            SNode pageNode = (isInit ? null : pageNodes.get(0));
            if (isInit) {
              pageNode = SConceptOperations.createNewNode(SNodeOperations.asInstanceConcept(CONCEPTS.TestExecutionConfig$QC));
              SModelOperations.addRootNode(model, pageNode);
            }

            initUpdate(isInit, pageNode, mpsProject);

            Solution solution = ((Solution) model.getModule());
            if (solution.isChanged() && !(solution.isReadOnly())) {
              solution.save();
            }

            EditableSModel editableModel = ((EditableSModel) model);
            if (editableModel.isChanged() && !(editableModel.isReadOnly())) {
              editableModel.save();
            }
          }
          public void initUpdate(boolean isInit, SNode node, jetbrains.mps.project.Project project) {
            if (isInit) {
              SLinkOperations.setTarget(node, LINKS.executionMode$y6nW, SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x2022a47110ba4431L, 0xba5d622df898f3c6L, 0x3e144f9cc1c797c8L, "org.iets3.core.expr.testExecution.structure.InterpreterExecutionMode")));
            }
          }
        });

        return model;
      }
    };
    components.add(new SPrefererencesComponent(project, "TestExecutionPreferences", TestExecution_ProjectPlugin.this.getClass().getName(), factory) {
      @Override
      protected boolean enabled(jetbrains.mps.project.Project project) {
        return TestExecution_ProjectPlugin.this.enabled(project);
      }

      protected SAbstractConcept getRootConcept() {
        return CONCEPTS.TestExecutionConfig$QC;
      }
    });

    return components;
  }

  @Override
  protected boolean enabled(jetbrains.mps.project.Project project) {
    return true;
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept TestExecutionConfig$QC = MetaAdapterFactory.getConcept(0x2022a47110ba4431L, 0xba5d622df898f3c6L, 0x3e144f9cc1c728afL, "org.iets3.core.expr.testExecution.structure.TestExecutionConfig");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink executionMode$y6nW = MetaAdapterFactory.getContainmentLink(0x2022a47110ba4431L, 0xba5d622df898f3c6L, 0x3e144f9cc1c728afL, 0x3e144f9cc1c79776L, "executionMode");
  }
}
