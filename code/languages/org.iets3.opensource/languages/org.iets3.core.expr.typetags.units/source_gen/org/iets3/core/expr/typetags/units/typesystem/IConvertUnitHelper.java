package org.iets3.core.expr.typetags.units.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.dependencies.CheckingMethod;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.List;
import org.iets3.core.expr.typetags.units.behavior.IConvertUnit__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.errors.messageTargets.MessageTarget;
import jetbrains.mps.errors.messageTargets.NodeMessageTarget;
import jetbrains.mps.errors.IErrorReporter;
import org.iets3.core.expr.typetags.units.plugin.IUnitLangConfig;
import org.iets3.core.expr.typetags.units.plugin.UnitLangConfigHelper;
import jetbrains.mps.lang.core.behavior.BaseConcept__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.errors.BaseQuickFixProvider;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.typechecking.TypecheckingFacade;
import org.iets3.core.expr.typetags.units.behavior.UnitConversionUtil;
import java.util.Map;
import org.iets3.core.expr.base.runtime.runtime.Fraction;
import org.iets3.core.expr.typetags.units.behavior.ConversionSpecifier__BehaviorDescriptor;
import jetbrains.mps.lang.typesystem.dependencies.InferenceMethod;
import jetbrains.mps.typesystem.inference.EquationInfo;
import org.iets3.core.expr.typetags.behavior.TaggedType__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SProperty;

public class IConvertUnitHelper {
  private IConvertUnitHelper() {
  }

  @CheckingMethod
  public static void checkIConvertUnit(final TypeCheckingContext typeCheckingContext, SNode iConvertUnit) {
    List<SNode> applicableSpecifiers = IConvertUnit__BehaviorDescriptor.getApplicableConversionSpecifiers_id3_TFq$0_vSx.invoke(iConvertUnit);
    SNode conversionSpecifier = IConvertUnit__BehaviorDescriptor.getConversionSpecifier_id7SygLIkR36w.invoke(iConvertUnit);
    SNode convertExpression = IConvertUnit__BehaviorDescriptor.getExpression_id7SygLIkQnGn.invoke(iConvertUnit);

    if (ListSequence.fromList(applicableSpecifiers).isEmpty()) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(iConvertUnit, "no matching conversion specifier found", "r:bf3cd5a0-eefc-4fd9-b3a6-b57643c9d80c(org.iets3.core.expr.typetags.units.typesystem)", "624957442818656662", null, errorTarget);
      }
    } else if (ListSequence.fromList(applicableSpecifiers).count() > 1) {
      StringBuilder builder = new StringBuilder();
      builder.append("Multiple matching conversion specifiers have been found.");
      IUnitLangConfig config = UnitLangConfigHelper.getConfig();

      switch (config.getConversionSpecifierSelection()) {
        case DEFINED_IN_CONVERT_EXPESSION:
          builder.append(" For conversions, the selected specifier will be used");
          break;
        case FIRST_APPLICABLE:
          builder.append(" For conversions, the first applicable specifier will be used");
          break;
      }

      for (SNode specifier : ListSequence.fromList(applicableSpecifiers)) {
        builder.append("\n");
        builder.append(BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(specifier) + " in " + BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(SNodeOperations.getNodeAncestor(specifier, CONCEPTS.Chunk$sT, true, false)));
      }

      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportWarning(convertExpression, builder.toString(), "r:bf3cd5a0-eefc-4fd9-b3a6-b57643c9d80c(org.iets3.core.expr.typetags.units.typesystem)", "624957442818704732", null, errorTarget);
      }
    } else if (conversionSpecifier == null && ListSequence.fromList(applicableSpecifiers).count() == 1) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(convertExpression, "the conversion specifier must be set", "r:bf3cd5a0-eefc-4fd9-b3a6-b57643c9d80c(org.iets3.core.expr.typetags.units.typesystem)", "1197174311014856570", null, errorTarget);
        {
          BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("org.iets3.core.expr.typetags.units.typesystem.quickfix_SetConversionRule_QuickFix", "1197174311014862547", true);
          intentionProvider.putArgument("iConvertUnit", iConvertUnit);
          intentionProvider.putArgument("specifier", ListSequence.fromList(applicableSpecifiers).first());
          _reporter_2309309498.addIntentionProvider(intentionProvider);
        }
      }
    }

    if (conversionSpecifier != null) {
      if (SLinkOperations.getTarget(conversionSpecifier, LINKS.type$4V9E) == null || TypecheckingFacade.getFromContext().isSubtype(UnitConversionUtil.getInnerType(TypecheckingFacade.getFromContext().getTypeOf(convertExpression)), SLinkOperations.getTarget(conversionSpecifier, LINKS.type$4V9E))) {
        // the type of the to-be-converted expression must match the source unit
        Map<SNode, Fraction> convertExpressionSourceUnitMap = UnitConversionUtil.getUnitMap_Type(TypecheckingFacade.getFromContext().getTypeOf(convertExpression));
        Map<SNode, Fraction> ruleSourceUnitMap = UnitConversionUtil.getUnitMap_IUnit(SLinkOperations.getTarget(ConversionSpecifier__BehaviorDescriptor.getConversionRule_id1wGuEUvYk55.invoke(conversionSpecifier), LINKS.sourceUnit$686l), 1);
        Map<SNode, Fraction> convertExpressionTargetUnitMap = UnitConversionUtil.getUnitMap_IUnit(IConvertUnit__BehaviorDescriptor.getTargetUnit_id7SygLIkQpOA.invoke(iConvertUnit), 1);
        Map<SNode, Fraction> ruleTargetUnitMap = UnitConversionUtil.getUnitMap_IUnit(SLinkOperations.getTarget(ConversionSpecifier__BehaviorDescriptor.getConversionRule_id1wGuEUvYk55.invoke(conversionSpecifier), LINKS.targetUnit$68lm), 1);

        if (!((boolean) UnitConversionUtil.matchingUnits(convertExpressionSourceUnitMap, ruleSourceUnitMap)._0() && (boolean) UnitConversionUtil.matchingUnits(convertExpressionTargetUnitMap, ruleTargetUnitMap)._0())) {
          {
            final MessageTarget errorTarget = new NodeMessageTarget();
            IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(convertExpression, "expression must evaluate to an annotated type with the defined source unit", "r:bf3cd5a0-eefc-4fd9-b3a6-b57643c9d80c(org.iets3.core.expr.typetags.units.typesystem)", "624957442818447421", null, errorTarget);
          }
        }
      } else {
        {
          final MessageTarget errorTarget = new NodeMessageTarget();
          IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(convertExpression, "The expression's type is not applicable for the specifier", "r:bf3cd5a0-eefc-4fd9-b3a6-b57643c9d80c(org.iets3.core.expr.typetags.units.typesystem)", "7644849806582182026", null, errorTarget);
        }
      }
    }
  }

  @InferenceMethod
  public static void inferType(final TypeCheckingContext typeCheckingContext, final SNode iConvertUnit) {
    final SNode conversionSpecifier = IConvertUnit__BehaviorDescriptor.getConversionSpecifier_id7SygLIkR36w.invoke(iConvertUnit);
    final SNode expressionToConvert = IConvertUnit__BehaviorDescriptor.getExpression_id7SygLIkQnGn.invoke(iConvertUnit);

    {
      final SNode expressionToConvertType = typeCheckingContext.typeOf(expressionToConvert, "r:bf3cd5a0-eefc-4fd9-b3a6-b57643c9d80c(org.iets3.core.expr.typetags.units.typesystem)", "78245274157250467", true);
      typeCheckingContext.whenConcrete(expressionToConvertType, () -> {
        final SNode conversionSpecExpression = SLinkOperations.getTarget(conversionSpecifier, LINKS.expression$jxzQ);
        if ((conversionSpecExpression == null)) {
          // error will be issued by the checker - we cannot infer the correct type
          return;
        }

        // even though conversionSpecExpressionType is not used locally, 
        // this when concrete block is necessary to prevent endless infer-loop   
        {
          final SNode conversionSpecExpressionType = typeCheckingContext.typeOf(conversionSpecExpression, "r:bf3cd5a0-eefc-4fd9-b3a6-b57643c9d80c(org.iets3.core.expr.typetags.units.typesystem)", "8208891105592569631", true);
          typeCheckingContext.whenConcrete(conversionSpecExpressionType, () -> {
            final SNode targetUnitTag = IConvertUnitHelper.createTargetTag(iConvertUnit);
            SNode baseType = getBaseType(typeCheckingContext.getExpandedNode(expressionToConvertType));

            // perform type calculation based on the expression specified in the conversion specifier by replacing the val expression with the conversion expression  
            final SNode specifierExpressionCopy = SNodeOperations.copyNode(conversionSpecExpression);
            SNode parentConversionRule = ConversionSpecifier__BehaviorDescriptor.getConversionRule_id1wGuEUvYk55.invoke(conversionSpecifier);
            IConvertUnitHelper.replaceValExpressionWithBaseType(specifierExpressionCopy, parentConversionRule, baseType);
            {
              final SNode specifierExpressionCopyType = typeCheckingContext.typeOf(specifierExpressionCopy, "r:bf3cd5a0-eefc-4fd9-b3a6-b57643c9d80c(org.iets3.core.expr.typetags.units.typesystem)", "4240468146474016393", true);
              typeCheckingContext.whenConcrete(specifierExpressionCopyType, () -> {
                if (SNodeOperations.isInstanceOf(typeCheckingContext.getExpandedNode(specifierExpressionCopyType), CONCEPTS.TaggedType$O4)) {
                  {
                    SNode _nodeToCheck_1029348928467 = iConvertUnit;
                    EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:bf3cd5a0-eefc-4fd9-b3a6-b57643c9d80c(org.iets3.core.expr.typetags.units.typesystem)", "8208891105592737002", 0, null);
                    typeCheckingContext.createEquation((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:bf3cd5a0-eefc-4fd9-b3a6-b57643c9d80c(org.iets3.core.expr.typetags.units.typesystem)", "8208891105592736049", true), (SNode) typeCheckingContext.getExpandedNode(specifierExpressionCopyType), _info_12389875345);
                  }
                } else if (SNodeOperations.isInstanceOf(typeCheckingContext.getExpandedNode(specifierExpressionCopyType), CONCEPTS.Type$WK)) {
                  SNode result = TaggedType__BehaviorDescriptor.create_id2JXkwhJbtfS.invoke(SNodeOperations.asSConcept(CONCEPTS.TaggedType$O4), SNodeOperations.cast(typeCheckingContext.getExpandedNode(specifierExpressionCopyType), CONCEPTS.Type$WK), targetUnitTag);
                  {
                    SNode _nodeToCheck_1029348928467 = iConvertUnit;
                    EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:bf3cd5a0-eefc-4fd9-b3a6-b57643c9d80c(org.iets3.core.expr.typetags.units.typesystem)", "4240468146474225493", 0, null);
                    typeCheckingContext.createEquation((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:bf3cd5a0-eefc-4fd9-b3a6-b57643c9d80c(org.iets3.core.expr.typetags.units.typesystem)", "4240468146474224333", true), (SNode) result, _info_12389875345);
                  }
                }
              }, "r:bf3cd5a0-eefc-4fd9-b3a6-b57643c9d80c(org.iets3.core.expr.typetags.units.typesystem)", "4240468146474013942", false, false);
            }
          }, "r:bf3cd5a0-eefc-4fd9-b3a6-b57643c9d80c(org.iets3.core.expr.typetags.units.typesystem)", "8208891105592568569", false, false);
        }
      }, "r:bf3cd5a0-eefc-4fd9-b3a6-b57643c9d80c(org.iets3.core.expr.typetags.units.typesystem)", "78245274157236472", false, false);
    }
  }

  private static SNode createTargetTag(final SNode iConvertUnit) {
    return createUnitSpecification_kpu7bi_a0a6(IConvertUnit__BehaviorDescriptor.getTargetUnit_id7SygLIkQpOA.invoke(iConvertUnit));
  }
  private static void replaceValExpressionWithBaseType(final SNode specifierExpressionCopy, final SNode parentConversionRule, final SNode baseType) {
    ListSequence.fromList(SNodeOperations.getNodeDescendants(specifierExpressionCopy, CONCEPTS.ValExpression$OM, false, new SAbstractConcept[]{})).visitAll((it) -> {
      if (SPropertyOperations.getBoolean(parentConversionRule, PROPS.isEager$69Yt)) {
        // in case of a eager rule --> replace the val expression with a tagged type that has the tag of the source unit
        SLinkOperations.getTarget(parentConversionRule, LINKS.sourceUnit$686l);
        SNode taggedType = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x5186c6ce428c4f09L, 0xa9df73d9e86c27d3L, 0x186a8ed9947750b6L, "org.iets3.core.expr.typetags.structure.TaggedType"));
        SLinkOperations.setTarget(taggedType, LINKS.baseType$z6Mz, SNodeOperations.copyNode(baseType));
        SNode srcUnitSpec = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0xcb91a38e738a4811L, 0xa96d448d08f526faL, 0x73b48a125b0d411dL, "org.iets3.core.expr.typetags.units.structure.UnitSpecification"));
        SNode srcUnitRef = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0xcb91a38e738a4811L, 0xa96d448d08f526faL, 0x73b48a125b0d4dc5L, "org.iets3.core.expr.typetags.units.structure.UnitReference"));
        SLinkOperations.setTarget(srcUnitRef, LINKS.unit$3rM9, SLinkOperations.getTarget(parentConversionRule, LINKS.sourceUnit$686l));
        ListSequence.fromList(SLinkOperations.getChildren(srcUnitSpec, LINKS.components$SDyb)).addElement(srcUnitRef);
        ListSequence.fromList(SLinkOperations.getChildren(taggedType, LINKS.tags$Lx_i)).addElement(srcUnitSpec);
        SNodeOperations.replaceWithAnother(it, taggedType);
      } else {
        SNodeOperations.replaceWithAnother(it, SNodeOperations.copyNode(baseType));
      }
    });
  }

  private static SNode getBaseType(SNode type) {
    if (SNodeOperations.isInstanceOf(type, CONCEPTS.TaggedType$O4)) {
      return SLinkOperations.getTarget(SNodeOperations.cast(type, CONCEPTS.TaggedType$O4), LINKS.baseType$z6Mz);
    } else if (SNodeOperations.isInstanceOf(type, CONCEPTS.Type$WK)) {
      return SNodeOperations.cast(type, CONCEPTS.Type$WK);
    }
    return null;
  }
  private static SNode createUnitSpecification_kpu7bi_a0a6(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.UnitSpecification$DK);
    {
      SNodeBuilder n1 = n0.forChild(LINKS.components$SDyb).init(CONCEPTS.UnitReference$yP);
      n1.setReferenceTarget(LINKS.unit$3rM9, p0);
    }
    return n0.getResult();
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Chunk$sT = MetaAdapterFactory.getConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x6315bcc6effb4ea6L, "com.mbeddr.core.base.structure.Chunk");
    /*package*/ static final SConcept TaggedType$O4 = MetaAdapterFactory.getConcept(0x5186c6ce428c4f09L, 0xa9df73d9e86c27d3L, 0x186a8ed9947750b6L, "org.iets3.core.expr.typetags.structure.TaggedType");
    /*package*/ static final SConcept Type$WK = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a614L, "org.iets3.core.expr.base.structure.Type");
    /*package*/ static final SConcept ValExpression$OM = MetaAdapterFactory.getConcept(0xcb91a38e738a4811L, 0xa96d448d08f526faL, 0x47f53137d1e3b2aeL, "org.iets3.core.expr.typetags.units.structure.ValExpression");
    /*package*/ static final SConcept UnitSpecification$DK = MetaAdapterFactory.getConcept(0xcb91a38e738a4811L, 0xa96d448d08f526faL, 0x73b48a125b0d411dL, "org.iets3.core.expr.typetags.units.structure.UnitSpecification");
    /*package*/ static final SConcept UnitReference$yP = MetaAdapterFactory.getConcept(0xcb91a38e738a4811L, 0xa96d448d08f526faL, 0x73b48a125b0d4dc5L, "org.iets3.core.expr.typetags.units.structure.UnitReference");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink sourceUnit$686l = MetaAdapterFactory.getReferenceLink(0xcb91a38e738a4811L, 0xa96d448d08f526faL, 0xed6abcb370b28cbL, 0x182c7aae9ff63558L, "sourceUnit");
    /*package*/ static final SReferenceLink targetUnit$68lm = MetaAdapterFactory.getReferenceLink(0xcb91a38e738a4811L, 0xa96d448d08f526faL, 0xed6abcb370b28cbL, 0x182c7aae9ff63559L, "targetUnit");
    /*package*/ static final SContainmentLink type$4V9E = MetaAdapterFactory.getContainmentLink(0xcb91a38e738a4811L, 0xa96d448d08f526faL, 0x182c7aae9fea4574L, 0x182c7aaea0320b8dL, "type");
    /*package*/ static final SContainmentLink expression$jxzQ = MetaAdapterFactory.getContainmentLink(0xcb91a38e738a4811L, 0xa96d448d08f526faL, 0x182c7aae9fea4574L, 0x182c7aae9fee3f05L, "expression");
    /*package*/ static final SContainmentLink baseType$z6Mz = MetaAdapterFactory.getContainmentLink(0x5186c6ce428c4f09L, 0xa9df73d9e86c27d3L, 0x186a8ed9947750b6L, 0x186a8ed9947750b9L, "baseType");
    /*package*/ static final SReferenceLink unit$3rM9 = MetaAdapterFactory.getReferenceLink(0xcb91a38e738a4811L, 0xa96d448d08f526faL, 0x73b48a125b0d4dc5L, 0x73b48a125b0daafcL, "unit");
    /*package*/ static final SContainmentLink components$SDyb = MetaAdapterFactory.getContainmentLink(0xcb91a38e738a4811L, 0xa96d448d08f526faL, 0x73b48a125b0d411dL, 0x73b48a125b0dab03L, "components");
    /*package*/ static final SContainmentLink tags$Lx_i = MetaAdapterFactory.getContainmentLink(0x5186c6ce428c4f09L, 0xa9df73d9e86c27d3L, 0x71bf4701bdf46b3eL, 0x186a8ed9947750b7L, "tags");
  }

  private static final class PROPS {
    /*package*/ static final SProperty isEager$69Yt = MetaAdapterFactory.getProperty(0xcb91a38e738a4811L, 0xa96d448d08f526faL, 0xed6abcb370b28cbL, 0x182c7aae9ff63560L, "isEager");
  }
}
