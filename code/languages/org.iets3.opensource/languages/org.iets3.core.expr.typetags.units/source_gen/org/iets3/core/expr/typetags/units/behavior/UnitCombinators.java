package org.iets3.core.expr.typetags.units.behavior;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.util.Map;
import org.iets3.core.expr.base.runtime.runtime.Fraction;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import jetbrains.mps.internal.collections.runtime.IterableUtils;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.core.behavior.BaseConcept__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import java.util.List;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class UnitCombinators {

  public static SNode combine(SNode left, SNode right, SNode operation) {
    Map<SNode, Fraction> leftSpec = UnitConversionUtil.getUnitMap_UnitSpecification(SNodeOperations.as(left, CONCEPTS.UnitSpecification$DK));
    Map<SNode, Fraction> rightSpec = UnitConversionUtil.getUnitMap_UnitSpecification(SNodeOperations.as(right, CONCEPTS.UnitSpecification$DK));

    if (SNodeOperations.isInstanceOf(operation, CONCEPTS.PlusExpression$mx) || SNodeOperations.isInstanceOf(operation, CONCEPTS.MinusExpression$6z) || SNodeOperations.isInstanceOf(operation, CONCEPTS.BinaryComparisonExpression$7z)) {
      Tuples._2<Boolean, Iterable<SNode>> matchingUnits = UnitConversionUtil.matchingUnits(leftSpec, rightSpec);
      if ((boolean) matchingUnits._0()) {
        return (SNodeOperations.isInstanceOf(operation, CONCEPTS.BinaryComparisonExpression$7z) ? null : left);
      } else {
        String errMsg = "Unmatched units: " + IterableUtils.join(Sequence.fromIterable(matchingUnits._1()).select((it) -> BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(SNodeOperations.getContainingRoot(it)) + "." + SPropertyOperations.getString(it, PROPS.name$MnvL)), ", ") + "!";
        return createErrorTag_fjxz21_a1a0b0d0b(errMsg);
      }
    }

    if (SNodeOperations.isInstanceOf(operation, CONCEPTS.MulExpression$iC)) {
      Map<SNode, Fraction> unified = UnitConversionUtil.unify(leftSpec, rightSpec);
      List<SNode> references = UnitConversionUtil.createUnitReferences(unified);
      return createUnitSpecification_fjxz21_a2a5a1(references);
    }

    if (SNodeOperations.isInstanceOf(operation, CONCEPTS.DivExpression$us)) {
      Map<SNode, Fraction> unified = UnitConversionUtil.unify(leftSpec, UnitConversionUtil.negate(rightSpec));
      List<SNode> references = UnitConversionUtil.createUnitReferences(unified);
      return createUnitSpecification_fjxz21_a2a7a1(references);
    }

    return null;
  }

  private static SNode createErrorTag_fjxz21_a1a0b0d0b(String p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ErrorTag$yj);
    n0.setProperty(PROPS.description$dnEg, p0);
    return n0.getResult();
  }
  private static SNode createUnitSpecification_fjxz21_a2a5a1(Iterable<? extends SNode> p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.UnitSpecification$DK);
    n0.forChild(LINKS.components$SDyb).initNodeList(p0, CONCEPTS.UnitReference$yP);
    return n0.getResult();
  }
  private static SNode createUnitSpecification_fjxz21_a2a7a1(Iterable<? extends SNode> p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.UnitSpecification$DK);
    n0.forChild(LINKS.components$SDyb).initNodeList(p0, CONCEPTS.UnitReference$yP);
    return n0.getResult();
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept UnitSpecification$DK = MetaAdapterFactory.getConcept(0xcb91a38e738a4811L, 0xa96d448d08f526faL, 0x73b48a125b0d411dL, "org.iets3.core.expr.typetags.units.structure.UnitSpecification");
    /*package*/ static final SConcept BinaryComparisonExpression$7z = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86cb4f93L, "org.iets3.core.expr.base.structure.BinaryComparisonExpression");
    /*package*/ static final SConcept PlusExpression$mx = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86c9a4f2L, "org.iets3.core.expr.base.structure.PlusExpression");
    /*package*/ static final SConcept MinusExpression$6z = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86cac5a5L, "org.iets3.core.expr.base.structure.MinusExpression");
    /*package*/ static final SConcept MulExpression$iC = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86c9a56fL, "org.iets3.core.expr.base.structure.MulExpression");
    /*package*/ static final SConcept DivExpression$us = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86cac63bL, "org.iets3.core.expr.base.structure.DivExpression");
    /*package*/ static final SConcept ErrorTag$yj = MetaAdapterFactory.getConcept(0x5186c6ce428c4f09L, 0xa9df73d9e86c27d3L, 0x4b61610d29e00172L, "org.iets3.core.expr.typetags.structure.ErrorTag");
    /*package*/ static final SConcept UnitReference$yP = MetaAdapterFactory.getConcept(0xcb91a38e738a4811L, 0xa96d448d08f526faL, 0x73b48a125b0d4dc5L, "org.iets3.core.expr.typetags.units.structure.UnitReference");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
    /*package*/ static final SProperty description$dnEg = MetaAdapterFactory.getProperty(0x5186c6ce428c4f09L, 0xa9df73d9e86c27d3L, 0x4b61610d29e00172L, 0x5f4a60cc7cac2147L, "description");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink components$SDyb = MetaAdapterFactory.getContainmentLink(0xcb91a38e738a4811L, 0xa96d448d08f526faL, 0x73b48a125b0d411dL, 0x73b48a125b0dab03L, "components");
  }
}
