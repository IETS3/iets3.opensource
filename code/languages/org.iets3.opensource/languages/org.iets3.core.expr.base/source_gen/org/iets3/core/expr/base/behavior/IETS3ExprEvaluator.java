package org.iets3.core.expr.base.behavior;

/*Generated by MPS */

import com.mbeddr.mpsutil.interpreter.rt.IContext;
import com.mbeddr.mpsutil.interpreter.rt.ICoverageAnalyzer;
import com.mbeddr.mpsutil.interpreter.rt.IInterpreter;
import java.util.Map;
import org.jetbrains.mps.openapi.model.SNode;
import com.mbeddr.mpsutil.interpreter.rt.InterpreterEvaluationHelper;
import com.mbeddr.mpsutil.interpreter.rt.ComputationTrace;
import org.iets3.core.expr.base.plugin.ConstraintFailedException;
import com.mbeddr.mpsutil.interpreter.rt.StopAndReturnException;

public class IETS3ExprEvaluator {
  public static final String INTERPRETER_CATEGORY = "arithmetic";

  private IContext context = null;
  private boolean createComputationTrace = true;
  private ICoverageAnalyzer coverageAnalyzer = null;
  private IInterpreter interpreter = null;
  private Map<SNode, Object> environmentContent = null;

  private InterpreterEvaluationHelper helper = null;

  public IETS3ExprEvaluator withContext(IContext context) {
    this.context = context;
    return this;
  }

  public IETS3ExprEvaluator withComputationTrace(boolean flag) {
    this.createComputationTrace = flag;
    return this;
  }

  public IETS3ExprEvaluator withCoverAnalyzer(ICoverageAnalyzer coverageAnalyzer) {
    this.coverageAnalyzer = coverageAnalyzer;
    return this;
  }

  public IETS3ExprEvaluator withInterpreter(IInterpreter interpreter) {
    this.interpreter = interpreter;
    return this;
  }

  public IETS3ExprEvaluator withEnvironmentContent(Map<SNode, Object> environmentContent) {
    this.environmentContent = environmentContent;
    return this;
  }

  public ComputationTrace getLastLog() {
    return this.helper.getLastLog();
  }

  public Object evaluateAndThrowConstraintFailures(SNode expr) {
    try {
      return new IETS3ExprEvaluator().evaluate(expr).getValue();
    } catch (ConstraintFailedException cfe) {
      throw cfe;
    } catch (StopAndReturnException stopEx) {
      return stopEx.value();
    }
  }

  public ValueAndTraceAndEnv evaluate(SNode expr) {
    if (context == null) {
      context = new IETS3ExprContext();
    }

    if (environmentContent != null) {
      context.pushEnvironment(expr, environmentContent);
    }

    if (interpreter == null) {
      interpreter = getInterpreter();
    }

    try {
      helper = new InterpreterEvaluationHelper(INTERPRETER_CATEGORY);
      Object res = helper.evaluateWithOptions(expr).withContext(context).withComputationTrace(createComputationTrace).withCoverAnalyzer(coverageAnalyzer).withInterpreter(interpreter).execute();
      ComputationTrace trace = null;

      if (createComputationTrace) {
        trace = helper.getLastLog();
        trace.setValue(res);
      }

      return new ValueAndTraceAndEnv(res, trace, context.getEnvironment(), coverageAnalyzer);
    } catch (StopAndReturnException stopEx) {
      return new ValueAndTraceAndEnv(stopEx.value(), helper.getLastLog(), context.getEnvironment(), coverageAnalyzer);
    }
  }

  public static IInterpreter getInterpreter() {
    return InterpreterEvaluationHelper.getInterpreter(INTERPRETER_CATEGORY);
  }
}
