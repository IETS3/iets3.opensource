package org.iets3.core.expr.adt.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import com.mbeddr.mpsutil.interpreter.rt.IInterpreter;
import com.mbeddr.mpsutil.interpreter.rt.IContext;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.iets3.core.expr.adt.behavior.AlgebraicConstructorType__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.iets3.core.expr.adt.behavior.AlgebraicConstructor__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.iets3.core.expr.adt.behavior.AlgebraicConstructorArg__BehaviorDescriptor;
import java.util.Objects;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import org.pcollections.Empty;
import org.pcollections.PVector;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class MatchingEngine {

  private SNode myPattern;
  private Object candidate;

  public MatchingEngine(SNode pattern, Object cand) {
    myPattern = pattern;
    candidate = cand;
  }

  public CaseMatchResult match(IInterpreter interpreter, IContext context) {
    SuccessMatchResult success = new SuccessMatchResult();
    // toplevel wildcard or name
    if (SNodeOperations.isInstanceOf(myPattern, CONCEPTS.WildcardExpr$bs) || SNodeOperations.isInstanceOf(myPattern, CONCEPTS.NameExpr$kW)) {
      handleBindings(false, myPattern, candidate, success);
      return success;
    }
    if (!(SNodeOperations.isInstanceOf(myPattern, CONCEPTS.AlgebraicTerm$x9))) {
      return new FailedMatchResult(myPattern, "not an algebraic instance");
    }
    if (!(candidate instanceof AlgebraicValue)) {
      return new FailedMatchResult(myPattern, "target not an algebraic value");
    }
    SNode pattern = SNodeOperations.cast(myPattern, CONCEPTS.AlgebraicTerm$x9);
    AlgebraicValue val = (AlgebraicValue) candidate;
    if (!((boolean) AlgebraicConstructorType__BehaviorDescriptor.isInstance_id5a_u3OzQlow.invoke(SLinkOperations.getTarget(pattern, LINKS.type$Krjw), val.cons))) {
      return new FailedMatchResult(myPattern, "not the same constructor");
    }
    SNode patternConstructor = SLinkOperations.getTarget(SLinkOperations.getTarget(pattern, LINKS.type$Krjw), LINKS.constructor$F6Xq);
    if (!((boolean) AlgebraicConstructor__BehaviorDescriptor.isNumberOfArgsValid_id28$LOSBMC$e.invoke(patternConstructor, ((int) ListSequence.fromList(val.args).count())))) {
      return new FailedMatchResult(myPattern, "not the same number of args");
    }

    // add empty list binding in any case for last (list) argument
    boolean lastIsMulti = (boolean) AlgebraicConstructorArg__BehaviorDescriptor.isMulti_id28$LOSBI7yJ.invoke(ListSequence.fromList(SLinkOperations.getChildren(patternConstructor, LINKS.args$Vmrw)).last());
    if (SNodeOperations.isInstanceOf(ListSequence.fromList(SLinkOperations.getChildren(pattern, LINKS.args$DHHT)).last(), CONCEPTS.INamedSlot$o3)) {
      handleBindings(lastIsMulti, ListSequence.fromList(SLinkOperations.getChildren(pattern, LINKS.args$DHHT)).last(), null, success);
    }

    boolean matchedAMulti = false;
    boolean triedToMatchMulti = false;
    for (int i = 0; i < ListSequence.fromList(val.args).count(); i++) {
      Object valArg = ListSequence.fromList(val.args).getElement(i);
      int relevantArgIndex = i;
      if (i >= ListSequence.fromList(SLinkOperations.getChildren(pattern, LINKS.args$DHHT)).count()) {
        relevantArgIndex = ListSequence.fromList(SLinkOperations.getChildren(pattern, LINKS.args$DHHT)).count() - 1;
      }
      SNode patArg = ListSequence.fromList(SLinkOperations.getChildren(pattern, LINKS.args$DHHT)).getElement(relevantArgIndex);
      boolean isList = SNodeOperations.isInstanceOf(AlgebraicConstructor__BehaviorDescriptor.patternTypeAtPosition_id28$LOSBJasb.invoke(patternConstructor, ((int) relevantArgIndex)), CONCEPTS.ListType$i0);
      if (SNodeOperations.isInstanceOf(patArg, CONCEPTS.IWildcard$9Q)) {
        // ok, matches always
      } else if (SNodeOperations.isInstanceOf(patArg, CONCEPTS.AlgebraicTerm$x9)) {
        MatchingEngine childEngine = new MatchingEngine(patArg, valArg);
        CaseMatchResult r = childEngine.match(interpreter, context);
        if (isList) {
          triedToMatchMulti = true;
          if (!(r.isSuccess())) {
            continue;
          } else {
            matchedAMulti = true;
          }
        } else {
          if (!(r.isSuccess())) {
            return r;
          }
        }
        success.copyBindingsFrom(r);
      } else {
        Object evaluatedPattern = interpreter.evaluate(patArg, context);
        if (!(Objects.equals(evaluatedPattern, valArg))) {
          return new FailedMatchResult(patArg, "evaluated expressions don't match");
        }
      }
      handleBindings(isList, patArg, valArg, success);
    }
    if (triedToMatchMulti && !(matchedAMulti)) {
      return new FailedMatchResult(pattern, "unsuccessful multi match");
    }
    return success;
  }

  private void handleBindings(boolean isList, SNode patArg, Object valArg, SuccessMatchResult success) {
    SNode slot = null;
    if (new IAttributeDescriptor.NodeAttribute(CONCEPTS.NameAnnotation$Uh).get(patArg) != null) {
      slot = new IAttributeDescriptor.NodeAttribute(CONCEPTS.NameAnnotation$Uh).get(patArg);
    }
    if (SNodeOperations.isInstanceOf(patArg, CONCEPTS.NameExpr$kW)) {
      slot = SNodeOperations.cast(patArg, CONCEPTS.NameExpr$kW);
    }
    if (slot != null) {
      Map<SNode, Object> b = success.bindings;
      if (isList) {
        if (MapSequence.fromMap(b).get(slot) == null) {
          // store single value
          if (valArg != null) {
            MapSequence.fromMap(b).put(slot, Empty.vector().plus(valArg));
          } else {
            MapSequence.fromMap(b).put(slot, Empty.vector());
          }
        } else if (MapSequence.fromMap(b).get(slot) instanceof PVector) {
          // append to existing list
          MapSequence.fromMap(b).put(slot, ((PVector) MapSequence.fromMap(b).get(slot)).plus(valArg));
        }
      } else {
        MapSequence.fromMap(b).put(slot, valArg);
      }
    }
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept NameExpr$kW = MetaAdapterFactory.getConcept(0x5fe6cb132fbd4e21L, 0x9842785bdd6fc5b1L, 0x52a5783d22fb13a2L, "org.iets3.core.expr.adt.structure.NameExpr");
    /*package*/ static final SConcept WildcardExpr$bs = MetaAdapterFactory.getConcept(0x5fe6cb132fbd4e21L, 0x9842785bdd6fc5b1L, 0x52a5783d22e27ffaL, "org.iets3.core.expr.adt.structure.WildcardExpr");
    /*package*/ static final SConcept AlgebraicTerm$x9 = MetaAdapterFactory.getConcept(0x5fe6cb132fbd4e21L, 0x9842785bdd6fc5b1L, 0x52a5783d22cb8ce4L, "org.iets3.core.expr.adt.structure.AlgebraicTerm");
    /*package*/ static final SInterfaceConcept INamedSlot$o3 = MetaAdapterFactory.getInterfaceConcept(0x5fe6cb132fbd4e21L, 0x9842785bdd6fc5b1L, 0x52a5783d22fb5190L, "org.iets3.core.expr.adt.structure.INamedSlot");
    /*package*/ static final SConcept ListType$i0 = MetaAdapterFactory.getConcept(0x2f7e2e356e744c43L, 0x9fa52465d68f5996L, 0x68d69d36ba497720L, "org.iets3.core.expr.collections.structure.ListType");
    /*package*/ static final SInterfaceConcept IWildcard$9Q = MetaAdapterFactory.getInterfaceConcept(0x5fe6cb132fbd4e21L, 0x9842785bdd6fc5b1L, 0x52a5783d22fb13f5L, "org.iets3.core.expr.adt.structure.IWildcard");
    /*package*/ static final SConcept NameAnnotation$Uh = MetaAdapterFactory.getConcept(0x5fe6cb132fbd4e21L, 0x9842785bdd6fc5b1L, 0x52a5783d22ea3588L, "org.iets3.core.expr.adt.structure.NameAnnotation");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink type$Krjw = MetaAdapterFactory.getContainmentLink(0x5fe6cb132fbd4e21L, 0x9842785bdd6fc5b1L, 0x52a5783d22cb8ce4L, 0x52a5783d22cb8d96L, "type");
    /*package*/ static final SReferenceLink constructor$F6Xq = MetaAdapterFactory.getReferenceLink(0x5fe6cb132fbd4e21L, 0x9842785bdd6fc5b1L, 0x52a5783d22ca5715L, 0x52a5783d22ca571cL, "constructor");
    /*package*/ static final SContainmentLink args$Vmrw = MetaAdapterFactory.getContainmentLink(0x5fe6cb132fbd4e21L, 0x9842785bdd6fc5b1L, 0x52a5783d22c9d77cL, 0x2224c74e27a1e45dL, "args");
    /*package*/ static final SContainmentLink args$DHHT = MetaAdapterFactory.getContainmentLink(0x5fe6cb132fbd4e21L, 0x9842785bdd6fc5b1L, 0x52a5783d22cb8ce4L, 0x52a5783d22cb8ceaL, "args");
  }
}
