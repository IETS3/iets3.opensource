package org.iets3.core.expr.simpleTypes.migration;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.util.regex.Pattern;
import org.iets3.core.expr.base.runtime.runtime.PTF;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import java.util.Deque;
import jetbrains.mps.lang.migration.runtime.base.Problem;
import org.iets3.core.expr.simpleTypes.behavior.NumberLiteral__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.LinkedListSequence;
import jetbrains.mps.lang.migration.runtime.base.NotMigratedNode;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class ScientificNumberMigrationHelper {
  public static SNode migrateNumber(SNode literal) {
    Pattern newPattern = (PTF.useCommaInsteadOfDotForDecimals() ? REGEXP : REGEXP1);
    String value = SPropertyOperations.getString(literal, PROPS.value$iWTK);
    if ((value == null || value.length() == 0)) {
      return literal;
    }

    if (!(newPattern.matcher(value).find())) {
      int indexOfE = SPropertyOperations.getString(literal, PROPS.value$iWTK).toLowerCase().indexOf('e');
      if (indexOfE == 0) {
        value = "0" + value;
      } else if (indexOfE > 0 && !(Character.isDigit(value.charAt(indexOfE - 1)))) {
        value = value.substring(0, indexOfE) + "0" + value.substring(indexOfE);
      }
      SPropertyOperations.assign(literal, PROPS.value$iWTK, value);
    }
    return literal;
  }

  public static void checkMigratedNumber(SNode literal, Deque<Problem> problems) {
    if (!((boolean) NumberLiteral__BehaviorDescriptor.isValidNumber_id5Ys_ngSnFbJ.invoke(literal, SPropertyOperations.getString(literal, PROPS.value$iWTK)))) {
      LinkedListSequence.fromLinkedListNew(problems).addElement(new NotMigratedNode(literal) {
        @Override
        public String getMessage() {
          return "The number literal could not be migrated. Please check that the number has the right format.";
        }
      });
    }

  }
  private static final Pattern REGEXP = Pattern.compile("(?:-?)\\d*(?:,\\d+(?:[Ee][\\+\\-]?\\d+)?|\\d+[Ee][\\+\\-]?\\d+)", 0);
  private static final Pattern REGEXP1 = Pattern.compile("(?:-?)\\d*(?:\\.\\d+(?:[Ee][\\+\\-]?\\d+)?|\\d+[Ee][\\+\\-]?\\d+)", 0);

  private static final class PROPS {
    /*package*/ static final SProperty value$iWTK = MetaAdapterFactory.getProperty(0x6b277d9ad52d416fL, 0xa2091919bd737f50L, 0x46ff3b3d86d0e6daL, 0x46ff3b3d86d0e6ddL, "value");
  }
}
