package org.iets3.core.expr.process.plugin;

/*Generated by MPS */

import org.iets3.core.expr.mutable.plugin.InteractorValue;
import org.iets3.core.expr.mutable.plugin.IDValue;
import org.iets3.core.expr.base.runtime.runtime.PTF;
import org.iets3.core.expr.mutable.plugin.IDCommand;
import org.iets3.core.expr.mutable.plugin.IDArg;
import org.jetbrains.mps.openapi.model.SNode;
import java.math.BigInteger;
import org.pcollections.PSet;
import org.pcollections.Empty;
import org.pcollections.PCollection;
import com.mbeddr.mpsutil.interpreter.rt.IContext;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.iets3.core.expr.mutable.plugin.GlobalClockContainer;
import com.mbeddr.mpsutil.interpreter.rt.ComputationTrace;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.iets3.core.expr.mutable.plugin.InteractionDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import java.util.Iterator;
import org.iets3.core.expr.mutable.plugin.IDElement;
import java.util.List;
import org.iets3.core.expr.mutable.plugin.ContextValue;
import org.iets3.core.expr.base.behavior.IETS3ExprContext;
import com.mbeddr.mpsutil.interpreter.rt.ICoverageAnalyzer;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.iets3.core.expr.process.behavior.AbstractDecisionProcedure__BehaviorDescriptor;
import org.iets3.core.expr.process.behavior.AbstractTurnoutPolicy__BehaviorDescriptor;
import org.iets3.core.expr.base.plugin.NoneValue;
import java.util.ArrayList;
import java.util.Collection;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SConcept;

public class MultipartyBooleanDecisionValue extends InteractorValue {

  private static final IDValue DEC_TAKEN_BOOL = new IDValue("decisionTaken", PTF.createBooleanType());
  private static final IDCommand VOTE = new IDCommand("vote", new IDArg("who", createPartyType_z7438d_b0b0a2()));
  private static final IDValue WHO_VOTED = new IDValue("whoVoted", createListType_z7438d_b0a3());

  private static final IDValue TURNOUT_ACHIEVED = new IDValue("turnoutAchieved", PTF.createBooleanType());
  private static final IDValue DEC_TAKEN_TROOL = new IDValue("decision", createOptionType_z7438d_b0a6(PTF.createBooleanType()));
  private static final IDValue WHO_VOTED_FOR = new IDValue("whoVotedFor", createListType_z7438d_b0a7());
  private static final IDValue WHO_VOTED_AGAINST = new IDValue("whoVotedAgainst", createListType_z7438d_b0a8());
  private static final IDCommand VOTE_FOR = new IDCommand("voteFor", new IDArg("who", createPartyType_z7438d_b0b0a9()));
  private static final IDCommand VOTE_AGAINST = new IDCommand("voteAgainst", new IDArg("who", createPartyType_z7438d_b0b0a01()));

  private static final IDCommand REVOKE = new IDCommand("revoke", new IDArg("who", createPartyType_z7438d_b0b0a21()));

  private static final IDValue REGISTERED_PARTIES = new IDValue("registeredParties", createListType_z7438d_b0a41());
  private static final IDCommand ADD_PARTY = new IDCommand("addParty", new IDArg("who", createPartyType_z7438d_b0b0a51()));
  private static final IDCommand ADD_PARTIES = new IDCommand("addParties", new IDArg("whose", createCollectionType_z7438d_b0b0a61()));

  private static final IDCommand SEAL_PARTIES = new IDCommand("sealParties");
  private static final IDValue IS_SEALED = new IDValue("isSealed", PTF.createBooleanType());


  private SNode decision;
  private State state;
  private BigInteger deadline = null;



  public static class State {
    private PSet registeredParties;
    private boolean partiesSealed;
    private PSet votedFor;
    private PSet votedAgainst;
    public State(PSet initialParties) {
      votedFor = Empty.set();
      votedAgainst = Empty.set();
      registeredParties = initialParties;
    }
    public State(PSet initialParties, boolean sealed, PSet votedYes, PSet votedNo) {
      registeredParties = initialParties;
      votedFor = votedYes;
      votedAgainst = votedNo;
      partiesSealed = sealed;
    }
    public State voteFor(Object party) {
      return new State(registeredParties, partiesSealed, votedFor.plus(party), votedAgainst.minus(party));
    }
    public State addParty(Object party) {
      return new State(registeredParties.plus(party), partiesSealed, votedFor, votedAgainst);
    }
    public State voteAgainst(Object party) {
      return new State(registeredParties, partiesSealed, votedFor.minus(party), votedAgainst.plus(party));
    }
    public State revoke(Object party) {
      return new State(registeredParties, partiesSealed, votedFor.minus(party), votedAgainst.minus(party));
    }
    public State seal() {
      return new State(registeredParties, true, votedFor, votedAgainst);
    }
    public PCollection allWhoVoted() {
      return votedFor.plusAll(votedAgainst);
    }
    public PCollection registeredParties() {
      return registeredParties;
    }
  }


  public MultipartyBooleanDecisionValue(SNode decision, IContext ctx) {
    super(decision, ctx);
    this.state = new State(addInitialParties(SLinkOperations.getChildren(decision, LINKS.parties$GCIW)));
    this.decision = decision;
    this.decision = decision;
    this.decision = decision;
    if (SLinkOperations.getTarget(decision, LINKS.timeLimit$E_5m) != null) {
      BigInteger now = GlobalClockContainer.clock().timeMillis();
      deadline = now.add((BigInteger) eval(SLinkOperations.getTarget(decision, LINKS.timeLimit$E_5m), new ComputationTrace()));
    }
  }

  public PSet addInitialParties(Iterable<SNode> parties) {
    final Wrappers._T<PSet> res = new Wrappers._T<PSet>(Empty.set());
    Sequence.fromIterable(parties).visitAll((it) -> res.value = res.value.plus(eval(it, new ComputationTrace())));
    return res.value;
  }


  public static InteractionDescriptor descriptor(SNode decision) {
    InteractionDescriptor d;
    if (SLinkOperations.getTarget(decision, LINKS.turnout$hghB) != null) {
      d = new InteractionDescriptor(VOTE_FOR, VOTE_AGAINST, DEC_TAKEN_TROOL, WHO_VOTED, TURNOUT_ACHIEVED, WHO_VOTED_FOR, WHO_VOTED_AGAINST);
    } else {
      d = new InteractionDescriptor(VOTE, DEC_TAKEN_BOOL, WHO_VOTED);
    }
    if (SPropertyOperations.getBoolean(decision, PROPS.revoke$cJ2w)) {
      d.addElement(REVOKE);
    }
    if (SPropertyOperations.getBoolean(decision, PROPS.dynamicParties$jJKL)) {
      d.addElement(ADD_PARTY);
      d.addElement(ADD_PARTIES);
      d.addElement(REGISTERED_PARTIES);
      if (SPropertyOperations.getBoolean(decision, PROPS.sealable$izVO)) {
        d.addElement(SEAL_PARTIES);
        d.addElement(IS_SEALED);
      }
    }
    return d;
  }

  private boolean isValidParty(String expr, ComputationTrace trace) {
    Iterator<Object> iter = state.registeredParties.iterator();
    while (iter.hasNext()) {
      Object next = iter.next();
      if (next.equals(expr)) {
        return true;
      }
    }
    return false;
  }

  private void failIfInvalidParty(String party, ComputationTrace trace) {
    if (!(isValidParty(party, trace))) {
      reportInvalidCommand("Party " + party + " is not declared in the process; current " + this.state.registeredParties, trace);
    }
  }

  private void failIfDeadlinePassed(ComputationTrace trace) {
    if (deadline != null) {
      BigInteger now = GlobalClockContainer.clock().timeMillis();
      if (now.compareTo(deadline) > 0) {
        reportInvalidCommand("Deadline has expired.", trace);
      }
    }
  }

  private void failISealed(ComputationTrace trace) {
    if (state.partiesSealed) {
      reportInvalidCommand("Parties are sealed.", trace);
    }
  }

  @Override
  public Object handleElement(IDElement element, List<Object> payload, List<ContextValue> contextArgs, IETS3ExprContext context, ICoverageAnalyzer coverage, final ComputationTrace trace) {
    if (VOTE.is(element) || VOTE_FOR.is(element)) {
      if (ListSequence.fromList(payload).isNotEmpty()) {
        String party = (String) ListSequence.fromList(payload).first();
        failIfInvalidParty(party, trace);
        failIfDeadlinePassed(trace);
        state = state.voteFor(party);
      }
    } else if (VOTE_AGAINST.is(element)) {
      String party = (String) ListSequence.fromList(payload).first();
      failIfInvalidParty(party, trace);
      failIfDeadlinePassed(trace);
      state = state.voteAgainst(party);
    } else if (REVOKE.is(element)) {
      if (ListSequence.fromList(payload).isNotEmpty()) {
        String party = (String) ListSequence.fromList(payload).first();
        failIfInvalidParty(party, trace);
        failIfDeadlinePassed(trace);
        state = state.revoke(party);
      }
    } else if (DEC_TAKEN_BOOL.is(element)) {
      return (boolean) AbstractDecisionProcedure__BehaviorDescriptor.isDecided_id1mDdTFSeTs.invoke(SLinkOperations.getTarget(decision, LINKS.procedure$FNg1), ListSequence.fromList(SLinkOperations.getChildren(this.decision, LINKS.parties$GCIW)).select((it) -> eval(it, trace)).toList(), state.votedFor, context, trace);
    } else if (DEC_TAKEN_TROOL.is(element)) {
      if ((boolean) AbstractTurnoutPolicy__BehaviorDescriptor.turnoutAchieved_id3wXkdMVmH69.invoke(SLinkOperations.getTarget(decision, LINKS.turnout$hghB), state.registeredParties, state.allWhoVoted(), context, trace)) {
        return (boolean) AbstractDecisionProcedure__BehaviorDescriptor.isDecided_id1mDdTFSeTs.invoke(SLinkOperations.getTarget(decision, LINKS.procedure$FNg1), ListSequence.fromList(SLinkOperations.getChildren(this.decision, LINKS.parties$GCIW)).select((it) -> eval(it, trace)).toList(), state.votedFor, context, trace);
      }
      return new NoneValue();
    } else if (WHO_VOTED.is(element)) {
      List<Object> r = ListSequence.fromList(new ArrayList<Object>());
      for (Object v : state.allWhoVoted().toArray()) {
        ListSequence.fromList(r).addElement(v);
      }
      return r;
    } else if (WHO_VOTED_FOR.is(element)) {
      return state.votedFor;
    } else if (WHO_VOTED_AGAINST.is(element)) {
      return state.votedAgainst;
    } else if (ADD_PARTY.is(element)) {
      failISealed(trace);
      if (ListSequence.fromList(payload).isNotEmpty()) {
        failIfDeadlinePassed(trace);
        String party = (String) ListSequence.fromList(payload).first();
        state = state.addParty(party);
      }
    } else if (ADD_PARTIES.is(element)) {
      failISealed(trace);
      if (ListSequence.fromList(payload).isNotEmpty()) {
        failIfDeadlinePassed(trace);
        Collection<String> parties = (Collection<String>) ListSequence.fromList(payload).first();
        for (String p : parties) {
          state = state.addParty(p);
        }
      }
    } else if (SEAL_PARTIES.is(element)) {
      state = state.seal();
    } else if (IS_SEALED.is(element)) {
      return state.partiesSealed;
    } else if (REGISTERED_PARTIES.is(element)) {
      return state.registeredParties;
    } else if (TURNOUT_ACHIEVED.is(element)) {
      return (boolean) AbstractTurnoutPolicy__BehaviorDescriptor.turnoutAchieved_id3wXkdMVmH69.invoke(SLinkOperations.getTarget(decision, LINKS.turnout$hghB), state.registeredParties, state.allWhoVoted(), context, trace);
    }
    return null;
  }


  @Override
  public Object getValue() {
    return this.state;
  }

  @Override
  public void setValue(Object newValue) {
    this.state = ((State) newValue);
  }

  @Override
  public Object createSnapshot() {
    return this.getValue();
  }

  @Override
  public Object getSubstate(SNode n, IContext ctx, ComputationTrace trace) {
    throw new RuntimeException();
  }
  private static SNode createPartyType_z7438d_b0b0a2() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.PartyType$21);
    return n0.getResult();
  }
  private static SNode createListType_z7438d_b0a3() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ListType$i0);
    n0.forChild(LINKS.baseType$5NOJ).init(CONCEPTS.PartyType$21);
    return n0.getResult();
  }
  private static SNode createOptionType_z7438d_b0a6(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.OptionType$eU);
    n0.forChild(LINKS.baseType$Cv_a).initNode(p0, CONCEPTS.Type$WK, true);
    return n0.getResult();
  }
  private static SNode createListType_z7438d_b0a7() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ListType$i0);
    n0.forChild(LINKS.baseType$5NOJ).init(CONCEPTS.PartyType$21);
    return n0.getResult();
  }
  private static SNode createListType_z7438d_b0a8() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ListType$i0);
    n0.forChild(LINKS.baseType$5NOJ).init(CONCEPTS.PartyType$21);
    return n0.getResult();
  }
  private static SNode createPartyType_z7438d_b0b0a9() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.PartyType$21);
    return n0.getResult();
  }
  private static SNode createPartyType_z7438d_b0b0a01() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.PartyType$21);
    return n0.getResult();
  }
  private static SNode createPartyType_z7438d_b0b0a21() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.PartyType$21);
    return n0.getResult();
  }
  private static SNode createListType_z7438d_b0a41() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ListType$i0);
    n0.forChild(LINKS.baseType$5NOJ).init(CONCEPTS.PartyType$21);
    return n0.getResult();
  }
  private static SNode createPartyType_z7438d_b0b0a51() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.PartyType$21);
    return n0.getResult();
  }
  private static SNode createCollectionType_z7438d_b0b0a61() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.CollectionType$kS);
    n0.forChild(LINKS.baseType$5NOJ).init(CONCEPTS.PartyType$21);
    return n0.getResult();
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink parties$GCIW = MetaAdapterFactory.getContainmentLink(0x50b470e714ad46c3L, 0xb5404586f56d2e9cL, 0x7f2b47dbd5d4adafL, 0xfc43d48233b1334L, "parties");
    /*package*/ static final SContainmentLink timeLimit$E_5m = MetaAdapterFactory.getContainmentLink(0x50b470e714ad46c3L, 0xb5404586f56d2e9cL, 0x7f2b47dbd5d4adafL, 0x47d8a6856c8eace0L, "timeLimit");
    /*package*/ static final SContainmentLink turnout$hghB = MetaAdapterFactory.getContainmentLink(0x50b470e714ad46c3L, 0xb5404586f56d2e9cL, 0x7f2b47dbd5d4adafL, 0x383d50dcbb50c27eL, "turnout");
    /*package*/ static final SContainmentLink procedure$FNg1 = MetaAdapterFactory.getContainmentLink(0x50b470e714ad46c3L, 0xb5404586f56d2e9cL, 0x7f2b47dbd5d4adafL, 0x30d6adb796c98f52L, "procedure");
    /*package*/ static final SContainmentLink baseType$5NOJ = MetaAdapterFactory.getContainmentLink(0x2f7e2e356e744c43L, 0x9fa52465d68f5996L, 0x68d69d36ba495885L, 0x68d69d36ba495886L, "baseType");
    /*package*/ static final SContainmentLink baseType$Cv_a = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x26f4f2a81ca93310L, 0x26f4f2a81ca93311L, "baseType");
  }

  private static final class PROPS {
    /*package*/ static final SProperty revoke$cJ2w = MetaAdapterFactory.getProperty(0x50b470e714ad46c3L, 0xb5404586f56d2e9cL, 0x7f2b47dbd5d4ada7L, 0xfc43d482337d416L, "revoke");
    /*package*/ static final SProperty sealable$izVO = MetaAdapterFactory.getProperty(0x50b470e714ad46c3L, 0xb5404586f56d2e9cL, 0x7f2b47dbd5d4adafL, 0x3b44f043516c00f8L, "sealable");
    /*package*/ static final SProperty dynamicParties$jJKL = MetaAdapterFactory.getProperty(0x50b470e714ad46c3L, 0xb5404586f56d2e9cL, 0x7f2b47dbd5d4adafL, 0xee66588a9aaf607L, "dynamicParties");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept PartyType$21 = MetaAdapterFactory.getConcept(0x50b470e714ad46c3L, 0xb5404586f56d2e9cL, 0xfc43d48233b0f22L, "org.iets3.core.expr.process.structure.PartyType");
    /*package*/ static final SConcept ListType$i0 = MetaAdapterFactory.getConcept(0x2f7e2e356e744c43L, 0x9fa52465d68f5996L, 0x68d69d36ba497720L, "org.iets3.core.expr.collections.structure.ListType");
    /*package*/ static final SConcept OptionType$eU = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x26f4f2a81ca93310L, "org.iets3.core.expr.base.structure.OptionType");
    /*package*/ static final SConcept Type$WK = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a614L, "org.iets3.core.expr.base.structure.Type");
    /*package*/ static final SConcept CollectionType$kS = MetaAdapterFactory.getConcept(0x2f7e2e356e744c43L, 0x9fa52465d68f5996L, 0x68d69d36ba495885L, "org.iets3.core.expr.collections.structure.CollectionType");
  }
}
