package org.iets3.components.functional.plugin;

/*Generated by MPS */

import de.itemis.mps.editor.diagram.runtime.model.SNodeConnectionType;
import javax.swing.Icon;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import de.itemis.mps.editor.diagram.runtime.DiagramContext;
import java.util.ArrayList;
import java.util.List;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import org.iets3.components.core.behavior.PortCategory__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.Objects;
import org.iets3.components.core.behavior.AbstractComponentInstanceBase__BehaviorDescriptor;
import org.iets3.components.core.behavior.Component__BehaviorDescriptor;
import jetbrains.mps.smodel.action.NodeFactoryManager;
import org.iets3.components.core.behavior.IPortType__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public abstract class AutoConnectionType extends SNodeConnectionType {
  private Icon _icon;
  private SNode _sourcePortCategory;

  public AutoConnectionType(String name, Icon icon, SNode sourcePortCategory) {
    super(name);
    _icon = icon;
    _sourcePortCategory = sourcePortCategory;
  }

  @Override
  public boolean canCreate(SNode fromNode, String fromPort, SNode toNode, String toPort) {
    return SNodeOperations.isInstanceOf(fromNode, CONCEPTS.AbstractComponentInstanceBase$QW) && SNodeOperations.isInstanceOf(toNode, CONCEPTS.AbstractComponentInstanceBase$QW) && fromNode != toNode && (fromPort == null || fromPort.length() == 0) && (toPort == null || toPort.length() == 0);
  }

  @Override
  public Icon getIcon() {
    return _icon;
  }

  @Override
  public boolean showContextButton() {
    return false;
  }

  public abstract SNode getPortType();

  protected void doCreate(SNode fromNode, String fromPort, SNode toNode, String toPort) {
    Iterable<SNode> contextInstances = SNodeOperations.ofConcept(getDeepComponentContent(SNodeOperations.ofConcept(DiagramContext.getAllDiagramNodes(), CONCEPTS.ComponentSubstructure$oB), new ArrayList<SNode>()), CONCEPTS.AbstractComponentInstanceBase$QW);
    List<SNode> hierarchyUp = calculateHierarchy(SNodeOperations.cast(fromNode, CONCEPTS.AbstractComponentInstanceBase$QW), contextInstances, new ArrayList<SNode>());
    final Wrappers._T<List<SNode>> hierarchyDn = new Wrappers._T<List<SNode>>(calculateHierarchy(SNodeOperations.cast(toNode, CONCEPTS.AbstractComponentInstanceBase$QW), contextInstances, new ArrayList<SNode>()));
    SNode commonParent = ListSequence.fromList(hierarchyUp).findFirst((it) -> ListSequence.fromList(hierarchyDn.value).contains(it));
    if (commonParent != null) {
      hierarchyUp = ListSequence.fromList(hierarchyUp).headListSequence(ListSequence.fromList(hierarchyUp).indexOf(commonParent));
      hierarchyDn.value = ListSequence.fromList(hierarchyDn.value).headListSequence(ListSequence.fromList(hierarchyDn.value).indexOf(commonParent));
    }
    hierarchyDn.value = ListSequence.fromList(hierarchyDn.value).reversedList();

    SNode interim_fromNode = null;
    SNode interim_fromPort = createPort_egjn7_a0i0n(getPortType(), _sourcePortCategory);

    for (SNode interim_toNode : ListSequence.fromList(hierarchyUp)) {
      if (interim_fromNode != null) {
        interim_fromPort = addPortsAndConnection(interim_fromNode, interim_fromPort, interim_toNode, _sourcePortCategory, true, false);
      }
      interim_fromNode = interim_toNode;
    }
    boolean importConnection = false;
    for (SNode interim_toNode : ListSequence.fromList(hierarchyDn.value)) {
      interim_fromPort = addPortsAndConnection(interim_fromNode, interim_fromPort, interim_toNode, SConceptOperations.createNewNode(SNodeOperations.asInstanceConcept(PortCategory__BehaviorDescriptor.oppositeCategory_idmIQkxfpv6J.invoke(_sourcePortCategory))), false, importConnection);
      interim_fromNode = interim_toNode;
      importConnection = true;
    }
  }

  private List<SNode> calculateHierarchy(final SNode baseInstance, final Iterable<SNode> contextInstances, List<SNode> hierarchy) {
    ListSequence.fromList(hierarchy).addElement(baseInstance);
    final SNode parentComponent = SNodeOperations.getNodeAncestor(baseInstance, CONCEPTS.Component$gR, false, false);
    if (parentComponent != null) {
      // TODO: looks like we need to make AbstractComponentInstanceBase implement ISubstructureContent to resolve the error below
      SNode parentComponentInstance = Sequence.fromIterable(contextInstances).findFirst((it) -> Objects.equals(AbstractComponentInstanceBase__BehaviorDescriptor.component_id77HYM7H$sfU.invoke(it), parentComponent) && Sequence.fromIterable(Component__BehaviorDescriptor.allSubstructure_idsiw10FnrMt.invoke(AbstractComponentInstanceBase__BehaviorDescriptor.component_id77HYM7H$sfU.invoke(it))).contains(baseInstance));
      if (parentComponentInstance != null) {
        calculateHierarchy(parentComponentInstance, contextInstances, hierarchy);
      }
    }
    return hierarchy;
  }

  private SNode addPortsAndConnection(SNode fromNode, SNode fromPort, SNode toNode, SNode toPortCategory, boolean isExportConnection, boolean isImportConnection) {
    SNode toPort = createPort_egjn7_a0a0r(getPortType(), toPortCategory);

    SNode toComponent = AbstractComponentInstanceBase__BehaviorDescriptor.component_id77HYM7H$sfU.invoke(toNode);
    SNode fromComponent = AbstractComponentInstanceBase__BehaviorDescriptor.component_id77HYM7H$sfU.invoke(fromNode);
    NodeFactoryManager.setupNode(CONCEPTS.Port$gs, toPort, null, Component__BehaviorDescriptor.ensureCompInterface_idx8tpSAdmRF.invoke(toComponent), SNodeOperations.getModel(toComponent));
    NodeFactoryManager.setupNode(CONCEPTS.Port$gs, fromPort, null, Component__BehaviorDescriptor.ensureCompInterface_idx8tpSAdmRF.invoke(fromComponent), SNodeOperations.getModel(fromComponent));
    ListSequence.fromList(Component__BehaviorDescriptor.interfaceContent_idx8tpSAdLM$.invoke(fromComponent)).addElement(fromPort);
    ListSequence.fromList(Component__BehaviorDescriptor.interfaceContent_idx8tpSAdLM$.invoke(toComponent)).addElement(toPort);

    if (isExportConnection) {
      SNode ss = SNodeOperations.getNodeAncestor(fromNode, CONCEPTS.ComponentSubstructure$oB, false, false);
      SNode exportConnector = createExportConnector_egjn7_a0b0j0r(IPortType__BehaviorDescriptor.createConnectorType_id4KDeVD8s9TJ.invoke(SLinkOperations.getTarget(fromPort, LINKS.type$5Gl6)), fromNode, fromPort, toPort);
      NodeFactoryManager.setupNode(CONCEPTS.ExportConnector$hw, exportConnector, null, ss, SNodeOperations.getModel(ss));
      ListSequence.fromList(SLinkOperations.getChildren(ss, LINKS.contents$7e9r)).addElement(exportConnector);
    } else if (isImportConnection) {
      SNode ss = SNodeOperations.getNodeAncestor(toNode, CONCEPTS.ComponentSubstructure$oB, false, false);
      SNode importConnector = createImportConnector_egjn7_a0b0a9a71(IPortType__BehaviorDescriptor.createConnectorType_id4KDeVD8s9TJ.invoke(SLinkOperations.getTarget(fromPort, LINKS.type$5Gl6)), fromPort, toNode, toPort);
      NodeFactoryManager.setupNode(CONCEPTS.ImportConnector$8o, importConnector, null, ss, SNodeOperations.getModel(ss));
      ListSequence.fromList(SLinkOperations.getChildren(ss, LINKS.contents$7e9r)).addElement(importConnector);
    } else {
      SNode ss = SNodeOperations.getNodeAncestor(fromNode, CONCEPTS.ComponentSubstructure$oB, false, false);
      SNode assemblyConnector = createAssemblyConnector_egjn7_a0b0a9a71(IPortType__BehaviorDescriptor.createConnectorType_id4KDeVD8s9TJ.invoke(SLinkOperations.getTarget(fromPort, LINKS.type$5Gl6)), fromNode, fromPort, toNode, toPort);
      NodeFactoryManager.setupNode(CONCEPTS.AssemblyConnector$qU, assemblyConnector, null, ss, SNodeOperations.getModel(ss));
      ListSequence.fromList(SLinkOperations.getChildren(ss, LINKS.contents$7e9r)).addElement(assemblyConnector);
    }

    return toPort;
  }

  private List<SNode> getDeepComponentContent(Iterable<SNode> structures, List<SNode> deepContent) {
    for (SNode ele : Sequence.fromIterable(structures).translate((it) -> SLinkOperations.getChildren(it, LINKS.contents$7e9r))) {
      ListSequence.fromList(deepContent).addElement(ele);
      {
        final SNode instance = ele;
        if (SNodeOperations.isInstanceOf(instance, CONCEPTS.AbstractComponentInstanceBase$QW)) {
          getDeepComponentContent(SNodeOperations.ofConcept(SLinkOperations.getChildren(AbstractComponentInstanceBase__BehaviorDescriptor.component_id77HYM7H$sfU.invoke(instance), LINKS.contents$i4tX), CONCEPTS.ComponentSubstructure$oB), deepContent);
        }
      }
    }
    return deepContent;
  }

  private static SNode createPort_egjn7_a0i0n(SNode p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.Port$gs);
    n0.forChild(LINKS.type$5Gl6).initNode(p0, CONCEPTS.IPortType$DL, true);
    n0.forChild(LINKS.category$WD4l).initNode(p1, CONCEPTS.PortCategory$Wm, true);
    return n0.getResult();
  }
  private static SNode createPort_egjn7_a0a0r(SNode p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.Port$gs);
    n0.forChild(LINKS.type$5Gl6).initNode(p0, CONCEPTS.IPortType$DL, true);
    n0.forChild(LINKS.category$WD4l).initNode(p1, CONCEPTS.PortCategory$Wm, true);
    return n0.getResult();
  }
  private static SNode createExportConnector_egjn7_a0b0j0r(SNode p0, SNode p1, SNode p2, SNode p3) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ExportConnector$hw);
    n0.forChild(LINKS.connectorType$8zQx).initNode(p0, CONCEPTS.IConnectorType$F7, true);
    {
      SNodeBuilder n1 = n0.forChild(LINKS.sourceInstance$fa_V).init(CONCEPTS.InstanceRef$Gm);
      n1.setReferenceTarget(LINKS.ref$H$FL, p1);
    }
    n0.setReferenceTarget(LINKS.sourcePort$fgej, p2);
    n0.setReferenceTarget(LINKS.outerPort$ffZi, p3);
    return n0.getResult();
  }
  private static SNode createAssemblyConnector_egjn7_a0b0a9a71(SNode p0, SNode p1, SNode p2, SNode p3, SNode p4) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.AssemblyConnector$qU);
    n0.forChild(LINKS.connectorType$8zQx).initNode(p0, CONCEPTS.IConnectorType$F7, true);
    {
      SNodeBuilder n1 = n0.forChild(LINKS.sourceInstance$LjmV).init(CONCEPTS.InstanceRef$Gm);
      n1.setReferenceTarget(LINKS.ref$H$FL, p1);
    }
    n0.setReferenceTarget(LINKS.sourcePort$ZLvQ, p2);
    {
      SNodeBuilder n2 = n0.forChild(LINKS.targetInstance$RipR).init(CONCEPTS.InstanceRef$Gm);
      n2.setReferenceTarget(LINKS.ref$H$FL, p3);
    }
    n0.setReferenceTarget(LINKS.targetPort$ZZ$M, p4);
    return n0.getResult();
  }
  private static SNode createImportConnector_egjn7_a0b0a9a71(SNode p0, SNode p1, SNode p2, SNode p3) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ImportConnector$8o);
    n0.forChild(LINKS.connectorType$8zQx).initNode(p0, CONCEPTS.IConnectorType$F7, true);
    n0.setReferenceTarget(LINKS.outerPort$3H4p, p1);
    {
      SNodeBuilder n1 = n0.forChild(LINKS.targetInstance$ZsmL).init(CONCEPTS.InstanceRef$Gm);
      n1.setReferenceTarget(LINKS.ref$H$FL, p2);
    }
    n0.setReferenceTarget(LINKS.targetPort$ZxZ9, p3);
    return n0.getResult();
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept AbstractComponentInstanceBase$QW = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x71edfb21ed616471L, "org.iets3.components.core.structure.AbstractComponentInstanceBase");
    /*package*/ static final SConcept ComponentSubstructure$oB = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x71280102b4ce9cdL, "org.iets3.components.core.structure.ComponentSubstructure");
    /*package*/ static final SConcept Component$gR = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x6c4f9fd23e484601L, "org.iets3.components.core.structure.Component");
    /*package*/ static final SConcept Port$gs = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x6c4f9fd23e51937cL, "org.iets3.components.core.structure.Port");
    /*package*/ static final SConcept ExportConnector$hw = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x32f64a31a0a561cL, "org.iets3.components.core.structure.ExportConnector");
    /*package*/ static final SConcept AssemblyConnector$qU = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x7fdf70a1447d7f1aL, "org.iets3.components.core.structure.AssemblyConnector");
    /*package*/ static final SConcept ImportConnector$8o = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x32f64a31a05d2c1L, "org.iets3.components.core.structure.ImportConnector");
    /*package*/ static final SInterfaceConcept IPortType$DL = MetaAdapterFactory.getInterfaceConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x6c4f9fd23e566371L, "org.iets3.components.core.structure.IPortType");
    /*package*/ static final SConcept PortCategory$Wm = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x71280102d0186c2L, "org.iets3.components.core.structure.PortCategory");
    /*package*/ static final SInterfaceConcept IConnectorType$F7 = MetaAdapterFactory.getInterfaceConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x4c293bba48709df1L, "org.iets3.components.core.structure.IConnectorType");
    /*package*/ static final SConcept InstanceRef$Gm = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x7fdf70a1447d7f29L, "org.iets3.components.core.structure.InstanceRef");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink type$5Gl6 = MetaAdapterFactory.getContainmentLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x6c4f9fd23e51937cL, 0x6c4f9fd23e566372L, "type");
    /*package*/ static final SContainmentLink contents$7e9r = MetaAdapterFactory.getContainmentLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x71280102b4ce9cdL, 0x71280102b4ce9ceL, "contents");
    /*package*/ static final SContainmentLink contents$i4tX = MetaAdapterFactory.getContainmentLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x6c4f9fd23e484601L, 0x6c4f9fd23e48465cL, "contents");
    /*package*/ static final SContainmentLink category$WD4l = MetaAdapterFactory.getContainmentLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x6c4f9fd23e51937cL, 0x5aed9484f65f1e5L, "category");
    /*package*/ static final SContainmentLink connectorType$8zQx = MetaAdapterFactory.getContainmentLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x3a8867c74e876c3fL, 0x3a8867c74e88330cL, "connectorType");
    /*package*/ static final SContainmentLink sourceInstance$fa_V = MetaAdapterFactory.getContainmentLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x32f64a31a0a561cL, 0x32f64a31a0a561dL, "sourceInstance");
    /*package*/ static final SReferenceLink ref$H$FL = MetaAdapterFactory.getReferenceLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x7fdf70a1447d7f29L, 0x7fdf70a1447d7f36L, "ref");
    /*package*/ static final SReferenceLink sourcePort$fgej = MetaAdapterFactory.getReferenceLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x32f64a31a0a561cL, 0x32f64a31a0a5620L, "sourcePort");
    /*package*/ static final SReferenceLink outerPort$ffZi = MetaAdapterFactory.getReferenceLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x32f64a31a0a561cL, 0x32f64a31a0a561fL, "outerPort");
    /*package*/ static final SContainmentLink sourceInstance$LjmV = MetaAdapterFactory.getContainmentLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x7fdf70a1447d7f1aL, 0x7fdf70a1447e06a1L, "sourceInstance");
    /*package*/ static final SReferenceLink sourcePort$ZLvQ = MetaAdapterFactory.getReferenceLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x7fdf70a1447d7f1aL, 0x32f64a31a05d502L, "sourcePort");
    /*package*/ static final SContainmentLink targetInstance$RipR = MetaAdapterFactory.getContainmentLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x7fdf70a1447d7f1aL, 0x7fdf70a1447f1d65L, "targetInstance");
    /*package*/ static final SReferenceLink targetPort$ZZ$M = MetaAdapterFactory.getReferenceLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x7fdf70a1447d7f1aL, 0x32f64a31a05d514L, "targetPort");
    /*package*/ static final SReferenceLink outerPort$3H4p = MetaAdapterFactory.getReferenceLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x32f64a31a05d2c1L, 0x32f64a31a05d2cbL, "outerPort");
    /*package*/ static final SContainmentLink targetInstance$ZsmL = MetaAdapterFactory.getContainmentLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x32f64a31a05d2c1L, 0x32f64a31a07b915L, "targetInstance");
    /*package*/ static final SReferenceLink targetPort$ZxZ9 = MetaAdapterFactory.getReferenceLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x32f64a31a05d2c1L, 0x32f64a31a07b918L, "targetPort");
  }
}
