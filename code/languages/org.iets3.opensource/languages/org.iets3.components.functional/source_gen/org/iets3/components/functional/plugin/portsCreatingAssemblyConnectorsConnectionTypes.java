package org.iets3.components.functional.plugin;

/*Generated by MPS */

import jetbrains.mps.smodel.structure.Extension;
import de.itemis.mps.editor.diagram.runtime.model.IConnectionTypesExtensionProvider;
import org.jetbrains.mps.openapi.model.SNode;
import javax.swing.Icon;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.ide.icons.GlobalIconManager;
import org.iets3.components.core.behavior.IPortType__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import de.itemis.mps.editor.diagram.runtime.model.IConnectionType;
import jetbrains.mps.openapi.editor.EditorContext;
import com.mbeddr.core.base.behavior.IVisibleElementProvider__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class portsCreatingAssemblyConnectorsConnectionTypes extends Extension.Default<IConnectionTypesExtensionProvider> {
  public portsCreatingAssemblyConnectorsConnectionTypes() {
    super("de.itemis.mps.editor.diagram.runtime.diagramConnectionTypesProvider");
  }


  public class PortsCreatingAutoConnectionType extends AutoConnectionType {
    private SNode _portType;

    public PortsCreatingAutoConnectionType(String name, SNode portType, SNode sourcePortCategory) {
      super(name, IconHelper.getIcon(portType), sourcePortCategory);
      _portType = portType;
    }

    public void create(SNode fromNode, String fromPort, SNode toNode, String toPort) {
      doCreate(fromNode, fromPort, toNode, toPort);
    }

    @Override
    public SNode getPortType() {
      return _portType;
    }
  }

  public static class IconHelper {
    public static Icon getIcon(final SNode portType) {
      final Wrappers._T<Icon> icon = new Wrappers._T<Icon>();
      // port types are created on the fly, so there is no model.
      SNodeOperations.getModel(SNodeOperations.asNode(SNodeOperations.getConcept(portType))).getRepository().getModelAccess().runReadAction(() -> icon.value = GlobalIconManager.getInstance().getIconFor(IPortType__BehaviorDescriptor.getReferencedNode_idsiw10GjEcX.invoke(portType)));
      return icon.value;
    }
  }

  public IConnectionTypesExtensionProvider get() {
    return new IConnectionTypesExtensionProvider<SNode>() {
      public boolean appliesFor(SAbstractConcept diagramNodeConcept) {
        return SConceptOperations.isSubConceptOf(SNodeOperations.asSConcept(diagramNodeConcept), CONCEPTS.ComponentSubstructure$oB);
      }
      public Iterable<IConnectionType> getConnectionTypes(SNode diagramNode, EditorContext editorContext) {
        Iterable<SNode> dataItems = SNodeOperations.ofConcept(IVisibleElementProvider__BehaviorDescriptor.visibleContentsOfTypeAsSequence_id3g6LnlWuSo8.invoke(SNodeOperations.getNodeAncestor(diagramNode, CONCEPTS.IVisibleElementProvider$$O, false, false), CONCEPTS.DataItem$8n), CONCEPTS.DataItem$8n);
        Iterable<IConnectionType> result = Sequence.fromIterable(dataItems).select((final SNode it) -> new PortsCreatingAutoConnectionType(SPropertyOperations.getString(it, PROPS.name$MnvL), createDataItemPortType_nnx36a_b0a0a0a0a1a1a0a0a8(it), createProducesPortCategory_nnx36a_c0a0a0a0a1a1a0a0a8()));
        Iterable<SNode> serviceDefs = SNodeOperations.ofConcept(IVisibleElementProvider__BehaviorDescriptor.visibleContentsOfTypeAsSequence_id3g6LnlWuSo8.invoke(SNodeOperations.getNodeAncestor(diagramNode, CONCEPTS.IVisibleElementProvider$$O, false, false), CONCEPTS.ServiceDefinition$6o), CONCEPTS.ServiceDefinition$6o);
        return Sequence.fromIterable(result).union(Sequence.fromIterable(serviceDefs).select((final SNode it) -> new PortsCreatingAutoConnectionType(SPropertyOperations.getString(it, PROPS.name$MnvL), createServicePortType_nnx36a_b0a0a0a0a0d0b0a0a0i(it), createUsesPortCategory_nnx36a_c0a0a0a0a0d0b0a0a0i())));
      }
    };
  }
  private static SNode createDataItemPortType_nnx36a_b0a0a0a0a1a1a0a0a8(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.DataItemPortType$kW);
    n0.setReferenceTarget(LINKS.ref$oSw, p0);
    return n0.getResult();
  }
  private static SNode createProducesPortCategory_nnx36a_c0a0a0a0a1a1a0a0a8() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ProducesPortCategory$f1);
    return n0.getResult();
  }
  private static SNode createServicePortType_nnx36a_b0a0a0a0a0d0b0a0a0i(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ServicePortType$Rm);
    n0.setReferenceTarget(LINKS.service$D09C, p0);
    return n0.getResult();
  }
  private static SNode createUsesPortCategory_nnx36a_c0a0a0a0a0d0b0a0a0i() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.UsesPortCategory$Yt);
    return n0.getResult();
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept ComponentSubstructure$oB = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x71280102b4ce9cdL, "org.iets3.components.core.structure.ComponentSubstructure");
    /*package*/ static final SInterfaceConcept IVisibleElementProvider$$O = MetaAdapterFactory.getInterfaceConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x6315bcc6eff580a3L, "com.mbeddr.core.base.structure.IVisibleElementProvider");
    /*package*/ static final SConcept DataItem$8n = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x6c4f9fd23e4bfa58L, "org.iets3.components.functional.structure.DataItem");
    /*package*/ static final SConcept ServiceDefinition$6o = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x5aed9484fdce311L, "org.iets3.components.functional.structure.ServiceDefinition");
    /*package*/ static final SConcept DataItemPortType$kW = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x6c4f9fd23e4bfae2L, "org.iets3.components.functional.structure.DataItemPortType");
    /*package*/ static final SConcept ProducesPortCategory$f1 = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x5aed9484f65f2b0L, "org.iets3.components.functional.structure.ProducesPortCategory");
    /*package*/ static final SConcept ServicePortType$Rm = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x5aed9484fdce38cL, "org.iets3.components.functional.structure.ServicePortType");
    /*package*/ static final SConcept UsesPortCategory$Yt = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x5aed9484fc135e3L, "org.iets3.components.functional.structure.UsesPortCategory");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink ref$oSw = MetaAdapterFactory.getReferenceLink(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x6c4f9fd23e4bfae2L, 0x6c4f9fd23e4bfae3L, "ref");
    /*package*/ static final SReferenceLink service$D09C = MetaAdapterFactory.getReferenceLink(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x5aed9484fdce38cL, 0x5aed9484fdce3b6L, "service");
  }
}
