package org.iets3.components.functional.plugin;

/*Generated by MPS */

import jetbrains.mps.smodel.structure.Extension;
import de.itemis.mps.editor.diagram.runtime.model.IPaletteEntryExtensionProvider;
import de.itemis.mps.editor.diagram.runtime.model.AbstractPaletteEntry;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import de.itemis.mps.editor.diagram.runtime.substitute.SubstituteInfoFactory;
import org.iets3.components.core.behavior.PortCategory__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.annotations.Nullable;
import javax.swing.Icon;
import jetbrains.mps.ide.icons.GlobalIconManager;
import org.jetbrains.annotations.NotNull;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import com.intellij.openapi.ui.popup.ListPopup;
import com.intellij.openapi.ui.popup.JBPopupFactory;
import com.intellij.openapi.ui.popup.PopupStep;
import org.iets3.components.core.editor.ValidReplacementHelper;
import jetbrains.mps.smodel.action.NodeFactoryManager;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import org.iets3.components.core.behavior.Component__BehaviorDescriptor;
import com.intellij.ui.awt.RelativePoint;
import java.awt.MouseInfo;
import de.itemis.mps.editor.diagram.runtime.model.IPaletteEntry;
import jetbrains.mps.openapi.editor.EditorContext;
import org.iets3.components.core.behavior.AbstractComponentInstanceBase__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.Collections;
import java.util.LinkedList;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class newItemsPaletteEntries extends Extension.Default<IPaletteEntryExtensionProvider> {
  public newItemsPaletteEntries() {
    super("de.itemis.mps.editor.diagram.runtime.diagramPaletteEntryProvider");
  }


  public abstract class NewPortPaletteEntry extends AbstractPaletteEntry {
    private SConcept portCategory;
    private SNode parentComponent;
    private SAbstractConcept portTargetConcept;
    private SubstituteInfoFactory substituteInfoFactory;
    private String categoryString;
    public NewPortPaletteEntry(SConcept portCategory, SNode parentComponent, SAbstractConcept portTargetConcept, SubstituteInfoFactory substituteInfoFactory) {
      this.portCategory = portCategory;
      this.parentComponent = parentComponent;
      this.portTargetConcept = portTargetConcept;
      this.substituteInfoFactory = substituteInfoFactory;
      categoryString = PortCategory__BehaviorDescriptor.categoryString_idmIQkxgI2fs.invoke(SConceptOperations.createNewNode(SNodeOperations.asInstanceConcept(portCategory)));
    }

    @Nullable
    public Icon getIcon() {
      return GlobalIconManager.getInstance().getIconFor(portCategory);
    }

    @NotNull
    public String getText() {
      return "New " + categoryString + " Port";
    }

    @NotNull
    public SAbstractConcept getOutputConcept() {
      return CONCEPTS.Port$gs;
    }

    public abstract SNode createPortType(SNode portTarget);

    @NotNull
    public SNode execute() {
      List<SConcept> subConcepts = ListSequence.fromList(SConceptOperations.getAllSubConcepts2(portCategory, SNodeOperations.getModel(parentComponent))).where((it) -> !(it.isAbstract())).toList();
      ListPopup portsPopup = JBPopupFactory.getInstance().createListPopup(new PortCategoryPopupStep(subConcepts) {
        @Override
        public PopupStep onChosen(final SConcept selectedCategory, boolean finalChoice) {
          SNodeOperations.getModel(SNodeOperations.asNode(selectedCategory)).getRepository().getModelAccess().executeCommand(() -> {
            SAbstractConcept applicablePortTargetConcept = ValidReplacementHelper.findValidReplacementConcept(parentComponent, portTargetConcept, substituteInfoFactory);

            SNode newPortTarget = NodeFactoryManager.createNode(applicablePortTargetConcept, null, SNodeOperations.getParent(parentComponent), SNodeOperations.getModel(parentComponent));
            {
              final SNode namedNewPortTarget = newPortTarget;
              if (SNodeOperations.isInstanceOf(namedNewPortTarget, CONCEPTS.INamedConcept$Kd)) {
                if (isEmptyString(SPropertyOperations.getString(namedNewPortTarget, PROPS.name$MnvL))) {
                  SPropertyOperations.assign(namedNewPortTarget, PROPS.name$MnvL, "New" + (((categoryString != null && categoryString.length() > 0) ? categoryString.substring(0, 1).toUpperCase() + categoryString.substring(1) : "")));
                }
              }
            }

            SNodeOperations.insertNextSiblingChild(parentComponent, newPortTarget);

            SNode port = createPort_7rtihm_a0h0a0a0a0a0a0b0p4(createPortType(newPortTarget), SConceptOperations.createNewNode(SNodeOperations.asInstanceConcept(selectedCategory)));
            NodeFactoryManager.setupNode(CONCEPTS.Port$gs, port, null, Component__BehaviorDescriptor.ensureCompInterface_idx8tpSAdmRF.invoke(parentComponent), SNodeOperations.getModel(parentComponent));
            ListSequence.fromList(Component__BehaviorDescriptor.interfaceContent_idx8tpSAdLM$.invoke(parentComponent)).addElement(port);
          });

          return super.onChosen(selectedCategory, finalChoice);
        }
      });
      portsPopup.show(new RelativePoint(MouseInfo.getPointerInfo().getLocation()));
      return null;
    }
  }

  public IPaletteEntryExtensionProvider get() {
    return new IPaletteEntryExtensionProvider<SNode>() {
      public boolean appliesFor(SAbstractConcept concept) {
        return SConceptOperations.isSubConceptOf(SNodeOperations.asSConcept(concept), CONCEPTS.ComponentSubstructure$oB) || SConceptOperations.isSubConceptOf(SNodeOperations.asSConcept(concept), CONCEPTS.AbstractComponentInstanceBase$QW);
      }
      public Iterable<IPaletteEntry> getEntries(final SNode node, final EditorContext editorContext) {
        SNode parentComponent = null;
        if (SNodeOperations.isInstanceOf(node, CONCEPTS.ComponentSubstructure$oB)) {
          parentComponent = SNodeOperations.getNodeAncestor(node, CONCEPTS.Component$gR, false, false);
        } else if (SNodeOperations.isInstanceOf(node, CONCEPTS.AbstractComponentInstanceBase$QW)) {
          parentComponent = AbstractComponentInstanceBase__BehaviorDescriptor.component_id77HYM7H$sfU.invoke(SNodeOperations.cast(node, CONCEPTS.AbstractComponentInstanceBase$QW));
        } else {
          return Sequence.fromIterable(Collections.<IPaletteEntry>emptyList());
        }
        SubstituteInfoFactory substituteInfoFactory = new SubstituteInfoFactory(editorContext, node);
        final List<IPaletteEntry> result = ListSequence.fromList(new LinkedList<IPaletteEntry>());
        if (ValidReplacementHelper.findValidReplacementConcept(parentComponent, CONCEPTS.DataItem$8n, substituteInfoFactory) != null) {
          IPaletteEntry newDataPortEntry = new NewPortPaletteEntry(CONCEPTS.DataPortCategory$ZY, parentComponent, CONCEPTS.DataItem$8n, substituteInfoFactory) {
            public SNode createPortType(SNode portTarget) {
              return createDataItemPortType_7rtihm_a0a0a0a0a0e0b0a0a0g(SNodeOperations.cast(portTarget, CONCEPTS.DataItem$8n));
            }
          };
          ListSequence.fromList(result).addElement(newDataPortEntry);
        }
        if (ValidReplacementHelper.findValidReplacementConcept(parentComponent, CONCEPTS.ServiceDefinition$6o, substituteInfoFactory) != null) {
          IPaletteEntry newServicePortEntry = new NewPortPaletteEntry(CONCEPTS.ServicePortCategory$ts, parentComponent, CONCEPTS.ServiceDefinition$6o, substituteInfoFactory) {
            public SNode createPortType(SNode portTarget) {
              return createServicePortType_7rtihm_a0a0a0a0a0f0b0a0a0g(SNodeOperations.cast(portTarget, CONCEPTS.ServiceDefinition$6o));
            }
          };
          ListSequence.fromList(result).addElement(newServicePortEntry);
        }
        return Sequence.fromClosure(() -> result);
      }
    };
  }
  private static SNode createPort_7rtihm_a0h0a0a0a0a0a0b0p4(SNode p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.Port$gs);
    n0.forChild(LINKS.type$5Gl6).initNode(p0, CONCEPTS.IPortType$DL, true);
    n0.forChild(LINKS.category$WD4l).initNode(p1, CONCEPTS.PortCategory$Wm, true);
    return n0.getResult();
  }
  private static SNode createDataItemPortType_7rtihm_a0a0a0a0a0e0b0a0a0g(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.DataItemPortType$kW);
    n0.setReferenceTarget(LINKS.ref$oSw, p0);
    return n0.getResult();
  }
  private static SNode createServicePortType_7rtihm_a0a0a0a0a0f0b0a0a0g(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ServicePortType$Rm);
    n0.setReferenceTarget(LINKS.service$D09C, p0);
    return n0.getResult();
  }
  private static boolean isEmptyString(String str) {
    return str == null || str.isEmpty();
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Port$gs = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x6c4f9fd23e51937cL, "org.iets3.components.core.structure.Port");
    /*package*/ static final SInterfaceConcept INamedConcept$Kd = MetaAdapterFactory.getInterfaceConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, "jetbrains.mps.lang.core.structure.INamedConcept");
    /*package*/ static final SConcept AbstractComponentInstanceBase$QW = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x71edfb21ed616471L, "org.iets3.components.core.structure.AbstractComponentInstanceBase");
    /*package*/ static final SConcept ComponentSubstructure$oB = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x71280102b4ce9cdL, "org.iets3.components.core.structure.ComponentSubstructure");
    /*package*/ static final SConcept Component$gR = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x6c4f9fd23e484601L, "org.iets3.components.core.structure.Component");
    /*package*/ static final SConcept DataItem$8n = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x6c4f9fd23e4bfa58L, "org.iets3.components.functional.structure.DataItem");
    /*package*/ static final SConcept DataPortCategory$ZY = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x5aed9484f65f1ccL, "org.iets3.components.functional.structure.DataPortCategory");
    /*package*/ static final SConcept ServiceDefinition$6o = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x5aed9484fdce311L, "org.iets3.components.functional.structure.ServiceDefinition");
    /*package*/ static final SConcept ServicePortCategory$ts = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x5aed9484fc1349aL, "org.iets3.components.functional.structure.ServicePortCategory");
    /*package*/ static final SInterfaceConcept IPortType$DL = MetaAdapterFactory.getInterfaceConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x6c4f9fd23e566371L, "org.iets3.components.core.structure.IPortType");
    /*package*/ static final SConcept PortCategory$Wm = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x71280102d0186c2L, "org.iets3.components.core.structure.PortCategory");
    /*package*/ static final SConcept DataItemPortType$kW = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x6c4f9fd23e4bfae2L, "org.iets3.components.functional.structure.DataItemPortType");
    /*package*/ static final SConcept ServicePortType$Rm = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x5aed9484fdce38cL, "org.iets3.components.functional.structure.ServicePortType");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink type$5Gl6 = MetaAdapterFactory.getContainmentLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x6c4f9fd23e51937cL, 0x6c4f9fd23e566372L, "type");
    /*package*/ static final SContainmentLink category$WD4l = MetaAdapterFactory.getContainmentLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x6c4f9fd23e51937cL, 0x5aed9484f65f1e5L, "category");
    /*package*/ static final SReferenceLink ref$oSw = MetaAdapterFactory.getReferenceLink(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x6c4f9fd23e4bfae2L, 0x6c4f9fd23e4bfae3L, "ref");
    /*package*/ static final SReferenceLink service$D09C = MetaAdapterFactory.getReferenceLink(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x5aed9484fdce38cL, 0x5aed9484fdce3b6L, "service");
  }
}
