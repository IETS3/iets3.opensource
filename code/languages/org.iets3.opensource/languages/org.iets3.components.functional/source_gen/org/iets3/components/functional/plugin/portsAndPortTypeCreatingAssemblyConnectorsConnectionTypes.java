package org.iets3.components.functional.plugin;

/*Generated by MPS */

import jetbrains.mps.smodel.structure.Extension;
import de.itemis.mps.editor.diagram.runtime.model.IConnectionTypesExtensionProvider;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import de.itemis.mps.editor.diagram.runtime.substitute.SubstituteInfoFactory;
import org.jetbrains.mps.openapi.model.SNode;
import org.iets3.components.core.behavior.PortCategory__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.iets3.components.core.editor.ValidReplacementHelper;
import jetbrains.mps.smodel.action.NodeFactoryManager;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import javax.swing.Icon;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.ide.icons.GlobalIconManager;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import de.itemis.mps.editor.diagram.runtime.model.IConnectionType;
import jetbrains.mps.openapi.editor.EditorContext;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.LinkedList;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class portsAndPortTypeCreatingAssemblyConnectorsConnectionTypes extends Extension.Default<IConnectionTypesExtensionProvider> {
  public portsAndPortTypeCreatingAssemblyConnectorsConnectionTypes() {
    super("de.itemis.mps.editor.diagram.runtime.diagramConnectionTypesProvider");
  }


  public abstract class PortsAndTypeCreatingAutoConnectionType extends AutoConnectionType {
    private SAbstractConcept _portTargetConcept;
    private String _categoryString;
    private SubstituteInfoFactory _substituteInfoFactory;
    private SNode _portType = null;

    public PortsAndTypeCreatingAutoConnectionType(String name, SNode sourcePortCategory, SAbstractConcept portTargetConcept, SubstituteInfoFactory substituteInfoFactory) {
      super(name, IconHelper.getIcon(portTargetConcept), sourcePortCategory);
      _portTargetConcept = portTargetConcept;
      _substituteInfoFactory = substituteInfoFactory;
      _categoryString = PortCategory__BehaviorDescriptor.categoryString_idmIQkxgI2fs.invoke(sourcePortCategory);

    }

    public void create(SNode fromNode, String fromPort, SNode toNode, String toPort) {
      SNode ss = SNodeOperations.getNodeAncestor(toNode, CONCEPTS.ComponentSubstructure$oB, false, false);
      SNode parentComponent = SNodeOperations.getNodeAncestor(ss, CONCEPTS.Component$gR, false, false);
      SAbstractConcept applicablePortTargetConcept = ValidReplacementHelper.findValidReplacementConcept(parentComponent, _portTargetConcept, _substituteInfoFactory);
      SNode newPortTarget = NodeFactoryManager.createNode(applicablePortTargetConcept, null, SNodeOperations.getParent(parentComponent), SNodeOperations.getModel(parentComponent));
      {
        final SNode namedNewPortTarget = newPortTarget;
        if (SNodeOperations.isInstanceOf(namedNewPortTarget, CONCEPTS.INamedConcept$Kd)) {
          if (isEmptyString(SPropertyOperations.getString(namedNewPortTarget, PROPS.name$MnvL))) {
            SPropertyOperations.assign(namedNewPortTarget, PROPS.name$MnvL, "New" + (((_categoryString != null && _categoryString.length() > 0) ? _categoryString.substring(0, 1).toUpperCase() + _categoryString.substring(1) : "")));
          }
        }
      }
      SNodeOperations.insertNextSiblingChild(SNodeOperations.getNodeAncestor(toNode, CONCEPTS.Component$gR, false, false), newPortTarget);
      _portType = createPortType(newPortTarget);

      doCreate(fromNode, fromPort, toNode, toPort);
    }

    @Override
    public SNode getPortType() {
      return _portType;
    }

    public abstract SNode createPortType(SNode portTarget);
  }

  public static class IconHelper {
    public static Icon getIcon(final SAbstractConcept portTargetConcept) {
      final Wrappers._T<Icon> icon = new Wrappers._T<Icon>();
      SNodeOperations.getModel(SNodeOperations.asNode(portTargetConcept)).getRepository().getModelAccess().runReadAction(() -> icon.value = GlobalIconManager.getInstance().getIconFor(portTargetConcept));
      return icon.value;
    }
  }

  public IConnectionTypesExtensionProvider get() {
    return new IConnectionTypesExtensionProvider<SNode>() {
      public boolean appliesFor(SAbstractConcept diagramNodeConcept) {
        return SConceptOperations.isSubConceptOf(SNodeOperations.asSConcept(diagramNodeConcept), CONCEPTS.ComponentSubstructure$oB);
      }
      public Iterable<IConnectionType> getConnectionTypes(SNode diagramNode, EditorContext editorContext) {
        List<IConnectionType> result = ListSequence.fromList(new LinkedList<IConnectionType>());
        SubstituteInfoFactory substituteInfoFactory = new SubstituteInfoFactory(editorContext, diagramNode);
        if (ValidReplacementHelper.findValidReplacementConcept(SNodeOperations.getNodeAncestor(diagramNode, CONCEPTS.Component$gR, false, false), CONCEPTS.DataItem$8n, substituteInfoFactory) != null) {
          ListSequence.fromList(result).addElement(new PortsAndTypeCreatingAutoConnectionType("+ New Data", createProducesPortCategory_ix726j_b0a0a0a0c0b0a0a0i(), CONCEPTS.DataItem$8n, substituteInfoFactory) {
            @Override
            public SNode createPortType(SNode portTarget) {
              return createDataItemPortType_ix726j_a0a0a0a0a0a2a1a0a0a8(SNodeOperations.cast(portTarget, CONCEPTS.DataItem$8n));
            }
          });
        }
        if (ValidReplacementHelper.findValidReplacementConcept(SNodeOperations.getNodeAncestor(diagramNode, CONCEPTS.Component$gR, false, false), CONCEPTS.ServiceDefinition$6o, substituteInfoFactory) != null) {
          ListSequence.fromList(result).addElement(new PortsAndTypeCreatingAutoConnectionType("+ New Service", createUsesPortCategory_ix726j_b0a0a0a0d0b0a0a0i(), CONCEPTS.ServiceDefinition$6o, substituteInfoFactory) {
            @Override
            public SNode createPortType(SNode portTarget) {
              return createServicePortType_ix726j_a0a0a0a0a0a3a1a0a0a8(SNodeOperations.cast(portTarget, CONCEPTS.ServiceDefinition$6o));
            }
          });
        }
        return result;
      }
    };
  }
  private static SNode createDataItemPortType_ix726j_a0a0a0a0a0a2a1a0a0a8(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.DataItemPortType$kW);
    n0.setReferenceTarget(LINKS.ref$oSw, p0);
    return n0.getResult();
  }
  private static SNode createProducesPortCategory_ix726j_b0a0a0a0c0b0a0a0i() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ProducesPortCategory$f1);
    return n0.getResult();
  }
  private static SNode createServicePortType_ix726j_a0a0a0a0a0a3a1a0a0a8(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ServicePortType$Rm);
    n0.setReferenceTarget(LINKS.service$D09C, p0);
    return n0.getResult();
  }
  private static SNode createUsesPortCategory_ix726j_b0a0a0a0d0b0a0a0i() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.UsesPortCategory$Yt);
    return n0.getResult();
  }
  private static boolean isEmptyString(String str) {
    return str == null || str.isEmpty();
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept ComponentSubstructure$oB = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x71280102b4ce9cdL, "org.iets3.components.core.structure.ComponentSubstructure");
    /*package*/ static final SConcept Component$gR = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x6c4f9fd23e484601L, "org.iets3.components.core.structure.Component");
    /*package*/ static final SInterfaceConcept INamedConcept$Kd = MetaAdapterFactory.getInterfaceConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, "jetbrains.mps.lang.core.structure.INamedConcept");
    /*package*/ static final SConcept DataItem$8n = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x6c4f9fd23e4bfa58L, "org.iets3.components.functional.structure.DataItem");
    /*package*/ static final SConcept ServiceDefinition$6o = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x5aed9484fdce311L, "org.iets3.components.functional.structure.ServiceDefinition");
    /*package*/ static final SConcept DataItemPortType$kW = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x6c4f9fd23e4bfae2L, "org.iets3.components.functional.structure.DataItemPortType");
    /*package*/ static final SConcept ProducesPortCategory$f1 = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x5aed9484f65f2b0L, "org.iets3.components.functional.structure.ProducesPortCategory");
    /*package*/ static final SConcept ServicePortType$Rm = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x5aed9484fdce38cL, "org.iets3.components.functional.structure.ServicePortType");
    /*package*/ static final SConcept UsesPortCategory$Yt = MetaAdapterFactory.getConcept(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x5aed9484fc135e3L, "org.iets3.components.functional.structure.UsesPortCategory");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink ref$oSw = MetaAdapterFactory.getReferenceLink(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x6c4f9fd23e4bfae2L, 0x6c4f9fd23e4bfae3L, "ref");
    /*package*/ static final SReferenceLink service$D09C = MetaAdapterFactory.getReferenceLink(0x257976063fb647b8L, 0xbc3cb4384df7da44L, 0x5aed9484fdce38cL, 0x5aed9484fdce3b6L, "service");
  }
}
