package org.iets3.core.expr.lambda.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.util.Map;
import com.mbeddr.mpsutil.interpreter.rt.IContext;
import com.mbeddr.mpsutil.interpreter.rt.ICoverageAnalyzer;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import org.iets3.core.expr.lambda.behavior.ShortLambdaExpression__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.smodel.CopyUtil;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import org.iets3.core.expr.lambda.behavior.IShortLambdaContainer__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.iets3.core.expr.base.behavior.IRef__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.typechecking.TypecheckingFacade;
import org.iets3.core.expr.lambda.behavior.CapturedValue__BehaviorDescriptor;
import org.iets3.core.expr.base.behavior.Expression__BehaviorDescriptor;
import java.util.List;
import com.mbeddr.mpsutil.interpreter.rt.ComputationTrace;
import org.iets3.core.expr.base.behavior.IDefaultCoverageAnalyzer;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SProperty;

public class ShortLambdaValue extends ExecutableValue {
  public static final String USER_OBJECT_KEY_MAPPING = "ShortLambdaMapping";
  public static final String USER_OBJECT_KEY_LAMBDAARG = "LambdaArg";
  public static final String USER_OBJECT_KEY_LAMBDA = "Lambda";
  private SNode lambda = null;
  private SNode shortLambda = null;
  private Map<SNode, SNode> mapping;
  private boolean stopOnStop = false;

  public ShortLambdaValue(SNode le, IContext ctx, ICoverageAnalyzer coverage, boolean stopOnStop) {
    mapping = MapSequence.fromMap(new HashMap<SNode, SNode>());
    ShortLambdaExpression__BehaviorDescriptor.putNodeMapping_id5s__jxDLZW7.invoke(le, mapping);
    shortLambda = le;
    lambda = ShortLambdaExpression__BehaviorDescriptor.getLambda_idXbOhLk5ek9.invoke(le);

    lambda = ((lambda == null) ? SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba520706L, "org.iets3.core.expr.lambda.structure.LambdaExpression")) : lambda);
    SNodeOperations.deleteNode(SLinkOperations.getTarget(lambda, LINKS.expression$T2aj));
    SLinkOperations.setTarget(lambda, LINKS.expression$T2aj, SNodeOperations.as(CopyUtil.copy(SLinkOperations.getTarget(le, LINKS.expr$CW3E), mapping, true), CONCEPTS.Expression$D_));
    ListSequence.fromList(SLinkOperations.getChildren(lambda, LINKS.args$8wKH)).clear();
    ShortLambdaExpression__BehaviorDescriptor.putLambda_idXbOhLk5ekn.invoke(le, lambda);

    final Wrappers._T<SNode> lambdaArg = new Wrappers._T<SNode>(ShortLambdaExpression__BehaviorDescriptor.getLambdaArg_id5s__jxCqcBE.invoke(le));
    if (lambdaArg.value == null) {
      lambdaArg.value = createLambdaArg_99yx9z_a0a0m0i();
      ShortLambdaExpression__BehaviorDescriptor.putLambdaArg_id5s__jxCq8Sv.invoke(le, lambdaArg.value);
    }
    SNode ttt = IShortLambdaContainer__BehaviorDescriptor.requiredType_id6zmBjqUm7MF.invoke(SNodeOperations.cast(SNodeOperations.getParent(le), CONCEPTS.IShortLambdaContainer$6m));
    SLinkOperations.setTarget(lambdaArg.value, LINKS.type$8xXf, ttt);
    ListSequence.fromList(SLinkOperations.getChildren(lambda, LINKS.args$8wKH)).addElement(lambdaArg.value);
    ListSequence.fromList(SNodeOperations.getNodeDescendants(SLinkOperations.getTarget(lambda, LINKS.expression$T2aj), CONCEPTS.ShortLambdaItExpression$k0, true, new SAbstractConcept[]{})).visitAll((it) -> {
      // do not go into nested short lambda expressions, otherwise all
      // "it"s are replaced with a ref to the same lambda arg!
      if (SNodeOperations.getNodeAncestor(it, CONCEPTS.LambdaExpression$64, false, false) == lambda && (SNodeOperations.getNodeAncestor(it, CONCEPTS.ShortLambdaExpression$Xg, false, false) == null)) {
        SNode argRef = createLambdaArgRef_99yx9z_a0a0c0a0a61a8(lambdaArg.value);
        MapSequence.fromMap(mapping).put(it, argRef);
        SNodeOperations.replaceWithAnother(it, argRef);
      }
    });

    this.stopOnStop = stopOnStop;
    Iterable<SNode> tobBeCaptured = ListSequence.fromList(SNodeOperations.getNodeDescendants(SLinkOperations.getTarget(lambda, LINKS.expression$T2aj), CONCEPTS.IRef$sq, true, new SAbstractConcept[]{})).where((it) -> (boolean) IRef__BehaviorDescriptor.targetStateIsMutable_id22hm_0zJBUZ.invoke(it));
    for (SNode c : Sequence.fromIterable(tobBeCaptured)) {
      SNode cv = createCapturedValue_99yx9z_a0a0u0i(SNodeOperations.cast(SNodeOperations.copyNode(TypecheckingFacade.getFromContext().getTypeOf(IRef__BehaviorDescriptor.target_id6rGLT0TevFd.invoke(c))), CONCEPTS.Type$WK));
      CapturedValue__BehaviorDescriptor.setValue_id22hm_0zJHWz.invoke(cv, ctx.getRootInterpreter().evaluate(IRef__BehaviorDescriptor.target_id6rGLT0TevFd.invoke(c), ctx, coverage, null, stopOnStop));
      SNodeOperations.replaceWithAnother(c, cv);
    }
  }

  @Override
  public String toString() {
    String bv = "";
    if (ListSequence.fromList(this.boundValues).isNotEmpty()) {
      bv = boundValues + "";
    }
    return "<shortlambda " + Expression__BehaviorDescriptor.renderReadable_id4Y0vh0cfqjE.invoke(this.lambda) + bv + ">";
  }

  @Override
  public ExecutableValue copy(IContext ctx, ICoverageAnalyzer coverage) {
    ShortLambdaValue copy = new ShortLambdaValue(shortLambda, ctx, coverage, stopOnStop);
    ListSequence.fromList(copy.boundValues).addSequence(ListSequence.fromList(this.boundValues));
    return copy;
  }


  @Override
  public Object executeEvaluated(List<Object> evaluatedArgs, IContext context, final ICoverageAnalyzer coverage, ComputationTrace contextTrace, boolean stopOnStop) {
    context.pushEnvironment(lambda, null);

    context.getEnvironment().put(ListSequence.fromList(SLinkOperations.getChildren(lambda, LINKS.args$8wKH)).getElement(0), ListSequence.fromList(evaluatedArgs).getElement(0));
    ComputationTrace tt = new ComputationTrace(lambda, false);
    contextTrace.addChild(tt);
    Object res = context.getRootInterpreter().evaluate(SLinkOperations.getTarget(lambda, LINKS.expression$T2aj), context, coverage, tt, stopOnStop);

    ListSequence.fromList(SNodeOperations.getNodeDescendants(lambda, null, true, new SAbstractConcept[]{})).visitAll((final SNode descendant) -> {
      MapSequence.fromMap(mapping).visitAll((mapping) -> {
        if (IDefaultCoverageAnalyzer.isNodeCovered(mapping.value())) {
          coverage.coverValue(mapping.key(), null);
        }
      });
      SNode originalNode = SetSequence.fromSet(MapSequence.fromMap(mapping).keySet()).findFirst((key) -> MapSequence.fromMap(mapping).get(key) == descendant);
      if (IDefaultCoverageAnalyzer.isNodeCovered(descendant)) {
        coverage.coverValue(originalNode, null);
      }
    });
    tt.setValue(res);
    context.popEnvironment(lambda);
    return res;
  }

  private static SNode createLambdaArg_99yx9z_a0a0m0i() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.LambdaArg$9W);
    n0.setProperty(PROPS.name$MnvL, "it");
    return n0.getResult();
  }
  private static SNode createLambdaArgRef_99yx9z_a0a0c0a0a61a8(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.LambdaArgRef$5P);
    n0.setReferenceTarget(LINKS.arg$J0Dd, p0);
    return n0.getResult();
  }
  private static SNode createCapturedValue_99yx9z_a0a0u0i(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.CapturedValue$Gh);
    n0.forChild(LINKS.type$EhVN).initNode(p0, CONCEPTS.Type$WK, true);
    return n0.getResult();
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink expression$T2aj = MetaAdapterFactory.getContainmentLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba520706L, 0x68d69d36ba520b43L, "expression");
    /*package*/ static final SContainmentLink expr$CW3E = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x3b256bb6ae8048d8L, 0x3b256bb6ae8048d9L, "expr");
    /*package*/ static final SContainmentLink args$8wKH = MetaAdapterFactory.getContainmentLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba520706L, 0x68d69d36ba520707L, "args");
    /*package*/ static final SContainmentLink type$8xXf = MetaAdapterFactory.getContainmentLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba520709L, 0x68d69d36ba52070cL, "type");
    /*package*/ static final SReferenceLink arg$J0Dd = MetaAdapterFactory.getReferenceLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba52d295L, 0x68d69d36ba52d296L, "arg");
    /*package*/ static final SContainmentLink type$EhVN = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x622163b5c76a6c48L, 0x7a477bfec24be9a9L, "type");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Expression$D_ = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a047L, "org.iets3.core.expr.base.structure.Expression");
    /*package*/ static final SInterfaceConcept IShortLambdaContainer$6m = MetaAdapterFactory.getInterfaceConcept(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba587c8fL, "org.iets3.core.expr.lambda.structure.IShortLambdaContainer");
    /*package*/ static final SConcept ShortLambdaItExpression$k0 = MetaAdapterFactory.getConcept(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba59c798L, "org.iets3.core.expr.lambda.structure.ShortLambdaItExpression");
    /*package*/ static final SConcept ShortLambdaExpression$Xg = MetaAdapterFactory.getConcept(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba587cb6L, "org.iets3.core.expr.lambda.structure.ShortLambdaExpression");
    /*package*/ static final SConcept LambdaExpression$64 = MetaAdapterFactory.getConcept(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba520706L, "org.iets3.core.expr.lambda.structure.LambdaExpression");
    /*package*/ static final SInterfaceConcept IRef$sq = MetaAdapterFactory.getInterfaceConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x66ecc7903939fab1L, "org.iets3.core.expr.base.structure.IRef");
    /*package*/ static final SConcept Type$WK = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a614L, "org.iets3.core.expr.base.structure.Type");
    /*package*/ static final SConcept LambdaArg$9W = MetaAdapterFactory.getConcept(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba52070eL, "org.iets3.core.expr.lambda.structure.LambdaArg");
    /*package*/ static final SConcept LambdaArgRef$5P = MetaAdapterFactory.getConcept(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba52d295L, "org.iets3.core.expr.lambda.structure.LambdaArgRef");
    /*package*/ static final SConcept CapturedValue$Gh = MetaAdapterFactory.getConcept(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x20915a5023bede87L, "org.iets3.core.expr.lambda.structure.CapturedValue");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }
}
