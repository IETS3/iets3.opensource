package org.iets3.core.expr.lambda.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.util.Map;
import com.mbeddr.mpsutil.interpreter.rt.IContext;
import com.mbeddr.mpsutil.interpreter.rt.ICoverageAnalyzer;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import org.iets3.core.expr.lambda.behavior.LambdaExpression__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.smodel.CopyUtil;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.iets3.core.expr.base.behavior.IRef__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.typechecking.TypecheckingFacade;
import org.iets3.core.expr.lambda.behavior.CapturedValue__BehaviorDescriptor;
import org.iets3.core.expr.base.behavior.Expression__BehaviorDescriptor;
import java.util.List;
import com.mbeddr.mpsutil.interpreter.rt.ComputationTrace;
import org.iets3.core.expr.base.behavior.IDefaultCoverageAnalyzer;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class LambdaValue extends ExecutableValue {

  public static final String USER_OBJECT_KEY = "LambdaMapping";
  private SNode lambda = null;
  private Map<SNode, SNode> mapping;
  private boolean stopOnStop = false;

  public LambdaValue(SNode le, IContext ctx, ICoverageAnalyzer coverage, boolean stopOnStop) {
    mapping = MapSequence.fromMap(new HashMap<SNode, SNode>());
    LambdaExpression__BehaviorDescriptor.putNodeMapping_id1ZCJf$ej28Z.invoke(le, mapping);
    lambda = SNodeOperations.as(CopyUtil.copy(le, mapping, true), CONCEPTS.LambdaExpression$64);
    this.stopOnStop = stopOnStop;
    Iterable<SNode> tobBeCaptured = ListSequence.fromList(SNodeOperations.getNodeDescendants(SLinkOperations.getTarget(lambda, LINKS.expression$T2aj), CONCEPTS.IRef$sq, true, new SAbstractConcept[]{})).where((it) -> (boolean) IRef__BehaviorDescriptor.targetStateIsMutable_id22hm_0zJBUZ.invoke(it));
    for (SNode c : Sequence.fromIterable(tobBeCaptured)) {
      SNode cv = createCapturedValue_z5q1ut_a0a0f0g(SNodeOperations.cast(SNodeOperations.copyNode(TypecheckingFacade.getFromContext().getTypeOf(IRef__BehaviorDescriptor.target_id6rGLT0TevFd.invoke(c))), CONCEPTS.Type$WK));
      CapturedValue__BehaviorDescriptor.setValue_id22hm_0zJHWz.invoke(cv, ctx.getRootInterpreter().evaluate(IRef__BehaviorDescriptor.target_id6rGLT0TevFd.invoke(c), ctx, coverage, null, stopOnStop));
      SNodeOperations.replaceWithAnother(c, cv);
    }
  }

  @Override
  public String toString() {
    String bv = "";
    if (ListSequence.fromList(this.boundValues).isNotEmpty()) {
      bv = boundValues + "";
    }
    return "<lambda " + Expression__BehaviorDescriptor.renderReadable_id4Y0vh0cfqjE.invoke(this.lambda) + bv + ">";
  }

  public ExecutableValue copy(IContext ctx, ICoverageAnalyzer coverage) {
    LambdaValue copy = new LambdaValue(lambda, ctx, coverage, stopOnStop);
    ListSequence.fromList(copy.boundValues).addSequence(ListSequence.fromList(this.boundValues));
    return copy;
  }


  public Object executeEvaluated(List<Object> evaluatedArgs, IContext context, final ICoverageAnalyzer coverage, ComputationTrace contextTrace, boolean stopOnStop) {
    context.pushEnvironment(lambda, null);
    int pos = 0;
    for (int i = 0; i < ListSequence.fromList(boundValues).count(); i++) {
      context.getEnvironment().put(ListSequence.fromList(SLinkOperations.getChildren(lambda, LINKS.args$8wKH)).getElement(pos), ListSequence.fromList(boundValues).getElement(i));
      pos++;
    }
    for (int i = 0; i < ListSequence.fromList(evaluatedArgs).count(); i++) {
      context.getEnvironment().put(ListSequence.fromList(SLinkOperations.getChildren(lambda, LINKS.args$8wKH)).getElement(pos), ListSequence.fromList(evaluatedArgs).getElement(i));
      pos++;
    }
    ComputationTrace tt = new ComputationTrace(lambda, false);
    contextTrace.addChild(tt);
    Object res = context.getRootInterpreter().evaluate(SLinkOperations.getTarget(lambda, LINKS.expression$T2aj), context, coverage, tt, stopOnStop);

    ListSequence.fromList(SNodeOperations.getNodeDescendants(lambda, null, true, new SAbstractConcept[]{})).visitAll((final SNode descendant) -> {
      MapSequence.fromMap(mapping).visitAll((mapping) -> {
        if (IDefaultCoverageAnalyzer.isNodeCovered(mapping.value())) {
          coverage.coverValue(mapping.key(), null);
        }
      });
      SNode originalNode = SetSequence.fromSet(MapSequence.fromMap(mapping).keySet()).findFirst((key) -> MapSequence.fromMap(mapping).get(key) == descendant);
      if (IDefaultCoverageAnalyzer.isNodeCovered(descendant)) {
        coverage.coverValue(originalNode, null);
      }
    });
    tt.setValue(res);
    context.popEnvironment(lambda);
    return res;
  }

  private static SNode createCapturedValue_z5q1ut_a0a0f0g(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.CapturedValue$Gh);
    n0.forChild(LINKS.type$EhVN).initNode(p0, CONCEPTS.Type$WK, true);
    return n0.getResult();
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept LambdaExpression$64 = MetaAdapterFactory.getConcept(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba520706L, "org.iets3.core.expr.lambda.structure.LambdaExpression");
    /*package*/ static final SInterfaceConcept IRef$sq = MetaAdapterFactory.getInterfaceConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x66ecc7903939fab1L, "org.iets3.core.expr.base.structure.IRef");
    /*package*/ static final SConcept Type$WK = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a614L, "org.iets3.core.expr.base.structure.Type");
    /*package*/ static final SConcept CapturedValue$Gh = MetaAdapterFactory.getConcept(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x20915a5023bede87L, "org.iets3.core.expr.lambda.structure.CapturedValue");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink expression$T2aj = MetaAdapterFactory.getContainmentLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba520706L, 0x68d69d36ba520b43L, "expression");
    /*package*/ static final SContainmentLink args$8wKH = MetaAdapterFactory.getContainmentLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba520706L, 0x68d69d36ba520707L, "args");
    /*package*/ static final SContainmentLink type$EhVN = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x622163b5c76a6c48L, 0x7a477bfec24be9a9L, "type");
  }
}
