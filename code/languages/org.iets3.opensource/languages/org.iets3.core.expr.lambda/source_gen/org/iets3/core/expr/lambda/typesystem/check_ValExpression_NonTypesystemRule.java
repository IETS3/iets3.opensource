package org.iets3.core.expr.lambda.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.runtime.AbstractNonTypesystemRule_Runtime;
import jetbrains.mps.lang.typesystem.runtime.NonTypesystemRule_Runtime;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import jetbrains.mps.lang.typesystem.runtime.IsApplicableStatus;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.iets3.core.expr.lambda.behavior.IJoinedBlockContext__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.errors.messageTargets.MessageTarget;
import jetbrains.mps.errors.messageTargets.NodeMessageTarget;
import jetbrains.mps.errors.IErrorReporter;
import jetbrains.mps.typechecking.TypecheckingFacade;
import org.iets3.core.expr.base.behavior.IMayHaveEffect__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class check_ValExpression_NonTypesystemRule extends AbstractNonTypesystemRule_Runtime implements NonTypesystemRule_Runtime {
  public check_ValExpression_NonTypesystemRule() {
  }
  public void applyRule(final SNode ve, final TypeCheckingContext typeCheckingContext, IsApplicableStatus status) {
    if ((SNodeOperations.getNodeAncestor(ve, CONCEPTS.IIgnoreTrivialErrorsContext$v_, false, false) == null)) {
      SNode block = SNodeOperations.cast(SNodeOperations.getParent(ve), CONCEPTS.BlockExpression$cH);
      boolean valueIsReferencedLocally = ListSequence.fromList(SLinkOperations.getChildren(block, LINKS.expressions$2$5d)).any((e) -> ListSequence.fromList(SNodeOperations.getNodeDescendants(e, CONCEPTS.ValRef$JF, true, new SAbstractConcept[]{})).any((it) -> SLinkOperations.getTarget(it, LINKS.val$pFD8) == ve));
      if (valueIsReferencedLocally) {
        return;
      }

      SNode joiner = SNodeOperations.getNodeAncestor(ve, CONCEPTS.IJoinedBlockContext$1Z, false, false);
      Iterable<SNode> otherLocs = IJoinedBlockContext__BehaviorDescriptor.otherLocationsForRefsToMe_id5ipapt3mzcn.invoke(joiner, ve);
      Iterable<SNode> otherRefs = Sequence.fromIterable(otherLocs).translate((it) -> SNodeOperations.getNodeDescendants(it, CONCEPTS.ValRef$JF, true, new SAbstractConcept[]{})).where((it) -> SLinkOperations.getTarget(it, LINKS.val$pFD8) == ve);

      if (Sequence.fromIterable(otherRefs).isNotEmpty()) {
        return;
      }

      if (!(valueIsReferencedLocally) && ListSequence.fromList(SLinkOperations.getChildren(block, LINKS.expressions$2$5d)).last() != ve) {
        {
          final MessageTarget errorTarget = new NodeMessageTarget();
          IErrorReporter _reporter_2309309498 = typeCheckingContext.reportWarning(ve, "value never used", "r:3b5d2a4d-f539-4854-bc25-c43da4b5202c(org.iets3.core.expr.lambda.typesystem)", "508719611258576809", null, errorTarget);
        }
      }
    }
    SNode value = SLinkOperations.getTarget(ve, LINKS.expr$CW3E);
    if (SNodeOperations.isInstanceOf(TypecheckingFacade.getFromContext().getTypeOf(value), CONCEPTS.VoidType$Ml)) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(value, "cannot assign value of type void", "r:3b5d2a4d-f539-4854-bc25-c43da4b5202c(org.iets3.core.expr.lambda.typesystem)", "5822875932052108827", null, errorTarget);
      }
    }
    if (SNodeOperations.isInstanceOf(value, CONCEPTS.IMayHaveEffect$Gp) && IMayHaveEffect__BehaviorDescriptor.effectDescriptor_id6GySMNjjWfO.invoke(SNodeOperations.cast(value, CONCEPTS.IMayHaveEffect$Gp)).modifiesState()) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(value, "cannot assign expression that has a ‹modifies› effect", "r:3b5d2a4d-f539-4854-bc25-c43da4b5202c(org.iets3.core.expr.lambda.typesystem)", "5822875932045004808", null, errorTarget);
      }
    }


  }
  public SAbstractConcept getApplicableConcept() {
    return CONCEPTS.ValExpression$fC;
  }
  public IsApplicableStatus isApplicableAndPattern(SNode argument) {
    return new IsApplicableStatus(argument.getConcept().isSubConceptOf(getApplicableConcept()), null);
  }
  public boolean overrides() {
    return false;
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept BlockExpression$cH = MetaAdapterFactory.getConcept(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x427ce52308490169L, "org.iets3.core.expr.lambda.structure.BlockExpression");
    /*package*/ static final SConcept ValRef$JF = MetaAdapterFactory.getConcept(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x427ce523084adea1L, "org.iets3.core.expr.lambda.structure.ValRef");
    /*package*/ static final SInterfaceConcept IJoinedBlockContext$1Z = MetaAdapterFactory.getInterfaceConcept(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x54992997435a32f2L, "org.iets3.core.expr.lambda.structure.IJoinedBlockContext");
    /*package*/ static final SInterfaceConcept IIgnoreTrivialErrorsContext$v_ = MetaAdapterFactory.getInterfaceConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x364e1fe0b7f278b5L, "org.iets3.core.expr.base.structure.IIgnoreTrivialErrorsContext");
    /*package*/ static final SConcept VoidType$Ml = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x7253306fa30e8ecdL, "org.iets3.core.expr.base.structure.VoidType");
    /*package*/ static final SInterfaceConcept IMayHaveEffect$Gp = MetaAdapterFactory.getInterfaceConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x6c21639b50c5f96eL, "org.iets3.core.expr.base.structure.IMayHaveEffect");
    /*package*/ static final SConcept ValExpression$fC = MetaAdapterFactory.getConcept(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x427ce523084a11aeL, "org.iets3.core.expr.lambda.structure.ValExpression");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink expressions$2$5d = MetaAdapterFactory.getContainmentLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x427ce52308490169L, 0x427ce5230849016aL, "expressions");
    /*package*/ static final SReferenceLink val$pFD8 = MetaAdapterFactory.getReferenceLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x427ce523084adea1L, 0x427ce523084ae265L, "val");
    /*package*/ static final SContainmentLink expr$CW3E = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x3b256bb6ae8048d8L, 0x3b256bb6ae8048d9L, "expr");
  }
}
