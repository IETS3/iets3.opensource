package org.iets3.core.expr.math.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.runtime.AbstractNonTypesystemRule_Runtime;
import jetbrains.mps.lang.typesystem.runtime.NonTypesystemRule_Runtime;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import jetbrains.mps.lang.typesystem.runtime.IsApplicableStatus;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.iets3.core.expr.math.plugin.PolynomialExpressionUtil;
import jetbrains.mps.errors.messageTargets.MessageTarget;
import jetbrains.mps.errors.messageTargets.NodeMessageTarget;
import jetbrains.mps.errors.IErrorReporter;
import jetbrains.mps.lang.core.behavior.BaseConcept__BehaviorDescriptor;
import org.iets3.core.expr.simpleTypes.behavior.NumberLiteral__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;

public class check_PolynomialExpression_NonTypesystemRule extends AbstractNonTypesystemRule_Runtime implements NonTypesystemRule_Runtime {
  public check_PolynomialExpression_NonTypesystemRule() {
  }
  public void applyRule(final SNode polynomialExpression, final TypeCheckingContext typeCheckingContext, IsApplicableStatus status) {

    SNode wronExpression = ListSequence.fromList(SNodeOperations.getNodeDescendants(SLinkOperations.getTarget(polynomialExpression, LINKS.expression$T2aj), CONCEPTS.Expression$D_, true, new SAbstractConcept[]{})).findFirst((expr) -> !(PolynomialExpressionUtil.canBeChildOfInnerExpression(expr)));

    if ((wronExpression != null)) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(wronExpression, "expression cannot be part of a polynomial", "r:8b224ec5-7a3e-45b9-8341-eb73ff942246(org.iets3.core.expr.math.typesystem)", "5200464802432196792", null, errorTarget);
      }
      return;
    }

    if (ListSequence.fromList(SLinkOperations.getChildren(polynomialExpression, LINKS.args$8wKH)).count() > 1) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(ListSequence.fromList(SLinkOperations.getChildren(polynomialExpression, LINKS.args$8wKH)).getElement(1), "only univariate polynomials are supported", "r:8b224ec5-7a3e-45b9-8341-eb73ff942246(org.iets3.core.expr.math.typesystem)", "4179418036542904789", null, errorTarget);
      }
      return;
    }

    SNode malformedBaseInMathVarExpression = PolynomialExpressionUtil.hasMalformedBaseInPowExpression(polynomialExpression);

    if ((malformedBaseInMathVarExpression != null)) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(SLinkOperations.getTarget(malformedBaseInMathVarExpression, LINKS.expr$CW3E), "expected variable as base, got expression " + BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(SLinkOperations.getTarget(malformedBaseInMathVarExpression, LINKS.expr$CW3E)), "r:8b224ec5-7a3e-45b9-8341-eb73ff942246(org.iets3.core.expr.math.typesystem)", "4179418036540776704", null, errorTarget);
      }
      return;
    }

    SNode exponentNotNumberLiteralInMathVarExpression = ListSequence.fromList(SNodeOperations.getNodeDescendants(SLinkOperations.getTarget(polynomialExpression, LINKS.expression$T2aj), CONCEPTS.PowerExpression$l7, true, new SAbstractConcept[]{})).where((it) -> !(SNodeOperations.isInstanceOf(SLinkOperations.getTarget(it, LINKS.exponent$uVP8), CONCEPTS.NumberLiteral$wE))).first();

    if ((exponentNotNumberLiteralInMathVarExpression != null)) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(SLinkOperations.getTarget(exponentNotNumberLiteralInMathVarExpression, LINKS.exponent$uVP8), "only numbers allowed in exponent", "r:8b224ec5-7a3e-45b9-8341-eb73ff942246(org.iets3.core.expr.math.typesystem)", "4179418036540961861", null, errorTarget);
      }
      return;
    }

    SNode exponentCannotBeRealInMathVarExpression = ListSequence.fromList(SNodeOperations.getNodeDescendants(SLinkOperations.getTarget(polynomialExpression, LINKS.expression$T2aj), CONCEPTS.PowerExpression$l7, true, new SAbstractConcept[]{})).where((it) -> SNodeOperations.isInstanceOf(SLinkOperations.getTarget(it, LINKS.exponent$uVP8), CONCEPTS.NumberLiteral$wE)).where((it) -> (int) NumberLiteral__BehaviorDescriptor.numberOfDecimals_id3p6$WoEl3wd.invoke(SNodeOperations.cast(SLinkOperations.getTarget(it, LINKS.exponent$uVP8), CONCEPTS.NumberLiteral$wE)) > 0).first();

    if ((exponentCannotBeRealInMathVarExpression != null)) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(SLinkOperations.getTarget(exponentCannotBeRealInMathVarExpression, LINKS.exponent$uVP8), "exponent cannot be of type ‹real›", "r:8b224ec5-7a3e-45b9-8341-eb73ff942246(org.iets3.core.expr.math.typesystem)", "4179418036541082992", null, errorTarget);
      }
      return;
    }

    SNode malformedMulExpression = ListSequence.fromList(SNodeOperations.getNodeDescendants(SLinkOperations.getTarget(polynomialExpression, LINKS.expression$T2aj), CONCEPTS.MulExpression$iC, true, new SAbstractConcept[]{})).where((it) -> !(PolynomialExpressionUtil.isValidMulExpression(it))).first();

    if ((malformedMulExpression != null)) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(malformedMulExpression, "left operand must be a number and right operand a variable", "r:8b224ec5-7a3e-45b9-8341-eb73ff942246(org.iets3.core.expr.math.typesystem)", "4179418036541505957", null, errorTarget);
      }
      return;
    }

    SNode plusExpressionCannotConsistOnlyOfNumberLiterals = ListSequence.fromList(SNodeOperations.getNodeDescendants(SLinkOperations.getTarget(polynomialExpression, LINKS.expression$T2aj), CONCEPTS.PlusExpression$mx, true, new SAbstractConcept[]{})).where((it) -> SNodeOperations.isInstanceOf(SLinkOperations.getTarget(it, LINKS.left$zxUa), CONCEPTS.NumberLiteral$wE) && SNodeOperations.isInstanceOf(SLinkOperations.getTarget(it, LINKS.right$zBjx), CONCEPTS.NumberLiteral$wE)).first();

    if ((plusExpressionCannotConsistOnlyOfNumberLiterals != null)) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(plusExpressionCannotConsistOnlyOfNumberLiterals, "plus expressions must refer to at least one variable", "r:8b224ec5-7a3e-45b9-8341-eb73ff942246(org.iets3.core.expr.math.typesystem)", "4179418036541772474", null, errorTarget);
      }
      return;
    }

    String nonUniqueExponent = PolynomialExpressionUtil.isExponentOfPowExpressionNonUnique(polynomialExpression);
    if ((nonUniqueExponent != null && nonUniqueExponent.length() > 0)) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(polynomialExpression, "for each exponent only one expression allowed, but " + nonUniqueExponent + " is not unique", "r:8b224ec5-7a3e-45b9-8341-eb73ff942246(org.iets3.core.expr.math.typesystem)", "3800040087837067728", null, errorTarget);
      }
      return;
    }
  }
  public SAbstractConcept getApplicableConcept() {
    return CONCEPTS.PolynomialExpression$pY;
  }
  public IsApplicableStatus isApplicableAndPattern(SNode argument) {
    return new IsApplicableStatus(argument.getConcept().isSubConceptOf(getApplicableConcept()), null);
  }
  public boolean overrides() {
    return false;
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink expression$T2aj = MetaAdapterFactory.getContainmentLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba520706L, 0x68d69d36ba520b43L, "expression");
    /*package*/ static final SContainmentLink args$8wKH = MetaAdapterFactory.getContainmentLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba520706L, 0x68d69d36ba520707L, "args");
    /*package*/ static final SContainmentLink expr$CW3E = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x3b256bb6ae8048d8L, 0x3b256bb6ae8048d9L, "expr");
    /*package*/ static final SContainmentLink exponent$uVP8 = MetaAdapterFactory.getContainmentLink(0x6fadc44e69c24a4aL, 0x9d167ebf5f8d3ba0L, 0x449e19d04e9c6144L, 0x46c15b39e5605f2fL, "exponent");
    /*package*/ static final SContainmentLink right$zBjx = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86c99c15L, 0x46ff3b3d86c99c18L, "right");
    /*package*/ static final SContainmentLink left$zxUa = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86c99c15L, 0x46ff3b3d86c99c16L, "left");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Expression$D_ = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a047L, "org.iets3.core.expr.base.structure.Expression");
    /*package*/ static final SConcept PowerExpression$l7 = MetaAdapterFactory.getConcept(0x6fadc44e69c24a4aL, 0x9d167ebf5f8d3ba0L, 0x449e19d04e9c6144L, "org.iets3.core.expr.math.structure.PowerExpression");
    /*package*/ static final SConcept NumberLiteral$wE = MetaAdapterFactory.getConcept(0x6b277d9ad52d416fL, 0xa2091919bd737f50L, 0x46ff3b3d86d0e6daL, "org.iets3.core.expr.simpleTypes.structure.NumberLiteral");
    /*package*/ static final SConcept MulExpression$iC = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86c9a56fL, "org.iets3.core.expr.base.structure.MulExpression");
    /*package*/ static final SConcept PlusExpression$mx = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86c9a4f2L, "org.iets3.core.expr.base.structure.PlusExpression");
    /*package*/ static final SConcept PolynomialExpression$pY = MetaAdapterFactory.getConcept(0x6fadc44e69c24a4aL, 0x9d167ebf5f8d3ba0L, 0x3a00468f8b639e38L, "org.iets3.core.expr.math.structure.PolynomialExpression");
  }
}
