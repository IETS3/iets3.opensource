package org.iets3.core.expr.math.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import com.google.common.collect.Multimap;
import com.google.common.collect.ArrayListMultimap;
import org.iets3.core.expr.math.behavior.PolynomialExpression__BehaviorDescriptor;
import org.iets3.core.expr.simpleTypes.behavior.NumberLiteral__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import java.util.Deque;
import java.util.Objects;
import jetbrains.mps.internal.collections.runtime.LinkedListSequence;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SConcept;

public class PolynomialExpressionUtil {

  public static SNode hasMalformedBaseInPowExpression(SNode polynomialExpression) {
    SNode malformedBaseInMathVarExpression = ListSequence.fromList(SNodeOperations.getNodeDescendants(SLinkOperations.getTarget(polynomialExpression, LINKS.expression$T2aj), CONCEPTS.PowerExpression$l7, true, new SAbstractConcept[]{})).where((it) -> !(SNodeOperations.isInstanceOf(SLinkOperations.getTarget(it, LINKS.expr$CW3E), CONCEPTS.LambdaArgRef$5P))).first();
    return malformedBaseInMathVarExpression;
  }


  public static String isExponentOfPowExpressionNonUnique(SNode polynomialExpression) {
    Multimap<String, SNode> exponentsToExpressions = ArrayListMultimap.create();

    for (SNode expr : ListSequence.fromList(PolynomialExpression__BehaviorDescriptor.polynomFlattened_id3C0hCYbWgi0.invoke(polynomialExpression))) {
      {
        final SNode mulExpression = expr;
        if (SNodeOperations.isInstanceOf(mulExpression, CONCEPTS.MulExpression$iC)) {
          {
            final SNode powerExpression = SLinkOperations.getTarget(mulExpression, LINKS.right$zBjx);
            if (SNodeOperations.isInstanceOf(powerExpression, CONCEPTS.PowerExpression$l7)) {
              SNode key = SNodeOperations.cast(SLinkOperations.getTarget(powerExpression, LINKS.exponent$uVP8), CONCEPTS.NumberLiteral$wE);
              exponentsToExpressions.put(NumberLiteral__BehaviorDescriptor.valueWithDotInsteadOfComma_id2oUyrt$QPvb.invoke(key), powerExpression);
              if (exponentsToExpressions.get(NumberLiteral__BehaviorDescriptor.valueWithDotInsteadOfComma_id2oUyrt$QPvb.invoke(key)).size() > 1) {
                return NumberLiteral__BehaviorDescriptor.valueWithDotInsteadOfComma_id2oUyrt$QPvb.invoke(key);
              }
            }
          }
        }
      }
    }
    return null;
  }

  /**
   * Transforms an Expression into the form c * x^n, ie. 3 x^3 + x^2 + 2x + 9 ---> 
   * 3 x^3 + 1 x^2 + 2 x^1 + 9 x^0.
   */
  public static SNode mapToPowerExpressions(SNode expr, SNode arg) {
    if (SNodeOperations.isInstanceOf(expr, CONCEPTS.NumberLiteral$wE)) {
      SNode xPowZero = createPowerExpression_xrs50n_a0a0a0g(NumberLiteral__BehaviorDescriptor.set_id2oUyrt$Tg3c.invoke(SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x6b277d9ad52d416fL, 0xa2091919bd737f50L, 0x46ff3b3d86d0e6daL, "org.iets3.core.expr.simpleTypes.structure.NumberLiteral")), "0"), createLambdaArgRef_xrs50n_a0b0a0a0a0g(arg));
      return createMulExpression_xrs50n_a1a0a6(expr, xPowZero);
    }

    {
      final SNode mulExpression = expr;
      if (SNodeOperations.isInstanceOf(mulExpression, CONCEPTS.MulExpression$iC)) {
        {
          final SNode lambdaArgRef = SLinkOperations.getTarget(mulExpression, LINKS.right$zBjx);
          if (SNodeOperations.isInstanceOf(lambdaArgRef, CONCEPTS.LambdaArgRef$5P)) {
            return PolynomialExpressionUtil.transformSimpleXWithCoefficient(lambdaArgRef, mulExpression);
          }
        }
      }
    }

    {
      final SNode lambdaArgRef = expr;
      if (SNodeOperations.isInstanceOf(lambdaArgRef, CONCEPTS.LambdaArgRef$5P)) {
        return PolynomialExpressionUtil.transformSimpleX(lambdaArgRef);
      }
    }

    {
      final SNode powerExpression = expr;
      if (SNodeOperations.isInstanceOf(powerExpression, CONCEPTS.PowerExpression$l7)) {
        return PolynomialExpressionUtil.transformPowerXWithoutCoefficient(powerExpression);
      }
    }
    return expr;
  }

  private static SNode transformSimpleXWithCoefficient(SNode lambdaArgRef, SNode mulExpression) {
    SNode xPowOne = createPowerExpression_xrs50n_a0a0i(NumberLiteral__BehaviorDescriptor.set_id2oUyrt$Tg3c.invoke(SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x6b277d9ad52d416fL, 0xa2091919bd737f50L, 0x46ff3b3d86d0e6daL, "org.iets3.core.expr.simpleTypes.structure.NumberLiteral")), "1"), lambdaArgRef);
    return createMulExpression_xrs50n_a1a8(SLinkOperations.getTarget(mulExpression, LINKS.left$zxUa), xPowOne);
  }

  private static SNode transformPowerXWithoutCoefficient(SNode powerExpression) {
    return createMulExpression_xrs50n_a0a01(NumberLiteral__BehaviorDescriptor.set_id2oUyrt$Tg3c.invoke(SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x6b277d9ad52d416fL, 0xa2091919bd737f50L, 0x46ff3b3d86d0e6daL, "org.iets3.core.expr.simpleTypes.structure.NumberLiteral")), "1"), powerExpression);
  }

  private static SNode transformSimpleX(SNode lambdaArgRef) {
    return PolynomialExpressionUtil.transformPowerXWithoutCoefficient(createPowerExpression_xrs50n_a0a0m(NumberLiteral__BehaviorDescriptor.set_id2oUyrt$Tg3c.invoke(SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x6b277d9ad52d416fL, 0xa2091919bd737f50L, 0x46ff3b3d86d0e6daL, "org.iets3.core.expr.simpleTypes.structure.NumberLiteral")), "1"), lambdaArgRef));
  }

  public static void polynomAsFlattendList(SNode expr, Deque<SNode> flattened) {
    if (Objects.equals(SNodeOperations.getConcept(expr), CONCEPTS.PlusExpression$mx) || Objects.equals(SNodeOperations.getConcept(expr), CONCEPTS.MinusExpression$6z)) {
      polynomAsFlattendList(SLinkOperations.getTarget(SNodeOperations.cast(expr, CONCEPTS.BinaryExpression$j$), LINKS.left$zxUa), flattened);
      LinkedListSequence.fromLinkedListNew(flattened).addElement(copyCancel(SNodeOperations.cast(expr, CONCEPTS.BinaryExpression$j$)));
      polynomAsFlattendList(SLinkOperations.getTarget(SNodeOperations.cast(expr, CONCEPTS.BinaryExpression$j$), LINKS.right$zBjx), flattened);
      return;
    }
    if ((ListSequence.fromList(SNodeOperations.getNodeDescendants(expr, CONCEPTS.BinaryExpression$j$, true, new SAbstractConcept[]{})).where((it) -> !(SNodeOperations.isInstanceOf(it, CONCEPTS.MulExpression$iC))).first() != null)) {
      throw new IllegalStateException("Unexpected BinaryExpression occurred!");
    }

    LinkedListSequence.fromLinkedListNew(flattened).addElement(expr);
  }

  private static SNode copyCancel(SNode expr) {
    SNode copy = SNodeOperations.copyNode(expr);
    SLinkOperations.setTarget(copy, LINKS.left$zxUa, null);
    SLinkOperations.setTarget(copy, LINKS.right$zBjx, null);
    return copy;
  }

  public static boolean isValidMulExpression(SNode expr) {
    if (!(SNodeOperations.isInstanceOf(SLinkOperations.getTarget(expr, LINKS.left$zxUa), CONCEPTS.NumberLiteral$wE))) {
      return false;
    }
    if (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(expr, LINKS.right$zBjx), CONCEPTS.LambdaArgRef$5P)) {
      return true;
    }
    if (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(expr, LINKS.right$zBjx), CONCEPTS.PowerExpression$l7) && SNodeOperations.isInstanceOf(SLinkOperations.getTarget(SNodeOperations.cast(SLinkOperations.getTarget(expr, LINKS.right$zBjx), CONCEPTS.PowerExpression$l7), LINKS.expr$CW3E), CONCEPTS.LambdaArgRef$5P)) {
      return true;
    }
    return false;
  }


  public static boolean canBeChildOfInnerExpression(SNode childNode) {
    return SNodeOperations.isInstanceOf(childNode, CONCEPTS.PlusExpression$mx) || SNodeOperations.isInstanceOf(childNode, CONCEPTS.MinusExpression$6z) || SNodeOperations.isInstanceOf(childNode, CONCEPTS.MulExpression$iC) || SNodeOperations.isInstanceOf(childNode, CONCEPTS.NumberLiteral$wE) || SNodeOperations.isInstanceOf(childNode, CONCEPTS.LambdaArgRef$5P) || SNodeOperations.isInstanceOf(childNode, CONCEPTS.PowerExpression$l7) || SNodeOperations.isInstanceOf(childNode, CONCEPTS.LambdaArgRef$5P);
  }
  private static SNode createPowerExpression_xrs50n_a0a0a0g(SNode p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.PowerExpression$l7);
    n0.forChild(LINKS.exponent$uVP8).initNode(p0, CONCEPTS.Expression$D_, true);
    n0.forChild(LINKS.expr$CW3E).initNode(p1, CONCEPTS.Expression$D_, true);
    return n0.getResult();
  }
  private static SNode createLambdaArgRef_xrs50n_a0b0a0a0a0g(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.LambdaArgRef$5P);
    n0.setReferenceTarget(LINKS.arg$J0Dd, p0);
    return n0.getResult();
  }
  private static SNode createMulExpression_xrs50n_a1a0a6(SNode p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.MulExpression$iC);
    n0.forChild(LINKS.left$zxUa).initNode(p0, CONCEPTS.Expression$D_, true);
    n0.forChild(LINKS.right$zBjx).initNode(p1, CONCEPTS.Expression$D_, true);
    return n0.getResult();
  }
  private static SNode createPowerExpression_xrs50n_a0a0i(SNode p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.PowerExpression$l7);
    n0.forChild(LINKS.exponent$uVP8).initNode(p0, CONCEPTS.Expression$D_, true);
    n0.forChild(LINKS.expr$CW3E).initNode(p1, CONCEPTS.Expression$D_, true);
    return n0.getResult();
  }
  private static SNode createMulExpression_xrs50n_a1a8(SNode p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.MulExpression$iC);
    n0.forChild(LINKS.left$zxUa).initNode(p0, CONCEPTS.Expression$D_, true);
    n0.forChild(LINKS.right$zBjx).initNode(p1, CONCEPTS.Expression$D_, true);
    return n0.getResult();
  }
  private static SNode createMulExpression_xrs50n_a0a01(SNode p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.MulExpression$iC);
    n0.forChild(LINKS.left$zxUa).initNode(p0, CONCEPTS.Expression$D_, true);
    n0.forChild(LINKS.right$zBjx).initNode(p1, CONCEPTS.Expression$D_, true);
    return n0.getResult();
  }
  private static SNode createPowerExpression_xrs50n_a0a0m(SNode p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.PowerExpression$l7);
    n0.forChild(LINKS.exponent$uVP8).initNode(p0, CONCEPTS.Expression$D_, true);
    n0.forChild(LINKS.expr$CW3E).initNode(p1, CONCEPTS.Expression$D_, true);
    return n0.getResult();
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink expression$T2aj = MetaAdapterFactory.getContainmentLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba520706L, 0x68d69d36ba520b43L, "expression");
    /*package*/ static final SContainmentLink expr$CW3E = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x3b256bb6ae8048d8L, 0x3b256bb6ae8048d9L, "expr");
    /*package*/ static final SContainmentLink right$zBjx = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86c99c15L, 0x46ff3b3d86c99c18L, "right");
    /*package*/ static final SContainmentLink exponent$uVP8 = MetaAdapterFactory.getContainmentLink(0x6fadc44e69c24a4aL, 0x9d167ebf5f8d3ba0L, 0x449e19d04e9c6144L, 0x46c15b39e5605f2fL, "exponent");
    /*package*/ static final SContainmentLink left$zxUa = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86c99c15L, 0x46ff3b3d86c99c16L, "left");
    /*package*/ static final SReferenceLink arg$J0Dd = MetaAdapterFactory.getReferenceLink(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba52d295L, 0x68d69d36ba52d296L, "arg");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept PowerExpression$l7 = MetaAdapterFactory.getConcept(0x6fadc44e69c24a4aL, 0x9d167ebf5f8d3ba0L, 0x449e19d04e9c6144L, "org.iets3.core.expr.math.structure.PowerExpression");
    /*package*/ static final SConcept LambdaArgRef$5P = MetaAdapterFactory.getConcept(0x9464fa065ab9409bL, 0x927464ab29588457L, 0x68d69d36ba52d295L, "org.iets3.core.expr.lambda.structure.LambdaArgRef");
    /*package*/ static final SConcept MulExpression$iC = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86c9a56fL, "org.iets3.core.expr.base.structure.MulExpression");
    /*package*/ static final SConcept NumberLiteral$wE = MetaAdapterFactory.getConcept(0x6b277d9ad52d416fL, 0xa2091919bd737f50L, 0x46ff3b3d86d0e6daL, "org.iets3.core.expr.simpleTypes.structure.NumberLiteral");
    /*package*/ static final SConcept BinaryExpression$j$ = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86c99c15L, "org.iets3.core.expr.base.structure.BinaryExpression");
    /*package*/ static final SConcept PlusExpression$mx = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86c9a4f2L, "org.iets3.core.expr.base.structure.PlusExpression");
    /*package*/ static final SConcept MinusExpression$6z = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86cac5a5L, "org.iets3.core.expr.base.structure.MinusExpression");
    /*package*/ static final SConcept Expression$D_ = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a047L, "org.iets3.core.expr.base.structure.Expression");
  }
}
