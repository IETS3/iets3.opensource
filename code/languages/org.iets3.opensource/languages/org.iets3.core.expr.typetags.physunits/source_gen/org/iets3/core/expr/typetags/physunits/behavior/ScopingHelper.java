package org.iets3.core.expr.typetags.physunits.behavior;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.smodel.MPSModuleRepository;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import com.mbeddr.core.base.behavior.IVisibleElementProvider__BehaviorDescriptor;
import java.util.Objects;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SProperty;

public class ScopingHelper {

  public static Iterable<SNode> getVisibleUnitsFrom(SNode node) {
    Set<SNode> units = SetSequence.fromSet(new HashSet<SNode>());

    // deprecated getInstance is necessary to ensure compatibility with the command-line generator execution (MpsEnvironment) 
    SRepository repository = MPSModuleRepository.getInstance();
    // reference to the unitless unit specified in the SIUnits accessory model
    final SNode unitLessUnit = StandardUnitHelper.getUnitLessUnit(repository);

    boolean canUseNoUnit = (SNodeOperations.getNodeAncestor(node, CONCEPTS.ICanUseUnitlessUnit$_s, true, false) != null);

    SNode visibleElementProvider = SNodeOperations.getNodeAncestor(node, CONCEPTS.IVisibleElementProvider$$O, true, false);
    for (SNode unit : Sequence.fromIterable(IVisibleElementProvider__BehaviorDescriptor.visibleContentsOfTypeAsSequence_id3g6LnlWuSo8.invoke(visibleElementProvider, CONCEPTS.IUnit$tw))) {
      SetSequence.fromSet(units).addElement(SNodeOperations.cast(unit, CONCEPTS.IUnit$tw));
    }

    if (!(canUseNoUnit)) {
      return SetSequence.fromSet(units).where((it) -> !(Objects.equals(SPropertyOperations.getString(it, PROPS.name$MnvL), SPropertyOperations.getString(unitLessUnit, PROPS.name$MnvL))));
    } else {
      return units;
    }
  }
  public static Iterable<SNode> getVisibleQuantityFrom(SNode node) {
    SNode visibleElementProvider = SNodeOperations.getNodeAncestor(node, CONCEPTS.IVisibleElementProvider$$O, true, false);
    return SNodeOperations.ofConcept(IVisibleElementProvider__BehaviorDescriptor.visibleContentsOfTypeAsSequence_id3g6LnlWuSo8.invoke(visibleElementProvider, CONCEPTS.Quantity$W4), CONCEPTS.Quantity$W4);
  }


  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept ICanUseUnitlessUnit$_s = MetaAdapterFactory.getInterfaceConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x65a3fdcab13f1e17L, "org.iets3.core.expr.typetags.physunits.structure.ICanUseUnitlessUnit");
    /*package*/ static final SInterfaceConcept IVisibleElementProvider$$O = MetaAdapterFactory.getInterfaceConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x6315bcc6eff580a3L, "com.mbeddr.core.base.structure.IVisibleElementProvider");
    /*package*/ static final SInterfaceConcept IUnit$tw = MetaAdapterFactory.getInterfaceConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d40ceL, "org.iets3.core.expr.typetags.physunits.structure.IUnit");
    /*package*/ static final SConcept Quantity$W4 = MetaAdapterFactory.getConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x1c3a590e2b660f17L, "org.iets3.core.expr.typetags.physunits.structure.Quantity");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }
}
