package org.iets3.core.expr.typetags.physunits.typesystem;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import org.iets3.core.expr.typetags.physunits.behavior.IGroupDivision__BehaviorDescriptor;
import org.iets3.core.expr.typetags.physunits.behavior.IGroupLike__BehaviorDescriptor;
import java.util.Objects;
import org.iets3.core.expr.typetags.physunits.plugin.PhysUnitLangConfigHelper;
import org.iets3.core.expr.typetags.physunits.plugin.IUnitLangConfig;
import org.iets3.core.expr.typetags.physunits.behavior.IGroupMultiplication__BehaviorDescriptor;
import org.iets3.core.expr.typetags.physunits.behavior.IGroupPower__BehaviorDescriptor;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import org.iets3.core.expr.base.runtime.runtime.Fraction;
import java.util.LinkedHashSet;
import org.iets3.core.expr.typetags.physunits.behavior.UnitConversionUtil;
import java.util.Comparator;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class GroupHelper {

  public static final String ORIGINAL_NODE_KEY = "original_node";

  /**
   * The assumption for this algorithm is that the arguments are already minimized. Otherwise recursion is needed
   */
  public static SNode minimize(SNode group) {
    SAbstractConcept cncpt = SNodeOperations.getConcept(group);
    boolean noneMatched = true;
    if (noneMatched && SConceptOperations.isSubConceptOf(cncpt, CONCEPTS.IGroupDivision$DT)) {
      noneMatched = false;
      SNode qDiv = SNodeOperations.as(group, CONCEPTS.IGroupDivision$DT);
      SNode top = normalizeToDivType(minimize(IGroupDivision__BehaviorDescriptor.getNumerator_id1JynhuWrSSG.invoke(qDiv)));
      SNode bot = normalizeToDivType(minimize(IGroupDivision__BehaviorDescriptor.getDenominator_id1JynhuWrTer.invoke(qDiv)));
      SNode newTop = IGroupLike__BehaviorDescriptor.mkMultiply_id45a4DYZTqDU.invoke(group, IGroupDivision__BehaviorDescriptor.getNumerator_id1JynhuWrSSG.invoke(top), IGroupDivision__BehaviorDescriptor.getDenominator_id1JynhuWrTer.invoke(bot));
      SNode newBot = IGroupLike__BehaviorDescriptor.mkMultiply_id45a4DYZTqDU.invoke(group, IGroupDivision__BehaviorDescriptor.getNumerator_id1JynhuWrSSG.invoke(bot), IGroupDivision__BehaviorDescriptor.getDenominator_id1JynhuWrTer.invoke(top));
      SNode normalizeDivArgs = normalizeDivArgs(newTop, newBot);
      {
        final SNode div = normalizeDivArgs;
        if (SNodeOperations.isInstanceOf(div, CONCEPTS.IGroupDivision$DT)) {
          if (Objects.equals(PhysUnitLangConfigHelper.getConfig().getMinimizationStrategy(), IUnitLangConfig.MinimizationStrategy.MULTIPLICATION) && (boolean) IGroupDivision__BehaviorDescriptor.convertableToMultiply_id15KrVXSxcF0.invoke(div)) {
            return simplifyMultAndPow(minimize(IGroupDivision__BehaviorDescriptor.convertToMulIfPossible_id15KrVXSx2Vf.invoke(div)));
          }
        }
      }

      return normalizeDivArgs;
    }
    if (noneMatched && SConceptOperations.isSubConceptOf(cncpt, CONCEPTS.IGroupMultiplication$Y1)) {
      noneMatched = false;
      SNode qMul = SNodeOperations.as(group, CONCEPTS.IGroupMultiplication$Y1);
      // reduce multiplication to division
      SNode left = normalizeToDivType(minimize(IGroupMultiplication__BehaviorDescriptor.getLeft_id1JynhuWs0Bg.invoke(qMul)));
      SNode right = normalizeToDivType(minimize(IGroupMultiplication__BehaviorDescriptor.getRight_id1JynhuWs0LF.invoke(qMul)));
      SNode newTop2 = IGroupLike__BehaviorDescriptor.mkMultiply_id45a4DYZTqDU.invoke(group, IGroupDivision__BehaviorDescriptor.getNumerator_id1JynhuWrSSG.invoke(left), IGroupDivision__BehaviorDescriptor.getNumerator_id1JynhuWrSSG.invoke(right));
      SNode newBot2 = IGroupLike__BehaviorDescriptor.mkMultiply_id45a4DYZTqDU.invoke(group, IGroupDivision__BehaviorDescriptor.getDenominator_id1JynhuWrTer.invoke(left), IGroupDivision__BehaviorDescriptor.getDenominator_id1JynhuWrTer.invoke(right));
      SNode normalizeDivArgs = normalizeDivArgs(newTop2, newBot2);
      {
        final SNode mul = normalizeDivArgs;
        if (SNodeOperations.isInstanceOf(mul, CONCEPTS.IGroupMultiplication$Y1)) {
          if (Objects.equals(PhysUnitLangConfigHelper.getConfig().getMinimizationStrategy(), IUnitLangConfig.MinimizationStrategy.DIVISION) && (boolean) IGroupMultiplication__BehaviorDescriptor.convertableToDivide_id15KrVXSx7g2.invoke(mul)) {
            return simplifyMultAndPow(minimize(IGroupMultiplication__BehaviorDescriptor.convertToDivIfPossible_id15KrVXSwXYh.invoke(mul)));
          }
        }
      }
      return normalizeDivArgs;
    }
    if (noneMatched && SConceptOperations.isSubConceptOf(cncpt, CONCEPTS.IGroupPower$Z2)) {
      noneMatched = false;
      final SNode qPower = SNodeOperations.copyNode(SNodeOperations.as(group, CONCEPTS.IGroupPower$Z2));
      SNode base = IGroupPower__BehaviorDescriptor.getBase_id1JynhuWs9Jp.invoke(qPower);
      if (!(SNodeOperations.isInstanceOf(base, CONCEPTS.IReference$$s))) {
        List<SNode> desc = ListSequence.fromList(SNodeOperations.getNodeDescendants(base, CONCEPTS.IGroupLike$8t, false, new SAbstractConcept[]{})).where((it) -> SNodeOperations.isInstanceOf(it, CONCEPTS.IReference$$s)).toList();
        ListSequence.fromList(desc).visitAll((it) -> SNodeOperations.replaceWithAnother(it, simplifyMultAndPow(IGroupLike__BehaviorDescriptor.mkPower_id15KrVXSDEu7.invoke(qPower, it, IGroupPower__BehaviorDescriptor.getExp_id1JynhuWslGU.invoke(qPower)))));
        return simplifyMultAndPow(base);
      }
      return simplifyMultAndPow(qPower);
    }
    return simplifyMultAndPow(group);
  }

  private static SNode normalizeDivArgs(SNode top, SNode bot) {
    Set<SNode> topTypes = getTypeSet(top);
    Set<SNode> botTypes = getTypeSet(bot);
    SNode finalTopType = IGroupLike__BehaviorDescriptor.mkNeutralElem_id45a4DYZV86U.invoke(top);
    SNode finalBotType = IGroupLike__BehaviorDescriptor.mkNeutralElem_id45a4DYZV86U.invoke(bot);

    for (final SNode topType : SetSequence.fromSet(topTypes)) {
      SNode node = SetSequence.fromSet(botTypes).findFirst((it) -> {
        String name = IGroupLike__BehaviorDescriptor.getName_id6Yx4TURG_yz.invoke(IGroupPower__BehaviorDescriptor.getBase_id1JynhuWs9Jp.invoke(it));
        return name != null && Objects.equals(name, IGroupLike__BehaviorDescriptor.getName_id6Yx4TURG_yz.invoke(IGroupPower__BehaviorDescriptor.getBase_id1JynhuWs9Jp.invoke(topType)));
      });
      // multiply if not found in bottom elements
      if ((node == null)) {
        finalTopType = IGroupLike__BehaviorDescriptor.mkMultiply_id45a4DYZTqDU.invoke(top, finalTopType, (SNode) topType);
        continue;
      }
      // found in bottom elements -> simplify
      Fraction exp = IGroupPower__BehaviorDescriptor.getExp_id1JynhuWslGU.invoke(topType).subtract(IGroupPower__BehaviorDescriptor.getExp_id1JynhuWslGU.invoke(node));
      if (exp.isNegative()) {
        IGroupPower__BehaviorDescriptor.setExp_id1JynhuWsqnp.invoke(node, exp.negate());
        finalBotType = IGroupLike__BehaviorDescriptor.mkMultiply_id45a4DYZTqDU.invoke(top, finalBotType, (SNode) node);
      }
      if (exp.isPositive()) {
        IGroupPower__BehaviorDescriptor.setExp_id1JynhuWsqnp.invoke(topType, exp);
        finalTopType = IGroupLike__BehaviorDescriptor.mkMultiply_id45a4DYZTqDU.invoke(top, finalTopType, (SNode) topType);
      }
      SetSequence.fromSet(botTypes).removeElement(node);
    }

    // multiply remaining elements into remainder
    for (SNode botType : SetSequence.fromSet(botTypes)) {
      finalBotType = IGroupLike__BehaviorDescriptor.mkMultiply_id45a4DYZTqDU.invoke(top, finalBotType, (SNode) botType);
    }

    finalTopType = simplifyMultAndPow(finalTopType);
    finalBotType = simplifyMultAndPow(finalBotType);

    if (SNodeOperations.isInstanceOf(finalBotType, CONCEPTS.IGroupNeutral$mQ)) {
      return finalTopType;
    }
    return IGroupLike__BehaviorDescriptor.mkDivide_id45a4DYZTre1.invoke(top, finalTopType, finalBotType);
  }

  private static SNode simplifyMultAndPow(SNode qTy) {
    {
      final SNode power = qTy;
      if (SNodeOperations.isInstanceOf(power, CONCEPTS.IGroupPower$Z2)) {
        {
          final SNode basePower = IGroupPower__BehaviorDescriptor.getBase_id1JynhuWs9Jp.invoke(power);
          if (SNodeOperations.isInstanceOf(basePower, CONCEPTS.IGroupPower$Z2)) {
            return minimize(IGroupLike__BehaviorDescriptor.mkPower_id15KrVXSDEu7.invoke(qTy, IGroupPower__BehaviorDescriptor.getBase_id1JynhuWs9Jp.invoke(basePower), IGroupPower__BehaviorDescriptor.getExp_id1JynhuWslGU.invoke(power).multiply(IGroupPower__BehaviorDescriptor.getExp_id1JynhuWslGU.invoke(basePower))));
          }
        }
        if (IGroupPower__BehaviorDescriptor.getExp_id1JynhuWslGU.invoke(power).equals(Fraction.ONE)) {
          return IGroupPower__BehaviorDescriptor.getBase_id1JynhuWs9Jp.invoke(power);
        } else if (IGroupPower__BehaviorDescriptor.getExp_id1JynhuWslGU.invoke(power).equals(Fraction.ZERO)) {
          return IGroupLike__BehaviorDescriptor.mkNeutralElem_id45a4DYZV86U.invoke(power);
        }
      }
    }

    if (SNodeOperations.isInstanceOf(qTy, CONCEPTS.IGroupPower$Z2) && IGroupPower__BehaviorDescriptor.getExp_id1JynhuWslGU.invoke(SNodeOperations.as(qTy, CONCEPTS.IGroupPower$Z2)).equals(Fraction.ONE)) {
      return IGroupPower__BehaviorDescriptor.getBase_id1JynhuWs9Jp.invoke(SNodeOperations.as(qTy, CONCEPTS.IGroupPower$Z2));
    }
    if (!(SNodeOperations.isInstanceOf(qTy, CONCEPTS.IGroupMultiplication$Y1))) {
      return qTy;
    }
    SNode qMul = SNodeOperations.as(qTy, CONCEPTS.IGroupMultiplication$Y1);
    SNode simplifyLeft = simplifyMultAndPow(IGroupMultiplication__BehaviorDescriptor.getLeft_id1JynhuWs0Bg.invoke(qMul));
    SNode simplifyRight = simplifyMultAndPow(IGroupMultiplication__BehaviorDescriptor.getRight_id1JynhuWs0LF.invoke(qMul));
    if (SNodeOperations.isInstanceOf(simplifyLeft, CONCEPTS.IGroupNeutral$mQ)) {
      return simplifyRight;
    }
    if (SNodeOperations.isInstanceOf(simplifyRight, CONCEPTS.IGroupNeutral$mQ)) {
      return simplifyLeft;
    }
    return IGroupLike__BehaviorDescriptor.mkMultiply_id45a4DYZTqDU.invoke(qTy, simplifyLeft, simplifyRight);
  }

  public static Set<SNode> getTypeSet(SNode group) {
    Set<SNode> res = SetSequence.fromSet(new LinkedHashSet<SNode>());
    SAbstractConcept cncpt = SNodeOperations.getConcept(group);
    boolean noneMatched = true;
    if (noneMatched && SConceptOperations.isSubConceptOf(cncpt, CONCEPTS.IGroupPower$Z2)) {
      noneMatched = false;
      SetSequence.fromSet(res).addElement(SNodeOperations.as(group, CONCEPTS.IGroupPower$Z2));
    }
    if (noneMatched && SConceptOperations.isSubConceptOf(cncpt, CONCEPTS.IGroupBase$L3)) {
      noneMatched = false;
      SNode node = SNodeOperations.as(group, CONCEPTS.IGroupBase$L3);
      SetSequence.fromSet(res).addElement(IGroupLike__BehaviorDescriptor.mkPower_id45a4DYZTrHQ.invoke(group, node, ((int) 1)));
      SetSequence.fromSet(res).last().putUserObject(ORIGINAL_NODE_KEY, group);
    }
    if (noneMatched && SConceptOperations.isSubConceptOf(cncpt, CONCEPTS.IGroupMultiplication$Y1)) {
      noneMatched = false;
      res = getTypeSet(IGroupMultiplication__BehaviorDescriptor.getLeft_id1JynhuWs0Bg.invoke(SNodeOperations.as(group, CONCEPTS.IGroupMultiplication$Y1)));
      for (final SNode elem : SetSequence.fromSet(getTypeSet(IGroupMultiplication__BehaviorDescriptor.getRight_id1JynhuWs0LF.invoke(SNodeOperations.as(group, CONCEPTS.IGroupMultiplication$Y1))))) {
        SNode node = SetSequence.fromSet(res).findFirst((it) -> {
          String name = IGroupLike__BehaviorDescriptor.getName_id6Yx4TURG_yz.invoke(IGroupPower__BehaviorDescriptor.getBase_id1JynhuWs9Jp.invoke(it));
          return name != null && Objects.equals(name, IGroupLike__BehaviorDescriptor.getName_id6Yx4TURG_yz.invoke(IGroupPower__BehaviorDescriptor.getBase_id1JynhuWs9Jp.invoke(elem)));
        });
        if ((node != null)) {
          IGroupPower__BehaviorDescriptor.setExp_id1JynhuWsqnp.invoke(node, IGroupPower__BehaviorDescriptor.getExp_id1JynhuWslGU.invoke(elem).add(IGroupPower__BehaviorDescriptor.getExp_id1JynhuWslGU.invoke(node)));
        } else {
          SetSequence.fromSet(res).addElement(elem);
        }
      }
    }
    return res;
  }

  private static SNode normalizeToDivType(SNode group) {
    if (SNodeOperations.isInstanceOf(group, CONCEPTS.IGroupDivision$DT)) {
      return SNodeOperations.as(group, CONCEPTS.IGroupDivision$DT);
    } else {
      return IGroupLike__BehaviorDescriptor.mkDivide_id45a4DYZTre1.invoke(group, group, IGroupLike__BehaviorDescriptor.mkNeutralElem_id45a4DYZV86U.invoke(group));
    }
  }

  private static SNode getOriginalNode(SNode group) {
    {
      final SNode powerGroup = group;
      if (SNodeOperations.isInstanceOf(powerGroup, CONCEPTS.IGroupPower$Z2)) {
        if (Objects.equals(IGroupPower__BehaviorDescriptor.getExp_id1JynhuWslGU.invoke(powerGroup), Fraction.ONE)) {
          return IGroupPower__BehaviorDescriptor.getBase_id1JynhuWs9Jp.invoke(powerGroup);
        } else {
          return powerGroup;
        }
      }
    }

    SNode userObject = (SNode) group.getUserObject(ORIGINAL_NODE_KEY);
    if (userObject != null && SNodeOperations.getParent(group) == null) {
      return userObject;
    }
    return group;
  }

  public static SNode sortByExponent(SNode group) {
    {
      final SNode divisionGroup = group;
      if (SNodeOperations.isInstanceOf(divisionGroup, CONCEPTS.IGroupDivision$DT)) {
        return IGroupLike__BehaviorDescriptor.mkDivide_id45a4DYZTre1.invoke(group, sortByExponent(IGroupDivision__BehaviorDescriptor.getNumerator_id1JynhuWrSSG.invoke(divisionGroup)), sortByExponent(IGroupDivision__BehaviorDescriptor.getDenominator_id1JynhuWrTer.invoke(divisionGroup)));
      }
    }
    SNode argCopy = SNodeOperations.copyNode(group);
    List<SNode> exponents = SetSequence.fromSet(getTypeSet(argCopy)).toList();
    List<SNode> sortedExponents = ListSequence.fromList(exponents).sort((a, b) -> PhysUnitLangConfigHelper.getConfig().getExponentComparator().compare(a, b), true).toList();
    List<SNode> sortedNodes = ListSequence.fromList(sortedExponents).select((it) -> getOriginalNode(it)).toList();

    SNode result = UnitConversionUtil.createUnitMultiplication(sortedNodes);
    return ((result != null) ? result : IGroupLike__BehaviorDescriptor.mkNeutralElem_id45a4DYZV86U.invoke(group));
  }

  public static Comparator<SNode> defaultExponentComparator = new Comparator<SNode>() {
    @Override
    public int compare(SNode left, SNode right) {
      SNode leftPower = SetSequence.fromSet(getTypeSet(left)).first();
      Fraction leftExponent = IGroupPower__BehaviorDescriptor.getExp_id1JynhuWslGU.invoke(leftPower);
      SNode rightPower = SetSequence.fromSet(getTypeSet(right)).first();
      Fraction rightExponent = IGroupPower__BehaviorDescriptor.getExp_id1JynhuWslGU.invoke(rightPower);

      if (leftExponent.equals(Fraction.ZERO)) {
        return -1;
      }

      int compare = leftExponent.compareTo(rightExponent);
      if (compare == 0) {
        String leftName = IGroupLike__BehaviorDescriptor.getName_id6Yx4TURG_yz.invoke(IGroupPower__BehaviorDescriptor.getBase_id1JynhuWs9Jp.invoke(leftPower));
        String rightName = IGroupLike__BehaviorDescriptor.getName_id6Yx4TURG_yz.invoke(IGroupPower__BehaviorDescriptor.getBase_id1JynhuWs9Jp.invoke(rightPower));
        if (leftName != null && rightName != null) {
          compare = leftName.compareTo(rightName);
        }
      }

      if (leftExponent.isPositive()) {
        if (rightExponent.isPositive()) {
          return compare;
        } else {
          return -1;
        }
      } else {
        if (rightExponent.isPositive()) {
          return 1;
        } else {
          return compare * -1;
        }
      }
    }
  };

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept IGroupDivision$DT = MetaAdapterFactory.getInterfaceConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x414a129fbfe5a55aL, "org.iets3.core.expr.typetags.physunits.structure.IGroupDivision");
    /*package*/ static final SInterfaceConcept IGroupMultiplication$Y1 = MetaAdapterFactory.getInterfaceConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x414a129fbfe5a32cL, "org.iets3.core.expr.typetags.physunits.structure.IGroupMultiplication");
    /*package*/ static final SInterfaceConcept IGroupPower$Z2 = MetaAdapterFactory.getInterfaceConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x414a129fbfe5a6d2L, "org.iets3.core.expr.typetags.physunits.structure.IGroupPower");
    /*package*/ static final SInterfaceConcept IGroupLike$8t = MetaAdapterFactory.getInterfaceConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x414a129fbfe5a091L, "org.iets3.core.expr.typetags.physunits.structure.IGroupLike");
    /*package*/ static final SInterfaceConcept IReference$$s = MetaAdapterFactory.getInterfaceConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x668417ae62784d3aL, "org.iets3.core.expr.typetags.physunits.structure.IReference");
    /*package*/ static final SInterfaceConcept IGroupNeutral$mQ = MetaAdapterFactory.getInterfaceConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x414a129fbffb8733L, "org.iets3.core.expr.typetags.physunits.structure.IGroupNeutral");
    /*package*/ static final SInterfaceConcept IGroupBase$L3 = MetaAdapterFactory.getInterfaceConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x414a129fbfe5a87eL, "org.iets3.core.expr.typetags.physunits.structure.IGroupBase");
  }
}
