package org.iets3.core.expr.typetags.physunits.typesystem;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.Objects;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.iets3.core.expr.typetags.physunits.behavior.IUnit__BehaviorDescriptor;
import org.iets3.core.expr.typetags.physunits.plugin.PhysUnitLangConfigHelper;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.iets3.core.expr.typetags.physunits.behavior.IConvertUnit__BehaviorDescriptor;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SProperty;

public class QuantityCompatibilityChecker {
  public static String check(SNode expr, SNode unitRefSub, SNode unitRefSup) {
    SNode convertToTarget = createConvertToTarget_ccx41k_a0a0a(unitRefSup);
    SNode dotExpression = createDotExpression_ccx41k_a0b0a(expr, convertToTarget);

    String subName = SNodeOperations.present(unitRefSub);
    String supName = SNodeOperations.present(unitRefSup);
    if (Objects.equals(subName, supName)) {
      String subUnitName = SPropertyOperations.getString(SNodeOperations.as(SLinkOperations.getTarget(unitRefSub, LINKS.unit$nTeG), CONCEPTS.Unit$Gq), PROPS.unitName$twX2);
      if ((subUnitName != null && subUnitName.length() > 0)) {
        subName += "(" + subUnitName + ")";
      }
      String supUnitName = SPropertyOperations.getString(SNodeOperations.as(SLinkOperations.getTarget(unitRefSup, LINKS.unit$nTeG), CONCEPTS.Unit$Gq), PROPS.unitName$twX2);
      if ((supUnitName != null && supUnitName.length() > 0)) {
        supName += "(" + supUnitName + ")";
      }
    }

    if (!(Objects.equals(IUnit__BehaviorDescriptor.quantity_id7JDqwWRWT0R.invoke(SLinkOperations.getTarget(unitRefSub, LINKS.unit$nTeG)), IUnit__BehaviorDescriptor.quantity_id7JDqwWRWT0R.invoke(SLinkOperations.getTarget(unitRefSup, LINKS.unit$nTeG))))) {
      return String.format("Unmatched units: ‹%s› and ‹%s›", subName, supName);
    }

    if (!(PhysUnitLangConfigHelper.getConfig().allowMixingCompatibleQuantitiesWithoutConversions()) && ListSequence.fromList(IConvertUnit__BehaviorDescriptor.getApplicableConversionSpecifiers_id3_TFq$0_vSx.invoke(convertToTarget, SNodeOperations.getNodeAncestor(expr, CONCEPTS.IVisibleElementProvider$$O, true, false))).isEmpty()) {
      return String.format("the quantities are compatible but no (implicit) conversion between ‹%s› and ‹%s› is available", subName, supName);
    } else if (!(PhysUnitLangConfigHelper.getConfig().implicitConversionIsEnabled()) && !(PhysUnitLangConfigHelper.getConfig().allowMixingCompatibleQuantitiesWithoutConversions())) {
      return String.format("the quantities ‹%s› and ‹%s› are compatible but implicit conversions are disabled", subName, supName);
    }
    return null;
  }
  private static SNode createConvertToTarget_ccx41k_a0a0a(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ConvertToTarget$M7);
    n0.forChild(LINKS.targetUnit$_yUk).initNode(p0, CONCEPTS.UnitReference$Zo, true);
    return n0.getResult();
  }
  private static SNode createDotExpression_ccx41k_a0b0a(SNode p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.DotExpression$jp);
    n0.forChild(LINKS.expr$CW3E).initNode(p0, CONCEPTS.Expression$D_, true);
    n0.forChild(LINKS.target$u23F).initNode(p1, CONCEPTS.IDotTarget$jS, true);
    return n0.getResult();
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink unit$nTeG = MetaAdapterFactory.getReferenceLink(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d4dc5L, 0x73b48a125b0daafcL, "unit");
    /*package*/ static final SContainmentLink targetUnit$_yUk = MetaAdapterFactory.getContainmentLink(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x7e22431b94d6fd64L, 0x33aa6489a920a49cL, "targetUnit");
    /*package*/ static final SContainmentLink expr$CW3E = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x3b256bb6ae8048d8L, 0x3b256bb6ae8048d9L, "expr");
    /*package*/ static final SContainmentLink target$u23F = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x7cef88020a0f4249L, 0x7cef88020a0f424bL, "target");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Unit$Gq = MetaAdapterFactory.getConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d373fL, "org.iets3.core.expr.typetags.physunits.structure.Unit");
    /*package*/ static final SInterfaceConcept IVisibleElementProvider$$O = MetaAdapterFactory.getInterfaceConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x6315bcc6eff580a3L, "com.mbeddr.core.base.structure.IVisibleElementProvider");
    /*package*/ static final SConcept ConvertToTarget$M7 = MetaAdapterFactory.getConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x7e22431b94d6fd64L, "org.iets3.core.expr.typetags.physunits.structure.ConvertToTarget");
    /*package*/ static final SConcept UnitReference$Zo = MetaAdapterFactory.getConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d4dc5L, "org.iets3.core.expr.typetags.physunits.structure.UnitReference");
    /*package*/ static final SConcept DotExpression$jp = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x7cef88020a0f4249L, "org.iets3.core.expr.base.structure.DotExpression");
    /*package*/ static final SConcept Expression$D_ = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a047L, "org.iets3.core.expr.base.structure.Expression");
    /*package*/ static final SInterfaceConcept IDotTarget$jS = MetaAdapterFactory.getInterfaceConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x7cef88020a0f424aL, "org.iets3.core.expr.base.structure.IDotTarget");
  }

  private static final class PROPS {
    /*package*/ static final SProperty unitName$twX2 = MetaAdapterFactory.getProperty(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d373fL, 0x3cd3b44764426267L, "unitName");
  }
}
