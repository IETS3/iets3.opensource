package org.iets3.core.expr.typetags.physunits.behavior;

/*Generated by MPS */

import jetbrains.mps.core.aspects.behaviour.BaseBHDescriptor;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.core.aspects.behaviour.api.SMethod;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.core.aspects.behaviour.SMethodBuilder;
import jetbrains.mps.core.aspects.behaviour.SJavaCompoundTypeImpl;
import jetbrains.mps.core.aspects.behaviour.AccessPrivileges;
import java.util.List;
import java.util.Arrays;
import org.jetbrains.annotations.NotNull;
import java.util.ArrayList;
import jetbrains.mps.classloading.ClassLoaderManager;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import jetbrains.mps.newTypesystem.context.IncrementalTypecheckingContext;
import jetbrains.mps.typesystem.inference.TypeChecker;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.Map;
import org.iets3.core.expr.base.runtime.runtime.Fraction;
import jetbrains.mps.internal.collections.runtime.Sequence;
import com.mbeddr.core.base.behavior.IVisibleElementProvider__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import java.util.Objects;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.typechecking.TypecheckingFacade;
import jetbrains.mps.core.aspects.behaviour.api.SConstructor;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.core.aspects.behaviour.api.BHMethodNotFoundException;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SProperty;

public final class IConvertUnit__BehaviorDescriptor extends BaseBHDescriptor {
  private static final SAbstractConcept CONCEPT = MetaAdapterFactory.getInterfaceConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x7e22431b94d76bbaL, "org.iets3.core.expr.typetags.physunits.structure.IConvertUnit");

  public static final SMethod<SNode> getExpression_id7SygLIkQnGn = new SMethodBuilder<SNode>(new SJavaCompoundTypeImpl((Class<SNode>) ((Class) Object.class))).name("getExpression").modifiers(12, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(9088900783727541015L).languageId(0x86ed2c6daa33cd8cL, 0x7ee265bd59864709L).build2();
  public static final SMethod<SNode> getTargetUnit_id7SygLIkQpOA = new SMethodBuilder<SNode>(new SJavaCompoundTypeImpl((Class<SNode>) ((Class) Object.class))).name("getTargetUnit").modifiers(12, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(9088900783727549734L).languageId(0x86ed2c6daa33cd8cL, 0x7ee265bd59864709L).build2();
  public static final SMethod<SNode> getTargetUnitReference_id1BdB9zGarhv = new SMethodBuilder<SNode>(new SJavaCompoundTypeImpl((Class<SNode>) ((Class) Object.class))).name("getTargetUnitReference").modifiers(12, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(1859314401785001055L).languageId(0x86ed2c6daa33cd8cL, 0x7ee265bd59864709L).build2();
  public static final SMethod<Void> setConversionSpecifier_id7SygLIkQzuc = new SMethodBuilder<Void>(new SJavaCompoundTypeImpl(Void.class)).name("setConversionSpecifier").modifiers(12, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(9088900783727589260L).languageId(0x86ed2c6daa33cd8cL, 0x7ee265bd59864709L).build2(SMethodBuilder.createJavaParameter((Class<SNode>) ((Class) Object.class), ""));
  public static final SMethod<SNode> getConversionSpecifier_id7SygLIkR36w = new SMethodBuilder<SNode>(new SJavaCompoundTypeImpl((Class<SNode>) ((Class) Object.class))).name("getConversionSpecifier").modifiers(12, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(9088900783727718816L).languageId(0x86ed2c6daa33cd8cL, 0x7ee265bd59864709L).build2();
  public static final SMethod<List<SNode>> getApplicableConversionSpecifiers_id3_TFq$0_vSx = new SMethodBuilder<List<SNode>>(new SJavaCompoundTypeImpl((Class<List<SNode>>) ((Class) Object.class))).name("getApplicableConversionSpecifiers").modifiers(0, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(4141532273714789921L).languageId(0x86ed2c6daa33cd8cL, 0x7ee265bd59864709L).build2(SMethodBuilder.createJavaParameter((Class<SNode>) ((Class) Object.class), ""));
  public static final SMethod<SNode> getImplicitConversionSpecifier_id2x0M_l2hX_w = new SMethodBuilder<SNode>(new SJavaCompoundTypeImpl((Class<SNode>) ((Class) Object.class))).name("getImplicitConversionSpecifier").modifiers(0, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(2900540627559635296L).languageId(0x86ed2c6daa33cd8cL, 0x7ee265bd59864709L).build2(SMethodBuilder.createJavaParameter((Class<SNode>) ((Class) Object.class), ""));

  private static final List<SMethod<?>> BH_METHODS = Arrays.<SMethod<?>>asList(getExpression_id7SygLIkQnGn, getTargetUnit_id7SygLIkQpOA, getTargetUnitReference_id1BdB9zGarhv, setConversionSpecifier_id7SygLIkQzuc, getConversionSpecifier_id7SygLIkR36w, getApplicableConversionSpecifiers_id3_TFq$0_vSx, getImplicitConversionSpecifier_id2x0M_l2hX_w);

  private static void ___init___(@NotNull SNode __thisNode__) {
  }

  /*package*/ static List<SNode> getApplicableConversionSpecifiers_id3_TFq$0_vSx(@NotNull SNode __thisNode__, SNode scope) {
    List<SNode> result = new ArrayList<SNode>();
    SNode expression = IConvertUnit__BehaviorDescriptor.getExpression_id7SygLIkQnGn.invoke(__thisNode__);
    if (expression != null && IConvertUnit__BehaviorDescriptor.getTargetUnit_id7SygLIkQpOA.invoke(__thisNode__) != null) {
      // deprecated getInstance is necessary to ensure compatibility with the command-line generator execution (MpsEnvironment)
      ClassLoaderManager classLoaderManager = ClassLoaderManager.getInstance();
      TypeCheckingContext typeChecking = new IncrementalTypecheckingContext(expression, TypeChecker.getInstance().getTypeCheckerHelper(), classLoaderManager);
      typeChecking.checkIfNotChecked(expression, false);
      SNode sourceType = typeChecking.typeOf(expression);
      typeChecking.dispose();
      SNode sourceUnitRef = SNodeOperations.as(IUnitSpecification__BehaviorDescriptor.getExpression_id6q45UTytEvW.invoke(UnitConversionUtil.getSpecification(sourceType)), CONCEPTS.UnitReference$Zo);
      SNode targetUnitRef = IConvertUnit__BehaviorDescriptor.getTargetUnitReference_id1BdB9zGarhv.invoke(__thisNode__);
      Map<NamedKeyWrapper, Fraction> sourceUnitMap = UnitConversionUtil.getMap_Type(sourceType);
      Map<NamedKeyWrapper, Fraction> targetUnitMap = UnitConversionUtil.getMap_IUnit(IConvertUnit__BehaviorDescriptor.getTargetUnit_id7SygLIkQpOA.invoke(__thisNode__), 1);
      List<SNode> rules = Sequence.fromIterable(SNodeOperations.ofConcept(IVisibleElementProvider__BehaviorDescriptor.visibleContentsOfTypeAsSequence_id3g6LnlWuSo8.invoke(scope, CONCEPTS.ConversionRule$iv), CONCEPTS.ConversionRule$iv)).toList();
      for (SNode rule : ListSequence.fromList(rules)) {
        if ((SLinkOperations.getTarget(SLinkOperations.getTarget(rule, LINKS.sourceUnit$zzDG), LINKS.unit$nTeG) == null) || (SLinkOperations.getTarget(SLinkOperations.getTarget(rule, LINKS.targetUnit$cNlh), LINKS.unit$nTeG) == null)) {
          continue;
        }
        Map<NamedKeyWrapper, Fraction> ruleSourceUnitMap = UnitConversionUtil.getMap_IUnit(SLinkOperations.getTarget(SLinkOperations.getTarget(rule, LINKS.sourceUnit$zzDG), LINKS.unit$nTeG), 1);
        Map<NamedKeyWrapper, Fraction> ruleTargetUnitMap = UnitConversionUtil.getMap_IUnit(SLinkOperations.getTarget(SLinkOperations.getTarget(rule, LINKS.targetUnit$cNlh), LINKS.unit$nTeG), 1);
        _FunctionTypes._return_P2_E0<? extends Boolean, ? super String, ? super String> compareCanBeNull = (String prefix, String otherPrefix) -> {
          if (prefix == null) {
            prefix = "";
          }
          if (otherPrefix == null) {
            otherPrefix = "";
          }
          return Objects.equals(prefix, otherPrefix);
        };
        boolean matchingPrefixes = compareCanBeNull.invoke(SPropertyOperations.getString(sourceUnitRef, PROPS.prefix$AtV), SPropertyOperations.getString(SLinkOperations.getTarget(rule, LINKS.sourceUnit$zzDG), PROPS.prefix$AtV)) && compareCanBeNull.invoke(SPropertyOperations.getString(targetUnitRef, PROPS.prefix$AtV), SPropertyOperations.getString(SLinkOperations.getTarget(rule, LINKS.targetUnit$cNlh), PROPS.prefix$AtV));
        if ((boolean) UnitConversionUtil.matchingMappings(sourceUnitMap, ruleSourceUnitMap)._0() && (boolean) UnitConversionUtil.matchingMappings(targetUnitMap, ruleTargetUnitMap)._0() && matchingPrefixes) {
          for (SNode specifier : ListSequence.fromList(SLinkOperations.getChildren(rule, LINKS.specifiers$j65U))) {
            if (SLinkOperations.getTarget(specifier, LINKS.type$poAd) == null || TypecheckingFacade.getFromContext().isSubtype(UnitConversionUtil.getInnerType(sourceType), SLinkOperations.getTarget(specifier, LINKS.type$poAd))) {
              ListSequence.fromList(result).addElement(specifier);
            }
          }
        }
      }
      if (ListSequence.fromList(result).isEmpty()) {
        SNode automaticallyCreatedConversionSpecifier = UnitConversionUtil.createConversionSpecifierForPrefixedUnitReferences(__thisNode__, sourceUnitMap, targetUnitMap);
        if ((automaticallyCreatedConversionSpecifier != null)) {
          ListSequence.fromList(result).addElement(automaticallyCreatedConversionSpecifier);
        }
      }
    }
    return result;
  }
  /*package*/ static SNode getImplicitConversionSpecifier_id2x0M_l2hX_w(@NotNull SNode __thisNode__, SNode scope) {
    if ((IConvertUnit__BehaviorDescriptor.getConversionSpecifier_id7SygLIkR36w.invoke(__thisNode__) != null)) {
      return null;
    }
    List<SNode> implicitMarkedSpecifiers = ListSequence.fromList(IConvertUnit__BehaviorDescriptor.getApplicableConversionSpecifiers_id3_TFq$0_vSx.invoke(__thisNode__, scope)).where((it) -> SNodeOperations.getModel(it) != null && (int) ConversionRule__BehaviorDescriptor.getPriority_id3wrpJuqIhSQ.invoke(ConversionSpecifier__BehaviorDescriptor.getConversionRule_id1wGuEUvYk55.invoke(it)) > -1).toList();
    if (ListSequence.fromList(implicitMarkedSpecifiers).isNotEmpty()) {
      return ListSequence.fromList(implicitMarkedSpecifiers).sort((a, b) -> (int) ConversionRule__BehaviorDescriptor.getPriority_id3wrpJuqIhSQ.invoke(ConversionSpecifier__BehaviorDescriptor.getConversionRule_id1wGuEUvYk55.invoke(a)), true).last();
    } else {
      return ListSequence.fromList(IConvertUnit__BehaviorDescriptor.getApplicableConversionSpecifiers_id3_TFq$0_vSx.invoke(__thisNode__, scope)).findFirst((it) -> SNodeOperations.getModel(it) == null);
    }
  }

  /*package*/ IConvertUnit__BehaviorDescriptor() {
  }

  @Override
  protected void initNode(@NotNull SNode node, @NotNull SConstructor constructor, @Nullable Object[] parameters) {
    ___init___(node);
  }

  @Override
  protected <T> T invokeSpecial0(@NotNull SNode node, @NotNull SMethod<T> method, @Nullable Object[] parameters) {
    int methodIndex = BH_METHODS.indexOf(method);
    if (methodIndex < 0) {
      throw new BHMethodNotFoundException(this, method);
    }
    switch (methodIndex) {
      case 5:
        return (T) ((List<SNode>) getApplicableConversionSpecifiers_id3_TFq$0_vSx(node, (SNode) parameters[0]));
      case 6:
        return (T) ((SNode) getImplicitConversionSpecifier_id2x0M_l2hX_w(node, (SNode) parameters[0]));
      default:
        throw new BHMethodNotFoundException(this, method);
    }
  }

  @Override
  protected <T> T invokeSpecial0(@NotNull SAbstractConcept concept, @NotNull SMethod<T> method, @Nullable Object[] parameters) {
    int methodIndex = BH_METHODS.indexOf(method);
    if (methodIndex < 0) {
      throw new BHMethodNotFoundException(this, method);
    }
    switch (methodIndex) {
      default:
        throw new BHMethodNotFoundException(this, method);
    }
  }

  @NotNull
  @Override
  public List<SMethod<?>> getDeclaredMethods() {
    return BH_METHODS;
  }

  @NotNull
  @Override
  public SAbstractConcept getConcept() {
    return CONCEPT;
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept UnitReference$Zo = MetaAdapterFactory.getConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d4dc5L, "org.iets3.core.expr.typetags.physunits.structure.UnitReference");
    /*package*/ static final SConcept ConversionRule$iv = MetaAdapterFactory.getConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0xed6abcb370b28cbL, "org.iets3.core.expr.typetags.physunits.structure.ConversionRule");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink targetUnit$cNlh = MetaAdapterFactory.getContainmentLink(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0xed6abcb370b28cbL, 0x6a9f53f6f54cb11bL, "targetUnit");
    /*package*/ static final SReferenceLink unit$nTeG = MetaAdapterFactory.getReferenceLink(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d4dc5L, 0x73b48a125b0daafcL, "unit");
    /*package*/ static final SContainmentLink sourceUnit$zzDG = MetaAdapterFactory.getContainmentLink(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0xed6abcb370b28cbL, 0x6a9f53f6f54cadbcL, "sourceUnit");
    /*package*/ static final SContainmentLink type$poAd = MetaAdapterFactory.getContainmentLink(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x182c7aae9fea4574L, 0x182c7aaea0320b8dL, "type");
    /*package*/ static final SContainmentLink specifiers$j65U = MetaAdapterFactory.getContainmentLink(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0xed6abcb370b28cbL, 0x182c7aae9ff87b9fL, "specifiers");
  }

  private static final class PROPS {
    /*package*/ static final SProperty prefix$AtV = MetaAdapterFactory.getProperty(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d4dc5L, 0x79d6409d1866689aL, "prefix");
  }
}
