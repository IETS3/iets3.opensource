package org.iets3.core.expr.typetags.physunits.behavior;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.util.Map;
import org.iets3.core.expr.base.runtime.runtime.Fraction;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.LinkedList;
import java.util.ArrayList;
import java.util.Iterator;
import org.iets3.core.expr.typetags.physunits.typesystem.QuantityCompatibilityChecker;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.core.behavior.BaseConcept__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.IterableUtils;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SProperty;

public class UnitCombinators {

  public static SNode combine(SNode left, SNode right, SNode operation) {
    Map<NamedKeyWrapper, Fraction> leftSpec = UnitConversionUtil.getMap_Group(IUnitSpecification__BehaviorDescriptor.getExpression_id6q45UTytEvW.invoke(SNodeOperations.as(left, CONCEPTS.IUnitSpecification$yp)));
    Map<NamedKeyWrapper, Fraction> rightSpec = UnitConversionUtil.getMap_Group(IUnitSpecification__BehaviorDescriptor.getExpression_id6q45UTytEvW.invoke(SNodeOperations.as(right, CONCEPTS.IUnitSpecification$yp)));

    if (SNodeOperations.isInstanceOf(operation, CONCEPTS.PlusExpression$mx) || SNodeOperations.isInstanceOf(operation, CONCEPTS.MinusExpression$6z) || SNodeOperations.isInstanceOf(operation, CONCEPTS.BinaryComparisonExpression$7z)) {
      Tuples._3<Boolean, List<SNode>, List<SNode>> matchingUnits = UnitConversionUtil.matchingMappings(leftSpec, rightSpec);
      if ((boolean) matchingUnits._0()) {
        return (SNodeOperations.isInstanceOf(operation, CONCEPTS.BinaryComparisonExpression$7z) ? null : left);
      } else {
        final List<String> unmatchedUnitsMessages = ListSequence.fromList(new LinkedList<String>());

        List<SNode> leftSide = ListSequence.fromListWithValues(new ArrayList<SNode>(), matchingUnits._1());
        List<SNode> rightSide = ListSequence.fromListWithValues(new ArrayList<SNode>(), matchingUnits._2());

        {
          Iterator<SNode> unmatchedLeft_it = ListSequence.fromList(matchingUnits._1()).iterator();
          Iterator<SNode> unmatchedRight_it = ListSequence.fromList(matchingUnits._2()).iterator();
          SNode unmatchedLeft_var;
          SNode unmatchedRight_var;
          while (unmatchedLeft_it.hasNext() && unmatchedRight_it.hasNext()) {
            unmatchedLeft_var = unmatchedLeft_it.next();
            unmatchedRight_var = unmatchedRight_it.next();
            ListSequence.fromList(leftSide).removeElement(unmatchedLeft_var);
            SNode unmatchedLeftRef = SNodeOperations.as(unmatchedLeft_var, CONCEPTS.UnitReference$Zo);
            ListSequence.fromList(rightSide).removeElement(unmatchedRight_var);
            SNode unmatchedRightRef = SNodeOperations.as(unmatchedRight_var, CONCEPTS.UnitReference$Zo);
            String errorMessage = QuantityCompatibilityChecker.check(SLinkOperations.getTarget(SNodeOperations.as(operation, CONCEPTS.BinaryExpression$j$), LINKS.right$zBjx), unmatchedRightRef, unmatchedLeftRef);
            if (errorMessage != null) {
              ListSequence.fromList(unmatchedUnitsMessages).addElement(errorMessage);
            }
          }
        }
        ListSequence.fromList(leftSide).concat(ListSequence.fromList(rightSide)).visitAll((it) -> ListSequence.fromList(unmatchedUnitsMessages).addElement(String.format("Unmatched unit ‹%s› with no counterpart", BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(it))));

        if (ListSequence.fromList(unmatchedUnitsMessages).isNotEmpty()) {
          return createErrorTag_fjxz21_a0a8a0b0d0b(IterableUtils.join(ListSequence.fromList(unmatchedUnitsMessages), "\n"));
        }
      }
    }

    if (SNodeOperations.isInstanceOf(operation, CONCEPTS.MulExpression$iC)) {
      Map<NamedKeyWrapper, Fraction> unified = UnitConversionUtil.unify(leftSpec, rightSpec);
      return UnitConversionUtil.createUnitSpecification(unified);
    }

    if (SNodeOperations.isInstanceOf(operation, CONCEPTS.DivExpression$us)) {
      Map<NamedKeyWrapper, Fraction> unified = UnitConversionUtil.unify(leftSpec, UnitConversionUtil.negate(rightSpec));
      return UnitConversionUtil.createUnitSpecification(unified);
    }

    return left;
  }

  private static SNode createErrorTag_fjxz21_a0a8a0b0d0b(String p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ErrorTag$yj);
    n0.setProperty(PROPS.description$dnEg, p0);
    return n0.getResult();
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept IUnitSpecification$yp = MetaAdapterFactory.getInterfaceConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x668417ae62765445L, "org.iets3.core.expr.typetags.physunits.structure.IUnitSpecification");
    /*package*/ static final SConcept BinaryComparisonExpression$7z = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86cb4f93L, "org.iets3.core.expr.base.structure.BinaryComparisonExpression");
    /*package*/ static final SConcept UnitReference$Zo = MetaAdapterFactory.getConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d4dc5L, "org.iets3.core.expr.typetags.physunits.structure.UnitReference");
    /*package*/ static final SConcept BinaryExpression$j$ = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86c99c15L, "org.iets3.core.expr.base.structure.BinaryExpression");
    /*package*/ static final SConcept PlusExpression$mx = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86c9a4f2L, "org.iets3.core.expr.base.structure.PlusExpression");
    /*package*/ static final SConcept MinusExpression$6z = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86cac5a5L, "org.iets3.core.expr.base.structure.MinusExpression");
    /*package*/ static final SConcept MulExpression$iC = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86c9a56fL, "org.iets3.core.expr.base.structure.MulExpression");
    /*package*/ static final SConcept DivExpression$us = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86cac63bL, "org.iets3.core.expr.base.structure.DivExpression");
    /*package*/ static final SConcept ErrorTag$yj = MetaAdapterFactory.getConcept(0x5186c6ce428c4f09L, 0xa9df73d9e86c27d3L, 0x4b61610d29e00172L, "org.iets3.core.expr.typetags.structure.ErrorTag");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink right$zBjx = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x46ff3b3d86c99c15L, 0x46ff3b3d86c99c18L, "right");
  }

  private static final class PROPS {
    /*package*/ static final SProperty description$dnEg = MetaAdapterFactory.getProperty(0x5186c6ce428c4f09L, 0xa9df73d9e86c27d3L, 0x4b61610d29e00172L, 0x5f4a60cc7cac2147L, "description");
  }
}
