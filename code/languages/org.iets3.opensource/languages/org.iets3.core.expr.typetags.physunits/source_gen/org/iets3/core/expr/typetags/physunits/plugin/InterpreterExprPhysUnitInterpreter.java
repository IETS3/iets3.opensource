package org.iets3.core.expr.typetags.physunits.plugin;

/*Generated by MPS */

import com.mbeddr.mpsutil.interpreter.rt.InterpreterBase;
import java.util.List;
import com.mbeddr.mpsutil.interpreter.rt.IEvaluator;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import com.mbeddr.mpsutil.interpreter.rt.ConceptEvaluatorBase;
import org.jetbrains.mps.openapi.model.SNode;
import com.mbeddr.mpsutil.interpreter.rt.IContext;
import com.mbeddr.mpsutil.interpreter.rt.ICoverageAnalyzer;
import com.mbeddr.mpsutil.interpreter.rt.ComputationTrace;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.iets3.core.expr.typetags.physunits.behavior.IConvertUnit__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import com.mbeddr.mpsutil.interpreter.rt.StopAndReturnException;
import com.mbeddr.mpsutil.interpreter.rt.InterpreterEscapeException;
import com.mbeddr.mpsutil.interpreter.rt.InterpreterRuntimeException;
import com.mbeddr.mpsutil.interpreter.rt.EvaluatorInfo;
import org.iets3.core.expr.typetags.physunits.behavior.UnitConversionUtil;
import jetbrains.mps.typechecking.TypecheckingFacade;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import org.iets3.core.expr.typetags.physunits.behavior.AbstractUnitPrefix;
import org.iets3.core.expr.typetags.physunits.behavior.GlobalUnitPrefixManager;
import com.mbeddr.mpsutil.interpreter.rt.ITypeMapper;
import com.mbeddr.mpsutil.interpreter.rt.IRelationship;
import com.mbeddr.mpsutil.interpreter.rt.InterpretBeforeRelationshipImpl;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SProperty;

public class InterpreterExprPhysUnitInterpreter extends InterpreterBase {
  public InterpreterExprPhysUnitInterpreter() {
    init();
  }

  @Override
  public String getCategory() {
    return "arithmetic";
  }

  protected void populateEvaluators(List<? extends IEvaluator> evaluators) {
    ListSequence.fromList(((List<IEvaluator>) evaluators)).addElement(new ConceptEvaluatorBase(CONCEPTS.IConvertUnit$8k, "r:6e69e40f-b186-4866-917f-dbdef5b3c590(org.iets3.core.expr.typetags.physunits.plugin)/4063324562830258787", true) {
      public Object evaluateEvaluator(SNode node, IContext context, ICoverageAnalyzer coverage, ComputationTrace trace) {
        try {
          coverage.visitedEvaluator(this);
          coverage.visitedConcept(this.concept);
          coverage.visitedConcept(SNodeOperations.getConcept(node));
          IUnitLangConfig config = PhysUnitLangConfigHelper.getConfig();
          SNode conversionSpecifier = null;
          SNode visibleElementsProvider = SNodeOperations.getNodeAncestor(node, CONCEPTS.IVisibleElementProvider$$O, false, false);

          switch (config.getConversionSpecifierSelection()) {
            case DEFINED_IN_CONVERT_EXPESSION:
              conversionSpecifier = IConvertUnit__BehaviorDescriptor.getConversionSpecifier_id7SygLIkR36w.invoke(node);
              break;
            case FIRST_APPLICABLE:
              conversionSpecifier = ListSequence.fromList(IConvertUnit__BehaviorDescriptor.getApplicableConversionSpecifiers_id3_TFq$0_vSx.invoke(node, visibleElementsProvider)).first();
              break;
          }
          if ((conversionSpecifier == null)) {
            conversionSpecifier = ListSequence.fromList(IConvertUnit__BehaviorDescriptor.getApplicableConversionSpecifiers_id3_TFq$0_vSx.invoke(node, visibleElementsProvider)).first();
          }

          SNode convertExpression = SLinkOperations.getTarget(conversionSpecifier, LINKS.expression$BZ0p);
          Object evaluatedSourceUnitValue = context.getRootInterpreter().evaluate(IConvertUnit__BehaviorDescriptor.getExpression_id7SygLIkQnGn.invoke(node), context, coverage, trace, false);
          MapSequence.fromMap(context.getEnvironment()).put(PhysUnitInterpreterHelper.CURRENT_VAL_EXPRESSION, evaluatedSourceUnitValue);
          Object convertedTargetUnit = context.getRootInterpreter().evaluate(convertExpression, context, coverage, trace, false);
          return convertedTargetUnit;
        } catch (StopAndReturnException stop) {
          return stop.value();
        } catch (InterpreterEscapeException ex) {
          throw ex;
        } catch (RuntimeException ex) {
          throw new InterpreterRuntimeException("IConvertUnit()", node, ex, trace);
        }
      }
      public EvaluatorInfo getInfo() {
        return new EvaluatorInfo("IConvertUnit", "http://127.0.0.1:63320/node?ref=b823644f-fc1f-4dd7-9451-201fcb31be28%2Fi%3A1000002e%28org.iets3.core.expr.typetags.physunits%40transient78%2Forg.iets3.core.expr.typetags.physunits.plugin%400%29%2F4063324562830258787");
      }

      @Override
      public String toString() {
        return "IConvertUnit";
      }

      @Override
      public boolean canLookupBeCached() {
        return true;
      }
    });
    ListSequence.fromList(((List<IEvaluator>) evaluators)).addElement(new ConceptEvaluatorBase(CONCEPTS.ValExpression$hl, "r:6e69e40f-b186-4866-917f-dbdef5b3c590(org.iets3.core.expr.typetags.physunits.plugin)/4063324562830308195", true) {
      public Object evaluateEvaluator(SNode node, IContext context, ICoverageAnalyzer coverage, ComputationTrace trace) {
        try {
          coverage.visitedEvaluator(this);
          coverage.visitedConcept(this.concept);
          coverage.visitedConcept(SNodeOperations.getConcept(node));
          return MapSequence.fromMap(context.getEnvironment()).get(PhysUnitInterpreterHelper.CURRENT_VAL_EXPRESSION);
        } catch (StopAndReturnException stop) {
          return stop.value();
        } catch (InterpreterEscapeException ex) {
          throw ex;
        } catch (RuntimeException ex) {
          throw new InterpreterRuntimeException("val()", node, ex, trace);
        }
      }
      public EvaluatorInfo getInfo() {
        return new EvaluatorInfo("ValExpression", "http://127.0.0.1:63320/node?ref=b823644f-fc1f-4dd7-9451-201fcb31be28%2Fi%3A1000002e%28org.iets3.core.expr.typetags.physunits%40transient78%2Forg.iets3.core.expr.typetags.physunits.plugin%400%29%2F4063324562830308195");
      }

      @Override
      public String toString() {
        return "ValExpression";
      }

      @Override
      public boolean canLookupBeCached() {
        return true;
      }
    });
    ListSequence.fromList(((List<IEvaluator>) evaluators)).addElement(new ConceptEvaluatorBase(CONCEPTS.NoConvertExpression$B$, "r:6e69e40f-b186-4866-917f-dbdef5b3c590(org.iets3.core.expr.typetags.physunits.plugin)/1227969439340862130", true) {
      public Object evaluateEvaluator(SNode node, IContext context, ICoverageAnalyzer coverage, ComputationTrace trace) {
        try {
          coverage.visitedEvaluator(this);
          coverage.visitedConcept(this.concept);
          coverage.visitedConcept(SNodeOperations.getConcept(node));
          return ((Object) castUp(context.getRootInterpreter().evaluate(SLinkOperations.getTarget(node, LINKS.expr$CW3E), context, coverage, trace, false), Object.class));
        } catch (StopAndReturnException stop) {
          return stop.value();
        } catch (InterpreterEscapeException ex) {
          throw ex;
        } catch (RuntimeException ex) {
          throw new InterpreterRuntimeException("noConvert()", node, ex, trace);
        }
      }
      public EvaluatorInfo getInfo() {
        return new EvaluatorInfo("NoConvertExpression", "http://127.0.0.1:63320/node?ref=b823644f-fc1f-4dd7-9451-201fcb31be28%2Fi%3A1000002e%28org.iets3.core.expr.typetags.physunits%40transient78%2Forg.iets3.core.expr.typetags.physunits.plugin%400%29%2F1227969439340862130");
      }

      @Override
      public String toString() {
        return "NoConvertExpression";
      }

      @Override
      public boolean canLookupBeCached() {
        return true;
      }
    });
    ListSequence.fromList(((List<IEvaluator>) evaluators)).addElement(new ConceptEvaluatorBase(CONCEPTS.TaggedExpression$jU, "r:6e69e40f-b186-4866-917f-dbdef5b3c590(org.iets3.core.expr.typetags.physunits.plugin)/4063324562830525726", true) {
      public Object evaluateEvaluator(SNode node, IContext context, ICoverageAnalyzer coverage, ComputationTrace trace) {
        try {
          coverage.visitedEvaluator(this);
          coverage.visitedConcept(this.concept);
          coverage.visitedConcept(SNodeOperations.getConcept(node));
          SNode theNode = node;
          SNode specification = SNodeOperations.as(UnitConversionUtil.getSpecification(TypecheckingFacade.getFromContext().getTypeOf(theNode)), CONCEPTS.UnitSpecification$6j);
          boolean interpretDirectly = theNode.getUserObject("interpret_directly") == null;

          IUnitLangConfig config = PhysUnitLangConfigHelper.getConfig();
          if (config.implicitConversionIsEnabled() && config.implicitConversionIsEnabledAt(node)) {
            {
              final SNode unitReference = SLinkOperations.getTarget(specification, LINKS.specification$d6YI);
              if (SNodeOperations.isInstanceOf(unitReference, CONCEPTS.UnitReference$Zo)) {
                String unitPrefix = SPropertyOperations.getString(unitReference, PROPS.prefix$AtV);
                if ((unitPrefix == null || unitPrefix.length() == 0)) {
                  unitPrefix = ((String) theNode.getUserObject("interpreter_original_unit_prefix"));
                }
                AbstractUnitPrefix prefix = GlobalUnitPrefixManager.getManager(SLinkOperations.getTarget(unitReference, LINKS.unit$nTeG)).findPrefix(unitPrefix);
                boolean isInsideConvert = (SNodeOperations.getNodeAncestor(theNode, CONCEPTS.IConvertUnit$8k, false, false) != null) || SNodeOperations.isInstanceOf(SLinkOperations.getTarget(SNodeOperations.getNodeAncestor(theNode, CONCEPTS.DotExpression$jp, false, false), LINKS.target$u23F), CONCEPTS.IConvertUnit$8k);
                boolean isInsideRule = (SNodeOperations.getNodeAncestor(theNode, CONCEPTS.ConversionRule$iv, false, false) != null);

                if (!(isInsideConvert) && !(isInsideRule) && (SNodeOperations.getNodeAncestor(theNode, CONCEPTS.NoConvertExpression$B$, false, false) == null) && prefix != null && interpretDirectly) {

                  SNode copiedExpr = SNodeOperations.copyNode(theNode);
                  copiedExpr.putUserObject("interpret_directly", true);
                  SNode convertExpression = createConvertExpression_ewsp53_a0d0g0a0f0a0d(copiedExpr, SLinkOperations.getTarget(unitReference, LINKS.unit$nTeG));

                  return context.getRootInterpreter().evaluate(convertExpression, context, coverage, trace, false);
                }
              }
            }

          }
          return ((Object) castUp(context.getRootInterpreter().evaluate(SLinkOperations.getTarget(node, LINKS.expr$CW3E), context, coverage, trace, false), Object.class));
        } catch (StopAndReturnException stop) {
          return stop.value();
        } catch (InterpreterEscapeException ex) {
          throw ex;
        } catch (RuntimeException ex) {
          throw new InterpreterRuntimeException("TaggedExpression()", node, ex, trace);
        }
      }
      public EvaluatorInfo getInfo() {
        return new EvaluatorInfo("TaggedExpression", "http://127.0.0.1:63320/node?ref=b823644f-fc1f-4dd7-9451-201fcb31be28%2Fi%3A1000002e%28org.iets3.core.expr.typetags.physunits%40transient78%2Forg.iets3.core.expr.typetags.physunits.plugin%400%29%2F4063324562830525726");
      }

      @Override
      public String toString() {
        return "TaggedExpression";
      }

      @Override
      public boolean canLookupBeCached() {
        return true;
      }
    });
  }


  protected void populateTypeMappers(List<? extends ITypeMapper> typeMappers) {
  }



  protected void populateRelationships(List<? extends IRelationship> relationships) {
    ListSequence.fromList(((List<IRelationship>) relationships)).addElement(new InterpretBeforeRelationshipImpl("org.iets3.core.expr.typetags.physunits.plugin.InterpreterExprPhysUnitInterpreter", "org.iets3.core.expr.base.interpreter.plugin.InterpreterExprBaseInterpreter"));
    ListSequence.fromList(((List<IRelationship>) relationships)).addElement(new InterpretBeforeRelationshipImpl("org.iets3.core.expr.typetags.physunits.plugin.InterpreterExprPhysUnitInterpreter", "org.iets3.core.expr.simpleTypes.interpreter.plugin.InterpreterExprSimpleTypesInterpreter"));
  }
  private static SNode createConvertExpression_ewsp53_a0d0g0a0f0a0d(SNode p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ConvertExpression$Xc);
    n0.forChild(LINKS.expr$CW3E).initNode(p0, CONCEPTS.Expression$D_, true);
    {
      SNodeBuilder n1 = n0.forChild(LINKS.targetUnit$c07m).init(CONCEPTS.UnitReference$Zo);
      n1.setReferenceTarget(LINKS.unit$nTeG, p1);
    }
    return n0.getResult();
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept IVisibleElementProvider$$O = MetaAdapterFactory.getInterfaceConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x6315bcc6eff580a3L, "com.mbeddr.core.base.structure.IVisibleElementProvider");
    /*package*/ static final SInterfaceConcept IConvertUnit$8k = MetaAdapterFactory.getInterfaceConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x7e22431b94d76bbaL, "org.iets3.core.expr.typetags.physunits.structure.IConvertUnit");
    /*package*/ static final SConcept ValExpression$hl = MetaAdapterFactory.getConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x47f53137d1e3b2aeL, "org.iets3.core.expr.typetags.physunits.structure.ValExpression");
    /*package*/ static final SConcept NoConvertExpression$B$ = MetaAdapterFactory.getConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x110a9fb2f2d15aadL, "org.iets3.core.expr.typetags.physunits.structure.NoConvertExpression");
    /*package*/ static final SConcept UnitSpecification$6j = MetaAdapterFactory.getConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d411dL, "org.iets3.core.expr.typetags.physunits.structure.UnitSpecification");
    /*package*/ static final SConcept UnitReference$Zo = MetaAdapterFactory.getConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d4dc5L, "org.iets3.core.expr.typetags.physunits.structure.UnitReference");
    /*package*/ static final SConcept DotExpression$jp = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x7cef88020a0f4249L, "org.iets3.core.expr.base.structure.DotExpression");
    /*package*/ static final SConcept ConversionRule$iv = MetaAdapterFactory.getConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0xed6abcb370b28cbL, "org.iets3.core.expr.typetags.physunits.structure.ConversionRule");
    /*package*/ static final SConcept TaggedExpression$jU = MetaAdapterFactory.getConcept(0x5186c6ce428c4f09L, 0xa9df73d9e86c27d3L, 0x2ea11acb50fe9dabL, "org.iets3.core.expr.typetags.structure.TaggedExpression");
    /*package*/ static final SConcept ConvertExpression$Xc = MetaAdapterFactory.getConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x3930d8ab4c0e6285L, "org.iets3.core.expr.typetags.physunits.structure.ConvertExpression");
    /*package*/ static final SConcept Expression$D_ = MetaAdapterFactory.getConcept(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x670d5e92f854a047L, "org.iets3.core.expr.base.structure.Expression");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink expression$BZ0p = MetaAdapterFactory.getContainmentLink(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x182c7aae9fea4574L, 0x182c7aae9fee3f05L, "expression");
    /*package*/ static final SContainmentLink expr$CW3E = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x3b256bb6ae8048d8L, 0x3b256bb6ae8048d9L, "expr");
    /*package*/ static final SContainmentLink specification$d6YI = MetaAdapterFactory.getContainmentLink(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d411dL, 0x73b48a125b0dab03L, "specification");
    /*package*/ static final SReferenceLink unit$nTeG = MetaAdapterFactory.getReferenceLink(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d4dc5L, 0x73b48a125b0daafcL, "unit");
    /*package*/ static final SContainmentLink target$u23F = MetaAdapterFactory.getContainmentLink(0xcfaa4966b7d54b69L, 0xb66a309a6e1a7290L, 0x7cef88020a0f4249L, 0x7cef88020a0f424bL, "target");
    /*package*/ static final SContainmentLink targetUnit$c07m = MetaAdapterFactory.getContainmentLink(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x3930d8ab4c0e6285L, 0x19cd9c98ec2a3ab4L, "targetUnit");
  }

  private static final class PROPS {
    /*package*/ static final SProperty prefix$AtV = MetaAdapterFactory.getProperty(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d4dc5L, 0x79d6409d1866689aL, "prefix");
  }
}
