package org.iets3.core.expr.typetags.physunits.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.runtime.AbstractNonTypesystemRule_Runtime;
import jetbrains.mps.lang.typesystem.runtime.NonTypesystemRule_Runtime;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import jetbrains.mps.lang.typesystem.runtime.IsApplicableStatus;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.errors.messageTargets.MessageTarget;
import jetbrains.mps.errors.messageTargets.NodeMessageTarget;
import jetbrains.mps.errors.IErrorReporter;
import jetbrains.mps.errors.BaseQuickFixProvider;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.iets3.core.expr.typetags.physunits.behavior.ScopingHelper;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.iets3.core.expr.typetags.physunits.behavior.GlobalUnitPrefixManager;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.internal.collections.runtime.IMapping;
import org.iets3.core.expr.typetags.physunits.behavior.AbstractUnitPrefix;
import java.util.Objects;
import com.mbeddr.core.base.behavior.IHasQualifiedName__BehaviorDescriptor;
import org.iets3.core.expr.typetags.physunits.behavior.Unit__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import jetbrains.mps.lang.core.behavior.BaseConcept__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SConcept;

public class check_Unit_NonTypesystemRule extends AbstractNonTypesystemRule_Runtime implements NonTypesystemRule_Runtime {
  public check_Unit_NonTypesystemRule() {
  }
  public void applyRule(final SNode unit, final TypeCheckingContext typeCheckingContext, IsApplicableStatus status) {
    if (!(SPropertyOperations.getBoolean(unit, PROPS.derived$qIf$)) && (SLinkOperations.getTarget(unit, LINKS.specification$Tp$k) != null)) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(unit, "Unit has a hidden specification. Please remove or set it as derived.", "r:d4f1532d-fc5c-419f-84ee-daef42867c8e(org.iets3.core.expr.typetags.physunits.typesystem)", "8779275567064525525", null, errorTarget);
        {
          BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("org.iets3.core.expr.typetags.physunits.typesystem.fix_nonderivedQuantityRemoveSpec_QuickFix", "8779275567064530070", false);
          _reporter_2309309498.addIntentionProvider(intentionProvider);
        }
        {
          BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("org.iets3.core.expr.typetags.physunits.typesystem.fix_nonderivedUnitMakeDerived_QuickFix", "8779275567064529326", false);
          _reporter_2309309498.addIntentionProvider(intentionProvider);
        }
      }
    }
    Sequence.fromIterable(SNodeOperations.ofConcept(ScopingHelper.getVisibleUnitsFrom(unit), CONCEPTS.Unit$Gq)).where((final SNode it) -> {
      List<String> availablePrefixes = ListSequence.fromList(GlobalUnitPrefixManager.getManager(it).getAvailablePrefixes()).select(new _FunctionTypes._return_P1_E0<String, IMapping<String, AbstractUnitPrefix>>() {
        public String invoke(IMapping<String, AbstractUnitPrefix> it) {
          return it.key();
        }
      }).toList();
      List<SNode> prefixReferences = ListSequence.fromList(availablePrefixes).select((prefix) -> createUnitReference_fv2j1j_a0a0a0a0b0a0a0a1a1(it, prefix)).toList();
      if (Objects.equals(SNodeOperations.getContainingRoot(it), SNodeOperations.getContainingRoot(unit))) {
        return !(Objects.equals(it, unit)) && (Objects.equals(IHasQualifiedName__BehaviorDescriptor.getQualifiedName_id4yaQL1YaUNL.invoke(it), IHasQualifiedName__BehaviorDescriptor.getQualifiedName_id4yaQL1YaUNL.invoke(unit)) || ((boolean) Unit__BehaviorDescriptor.hasScaling_id2hbaSyAVW8s.invoke(it) && ListSequence.fromList(prefixReferences).any((reference) -> Objects.equals(SPropertyOperations.getString(reference, PROPS.name$MnvL), IHasQualifiedName__BehaviorDescriptor.getQualifiedName_id4yaQL1YaUNL.invoke(unit)))));
      } else {
        return !(Objects.equals(it, unit)) && (Objects.equals(SPropertyOperations.getString(it, PROPS.name$MnvL), SPropertyOperations.getString(unit, PROPS.name$MnvL)) || ((boolean) Unit__BehaviorDescriptor.hasScaling_id2hbaSyAVW8s.invoke(it) && ListSequence.fromList(prefixReferences).any((reference) -> Objects.equals(SPropertyOperations.getString(reference, PROPS.name$MnvL), SPropertyOperations.getString(unit, PROPS.name$MnvL)))));
      }
    }).where((it) -> (new IAttributeDescriptor.NodeAttribute(CONCEPTS.AllowNameShadowingAnnotation$Du).get(unit) == null)).visitAll((it) -> {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(unit, String.format("this unit shadows the already defined unit ‹%s›", BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(it)), "r:d4f1532d-fc5c-419f-84ee-daef42867c8e(org.iets3.core.expr.typetags.physunits.typesystem)", "7125972987003088349", null, errorTarget);
        {
          BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("org.iets3.core.expr.typetags.physunits.typesystem.fix_addAllowNameShadowingAnnotation_QuickFix", "4948592237830653626", false);
          intentionProvider.putArgument("unit", unit);
          _reporter_2309309498.addIntentionProvider(intentionProvider);
        }
      }
    });
  }
  public SAbstractConcept getApplicableConcept() {
    return CONCEPTS.Unit$Gq;
  }
  public IsApplicableStatus isApplicableAndPattern(SNode argument) {
    return new IsApplicableStatus(argument.getConcept().isSubConceptOf(getApplicableConcept()), null);
  }
  public boolean overrides() {
    return false;
  }
  private static SNode createUnitReference_fv2j1j_a0a0a0a0b0a0a0a1a1(SNode p0, String p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.UnitReference$Zo);
    n0.setReferenceTarget(LINKS.unit$nTeG, p0);
    n0.setProperty(PROPS.prefix$AtV, p1);
    return n0.getResult();
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink specification$Tp$k = MetaAdapterFactory.getContainmentLink(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x668417ae62c5c36cL, 0x668417ae62c5ca21L, "specification");
    /*package*/ static final SReferenceLink unit$nTeG = MetaAdapterFactory.getReferenceLink(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d4dc5L, 0x73b48a125b0daafcL, "unit");
  }

  private static final class PROPS {
    /*package*/ static final SProperty derived$qIf$ = MetaAdapterFactory.getProperty(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d373fL, 0x79d6409d181f07deL, "derived");
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
    /*package*/ static final SProperty prefix$AtV = MetaAdapterFactory.getProperty(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d4dc5L, 0x79d6409d1866689aL, "prefix");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Unit$Gq = MetaAdapterFactory.getConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d373fL, "org.iets3.core.expr.typetags.physunits.structure.Unit");
    /*package*/ static final SConcept AllowNameShadowingAnnotation$Du = MetaAdapterFactory.getConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x3ec23d494c1ab77bL, "org.iets3.core.expr.typetags.physunits.structure.AllowNameShadowingAnnotation");
    /*package*/ static final SConcept UnitReference$Zo = MetaAdapterFactory.getConcept(0x7ee265bd59864709L, 0x86ed2c6daa33cd8cL, 0x73b48a125b0d4dc5L, "org.iets3.core.expr.typetags.physunits.structure.UnitReference");
  }
}
