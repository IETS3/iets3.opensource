package org.iets3.variability.base.behavior;

/*Generated by MPS */

import java.util.List;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.Objects;

public class TreeWalker {

  /**
   * TODO: Replace this method's body by some method from class "Traversal" (from mpsutil) and deprecate it.
   */
  public static List<SNode> gatherChildren(SNode root, SAbstractConcept childType, SAbstractConcept referenceType, final _FunctionTypes._return_P1_E0<? extends SNode, ? super SNode> extractor) {
    List<SNode> models = new ArrayList<SNode>();
    final List<SNode> visited = new ArrayList<SNode>();
    final List<SNode> worklist = new ArrayList<SNode>();

    ListSequence.fromList(worklist).addElement(root);

    while (!(worklist.isEmpty())) {
      SNode currNode = ListSequence.fromList(worklist).removeElementAt(0);
      ListSequence.fromList(models).addElement(currNode);
      models.addAll(SNodeOperations.getNodeDescendants(currNode, SNodeOperations.asSConcept(childType), false, new SAbstractConcept[]{}));
      ListSequence.fromList(visited).addElement(currNode);
      List<SNode> descendants = new ArrayList<SNode>();
      ListSequence.fromList(descendants).addSequence(ListSequence.fromList(SNodeOperations.getNodeDescendants(currNode, SNodeOperations.asSConcept(referenceType), false, new SAbstractConcept[]{})).select((it) -> extractor.invoke(it)));
      ListSequence.fromList(descendants).visitAll((final SNode child) -> {
        if (ListSequence.fromList(visited).where((visitedNode) -> Objects.equals(visitedNode, child)).count() == 0) {
          ListSequence.fromList(worklist).addElement(child);
        }
      });
    }
    return models;
  }
}
