package org.iets3.core.expr.toplevel.plugin;

/*Generated by MPS */

import org.iets3.core.expr.path.plugin.IRecordValue;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.IMapping;
import java.util.Objects;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.iets3.core.expr.simpleTypes.runtime.OH;
import org.iets3.core.expr.toplevel.behavior.IRecordDeclaration__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;

public class RecordValue implements IRecordValue, Comparable<RecordValue> {

  protected Map<String, Object> memberData = MapSequence.fromMap(new HashMap<String, Object>());
  private SNode recordDeclaration;
  private IPresenter presenter;

  public RecordValue(SNode recordDecl) {
    recordDeclaration = recordDecl;
    presenter = RecordValuePresenterAccess.resolveIPresenter();
  }

  public RecordValue(SNode recordDecl, IPresenter presenter) {
    recordDeclaration = recordDecl;
    this.presenter = presenter;
  }

  public void add(String name, Object value) {
    MapSequence.fromMap(memberData).put(name, value);
  }

  public void setPresenter(IPresenter presenter) {
    this.presenter = presenter;
  }

  @Override
  public String toString() {
    return presenter.present(this);
  }

  public RecordValue copy() {
    RecordValue r = new RecordValue(recordDeclaration, presenter);
    MapSequence.fromMap(r.memberData).putAll(this.memberData);
    return r;
  }

  public void update(String name, Object value) {
    MapSequence.fromMap(memberData).put(name, value);
  }

  @Override
  public boolean equals(Object object) {
    if (object instanceof RecordValue) {
      RecordValue rv = ((RecordValue) object);
      if (MapSequence.fromMap(this.memberData).count() != MapSequence.fromMap(rv.memberData).count()) {
        return false;
      }
      for (IMapping<String, Object> e : MapSequence.fromMap(this.memberData)) {
        if (!(MapSequence.fromMap(rv.memberData).containsKey(e.key()))) {
          return false;
        }
        if (!(MapSequence.fromMap(rv.memberData).get(e.key()).equals(e.value()))) {
          return false;
        }
      }
      return true;
    }
    return false;
  }

  @Override
  public int hashCode() {
    return Objects.hash(memberData, recordDeclaration);
  }

  public Object getValueForPath(SNode member) {
    String n = SPropertyOperations.getString(member, PROPS.name$MnvL);
    return MapSequence.fromMap(this.memberData).get(n);
  }

  public Object getValueByName(String name) {
    return MapSequence.fromMap(memberData).get(name);
  }

  public Iterable<String> memberNames() {
    return MapSequence.fromMap(this.memberData).keySet();
  }

  public String recordTypeName() {
    return (this.recordDeclaration != null ? SPropertyOperations.getString(this.recordDeclaration, PROPS.name$MnvL) : "<anonymous>");
  }

  public SNode recordDeclaration() {
    return this.recordDeclaration;
  }

  @Override
  public int compareTo(RecordValue value) {
    if (ListSequence.fromList(SLinkOperations.getChildren(SNodeOperations.as(recordDeclaration, CONCEPTS.IRecordDeclaration$Cv), LINKS.comparisonOrder$fACp)).isNotEmpty()) {
      for (SNode comparisonOrder : SLinkOperations.getChildren(SNodeOperations.as(recordDeclaration, CONCEPTS.IRecordDeclaration$Cv), LINKS.comparisonOrder$fACp)) {
        Object thisValue = getValueForPath(SLinkOperations.getTarget(comparisonOrder, LINKS.member$2ryB));
        Object otherValue = value.getValueForPath(SLinkOperations.getTarget(comparisonOrder, LINKS.member$2ryB));

        if (thisValue != null && otherValue != null) {
          int memberComparison = OH.compare(thisValue, otherValue);
          if (memberComparison != 0) {
            return memberComparison;
          }
        }

      }
    } else {
      for (SNode member : IRecordDeclaration__BehaviorDescriptor.effectiveMembers_id1qrYg08iahZ.invoke(SNodeOperations.as(recordDeclaration, CONCEPTS.IRecordDeclaration$Cv))) {
        Object thisValue = getValueForPath(member);
        Object otherValue = value.getValueByName(SPropertyOperations.getString(member, PROPS.name$MnvL));

        if (thisValue != null && otherValue != null) {
          int memberComparison = OH.compare(thisValue, otherValue);
          if (memberComparison != 0) {
            return memberComparison;
          }
        }
      }
    }
    return 0;
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink member$2ryB = MetaAdapterFactory.getReferenceLink(0x71934284d7d145eeL, 0xa0548c072591085fL, 0x373cc1802a0589c0L, 0x373cc1802a0589c1L, "member");
    /*package*/ static final SContainmentLink comparisonOrder$fACp = MetaAdapterFactory.getContainmentLink(0x71934284d7d145eeL, 0xa0548c072591085fL, 0x85e1e1330497e6fL, 0x67fa8a3063137fecL, "comparisonOrder");
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept IRecordDeclaration$Cv = MetaAdapterFactory.getInterfaceConcept(0x71934284d7d145eeL, 0xa0548c072591085fL, 0x85e1e1330497e6fL, "org.iets3.core.expr.toplevel.structure.IRecordDeclaration");
  }
}
