package org.iets3.core.expr.toplevel.editor;

/*Generated by MPS */

import com.mbeddr.core.base.editor.AbstractBracketCell;
import org.jetbrains.mps.openapi.model.SNode;
import java.awt.Color;
import jetbrains.mps.nodeEditor.cells.EditorCell;
import jetbrains.mps.openapi.editor.EditorContext;
import jetbrains.mps.nodeEditor.cells.EditorCell_Basic;
import jetbrains.mps.openapi.editor.selection.SelectionListener;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.editor.runtime.style.StyleAttributes;
import jetbrains.mps.openapi.editor.cells.CellActionType;
import jetbrains.mps.nodeEditor.cellActions.CellAction_DeleteNode;
import java.awt.event.KeyEvent;
import jetbrains.mps.editor.runtime.commands.EditorCommand;
import jetbrains.mps.nodeEditor.sidetransform.EditorCell_STHint;
import java.awt.Graphics;
import jetbrains.mps.nodeEditor.cells.ParentSettings;
import com.intellij.ui.ColorUtil;
import com.intellij.ui.JBColor;
import jetbrains.mps.nodeEditor.cells.EditorCell_Collection;
import jetbrains.mps.openapi.editor.EditorComponent;
import jetbrains.mps.openapi.editor.selection.Selection;

public class EndCell extends AbstractBracketCell {
  public EndCell(SNode node) {
    super(node);
  }
  public EndCell(SNode node, Color c) {
    super(node, c);
  }

  public EditorCell createEditorCell(final EditorContext context) {
    EditorCell_Basic result = new Cell(context, getSNode());
    return result;
  }

  public class Cell extends EditorCell_Basic implements SelectionListener {

    public Cell(@NotNull EditorContext context, SNode node) {
      super(context, node);
      getStyle().set(StyleAttributes.getInstance().<Boolean>getAttribute("de.itemis.mps.editor.celllayout.styles", "_grow-y"), true);

      setAction(CellActionType.DELETE, new CellAction_DeleteNode(node));
      setAction(CellActionType.BACKSPACE, new CellAction_DeleteNode(node));
    }

    @Override
    protected boolean doProcessKeyTyped(final KeyEvent event, boolean allowErrors) {
      final EditorContext editorContext = getContext();
      if (!(isTextTypedEvent(event))) {
        return false;
      }

      final CellActionType actionType;
      actionType = CellActionType.RIGHT_TRANSFORM;

      editorContext.getRepository().getModelAccess().executeCommand(new EditorCommand(editorContext) {
        protected void doExecute() {
          boolean wasExecuted = editorContext.getEditorComponent().getActionHandler().executeAction(Cell.this, actionType);
          if (wasExecuted) {
            EditorCell_STHint stHintCell = EditorCell_STHint.getSTHintCell(getSNode(), getEditorComponent());
            if (stHintCell != null) {
              stHintCell.changeText("" + event.getKeyChar());
              stHintCell.end();
            }
          }
        }
      });
      return true;
    }


    public void paintContent(Graphics g, ParentSettings parentSettings) {
      if (shouldPaintBracket(getContext(), this, parentSettings)) {
        if (color != null) {
          g.setColor(color);
        } else {
          g.setColor(ColorUtil.withAlpha(JBColor.BLACK, 0.12));
        }
        EditorCell_Collection parent = this.getParent();
        int x = myX + getLeftGap();
        int y = parent.getY();
        int height = parent.getHeight() - 2;
        g.fillRect(x, y + 2, 2, height);
      }
    }

    public void relayoutImpl() {
      this.myWidth = 2;
      this.myHeight = 20;
    }

    @Override
    public void onAdd() {
      getEditorComponent().getSelectionManager().addSelectionListener(this);
    }

    @Override
    public void onRemove() {
      getEditorComponent().getSelectionManager().removeSelectionListener(this);
    }

    public void selectionChanged(EditorComponent component, Selection selection, Selection selection1) {
      ((jetbrains.mps.nodeEditor.EditorComponent) getEditorComponent()).repaint(this);
    }
  }
}
