package org.iets3.variability.artifacts.base.editor;

/*Generated by MPS */

import jetbrains.mps.editor.runtime.descriptor.AbstractEditorBuilder;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.openapi.editor.EditorContext;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import de.slisson.mps.tables.runtime.cells.TableEditor;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import de.slisson.mps.hacks.editor.EditorCacheHacks;
import de.slisson.mps.tables.runtime.cells.ChildsTracker;
import de.slisson.mps.tables.runtime.cells.PartialTableExtractor;
import de.slisson.mps.tables.runtime.gridmodel.Grid;
import java.util.List;
import de.slisson.mps.tables.runtime.gridmodel.HeaderGrid;
import java.util.ArrayList;
import de.slisson.mps.tables.runtime.style.ITableStyleFactory;
import jetbrains.mps.openapi.editor.style.Style;
import jetbrains.mps.editor.runtime.style.StyleImpl;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import de.slisson.mps.tables.runtime.gridmodel.GridAdapter;
import de.slisson.mps.tables.runtime.gridmodel.IHeaderNodeInsertAction;
import de.slisson.mps.tables.runtime.gridmodel.ChildNodesInsertAction;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.openapi.editor.cells.SubstituteInfo;
import de.slisson.mps.hacks.editor.SubstituteUtil;
import de.slisson.mps.tables.runtime.gridmodel.IGridElement;
import de.slisson.mps.tables.runtime.gridmodel.HeaderNodeInsertAction;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import de.slisson.mps.tables.runtime.gridmodel.EditorCellFactory;
import jetbrains.mps.openapi.editor.cells.CellActionType;
import jetbrains.mps.editor.runtime.cells.AbstractCellAction;
import jetbrains.mps.nodeEditor.cellMenu.DefaultSChildSubstituteInfo;
import de.slisson.mps.tables.runtime.gridmodel.IRowCreateHandler;
import org.iets3.variability.artifacts.base.plugin.ArtifactHelper;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import org.iets3.variability.artifacts.base.behavior.IPreviewableArtifact__BehaviorDescriptor;
import org.iets3.variability.artifacts.base.plugin.PreviewCriteria;
import org.iets3.variability.artifacts.base.behavior.IVariationPointBase__BehaviorDescriptor;
import de.slisson.mps.tables.runtime.cells.PartialTableEditor;
import de.slisson.mps.tables.runtime.gridmodel.EditorCellGridLeaf;
import jetbrains.mps.nodeEditor.cells.EditorCell_Constant;
import org.iets3.variability.artifacts.base.editor.ArtifactStyles_StyleSheet.FeatureDecTabTableStyleClass;
import jetbrains.mps.lang.editor.cellProviders.SingleRoleCellProvider;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.editor.runtime.impl.cellActions.CellAction_DeleteSmart;
import jetbrains.mps.openapi.editor.cells.DefaultSubstituteInfo;
import jetbrains.mps.nodeEditor.cellMenu.SEmptyContainmentSubstituteInfo;
import jetbrains.mps.nodeEditor.cellMenu.SChildSubstituteInfo;
import org.iets3.variability.artifacts.base.editor.ArtifactStyles_StyleSheet.FeatureDecTabValueStyleClass;
import jetbrains.mps.openapi.editor.menus.transformation.SNodeLocation;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SProperty;

/*package*/ class FeatureDecTab_EditorBuilder_a extends AbstractEditorBuilder {
  @NotNull
  private SNode myNode;

  public FeatureDecTab_EditorBuilder_a(@NotNull EditorContext context, @NotNull SNode node) {
    super(context);
    myNode = node;
  }

  @NotNull
  @Override
  public SNode getNode() {
    return myNode;
  }

  /*package*/ EditorCell createCell() {
    return createTable_1();
  }

  private EditorCell createTable_0(final EditorContext editorContext, final SNode node) {

    final Wrappers._T<TableEditor> editorCell = new Wrappers._T<TableEditor>(null);
    _FunctionTypes._void_P0_E0 creator = () -> {
      EditorCacheHacks.noCaching(editorContext, () -> {
        try {

          ChildsTracker.pushNewInstance();
          PartialTableExtractor.pushNewInstance();
          Grid grid = new Grid();

          // column headers
          {
            List<HeaderGrid> headerGrids = new ArrayList<HeaderGrid>(0);
            grid.setColumnHeaders(headerGrids);
          }

          // row headers
          {
            List<HeaderGrid> headerGrids = new ArrayList<HeaderGrid>(0);
            grid.setRowHeaders(headerGrids);
          }
          final Grid childGrid = createStaticVertical_wguyup_a0(editorContext, node);
          childGrid.setSpanX(Math.max(1, grid.getColumnHeadersSizeX()));
          childGrid.setSpanY(Math.max(1, grid.getRowHeadersSizeY()));
          grid.setElement(0, 0, childGrid);

          editorCell.value = new TableEditor(editorContext, node, grid);
          editorCell.value.setCellId("Table_wguyup_a");
          editorCell.value.setBig(true);
          setCellContext(editorCell.value);
          TableSelectionActionMap.setCellActions(editorCell.value, myNode, getEditorContext());
          ITableStyleFactory factory = new ITableStyleFactory() {
            public Style createStyle(final int columnIndex, final int rowIndex) {
              Style style = new StyleImpl();
              final EditorCell editorCell = null;
              return style;
            }
          };
          editorCell.value.getStyle().putAll(factory.createStyle(0, 0));


          editorCell.value.init();
        } finally {
          PartialTableExtractor.popInstance();
          ChildsTracker.popInstance(true);
        }
      });
    };

    creator.invoke();

    return editorCell.value;

  }
  private EditorCell createTable_1() {
    return createTable_0(getEditorContext(), myNode);
  }
  public Grid createStaticVertical_wguyup_a0(final EditorContext editorContext, final SNode node) {
    Grid grid = new Grid();

    List<Grid> children = new ArrayList<Grid>(2);
    if (true) {
      children.add(createChildsVertical_wguyup_a0a(editorContext, node));
    }
    if (true) {
      children.add(createStaticHorizontal_wguyup_b0a(editorContext, node));
    }
    int maxWidth = grid.getColumnHeadersSizeX();
    for (Grid child : ListSequence.fromList(children)) {
      maxWidth = Math.max(maxWidth, child.getSizeX());
    }
    for (int y = 0; y < children.size(); y++) {
      if (maxWidth > 0) {
        children.get(y).setSpanX(maxWidth);
      }
      grid.setElement(0, y, children.get(y));
    }
    final Style style = new ITableStyleFactory() {
      public Style createStyle(final int columnIndex, final int rowIndex) {
        Style style = new StyleImpl();
        final EditorCell editorCell = null;
        return style;
      }
    }.createStyle(0, 0);
    grid.setOrAddStyle(style);
    return grid;
  }
  public Grid createChildsVertical_wguyup_a0a(final EditorContext editorContext, final SNode node) {
    Grid grid = new Grid();
    GridAdapter gridAdapter = new GridAdapter(grid, editorContext, node);


    final IHeaderNodeInsertAction insertAction = new ChildNodesInsertAction(node, SLinkOperations.findLinkDeclaration(LINKS.contents$oelO)) {};

    try {
      getCellFactory().pushCellContext();
      getCellFactory().addCellContextHints();
      getCellFactory().removeCellContextHints();
      int y = 0;
      Iterable<SNode> elements = SLinkOperations.getChildren(node, LINKS.contents$oelO);
      for (SNode child : Sequence.fromIterable(elements)) {
        final int yFinal = y;
        EditorCell cell = editorContext.getEditorComponent().getUpdater().getCurrentUpdateSession().updateChildNodeCell(child);
        ChildsTracker.getInstance().registerChild(cell);
        SubstituteInfo substituteInfo = SubstituteUtil.forChild(editorContext, node, (y < ListSequence.fromList(SLinkOperations.getChildren(node, LINKS.contents$oelO)).count() ? ListSequence.fromList(SLinkOperations.getChildren(node, LINKS.contents$oelO)).getElement(y) : null), LINKS.contents$oelO);
        cell.setSubstituteInfo(substituteInfo);

        IGridElement gridElement = PartialTableExtractor.getGridElementFromEditorCell(cell, grid);

        gridElement.setRightRowCreateHandler(new HeaderNodeInsertAction(SNodeOperations.getIndexInParent(child) + 1, insertAction));
        gridElement.setLeftRowCreateHandler(new HeaderNodeInsertAction(SNodeOperations.getIndexInParent(child), insertAction));
        gridElement.setSpanX(Math.max(1, grid.getSizeX()));

        grid.setElement(0, y, gridElement);


        gridElement.setOrAddStyle(new ITableStyleFactory() {
          public Style createStyle(final int columnIndex, final int rowIndex) {
            Style style = new StyleImpl();
            final EditorCell editorCell = null;
            return style;
          }
        }.createStyle(0, y));

        gridElement.setInsertBeforeAction(new HeaderNodeInsertAction(SNodeOperations.getIndexInParent(child), insertAction), -1);
        gridElement.setInsertAction(new HeaderNodeInsertAction(SNodeOperations.getIndexInParent(child) + 1, insertAction), -1);

        y++;
      }
    } finally {
      getCellFactory().popCellContext();
    }

    if (ListSequence.fromList(SLinkOperations.getChildren(node, LINKS.contents$oelO)).isEmpty()) {
      EditorCell placeholder = new EditorCellFactory(editorContext, node, grid).createPlaceholderConstant("<no contents>");
      IGridElement element = PartialTableExtractor.getGridElementFromEditorCell(placeholder, grid);
      element.setSpanX(Math.max(element.getSpanX(), grid.getColumnHeadersSizeX()));
      element.setSpanY(Math.max(element.getSpanY(), grid.getRowHeadersSizeY()));
      grid.setElement(0, 0, element);

      placeholder.setAction(CellActionType.INSERT, new AbstractCellAction() {
        public void execute(EditorContext p0) {
          insertAction.insertNew(0);
        }
      });
      placeholder.setAction(CellActionType.INSERT_BEFORE, placeholder.getAction(CellActionType.INSERT));
      SubstituteInfo substituteInfo = new DefaultSChildSubstituteInfo(node, null, LINKS.contents$oelO, editorContext);
      placeholder.setSubstituteInfo(substituteInfo);
      IRowCreateHandler rowCreateHandler = new IRowCreateHandler() {
        public void create() {
          insertAction.insertNew(0);
        }
      };

      grid.setLeftRowCreateHandler(rowCreateHandler);
      grid.setRightRowCreateHandler(rowCreateHandler);
    }

    grid.flattenOneLevel();
    return grid;
  }
  public Grid createStaticHorizontal_wguyup_b0a(final EditorContext editorContext, final SNode node) {
    Grid grid = new Grid();

    List<Grid> children = new ArrayList<Grid>(2);
    if (new Object() {
      public boolean condition() {
        final SNode ivaa = ArtifactHelper.findIVAA(node);
        // Show if not in preview or not ready for preview
        if ((ivaa == null) || !(SPropertyOperations.getBoolean(ivaa, PROPS.inPreview$Ox7X)) || ListSequence.fromList(SLinkOperations.getChildren(node, LINKS.contents$oelO)).isEmpty()) {
          return true;
        }

        if (IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).equals(PreviewCriteria.criteria0)) {
          return false;
        }

        if ((IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).equals(PreviewCriteria.criteria1) || IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).equals(PreviewCriteria.criteria2))) {
          // Show according criteria but only if default value must be used
          return ListSequence.fromList(SLinkOperations.getChildren(node, LINKS.contents$oelO)).all((cont) -> !(IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).isVisible(IVariationPointBase__BehaviorDescriptor.getState_id7pGmjNvL72C.invoke(cont))));
        }

        if (IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).equals(PreviewCriteria.criteria3)) {
          return true;
        }

        return true;
      }
    }.condition()) {
      children.add(createTableCell_wguyup_a1a0(editorContext, node));
    }
    if (new Object() {
      public boolean condition() {
        final SNode ivaa = ArtifactHelper.findIVAA(node);
        // Show if not in preview or not ready for preview
        if ((ivaa == null) || !(SPropertyOperations.getBoolean(ivaa, PROPS.inPreview$Ox7X)) || ListSequence.fromList(SLinkOperations.getChildren(node, LINKS.contents$oelO)).isEmpty()) {
          return true;
        }

        if (IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).equals(PreviewCriteria.criteria0) || IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).equals(PreviewCriteria.criteria1) || IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).equals(PreviewCriteria.criteria2)) {
          // Show according criteria but only if default value must be used
          return ListSequence.fromList(SLinkOperations.getChildren(node, LINKS.contents$oelO)).all((cont) -> !(IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).isVisible(IVariationPointBase__BehaviorDescriptor.getState_id7pGmjNvL72C.invoke(cont))));
        }

        if (IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).equals(PreviewCriteria.criteria3)) {
          return true;
        }

        return true;
      }
    }.condition()) {
      children.add(createTableCell_wguyup_b1a0(editorContext, node));
    }
    int maxHeight = grid.getRowHeadersSizeY();
    for (Grid child : ListSequence.fromList(children)) {
      maxHeight = Math.max(maxHeight, child.getSizeY());
    }
    for (int x = 0; x < children.size(); x++) {
      if (maxHeight > 0) {
        children.get(x).setSpanY(maxHeight);
      }
      grid.setElement(x, 0, children.get(x));
    }
    final Style style = new ITableStyleFactory() {
      public Style createStyle(final int columnIndex, final int rowIndex) {
        Style style = new StyleImpl();
        final EditorCell editorCell = null;
        return style;
      }
    }.createStyle(0, 0);
    grid.setOrAddStyle(style);
    return grid;
  }
  public Grid createTableCell_wguyup_a1a0(final EditorContext editorContext, final SNode node) {
    if (!(new Object() {
      public boolean condition() {
        final SNode ivaa = ArtifactHelper.findIVAA(node);
        // Show if not in preview or not ready for preview
        if ((ivaa == null) || !(SPropertyOperations.getBoolean(ivaa, PROPS.inPreview$Ox7X)) || ListSequence.fromList(SLinkOperations.getChildren(node, LINKS.contents$oelO)).isEmpty()) {
          return true;
        }

        if (IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).equals(PreviewCriteria.criteria0)) {
          return false;
        }

        if ((IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).equals(PreviewCriteria.criteria1) || IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).equals(PreviewCriteria.criteria2))) {
          // Show according criteria but only if default value must be used
          return ListSequence.fromList(SLinkOperations.getChildren(node, LINKS.contents$oelO)).all((cont) -> !(IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).isVisible(IVariationPointBase__BehaviorDescriptor.getState_id7pGmjNvL72C.invoke(cont))));
        }

        if (IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).equals(PreviewCriteria.criteria3)) {
          return true;
        }

        return true;
      }
    }.condition())) {
      return new Grid();
    }

    EditorCell cell = createConstant_0();
    final Style style = new ITableStyleFactory() {
      public Style createStyle(final int columnIndex, final int rowIndex) {
        Style style = new StyleImpl();
        final EditorCell editorCell = null;
        return style;
      }
    }.createStyle(0, 0);

    Grid grid;
    if (cell instanceof PartialTableEditor) {
      grid = ((PartialTableEditor) cell).getGrid().clone();
    } else {
      grid = new Grid();
      EditorCellGridLeaf leaf = new EditorCellGridLeaf(cell);
      leaf.setStyle(style);
      grid.setElement(0, 0, leaf);
    }

    return grid;
  }
  private EditorCell createConstant_0() {
    EditorCell_Constant editorCell = new EditorCell_Constant(getEditorContext(), myNode, "default:");
    editorCell.setCellId("Constant_wguyup_a0b0a");
    Style style = new StyleImpl();
    new FeatureDecTabTableStyleClass(this).apply(style, editorCell);
    editorCell.getStyle().putAll(style);
    editorCell.setDefaultText("");
    return editorCell;
  }
  public Grid createTableCell_wguyup_b1a0(final EditorContext editorContext, final SNode node) {
    if (!(new Object() {
      public boolean condition() {
        final SNode ivaa = ArtifactHelper.findIVAA(node);
        // Show if not in preview or not ready for preview
        if ((ivaa == null) || !(SPropertyOperations.getBoolean(ivaa, PROPS.inPreview$Ox7X)) || ListSequence.fromList(SLinkOperations.getChildren(node, LINKS.contents$oelO)).isEmpty()) {
          return true;
        }

        if (IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).equals(PreviewCriteria.criteria0) || IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).equals(PreviewCriteria.criteria1) || IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).equals(PreviewCriteria.criteria2)) {
          // Show according criteria but only if default value must be used
          return ListSequence.fromList(SLinkOperations.getChildren(node, LINKS.contents$oelO)).all((cont) -> !(IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).isVisible(IVariationPointBase__BehaviorDescriptor.getState_id7pGmjNvL72C.invoke(cont))));
        }

        if (IPreviewableArtifact__BehaviorDescriptor.previewCriteria_id6ViAOjRttY.invoke(ivaa).equals(PreviewCriteria.criteria3)) {
          return true;
        }

        return true;
      }
    }.condition())) {
      return new Grid();
    }

    EditorCell cell = createRefNode_0();
    final Style style = new ITableStyleFactory() {
      public Style createStyle(final int columnIndex, final int rowIndex) {
        Style style = new StyleImpl();
        final EditorCell editorCell = null;
        return style;
      }
    }.createStyle(0, 0);

    Grid grid;
    if (cell instanceof PartialTableEditor) {
      grid = ((PartialTableEditor) cell).getGrid().clone();
    } else {
      grid = new Grid();
      EditorCellGridLeaf leaf = new EditorCellGridLeaf(cell);
      leaf.setStyle(style);
      grid.setElement(0, 0, leaf);
    }

    return grid;
  }
  private EditorCell createRefNode_0() {
    SingleRoleCellProvider provider = new defaultSingleRoleHandler_wguyup_a1b0a(myNode, LINKS.default$k9_M, getEditorContext());
    return provider.createCell();
  }
  private static class defaultSingleRoleHandler_wguyup_a1b0a extends SingleRoleCellProvider {
    @NotNull
    private SNode myNode;

    public defaultSingleRoleHandler_wguyup_a1b0a(SNode ownerNode, SContainmentLink containmentLink, EditorContext context) {
      super(containmentLink, context);
      myNode = ownerNode;
    }

    @Override
    @NotNull
    public SNode getNode() {
      return myNode;
    }

    protected EditorCell createChildCell(SNode child) {
      EditorCell editorCell = getUpdateSession().updateChildNodeCell(child);
      editorCell.setAction(CellActionType.DELETE, new CellAction_DeleteSmart(getNode(), LINKS.default$k9_M, child));
      editorCell.setAction(CellActionType.BACKSPACE, new CellAction_DeleteSmart(getNode(), LINKS.default$k9_M, child));
      installCellInfo(child, editorCell, false);
      return editorCell;
    }



    private void installCellInfo(SNode child, EditorCell editorCell, boolean isEmpty) {
      if (editorCell.getSubstituteInfo() == null || editorCell.getSubstituteInfo() instanceof DefaultSubstituteInfo) {
        editorCell.setSubstituteInfo((isEmpty ? new SEmptyContainmentSubstituteInfo(editorCell) : new SChildSubstituteInfo(editorCell)));
      }
      if (editorCell.getSRole() == null) {
        editorCell.setSRole(LINKS.default$k9_M);
      }
      Style style = new StyleImpl();
      new FeatureDecTabValueStyleClass(this).apply(style, editorCell);
      editorCell.getStyle().putAll(style);
    }
    @Override
    protected EditorCell createEmptyCell() {
      getCellFactory().pushCellContext();
      getCellFactory().setNodeLocation(new SNodeLocation.FromParentAndLink(getNode(), LINKS.default$k9_M));
      try {
        EditorCell editorCell = super.createEmptyCell();
        editorCell.setCellId("empty_default");
        installCellInfo(null, editorCell, true);
        setCellContext(editorCell);
        return editorCell;
      } finally {
        getCellFactory().popCellContext();
      }
    }
    protected String getNoTargetText() {
      return "<no default>";
    }
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink contents$oelO = MetaAdapterFactory.getContainmentLink(0xf08835038eaa4bc8L, 0x8846eb63220ab1ddL, 0x2de0d5b2023d47abL, 0x2de0d5b2023d497cL, "contents");
    /*package*/ static final SContainmentLink default$k9_M = MetaAdapterFactory.getContainmentLink(0xf08835038eaa4bc8L, 0x8846eb63220ab1ddL, 0x2de0d5b2023d47abL, 0x48cf6454839aefb1L, "default");
  }

  private static final class PROPS {
    /*package*/ static final SProperty inPreview$Ox7X = MetaAdapterFactory.getProperty(0xf08835038eaa4bc8L, 0x8846eb63220ab1ddL, 0x41a5090d088f66bcL, 0x41a5090d0891713dL, "inPreview");
  }
}
