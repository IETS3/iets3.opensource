package org.iets3.variability.artifacts.base.plugin;

/*Generated by MPS */

import com.mbeddr.mpsutil.interpreter.rt.ContextImpl;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.Deque;
import jetbrains.mps.internal.collections.runtime.DequeSequence;
import java.util.LinkedList;
import org.iets3.variability.configuration.base.behavior.UsedConfigs;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import org.iets3.variability.featuremodel.base.plugin.EvalConstants;

public class VPEvalContext extends ContextImpl {
  private final SNode rootConfig;
  private final Deque<SNode> configStack = DequeSequence.fromDeque(new LinkedList<SNode>());

  public VPEvalContext(SNode rootConfig) {
    super();
    this.rootConfig = rootConfig;
    new UsedConfigs(rootConfig).storeInEnv(getEnvironment());
  }

  public SNode rootConfig() {
    return this.rootConfig;
  }

  public SNode leafConfig() {
    if (DequeSequence.fromDequeNew(configStack).isEmpty()) {
      return rootConfig;
    }
    return DequeSequence.fromDequeNew(configStack).peekElement();
  }

  public void addAsRoot(SNode ivaa) {
    Map<SNode, Object> environment = getEnvironment();
    environment.put(ivaa, rootConfig);
  }

  public void push(SNode ivaa, SNode childConfig, UsedConfigs actuallyUsed) {
    // Create a new environment layer, with a mapping from ivaa to the configuration.
    // If the configuration is unspecified, use marker object UNSPECIFIED_CONFIGURATION.
    Map<SNode, Object> newEnv = MapSequence.fromMap(new HashMap<SNode, Object>());
    MapSequence.fromMap(newEnv).put(ivaa, ((childConfig != null) ? childConfig : EvalConstants.UNSPECIFIED_CONFIGURATION));
    pushEnvironment(ivaa, newEnv);
    actuallyUsed.storeInEnv(getEnvironment());
    DequeSequence.fromDequeNew(configStack).pushElement(childConfig);
  }

  public void pop(SNode ivaa) {
    popEnvironment(ivaa);
    if (DequeSequence.fromDequeNew(configStack).isNotEmpty()) {
      DequeSequence.fromDequeNew(configStack).popElement();
    }
  }
}
