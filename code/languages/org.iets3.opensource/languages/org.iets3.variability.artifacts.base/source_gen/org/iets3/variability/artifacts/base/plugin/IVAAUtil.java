package org.iets3.variability.artifacts.base.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.iets3.variability.artifacts.base.behavior.IVariabilityAwareArtifact__BehaviorDescriptor;
import java.util.List;
import java.util.Collection;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import com.google.common.collect.Iterables;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import com.mbeddr.mpsutil.logicalChild.behavior.LogicalChildOwnerUtil;
import java.util.ArrayList;
import java.util.Set;
import com.google.common.collect.Sets;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import com.mbeddr.mpsutil.logicalChild.behavior.ILogicalChildOwner__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class IVAAUtil {

  public static Iterable<SNode> artifactGroup(SNode mainArtifact) {
    return Sequence.fromIterable(Sequence.<SNode>singleton(mainArtifact)).union(Sequence.fromIterable(IVariabilityAwareArtifact__BehaviorDescriptor.getAllDependenciesTransitive_id5LihCoMjg$M.invoke(mainArtifact)).select((it) -> it.getLeaf()));
  }

  public static Iterable<SNode> artifactGroupWithLogicalChildren(SNode mainArtifact) {
    List<SNode> artifactGroup = Sequence.fromIterable(artifactGroup(mainArtifact)).toList();
    return artifactGroupWithLogicalChildren(artifactGroup);
  }

  public static Iterable<SNode> artifactGroupWithLogicalChildren(Collection<SNode> artifactGroup) {
    Iterable<SNode> logicalChildren = CollectionSequence.fromCollection(artifactGroup).translate((ivaa) -> collectNestedLogicalChildren(ivaa));
    return Iterables.<SNode>concat(artifactGroup, logicalChildren);
  }

  private static Iterable<SNode> collectNestedLogicalChildren(SNode ivaa) {
    List<SNode> childOwners = SNodeOperations.getNodeDescendants(IVariabilityAwareArtifact__BehaviorDescriptor.artifactRoot_id3q2wVeorTKs.invoke(ivaa), CONCEPTS.ILogicalChildOwner$nQ, true, new SAbstractConcept[]{});
    return collectNestedLogicalChildren(childOwners, true);
  }

  public static Iterable<SNode> collectNestedLogicalChildren(final Collection<SNode> childOwners, boolean useCache) {
    if (!(useCache)) {
      return IVAAUtil.collectNestedLogicalChildrenInner(childOwners);
    }
    try {
      return LogicalChildOwnerUtil.withCachedLogicalChildren(() -> IVAAUtil.collectNestedLogicalChildrenInner(childOwners));
    } catch (Exception e) {
      throw new RuntimeException(e);
    }
  }

  private static Iterable<SNode> collectNestedLogicalChildrenInner(Collection<SNode> childOwners) {
    List<SNode> foundOwners = new ArrayList<SNode>();
    List<SNode> allChildren = new ArrayList<SNode>();
    // Make sure we do not get caught in a cyclce
    Set<SNode> visited = Sets.newHashSet();

    ListSequence.fromList(foundOwners).addSequence(CollectionSequence.fromCollection(childOwners));

    while (ListSequence.fromList(foundOwners).isNotEmpty()) {
      SNode currNode = ListSequence.fromList(foundOwners).removeElementAt(0);
      SetSequence.fromSet(visited).addElement(currNode);
      List<SNode> children = Sequence.fromIterable(ILogicalChildOwner__BehaviorDescriptor.findLogicalChildren_id7c93VeVMIYV.invoke(currNode)).toList();
      ListSequence.fromList(allChildren).addSequence(ListSequence.fromList(children));
      ListSequence.fromList(foundOwners).addSequence(Sequence.fromIterable(SNodeOperations.ofConcept(children, CONCEPTS.ILogicalChildOwner$nQ)).subtract(SetSequence.fromSet(visited)));
    }
    return allChildren;
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept ILogicalChildOwner$nQ = MetaAdapterFactory.getInterfaceConcept(0x85a9bace37a140afL, 0x956a7bb1b081a77cL, 0x4d47311ce8608adL, "com.mbeddr.mpsutil.logicalChild.structure.ILogicalChildOwner");
  }
}
