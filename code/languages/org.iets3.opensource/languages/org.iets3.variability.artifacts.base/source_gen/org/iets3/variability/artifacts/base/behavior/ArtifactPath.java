package org.iets3.variability.artifacts.base.behavior;

/*Generated by MPS */

import com.mbeddr.mpsutil.common.util.InstancePath;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.Optional;
import jetbrains.mps.lang.core.behavior.BaseConcept__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.NotNullWhereFilter;
import org.iets3.variability.featuremodel.base.plugin.DotExpressionUtil;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.IterableUtils;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;

public class ArtifactPath extends InstancePath<SNode, Segment, ArtifactPath> {

  public static ArtifactPath toArtifactPath(Pivot pivot) {
    return new ArtifactPath(pivot.getTargetIVAA(), Sequence.singleton(pivot.asSegment()));
  }

  public ArtifactPath(SNode root) {
    super(root);
  }

  public ArtifactPath(SNode root, Iterable<Segment> segments) {
    super(root, segments);
  }

  private ArtifactPath(ArtifactPath orig) {
    super(orig);
  }

  @Override
  protected ArtifactPath cloneObject() {
    return new ArtifactPath(this);
  }

  @Override
  protected Optional<SNode> getDefinition(Segment segment) {
    return Optional.ofNullable(segment.getTarget());
  }

  @Override
  protected String getRootPresentation() {
    return (String) BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(root());
  }

  public boolean hasDirectLeaf() {
    return lastSegment().map((seg) -> seg.isDirect()).orElse(false);
  }

  public Iterable<SNode> getFMIncludePath() {
    return Sequence.fromIterable(segments()).select((it) -> it.getFMInclude()).where(new NotNullWhereFilter());
  }

  public Iterable<SNode> getPath() {
    return getPathAux(getFMIncludePath());
  }

  public SNode getPathExpression() {
    // last segment needs to be skipped as it is the include, which is also used in FeatureRefExpr
    Iterable<SNode> ftns = getPathAux(Sequence.fromIterable(getFMIncludePath()).cut(1));
    return (Sequence.fromIterable(ftns).count() <= 1 ? createFeatureRefExpr_vbbj4r_a0c0v(Sequence.fromIterable(ftns).first()) : DotExpressionUtil.toDotExpression(ftns));
  }

  private Iterable<SNode> getPathAux(Iterable<SNode> fmiPath) {
    return Sequence.fromIterable(Sequence.<SNode>singleton(SLinkOperations.getTarget(root(), LINKS.rootFeature$hMQ2))).union(Sequence.fromIterable(fmiPath));
  }


  public String asInstancePath() {
    return IterableUtils.join(Sequence.fromIterable(Sequence.singleton(IVariabilityAwareArtifact__BehaviorDescriptor.artifactName_id7eAm6HphX4A.invoke(root()))).union(Sequence.fromIterable(segments()).select((it) -> it.getName())), "_");
  }

  public String asNameForSolver() {
    return IterableUtils.join(Sequence.fromIterable(segmentsReversed()).select((it) -> it.getName()).where(new NotNullWhereFilter()), "_");
  }

  public String asNameForSkeletonNode() {
    return IterableUtils.join(Sequence.fromIterable(segmentsReversed()).skip(1).select((it) -> it.getName()).where(new NotNullWhereFilter()), "_");
  }

  public String asSegmentPathString() {
    return IterableUtils.join(Sequence.fromIterable(segments()).select((it) -> it.toString()), " / ");
  }

  public String asDependency() {
    Segment direct = Sequence.fromIterable(segments()).findLast((it) -> it.isDirect());
    if (direct != null) {
      return IVariabilityAwareArtifact__BehaviorDescriptor.artifactName_id7eAm6HphX4A.invoke(direct.getTarget());
    } else {
      return asSegmentPathString();
    }
  }

  private static SNode createFeatureRefExpr_vbbj4r_a0c0v(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.FeatureRefExpr$Ys);
    n0.setReferenceTarget(LINKS.feature$3d5y, p0);
    return n0.getResult();
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink rootFeature$hMQ2 = MetaAdapterFactory.getReferenceLink(0xf08835038eaa4bc8L, 0x8846eb63220ab1ddL, 0x716b3738b4b28e4bL, 0x740cca37d2b86175L, "rootFeature");
    /*package*/ static final SReferenceLink feature$3d5y = MetaAdapterFactory.getReferenceLink(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x7cde27c7fd81d2eeL, 0x7cde27c7fd81d2f8L, "feature");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept FeatureRefExpr$Ys = MetaAdapterFactory.getConcept(0x165f1d0525064544L, 0x895e1424f54166ecL, 0x7cde27c7fd81d2eeL, "org.iets3.variability.featuremodel.base.structure.FeatureRefExpr");
  }
}
