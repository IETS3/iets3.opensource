package org.iets3.variability.artifacts.base.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;

public class PresenceConditionFormatter {
  private static final int MINIMAL_LIMIT = 16;
  private static final int EXTRA_PERCENTAGE = 30;

  /**
   * Use a heuristics to shorten a condition expression based on a fixed maximum horizontal space.
   * 
   * The maximum space is given as number of characters. This method is being used to shorten
   * presence conditions for boxes in diagram editors.
   * 
   * @param expr the condition expression to be shortened
   * @param maxLen the maximum number of characters
   * @return the condition expression as a string, possibly shortened
   */
  public static String shortenConditionFixed(SNode expr, int maxLen) {
    return shortenConditionHelper(expr, maxLen);
  }

  /**
   * Use a heuristics to shorten a condition expression based on the allowed horizontal space.
   * 
   * The allowed space is given as number of characters. This method is being used to shorten
   * presence conditions for boxes in diagram editors.
   * 
   * @param expr the condition expression to be shortened
   * @param allowedSpace the number of characters that are shown in the box anyway
   * @return the condition expression as a string, possibly shortened
   */
  public static String shortenCondition(SNode expr, int allowedSpace) {
    // compute presence condition string length from allowedSpace
    int withExtraSpace = allowedSpace * (100 + EXTRA_PERCENTAGE) / 100;
    int maxLen = (allowedSpace < MINIMAL_LIMIT ? MINIMAL_LIMIT : withExtraSpace);
    return shortenConditionHelper(expr, maxLen);
  }


  private static String shortenConditionHelper(SNode expr, int maxLen) {
    // first, "compactify" the condition expression (without loosing semantics)
    String label = FeatureExpressionCompactor.getCompact(expr);
    if (label == null) {
      // if there is no valid presence conditions, just show "true" as a default
      return "true";
    }

    // compute presence condition string length from component instance name length
    if (label.length() <= maxLen) {
      // presence condition is not longer than the maximal allowed space
      return label;
    } else {
      // presence condition is too long, shorten it and make space for appended ellipsis
      return label.substring(0, maxLen - 3) + "...";
    }
  }
}
