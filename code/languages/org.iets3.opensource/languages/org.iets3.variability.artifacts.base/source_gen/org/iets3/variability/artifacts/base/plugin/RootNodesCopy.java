package org.iets3.variability.artifacts.base.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.google.common.collect.BiMap;
import com.google.common.collect.HashBiMap;
import jetbrains.mps.smodel.CopyUtil;
import com.google.common.collect.ImmutableBiMap;

public class RootNodesCopy {
  /**
   * Create a copy of a set of root nodes. The set is specified by a set of any nodes,
   * and their roots will be determined by the factory function.
   * 
   * @param nodeGroup a set of nodes defining the roots to be copied
   * @return a copy of the root node group, and some meta-information
   */
  public static RootNodesCopy createFromNodeGroup(Iterable<SNode> nodeGroup) {
    List<SNode> originalRoots = Sequence.fromIterable(nodeGroup).select((it) -> SNodeOperations.getContainingRoot(it)).distinct().toList();
    return new RootNodesCopy(originalRoots);
  }

  /**
   * A mapping from original nodes to copied nodes
   */
  private BiMap<SNode, SNode> origToCopy = HashBiMap.create();

  private RootNodesCopy(Iterable<SNode> originalRoots) {
    List<SNode> copiedRoots = CopyUtil.copy(Sequence.fromIterable(originalRoots).toList(), origToCopy);
    copiedRoots.forEach((SNode n) -> CopyUtil.addReferences(n, origToCopy, false));
  }

  public INodeMapper getMapper() {
    return new INodeMapper() {
      @Override
      public SNode mapOrig2Actual(SNode orig) {
        return origToCopy.get(orig);
      }
    };
  }

  public SNode getCopyFor(SNode origNode) {
    return origToCopy.get(origNode);
  }

  public ImmutableBiMap<SNode, SNode> inverseMapping() {
    return ImmutableBiMap.copyOf(origToCopy.inverse());
  }
}
