package org.iets3.variability.artifacts.base.behavior;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.Objects;
import java.util.List;
import java.util.LinkedList;
import jetbrains.mps.internal.collections.runtime.NotNullWhereFilter;
import java.util.ArrayList;

public class IVAADependencyHelper {

  public static Iterable<SNode> getDependenciesSimpleGeneric(final SNode artifactRoot, final _FunctionTypes._return_P1_E0<? extends SNode, ? super SNode> ivaaGetter) {
    Iterable<SNode> referencedNodes = ListSequence.fromList(SNodeOperations.getNodeDescendants(artifactRoot, null, false, new SAbstractConcept[]{})).translate((it) -> SNodeOperations.getReferences(it)).select((it) -> it.getTargetNode()).where((it) -> it != null);
    Iterable<SNode> otherRoots = Sequence.fromIterable(referencedNodes).select((it) -> it.getContainingRoot()).where((it) -> !(Objects.equals(it, artifactRoot)));
    List<SNode> result = ListSequence.fromList(new LinkedList<>());
    ListSequence.fromList(result).addSequence(Sequence.fromIterable(otherRoots).select((it) -> ivaaGetter.invoke(it)).where(new NotNullWhereFilter()));
    return result;
  }

  public static Iterable<Segment> getAllDependencies(SNode ivaa) {
    // default behavior: fall back to deprecated version getDependenciesSimple (without instantiation)
    Iterable<Segment> instanceDependencies = IVariabilityAwareArtifact__BehaviorDescriptor.getDependencies_id5LihCoMjdTK.invoke(ivaa);
    Iterable<Segment> simpleDeps = Sequence.fromIterable(IVariabilityAwareArtifact__BehaviorDescriptor.getDependenciesSimple_id28EqHe3I657.invoke(ivaa)).select((it) -> new Segment(null, it));

    // return union of simple dependencies with instantiated dependencies
    return Sequence.fromIterable(simpleDeps).union(Sequence.fromIterable(instanceDependencies));
  }

  public static Iterable<ArtifactPath> getAllDependenciesTransitive(SNode ivaa) {
    // TODO: Use Traversal helper from mpsutil.common here
    List<ArtifactPath> results = ListSequence.fromList(new ArrayList<ArtifactPath>());
    getDepsTransitiveRec(ivaa, new ArtifactPath(ivaa), results);
    return results;
  }

  private static void getDepsTransitiveRec(SNode ivaa, ArtifactPath prefix, List<ArtifactPath> results) {
    Iterable<Segment> dependencies = IVariabilityAwareArtifact__BehaviorDescriptor.getAllDependencies_id36x6ZtcRcQW.invoke(ivaa);
    if (dependencies == null) {
      return;
    }
    for (Segment cn : ListSequence.fromList(Sequence.fromIterable(dependencies).toList())) {
      SNode target = cn.getTarget();
      if (!(prefix.visits(target))) {
        ArtifactPath path = prefix.append(cn);
        ListSequence.fromList(results).addElement(path);
        getDepsTransitiveRec(target, path, results);
      }
    }
  }

  public static Iterable<SNode> getDependenciesTransitivePlain(SNode ivaa) {
    return TransitiveDepsComputer.compute(ivaa, (SNode ivaa_) -> Sequence.fromIterable(IVariabilityAwareArtifact__BehaviorDescriptor.getDependencies_id5LihCoMjdTK.invoke(ivaa_)).select((dep) -> dep.getTarget()).union(Sequence.fromIterable(IVariabilityAwareArtifact__BehaviorDescriptor.getDependenciesSimple_id28EqHe3I657.invoke(ivaa_))).distinct());
  }

  public static Iterable<SNode> getDirectDependenciesTransitive(SNode ivaa) {
    Iterable<ArtifactPath> allDependenciesTransitive = getAllDependenciesTransitive(ivaa);
    return Sequence.fromIterable(allDependenciesTransitive).where((it) -> it.hasDirectLeaf()).select((it) -> it.getLeaf()).distinct();
  }
}
