package org.iets3.variability.artifacts.base.behavior;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.util.List;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.NotNullWhereFilter;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.Collection;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class SkeletonTree {
  private final SNode artifact;
  private final SkeletonNode rootNode;
  private final List<SkeletonNode> allSkeletonNodes;
  private final _FunctionTypes._return_P2_E0<? extends SkeletonNode, ? super SNode, ? super ArtifactPath> skeletonNodeResolver;

  public SkeletonTree(SNode artifact, SkeletonNode rootNode, List<SkeletonNode> allNodes, _FunctionTypes._return_P2_E0<? extends SkeletonNode, ? super SNode, ? super ArtifactPath> skeletonNodeResolver) {
    this.artifact = artifact;
    this.rootNode = rootNode;
    this.allSkeletonNodes = allNodes;
    this.skeletonNodeResolver = skeletonNodeResolver;
  }

  public SNode getArtifact() {
    return this.artifact;
  }

  public Iterable<SNode> getAllNonInstanceArtifacts() {
    Iterable<SkeletonNode> sn = ListSequence.fromList(this.allSkeletonNodes).where((it) -> {
      SkeletonNode.PivotInfo pivot = it.getPivot();
      return it.representsRootNode() || (pivot != null && !(pivot.isInstance()));
    });
    return Sequence.fromIterable(sn).select((it) -> check_dajowl_a0a0a0a0b0j(it.getFullPath())).where(new NotNullWhereFilter()).distinct();
  }

  /**
   * 
   * @deprecated This method is likely not used.
   */
  @Deprecated
  public Iterable<SNode> getAllArtifacts() {
    return ListSequence.fromList(this.allSkeletonNodes).select((it) -> check_dajowl_a0a0a0a0a0l(it.getFullPath())).where(new NotNullWhereFilter()).distinct();
  }

  public SkeletonNode getSkeletonRoot() {
    return this.rootNode;
  }

  public void accept(ISkeletonVisitor visitor) {
    // forward to root node
    this.rootNode.accept(visitor);
  }

  public Iterable<SkeletonNode> getAllVarPoints() {
    return this.allVPNodes();
  }


  public Iterable<SkeletonNode> getAllConditionVarPoints() {
    return Sequence.fromIterable(allVPNodes()).where((it) -> Sequence.fromIterable(SNodeOperations.ofConcept(it.varPoints(), CONCEPTS.IConditionVarPoint$bG)).isNotEmpty());
  }

  private Iterable<SkeletonNode> allVPNodes() {
    return ListSequence.fromList(this.allSkeletonNodes).where((it) -> it.hasVarPoint());
  }

  public Iterable<SkeletonNode> getAllNonVarPoints() {
    return ListSequence.fromList(this.allSkeletonNodes).where((it) -> !(it.hasVarPoint()));
  }

  /**
   * 
   * @deprecated This method is likely not used.
   */
  @Deprecated
  public Collection<SkeletonNode> allSkeletonNodes() {
    return this.allSkeletonNodes;
  }

  public SkeletonNode resolve(SNode n, ArtifactPath path) {
    return this.skeletonNodeResolver.invoke(n, path);
  }

  /**
   * Create a graph of the skeleton tree in graphviz/dot format (for debugging)
   * 
   * @return a string with the graph in graphviz/dot format
   */
  public String buildGraph(boolean withReferences) {
    return new SkeletonTreeGraphCreator(true).draw(this.rootNode, withReferences);
  }

  private static SNode check_dajowl_a0a0a0a0b0j(ArtifactPath checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getLeaf();
    }
    return null;
  }
  private static SNode check_dajowl_a0a0a0a0a0l(ArtifactPath checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getLeaf();
    }
    return null;
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept IConditionVarPoint$bG = MetaAdapterFactory.getInterfaceConcept(0xf08835038eaa4bc8L, 0x8846eb63220ab1ddL, 0xe86d1af52aae5ceL, "org.iets3.variability.artifacts.base.structure.IConditionVarPoint");
  }
}
