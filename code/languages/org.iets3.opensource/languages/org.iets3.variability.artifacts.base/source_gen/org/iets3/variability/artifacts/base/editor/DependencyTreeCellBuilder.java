package org.iets3.variability.artifacts.base.editor;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.nodeEditor.AbstractCellProvider;
import jetbrains.mps.openapi.editor.EditorContext;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.nodeEditor.cells.EditorCell_Collection;
import org.iets3.variability.artifacts.base.behavior.IVariabilityAwareArtifact__BehaviorDescriptor;
import jetbrains.mps.nodeEditor.cells.EditorCell_Constant;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import org.iets3.variability.artifacts.base.behavior.ArtifactPath;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.nodeEditor.cells.EditorCell_Property;
import jetbrains.mps.nodeEditor.cells.ModelAccessor;
import jetbrains.mps.editor.runtime.style.StyleAttributes;
import jetbrains.mps.nodeEditor.cells.EditorCell_Basic;
import com.intellij.ui.JBColor;
import jetbrains.mps.nodeEditor.MPSFonts;

public class DependencyTreeCellBuilder {

  private final SNode root;

  public DependencyTreeCellBuilder(SNode root) {
    this.root = root;
  }

  public AbstractCellProvider createCellProvider(final EditorContext editorContext) {
    final SNode root = this.root;
    return new AbstractCellProvider(root) {
      public EditorCell createEditorCell(EditorContext p0) {
        return createCell(editorContext, root);
      }
    };
  }

  private EditorCell createCell(EditorContext ec, SNode ivaa) {
    EditorCell_Collection enclosingCell = EditorCell_Collection.createVertical(ec, ivaa);
    if (!((boolean) IVariabilityAwareArtifact__BehaviorDescriptor.hasAnyDependencies_idikWLjwemlM.invoke(ivaa))) {
      EditorCell_Constant none = new EditorCell_Constant(ec, ivaa, "<none>");
      setCommonStyle(none);
      enclosingCell.addEditorCell(none);
    } else {
      createTransitiveList(ec, enclosingCell, ivaa);
    }
    return enclosingCell;
  }

  private void createTransitiveList(EditorContext ec, jetbrains.mps.openapi.editor.cells.EditorCell_Collection collection, SNode n) {
    Set<String> shown = SetSequence.fromSet(new HashSet<String>());
    for (ArtifactPath dep : Sequence.fromIterable(IVariabilityAwareArtifact__BehaviorDescriptor.getAllDependenciesTransitive_id5LihCoMjg$M.invoke(n))) {
      final String label = dep.asDependency();
      // there might be more than one way to reach direct dependencies, show only once
      if (!(SetSequence.fromSet(shown).contains(label))) {
        SetSequence.fromSet(shown).addElement(label);
        EditorCell_Property single = new EditorCell_Property(ec, new ModelAccessor.ReadOnly() {
          @Override
          public String getText() {
            return label;
          }
        }, dep.getLeaf());
        setCommonStyle(single);
        single.getStyle().set(StyleAttributes.NAVIGATABLE_NODE, IVariabilityAwareArtifact__BehaviorDescriptor.artifactRoot_id3q2wVeorTKs.invoke(dep.getLeaf()));
        collection.addEditorCell(single);
      }
    }
  }

  private void setCommonStyle(EditorCell_Basic cell) {
    cell.getStyle().set(StyleAttributes.TEXT_COLOR, JBColor.DARK_GRAY);
    cell.getStyle().set(StyleAttributes.FONT_STYLE, MPSFonts.ITALIC);
  }

}
