package org.iets3.core.expr.mutable.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.math.BigInteger;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;

public class RateLimitInterceptorState extends InterceptorState {

  public RateLimitInterceptorState(SNode intc) {
    super(intc);
  }

  public class Entry {
    public Entry(BigInteger time, IDElement element) {
      myElement = element;
      myTime = time;
    }
    public boolean isAfter(BigInteger t) {
      return myTime.compareTo(t) > 0;
    }
    private IDElement myElement;
    private BigInteger myTime;

    @Override
    public String toString() {
      return this.myTime + " -> " + this.myElement;
    }
  }

  private List<Entry> entries = ListSequence.fromList(new ArrayList<Entry>());

  public void register(BigInteger time, IDElement element) {
    ListSequence.fromList(entries).addElement(new Entry(time, element));
  }

  public List<Entry> messagesInPeriod(BigInteger now, BigInteger delta) {
    final Wrappers._T<BigInteger> start = new Wrappers._T<BigInteger>(now.subtract(delta));
    if (start.value.compareTo(BigInteger.ZERO) < 0) {
      start.value = BigInteger.ZERO;
    }
    return ListSequence.fromList(this.entries).where((it) -> it.isAfter(start.value)).toList();
  }

}
