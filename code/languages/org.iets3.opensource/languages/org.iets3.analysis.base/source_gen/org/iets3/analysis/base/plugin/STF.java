package org.iets3.analysis.base.plugin;

/*Generated by MPS */

import java.util.Map;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.smodel.structure.ExtensionPoint;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SProperty;

public class STF {

  private static Map<SAbstractConcept, SolverTaskFactory> factories = null;

  public static SNode createSolverTask(SNode n, String name) {
    ExtensionPoint<SolverTaskFactory> ep = new ExtensionPoint<SolverTaskFactory>("org.iets3.analysis.base.solverfactories");
    STF.factories = MapSequence.fromMap(new HashMap<SAbstractConcept, SolverTaskFactory>());
    for (SolverTaskFactory f : Sequence.fromIterable(ep.getObjects())) {
      for (SAbstractConcept c : Sequence.fromIterable(f.applicableConcepts())) {
        MapSequence.fromMap(STF.factories).put(c, f);
      }
    }
    if (factories == null) {
      return null;
    }

    SolverTaskFactory factory = findFactory(n);
    if (factory == null) {
      System.err.println("STF ERROR: No SolverTaskFactory found for concept " + SNodeOperations.getConcept(n));
      return null;
    } else {
      return factory.createSolverTask(n, name);
    }
  }

  private static SolverTaskFactory findFactory(SNode n) {
    // check if there is a factory for this concept
    SAbstractConcept conc = SNodeOperations.getConcept(n);
    SolverTaskFactory factory = MapSequence.fromMap(factories).get(conc);
    if (factory != null) {
      return factory;
    }

    // check super-concepts breadth-first
    for (SAbstractConcept superConc : ListSequence.fromList(SConceptOperations.getAllSuperConcepts(conc, false))) {
      SolverTaskFactory fac = MapSequence.fromMap(factories).get(superConc);
      if (fac != null) {
        return fac;
      }
    }

    // not found
    return null;
  }

  public static SNode createErrorTask(TaskCreationException ex) {
    SNode errorTask = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0xdb8bd0353f5141d8L, 0x8fed954c202d18beL, 0xf5136bc1ff76858L, "org.iets3.analysis.base.structure.ErrorSolverTask"));
    ListSequence.fromList(SLinkOperations.getChildren(errorTask, LINKS.errors$rx2e)).addSequence(Sequence.fromIterable(ex.getMessages()).select((it) -> createErrorMessage_vsy_a0a0a0a0b0h(it)));
    return errorTask;
  }

  public static boolean areFactoriesAvailable() {
    ExtensionPoint<SolverTaskFactory> ep = new ExtensionPoint<SolverTaskFactory>("org.iets3.analysis.base.solverfactories");
    return Sequence.fromIterable(ep.getObjects()).count() > 0;
  }
  private static SNode createErrorMessage_vsy_a0a0a0a0b0h(String p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ErrorMessage$zn);
    n0.setProperty(PROPS.msg$2JDK, p0);
    return n0.getResult();
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink errors$rx2e = MetaAdapterFactory.getContainmentLink(0xdb8bd0353f5141d8L, 0x8fed954c202d18beL, 0xf5136bc1ff76858L, 0xf5136bc1ff78cfeL, "errors");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept ErrorMessage$zn = MetaAdapterFactory.getConcept(0xdb8bd0353f5141d8L, 0x8fed954c202d18beL, 0xf5136bc1ff78cdbL, "org.iets3.analysis.base.structure.ErrorMessage");
  }

  private static final class PROPS {
    /*package*/ static final SProperty msg$2JDK = MetaAdapterFactory.getProperty(0xdb8bd0353f5141d8L, 0x8fed954c202d18beL, 0xf5136bc1ff78cdbL, 0xf5136bc1ff78cdcL, "msg");
  }
}
