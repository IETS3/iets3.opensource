package org.iets3.analysis.base.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.module.SRepository;
import java.util.concurrent.Callable;
import java.util.concurrent.Future;
import com.intellij.openapi.application.ApplicationManager;
import java.util.concurrent.ExecutionException;

public class ExecOnPooledThreadInWriteAccess<T> implements AsyncSolverTaskExecutor.IExecEnv<T> {

  private final SRepository repo;

  public ExecOnPooledThreadInWriteAccess(SRepository repo) {
    this.repo = repo;
  }

  @Override
  public T runWithin(final Callable<T> executionCode) {
    Future<T> future = ApplicationManager.getApplication().executeOnPooledThread(wrapInWriteAccess(executionCode));
    try {
      return future.get();
    } catch (ExecutionException | InterruptedException e) {
      throw new RuntimeException(e);
    }
  }

  private Callable<T> wrapInWriteAccess(final Callable<T> executionCode) {
    return new Callable<T>() {
      @Override
      public T call() {
        return AsyncUtil.callWithWriteAction(executionCode, repo);
      }
    };
  }

}
