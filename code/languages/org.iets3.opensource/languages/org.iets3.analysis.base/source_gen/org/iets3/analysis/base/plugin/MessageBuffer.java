package org.iets3.analysis.base.plugin;

/*Generated by MPS */

import java.util.Set;
import com.google.common.collect.Sets;
import java.util.Collection;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.ArrayList;
import java.util.Objects;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;

/**
 * Buffers messages which are drained by the UI THread
 */
public class MessageBuffer {
  private Set<MessageUI> messages = Sets.newHashSet();
  private static long changeCount = 0;

  public synchronized void add(Collection<MessageUI> messages) {
    SetSequence.fromSet(this.messages).addSequence(CollectionSequence.fromCollection(messages));
    changeCount++;
  }

  public synchronized Tuples._2<Long, Collection<MessageUI>> nodesMessages(SNode node) {
    Collection<MessageUI> relevantMessages = CollectionSequence.fromCollection(new ArrayList<MessageUI>());
    for (MessageUI msg : messages) {
      if (Objects.equals(node, msg.node) || Objects.equals(SNodeOperations.getContainingRoot(msg.node), node)) {
        CollectionSequence.fromCollection(relevantMessages).addElement(msg);
      }
    }
    SetSequence.fromSet(messages).removeSequence(CollectionSequence.fromCollection(relevantMessages));
    return MultiTuple.<Long,Collection<MessageUI>>from(changeCount, relevantMessages);
  }

  public synchronized long changeCount() {
    return changeCount;
  }

}
