package org.iets3.analysis.base.plugin;

/*Generated by MPS */

import java.util.function.Supplier;
import java.util.concurrent.Callable;
import com.intellij.util.Consumer;

/**
 * Wraps a supplier and adds an isCancelled-flag. Only if not cancelled the wrapped callable is called.
 * 
 * @param <T> generic Type
 */
public class CancelableSupplier<T> implements Supplier<T>, Callable<T> {

  private volatile ISolvableTaskStatus status = ISolvableTaskStatus.Queued;
  private final Supplier<T> supplier;
  private final Consumer<ISolvableTaskStatus> statusUpdater;
  private final T cancelValue;

  public CancelableSupplier(Supplier<T> supplier, final Consumer<ISolvableTaskStatus> statusUpdater, T cancelValue) {
    this.supplier = supplier;
    this.statusUpdater = statusUpdater;
    this.statusUpdater.consume(this.status);
    this.cancelValue = cancelValue;
  }

  public void cancel() {
    status = ISolvableTaskStatus.Rejected;
    statusUpdater.consume(status);
  }

  @Override
  public T get() {
    statusUpdater.consume(status);
    if (status != ISolvableTaskStatus.Rejected) {
      return this.supplier.get();
    }
    return this.cancelValue;
  }

  @Override
  public T call() throws Exception {
    return this.get();
  }
}
