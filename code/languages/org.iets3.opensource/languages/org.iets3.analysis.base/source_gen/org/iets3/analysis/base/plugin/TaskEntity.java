package org.iets3.analysis.base.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNodeReference;
import org.jetbrains.mps.openapi.module.SRepository;
import java.time.LocalDateTime;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.smodel.ModelAccessHelper;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPointerOperations;
import org.iets3.analysis.base.behavior.ISolvable__BehaviorDescriptor;
import java.time.temporal.ChronoUnit;
import org.apache.commons.lang3.builder.ToStringBuilder;
import org.apache.commons.lang3.builder.ToStringStyle;
import org.apache.commons.lang3.builder.HashCodeBuilder;
import com.google.common.collect.Ordering;
import com.google.common.collect.ComparisonChain;

public class TaskEntity implements Comparable<TaskEntity> {
  private SNodeReference solvable;
  private SRepository repo;
  private final ISolvableTaskStatus status;
  private LocalDateTime startTime;
  private LocalDateTime timeStampSorting;
  private final int id;

  private TaskEntity(SNode solvable, ISolvableTaskStatus status, LocalDateTime timestamp, int id) {
    this.solvable = SNodeOperations.getPointer(solvable);
    SModel model = solvable.getModel();
    assert model != null : "Solvable is not in a model";
    this.repo = model.getRepository();
    this.status = status;
    this.startTime = timestamp;
    setTimeStamp(timestamp);

    this.id = id;
  }

  public SNode getSolvable() {
    return new ModelAccessHelper(repo).runReadAction(() -> SPointerOperations.resolveNode(solvable, repo));
  }

  public String getName() {
    return new ModelAccessHelper(repo).runReadAction(() -> (String) ISolvable__BehaviorDescriptor.getSolvableName_idWieAE6TWOo.invoke(SPointerOperations.resolveNode(solvable, repo)));
  }

  public void setTimeStamp(LocalDateTime timestamp) {
    LocalDateTime truncatedTo = timestamp.truncatedTo(ChronoUnit.SECONDS);
    // Round to seconds divisible by 5
    int second = truncatedTo.getSecond();
    this.timeStampSorting = truncatedTo.minusSeconds(second).plusSeconds((second / 5) * 5);
  }

  public ISolvableTaskStatus getStatus() {
    return status;
  }

  public LocalDateTime getTimeStamp() {
    return timeStampSorting;
  }


  @Override
  public String toString() {
    return new ToStringBuilder(this, ToStringStyle.SIMPLE_STYLE).append("Status: ", this.status).append("Name: ", this.getName()).append("Time: ", this.startTime).toString();
  }

  @Override
  public int hashCode() {
    return new HashCodeBuilder(17, 37).append(id).append(startTime).toHashCode();
  }



  @Override
  public boolean equals(Object obj) {
    if (!(obj instanceof TaskEntity)) {
      return false;
    }
    TaskEntity other = ((TaskEntity) obj);
    return this.id == other.id && startTime.equals(other.startTime);
  }

  public static TaskEntity fromISolvable(SNode solvable, ISolvableTaskStatus status, LocalDateTime timestamp) {
    return new TaskEntity(solvable, status, timestamp, solvable.getNodeId().hashCode());
  }
  @Override
  public int compareTo(TaskEntity other) {
    Ordering<LocalDateTime> reverse = Ordering.<LocalDateTime>natural().reverse();
    return ComparisonChain.start().compare(this.timeStampSorting, other.timeStampSorting, reverse).compare(this.status.sortingPriority(), other.status.sortingPriority()).result();
  }
}
