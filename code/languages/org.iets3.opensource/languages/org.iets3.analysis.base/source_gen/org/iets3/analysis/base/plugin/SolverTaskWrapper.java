package org.iets3.analysis.base.plugin;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.Collection;
import org.iets3.core.base.behavior.IResult;
import org.iets3.analysis.base.behavior.AbstractSolverTask__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.Collections;

/**
 * Wraps an actual AbstractSolverTask and runs it.
 */
public class SolverTaskWrapper implements ITask {
  private static final Logger LOG = Logger.getLogger(SolverTaskWrapper.class);

  private SNode st;
  private SNode messageNode;

  /**
   * Runs a SolverTask in a write action and generate the appropriate IResult collection also in case of an exception.
   * 
   * @param st solverTask
   * @param messageNode the node where general messages of the solver are highlighted (i.e. general solver failures)
   */
  public SolverTaskWrapper(SNode st, SNode messageNode) {
    this.st = st;
    this.messageNode = messageNode;
  }

  public SNode solverTask() {
    return this.st;
  }

  @Override
  public Collection<IResult> run() {
    try {
      IResult checkResult = AbstractSolverTask__BehaviorDescriptor.run_id7rOSrvnGeUQ.invoke(st);
      if (checkResult == null) {
        return asResult("SolverTask produced no result!");
      } else {
        Iterable<IResult> mainResult = Sequence.<IResult>singleton(checkResult);
        Iterable<IResult> subResults = Sequence.fromIterable(checkResult.getSubResults()).ofType(IResult.class);
        return Sequence.fromIterable(mainResult).union(Sequence.fromIterable(subResults)).toList();
      }
    } catch (SolverException e) {
      return asResult(e.getMessage());

    } catch (Throwable e) {
      if (LOG.isErrorLevel()) {
        LOG.error("", e);
      }
      return asResult(e.getMessage());
    }
  }

  private Collection<IResult> asResult(String msg) {
    return Collections.<IResult>singletonList(IResult.make(IResult.MessageType.Error, msg, Sequence.<SNode>singleton(messageNode), null));
  }
}
