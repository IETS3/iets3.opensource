package org.iets3.analysis.base.plugin;

/*Generated by MPS */

import com.intellij.openapi.wm.StatusBarWidget;
import com.intellij.ide.ui.UISettingsListener;
import com.intellij.openapi.wm.CustomStatusBarWidget;
import java.util.Set;
import java.util.Collections;
import java.util.LinkedHashMap;
import java.util.Map;
import javax.swing.Icon;
import org.jetbrains.annotations.NotNull;
import com.intellij.openapi.wm.StatusBar;
import com.intellij.util.Consumer;
import org.jetbrains.annotations.NonNls;
import com.intellij.openapi.application.ApplicationManager;
import com.intellij.ide.ui.UISettings;
import javax.swing.JComponent;
import org.jetbrains.annotations.Nullable;
import com.intellij.openapi.util.NlsContexts;
import java.awt.event.MouseEvent;
import javax.swing.DefaultListModel;
import java.util.ArrayList;
import com.google.common.collect.Lists;
import java.util.Comparator;
import javax.swing.JList;
import java.awt.event.MouseAdapter;
import org.jetbrains.mps.openapi.model.SNode;
import com.intellij.openapi.actionSystem.DataContext;
import com.intellij.ide.DataManager;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.ide.actions.MPSCommonDataKeys;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.openapi.navigation.NavigationSupport;
import com.intellij.openapi.ui.Messages;
import javax.swing.BorderFactory;
import javax.swing.JScrollPane;
import java.awt.Dimension;
import java.awt.Point;
import com.intellij.ui.awt.RelativePoint;

public class ISolvableMonitorWidget implements StatusBarWidget, UISettingsListener, CustomStatusBarWidget, StatusBarWidget.TextPresentation, StatusBarWidget.IconPresentation {

  private int MAX_ENTRIES = 20;
  private Set<TaskEntity> activeTasks = Collections.newSetFromMap(new LinkedHashMap<TaskEntity, Boolean>() {
    @Override
    protected boolean removeEldestEntry(Map.Entry<TaskEntity, Boolean> eldest) {
      return size() > MAX_ENTRIES;
    }
  });


  private final Icon myIcon = IconContainer.ICON_a5;


  private ISolvablePanel component;

  @NotNull
  private final StatusBar myStatusBar;

  private Consumer<TaskEntity> myListener = (TaskEntity taskEntity) -> {
    ISolvableMonitorWidget.this.activeTasks.remove(taskEntity);
    ISolvableMonitorWidget.this.activeTasks.add(taskEntity);
  };

  public ISolvableMonitorWidget(StatusBar sb) {
    myStatusBar = sb;
  }

  @Override
  public void dispose() {
    AsyncSolverTaskExecutor.removeTaskChangeListener(myListener);
  }

  @NonNls
  @NotNull
  @Override
  public String ID() {
    return "ISolvableRunningQueued";
  }
  @Override
  public void install(@NotNull StatusBar bar) {
    // Use approach from com.intellij.openapi.wm.impl.status.ToolWindowsWidget
    ApplicationManager.getApplication().getMessageBus().connect(this).<UISettingsListener>subscribe(UISettingsListener.TOPIC, this);
    AsyncSolverTaskExecutor.addTaskChangeListener(myListener);
  }
  @Override
  public void uiSettingsChanged(@NotNull UISettings settings) {
    this.update();
  }

  public void update() {
    if (component != null) {
      component.update();
    }
    myStatusBar.updateWidget(ID());
  }
  @Override
  public JComponent getComponent() {
    if (component == null) {
      // getComponent() is invoked EARLIER than install(), so this is the only place to instantiate panel
      // except cons of this class (which is bad, because this goes to TMP, which uses it e.g. to getText() on un-initialized instance)
      component = new ISolvablePanel(this, this);
    }
    return component;
  }
  @Override
  public float getAlignment() {
    return JComponent.RIGHT_ALIGNMENT;
  }
  @Nullable
  @NlsContexts.Tooltip
  @Override
  public String getTooltipText() {
    return "Show running and queued ISolvables in Background.";
  }
  @NotNull
  @NlsContexts.Label
  @Override
  public String getText() {
    return "ISolvables";
  }

  @Nullable
  @Override
  public Consumer<MouseEvent> getClickConsumer() {
    return new Consumer<MouseEvent>() {
      @Override
      public void consume(MouseEvent e) {
        PopupPanel panel = new PopupPanel();
        panel.setEnabled(false);
        final DefaultListModel<TaskEntity> model = new DefaultListModel<TaskEntity>();
        ArrayList<TaskEntity> sortedTasks = Lists.newArrayList(activeTasks);
        Collections.sort(sortedTasks, Comparator.naturalOrder());
        model.addAll(sortedTasks);
        int maxtextLenght = Math.min(15, activeTasks.stream().mapToInt((TaskEntity te) -> te.getName().length()).max().orElse(0));
        final JList list = new JList(model);
        list.setEnabled(false);
        list.setCellRenderer(new TaskEntityRenderer(maxtextLenght));
        list.addMouseListener(new MouseAdapter() {
          @Override
          public void mouseClicked(MouseEvent e) {
            int clickIndex = list.locationToIndex(e.getPoint());
            // Empty List Check
            if (clickIndex < 0) {
              return;
            }
            TaskEntity clickedTask = model.get(clickIndex);
            final SNode solvable = clickedTask.getSolvable();
            DataContext dataContext = DataManager.getInstance().getDataContext(e.getComponent());
            final MPSProject mpsProject = MPSCommonDataKeys.MPS_PROJECT.getData(dataContext);
            if (mpsProject != null) {
              if ((solvable != null) && SNodeOperations.getModel(solvable) != null) {
                SNodeOperations.getModel(solvable).getRepository().getModelAccess().runReadAction(() -> NavigationSupport.getInstance().openNode(mpsProject, solvable, true, true));
              } else {
                ApplicationManager.getApplication().invokeLater(() -> Messages.showWarningDialog(mpsProject.getProject(), "Solvable node is not available anymore", "Solvable not found"));
              }
            }
          }
        });
        list.setBorder(BorderFactory.createEmptyBorder(5, 5, 5, 5));
        panel.add(new JScrollPane(list));
        Dimension dimension = panel.getPreferredSize();
        Point point = new Point(0, 0);
        point = new Point(point.x - dimension.width, point.y - dimension.height);
        panel.showComponent(new RelativePoint(e.getComponent(), point));

      }
    };
  }
  @NotNull
  @Override
  public Icon getIcon() {
    // TODO: Use only one Icon. This hack helps to avoid tests fails
    return myIcon;
  }

  @Nullable
  @Override
  public StatusBarWidget.WidgetPresentation getPresentation() {
    return this;
  }

}
