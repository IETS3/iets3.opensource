package org.iets3.components.hardware.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import jetbrains.mps.smodel.action.SNodeFactoryOperations;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.ide.findusages.model.SearchResults;
import jetbrains.mps.ide.findusages.view.FindUtils;
import jetbrains.mps.progress.EmptyProgressMonitor;
import jetbrains.mps.ide.findusages.model.SearchResult;
import org.jetbrains.mps.openapi.model.SReference;
import java.util.Objects;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SProperty;

public class BusRefactoringHelper {

  /**
   * Tries to derive a concrete instance of a BusType from athe name of a "buskind component". 
   * 
   * @param busComp component with a buskind
   * @return derived instance of a AbstractBusType etherwise null
   */
  public static SNode deriveBusTypeFromBusComponent(SNode busComp) {
    if (!(SNodeOperations.isInstanceOf(SLinkOperations.getTarget(busComp, LINKS.kind$8cnO), CONCEPTS.BusKind$f0))) {
      throw new IllegalArgumentException("Bus Component should have BusKind");
    }

    final String busCompName = SPropertyOperations.getString(busComp, PROPS.name$MnvL).toLowerCase();

    Iterable<SConcept> nonAbstractBusTypes = ListSequence.fromList(SConceptOperations.getAllSubConcepts2(CONCEPTS.AbstractBusType$uY, SNodeOperations.getModel(busComp))).where((it) -> !(it.isAbstract()));

    Iterable<Tuples._2<SConcept, String>> busTypeToAlias = Sequence.fromIterable(nonAbstractBusTypes).select((it) -> MultiTuple.<SConcept,String>from(it, SConceptOperations.conceptAlias(it))).sort((it) -> it._1().length(), true);

    Tuples._2<SConcept, String> pair = Sequence.fromIterable(busTypeToAlias).findFirst((it) -> {
      String busTypeAlias = it._1().toLowerCase();
      // check if componentname matches any concept alias
      return busCompName.equalsIgnoreCase(busTypeAlias);
    });

    if (pair != null) {
      return SConceptOperations.createNewNode(SNodeOperations.asInstanceConcept(pair._0()));
    }
    return null;
  }

  /**
   * replaces a deprecated buskind with a derived bustype if possible
   * 
   * @param cmp the component attached with buskind
   */
  public static void fixDeprecatedBuskinds(SNode cmp) {

    Iterable<SNode> foundUsages = findUsages(cmp);
    Iterable<SNode> compInstances = Sequence.fromIterable(SNodeOperations.ofConcept(foundUsages, CONCEPTS.ComponentRef$BR)).select((it) -> SNodeOperations.getNodeAncestor(it, CONCEPTS.ComponentInstance$7c, false, false));

    final Map<SNode, SNode> newBusInstanceMap = MapSequence.fromMap(new HashMap<SNode, SNode>());

    Sequence.fromIterable(compInstances).visitAll((old) -> {
      SNode newBusInst = BusRefactoringHelper.componentInstance2BusInstance(old);
      MapSequence.fromMap(newBusInstanceMap).put(old, newBusInst);
      SNodeOperations.replaceWithAnother(old, newBusInst);
    });

    Sequence.fromIterable(SNodeOperations.ofConcept(foundUsages, CONCEPTS.BusPortType$60)).visitAll((it) -> {
      SLinkOperations.setTarget(it, LINKS.busType$HmsX, BusRefactoringHelper.deriveBusTypeFromBusComponent(SLinkOperations.getTarget(it, LINKS.busType_old$TIk)));
      SLinkOperations.setTarget(it, LINKS.busType_old$TIk, null);
    });

    SNodeOperations.deleteNode(cmp);
  }
  /**
   * replaces a deprecated buskind with an instance of the given bustype-concept and fixed all references
   * 
   * @param cmp the component attached with buskind
   * @param newBusTypeCpt the new bustype concept that should be used. 
   */
  public static void fixDeprecatedBuskinds(SNode cmp, final SConcept newBusTypeCpt) {

    Iterable<SNode> foundUsages = findUsages(cmp);
    Iterable<SNode> compInstances = Sequence.fromIterable(SNodeOperations.ofConcept(foundUsages, CONCEPTS.ComponentRef$BR)).select((it) -> SNodeOperations.getNodeAncestor(it, CONCEPTS.ComponentInstance$7c, false, false));

    final Map<SNode, SNode> newBusInstanceMap = MapSequence.fromMap(new HashMap<SNode, SNode>());

    Sequence.fromIterable(compInstances).visitAll((old) -> {
      SNode newBusInst = BusRefactoringHelper.componentInstance2BusInstance(old, newBusTypeCpt);
      MapSequence.fromMap(newBusInstanceMap).put(old, newBusInst);
      SNodeOperations.replaceWithAnother(old, newBusInst);
    });

    Sequence.fromIterable(SNodeOperations.ofConcept(foundUsages, CONCEPTS.BusPortType$60)).visitAll((it) -> {
      SLinkOperations.setTarget(it, LINKS.busType$HmsX, SNodeFactoryOperations.createNewNode(newBusTypeCpt, null));
      SLinkOperations.setTarget(it, LINKS.busType_old$TIk, null);
    });

    SNodeOperations.deleteNode(cmp);
  }

  private static SNode componentInstance2BusInstance(SNode cmpInstance) {
    SNode newBusInst = createBusInstance_iyia8n_a0a0g(BusRefactoringHelper.deriveBusTypeFromBusComponent(SLinkOperations.getTarget(SLinkOperations.getTarget(cmpInstance, LINKS.component$xlLY), LINKS.ref$KPLr)));

    SLinkOperations.setTarget(newBusInst, LINKS.optionalName$AhFr, SLinkOperations.getTarget(cmpInstance, LINKS.optionalName$AhFr));
    ListSequence.fromList(SLinkOperations.getChildren(newBusInst, LINKS.attributes$zPmM)).addSequence(ListSequence.fromList(SLinkOperations.getChildren(cmpInstance, LINKS.attributes$zPmM)));
    ListSequence.fromList(SLinkOperations.getChildren(newBusInst, LINKS.smodelAttribute$KJ43)).addSequence(ListSequence.fromList(SLinkOperations.getChildren(cmpInstance, LINKS.smodelAttribute$KJ43)));
    fixReference(newBusInst, cmpInstance);

    return newBusInst;
  }

  /**
   * 
   * 
   * @param cmpInstance instance referencing old buskind component
   * @param newBusTypeCpt the bustype which should be used
   * @return newly created businstance
   */
  private static SNode componentInstance2BusInstance(SNode cmpInstance, SConcept newBusTypeCpt) {
    SNode newBusInst = createBusInstance_iyia8n_a0a0i(SNodeFactoryOperations.createNewNode(newBusTypeCpt, null));

    SLinkOperations.setTarget(newBusInst, LINKS.optionalName$AhFr, SLinkOperations.getTarget(cmpInstance, LINKS.optionalName$AhFr));
    ListSequence.fromList(SLinkOperations.getChildren(newBusInst, LINKS.attributes$zPmM)).addSequence(ListSequence.fromList(SLinkOperations.getChildren(cmpInstance, LINKS.attributes$zPmM)));
    ListSequence.fromList(SLinkOperations.getChildren(newBusInst, LINKS.smodelAttribute$KJ43)).addSequence(ListSequence.fromList(SLinkOperations.getChildren(cmpInstance, LINKS.smodelAttribute$KJ43)));
    fixReference(newBusInst, cmpInstance);

    return newBusInst;
  }


  private static Iterable<SNode> findUsages(SNode node) {
    List<SNode> result = new ArrayList<SNode>();
    SearchResults<SNode> results = FindUtils.getSearchResults(new EmptyProgressMonitor(), node, null, "jetbrains.mps.lang.structure.findUsages.NodeUsages_Finder");
    for (SearchResult<SNode> res : ListSequence.fromList(results.getSearchResults2())) {
      ListSequence.fromList(result).addElement(res.getObject());
    }
    return result;
  }

  private static void fixReference(final SNode newNode, final SNode oldNode) {
    for (final SNode el : Sequence.fromIterable(findUsages(oldNode))) {
      Iterable<SReference> references = ListSequence.fromList(SNodeOperations.getReferences(el)).where((it) -> Objects.equals(SLinkOperations.getTargetNode(it), oldNode));
      Sequence.fromIterable(references).visitAll((it) -> el.setReferenceTarget(SLinkOperations.getRefLink(it), newNode));
    }
  }

  private static SNode createBusInstance_iyia8n_a0a0g(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.BusInstance$mP);
    n0.forChild(LINKS.busType$2oCT).initNode(p0, CONCEPTS.AbstractBusType$uY, true);
    return n0.getResult();
  }
  private static SNode createBusInstance_iyia8n_a0a0i(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.BusInstance$mP);
    n0.forChild(LINKS.busType$2oCT).initNode(p0, CONCEPTS.AbstractBusType$uY, true);
    return n0.getResult();
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink kind$8cnO = MetaAdapterFactory.getContainmentLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x6c4f9fd23e484601L, 0x6c4f9fd23e4c96f7L, "kind");
    /*package*/ static final SContainmentLink busType$HmsX = MetaAdapterFactory.getContainmentLink(0xc35abfa80db04d42L, 0xbb3ff46112aeb888L, 0x74c0c1babfb4a1aL, 0x456b5e858baa35a7L, "busType");
    /*package*/ static final SReferenceLink busType_old$TIk = MetaAdapterFactory.getReferenceLink(0xc35abfa80db04d42L, 0xbb3ff46112aeb888L, 0x74c0c1babfb4a1aL, 0x74c0c1babfb4a1bL, "busType_old");
    /*package*/ static final SContainmentLink component$xlLY = MetaAdapterFactory.getContainmentLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x2fa41bd61d1549deL, 0x2fa41bd61d154b21L, "component");
    /*package*/ static final SReferenceLink ref$KPLr = MetaAdapterFactory.getReferenceLink(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x6c4f9fd23e4b67eeL, 0x6c4f9fd23e4b67efL, "ref");
    /*package*/ static final SContainmentLink optionalName$AhFr = MetaAdapterFactory.getContainmentLink(0x7b68d745a7b848b9L, 0xbd9c05c0f8725a35L, 0x32f64a31a100207L, 0x32f64a31a1004e8L, "optionalName");
    /*package*/ static final SContainmentLink attributes$zPmM = MetaAdapterFactory.getContainmentLink(0x583939beded04735L, 0xa055a74f8477fc34L, 0x3ce7d48974432ecdL, 0x3ce7d48974432eceL, "attributes");
    /*package*/ static final SContainmentLink smodelAttribute$KJ43 = MetaAdapterFactory.getContainmentLink(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x10802efe25aL, 0x47bf8397520e5942L, "smodelAttribute");
    /*package*/ static final SContainmentLink busType$2oCT = MetaAdapterFactory.getContainmentLink(0xc35abfa80db04d42L, 0xbb3ff46112aeb888L, 0x456b5e858ba6b1faL, 0x456b5e858ba75d88L, "busType");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept BusKind$f0 = MetaAdapterFactory.getConcept(0xc35abfa80db04d42L, 0xbb3ff46112aeb888L, 0x42253160e3e4d64cL, "org.iets3.components.hardware.structure.BusKind");
    /*package*/ static final SConcept AbstractBusType$uY = MetaAdapterFactory.getConcept(0xc35abfa80db04d42L, 0xbb3ff46112aeb888L, 0x456b5e858ba733b5L, "org.iets3.components.hardware.structure.AbstractBusType");
    /*package*/ static final SConcept ComponentRef$BR = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x6c4f9fd23e4b67eeL, "org.iets3.components.core.structure.ComponentRef");
    /*package*/ static final SConcept ComponentInstance$7c = MetaAdapterFactory.getConcept(0xf0fd486f857743e9L, 0xb6713d118449c6e7L, 0x6c4f9fd23e558729L, "org.iets3.components.core.structure.ComponentInstance");
    /*package*/ static final SConcept BusPortType$60 = MetaAdapterFactory.getConcept(0xc35abfa80db04d42L, 0xbb3ff46112aeb888L, 0x74c0c1babfb4a1aL, "org.iets3.components.hardware.structure.BusPortType");
    /*package*/ static final SConcept BusInstance$mP = MetaAdapterFactory.getConcept(0xc35abfa80db04d42L, 0xbb3ff46112aeb888L, 0x456b5e858ba6b1faL, "org.iets3.components.hardware.structure.BusInstance");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }
}
